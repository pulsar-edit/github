"use strict";

const qs = require('querystring');

const {
  remote,
  ipcRenderer: ipc
} = require('electron');

const {
  GitProcess
} = require('dugite');

class AverageTracker {
  constructor({
    limit
  } = {
    limit: 10
  }) {
    // for now this serves a dual purpose - # of values tracked AND # discarded prior to starting avg calculation
    this.limit = limit;
    this.sum = 0;
    this.values = [];
  }

  addValue(value) {
    if (this.values.length >= this.limit) {
      const discardedValue = this.values.shift();
      this.sum -= discardedValue;
    }

    this.values.push(value);
    this.sum += value;
  }

  getAverage() {
    if (this.enoughData()) {
      return this.sum / this.limit;
    } else {
      return null;
    }
  }

  getLimit() {
    return this.limit;
  }

  enoughData() {
    return this.values.length === this.limit;
  }

}

const query = qs.parse(window.location.search.substr(1));
const sourceWebContentsId = remote.getCurrentWindow().webContents.id;
const operationCountLimit = parseInt(query.operationCountLimit, 10);
const averageTracker = new AverageTracker({
  limit: operationCountLimit
});
const childPidsById = new Map();

const destroyRenderer = () => {
  if (!managerWebContents.isDestroyed()) {
    managerWebContents.removeListener('crashed', destroyRenderer);
    managerWebContents.removeListener('destroyed', destroyRenderer);
  }

  const win = remote.BrowserWindow.fromWebContents(remote.getCurrentWebContents());

  if (win && !win.isDestroyed()) {
    win.destroy();
  }
};

const managerWebContentsId = parseInt(query.managerWebContentsId, 10);
const managerWebContents = remote.webContents.fromId(managerWebContentsId);

if (managerWebContents && !managerWebContents.isDestroyed()) {
  managerWebContents.on('crashed', destroyRenderer);
  managerWebContents.on('destroyed', destroyRenderer);

  window.onbeforeunload = () => {
    managerWebContents.removeListener('crashed', destroyRenderer);
    managerWebContents.removeListener('destroyed', destroyRenderer);
  };
}

const channelName = query.channelName;
ipc.on(channelName, (event, {
  type,
  data
}) => {
  if (type === 'git-exec') {
    const {
      args,
      workingDir,
      options,
      id
    } = data;

    if (args) {
      document.getElementById('command').textContent = `git ${args.join(' ')}`;
    }

    options.processCallback = child => {
      childPidsById.set(id, child.pid);
      child.on('error', err => {
        event.sender.sendTo(managerWebContentsId, channelName, {
          sourceWebContentsId,
          type: 'git-spawn-error',
          data: {
            id,
            err
          }
        });
      });
      child.stdin.on('error', err => {
        event.sender.sendTo(managerWebContentsId, channelName, {
          sourceWebContentsId,
          type: 'git-stdin-error',
          data: {
            id,
            stdin: options.stdin,
            err
          }
        });
      });
    };

    const spawnStart = performance.now();
    GitProcess.exec(args, workingDir, options).then(({
      stdout,
      stderr,
      exitCode
    }) => {
      const timing = {
        spawnTime: spawnEnd - spawnStart,
        execTime: performance.now() - spawnEnd
      };
      childPidsById.delete(id);
      event.sender.sendTo(managerWebContentsId, channelName, {
        sourceWebContentsId,
        type: 'git-data',
        data: {
          id,
          average: averageTracker.getAverage(),
          results: {
            stdout,
            stderr,
            exitCode,
            timing
          }
        }
      });
    }, err => {
      const timing = {
        spawnTime: spawnEnd - spawnStart,
        execTime: performance.now() - spawnEnd
      };
      childPidsById.delete(id);
      event.sender.sendTo(managerWebContentsId, channelName, {
        sourceWebContentsId,
        type: 'git-data',
        data: {
          id,
          average: averageTracker.getAverage(),
          results: {
            stdout: err.stdout,
            stderr: err.stderr,
            exitCode: err.code,
            signal: err.signal,
            timing
          }
        }
      });
    });
    const spawnEnd = performance.now();
    averageTracker.addValue(spawnEnd - spawnStart); // TODO: consider using this to avoid duplicate write operations upon crashing.
    // For now we won't do this to avoid clogging up ipc channel
    // event.sender.sendTo(managerWebContentsId, channelName, {sourceWebContentsId, type: 'exec-started', data: {id}});

    if (averageTracker.enoughData() && averageTracker.getAverage() > 20) {
      event.sender.sendTo(managerWebContentsId, channelName, {
        type: 'slow-spawns'
      });
    }
  } else if (type === 'git-cancel') {
    const {
      id
    } = data;
    const childPid = childPidsById.get(id);

    if (childPid !== undefined) {
      require('tree-kill')(childPid, 'SIGINT', () => {
        event.sender.sendTo(managerWebContentsId, channelName, {
          sourceWebContentsId,
          type: 'git-cancelled',
          data: {
            id,
            childPid
          }
        });
      });

      childPidsById.delete(id);
    }
  } else {
    throw new Error(`Could not identify type ${type}`);
  }
});
ipc.sendTo(managerWebContentsId, channelName, {
  sourceWebContentsId,
  type: 'renderer-ready',
  data: {
    pid: process.pid
  }
});
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uL2xpYi93b3JrZXIuanMiXSwibmFtZXMiOlsicXMiLCJyZXF1aXJlIiwicmVtb3RlIiwiaXBjUmVuZGVyZXIiLCJpcGMiLCJHaXRQcm9jZXNzIiwiQXZlcmFnZVRyYWNrZXIiLCJjb25zdHJ1Y3RvciIsImxpbWl0Iiwic3VtIiwidmFsdWVzIiwiYWRkVmFsdWUiLCJ2YWx1ZSIsImxlbmd0aCIsImRpc2NhcmRlZFZhbHVlIiwic2hpZnQiLCJwdXNoIiwiZ2V0QXZlcmFnZSIsImVub3VnaERhdGEiLCJnZXRMaW1pdCIsInF1ZXJ5IiwicGFyc2UiLCJ3aW5kb3ciLCJsb2NhdGlvbiIsInNlYXJjaCIsInN1YnN0ciIsInNvdXJjZVdlYkNvbnRlbnRzSWQiLCJnZXRDdXJyZW50V2luZG93Iiwid2ViQ29udGVudHMiLCJpZCIsIm9wZXJhdGlvbkNvdW50TGltaXQiLCJwYXJzZUludCIsImF2ZXJhZ2VUcmFja2VyIiwiY2hpbGRQaWRzQnlJZCIsIk1hcCIsImRlc3Ryb3lSZW5kZXJlciIsIm1hbmFnZXJXZWJDb250ZW50cyIsImlzRGVzdHJveWVkIiwicmVtb3ZlTGlzdGVuZXIiLCJ3aW4iLCJCcm93c2VyV2luZG93IiwiZnJvbVdlYkNvbnRlbnRzIiwiZ2V0Q3VycmVudFdlYkNvbnRlbnRzIiwiZGVzdHJveSIsIm1hbmFnZXJXZWJDb250ZW50c0lkIiwiZnJvbUlkIiwib24iLCJvbmJlZm9yZXVubG9hZCIsImNoYW5uZWxOYW1lIiwiZXZlbnQiLCJ0eXBlIiwiZGF0YSIsImFyZ3MiLCJ3b3JraW5nRGlyIiwib3B0aW9ucyIsImRvY3VtZW50IiwiZ2V0RWxlbWVudEJ5SWQiLCJ0ZXh0Q29udGVudCIsImpvaW4iLCJwcm9jZXNzQ2FsbGJhY2siLCJjaGlsZCIsInNldCIsInBpZCIsImVyciIsInNlbmRlciIsInNlbmRUbyIsInN0ZGluIiwic3Bhd25TdGFydCIsInBlcmZvcm1hbmNlIiwibm93IiwiZXhlYyIsInRoZW4iLCJzdGRvdXQiLCJzdGRlcnIiLCJleGl0Q29kZSIsInRpbWluZyIsInNwYXduVGltZSIsInNwYXduRW5kIiwiZXhlY1RpbWUiLCJkZWxldGUiLCJhdmVyYWdlIiwicmVzdWx0cyIsImNvZGUiLCJzaWduYWwiLCJjaGlsZFBpZCIsImdldCIsInVuZGVmaW5lZCIsIkVycm9yIiwicHJvY2VzcyJdLCJtYXBwaW5ncyI6Ijs7QUFBQSxNQUFNQSxFQUFFLEdBQUdDLE9BQU8sQ0FBQyxhQUFELENBQWxCOztBQUVBLE1BQU07QUFBQ0MsRUFBQUEsTUFBRDtBQUFTQyxFQUFBQSxXQUFXLEVBQUVDO0FBQXRCLElBQTZCSCxPQUFPLENBQUMsVUFBRCxDQUExQzs7QUFDQSxNQUFNO0FBQUNJLEVBQUFBO0FBQUQsSUFBZUosT0FBTyxDQUFDLFFBQUQsQ0FBNUI7O0FBR0EsTUFBTUssY0FBTixDQUFxQjtBQUNuQkMsRUFBQUEsV0FBVyxDQUFDO0FBQUNDLElBQUFBO0FBQUQsTUFBVTtBQUFDQSxJQUFBQSxLQUFLLEVBQUU7QUFBUixHQUFYLEVBQXdCO0FBQ2pDO0FBQ0EsU0FBS0EsS0FBTCxHQUFhQSxLQUFiO0FBQ0EsU0FBS0MsR0FBTCxHQUFXLENBQVg7QUFDQSxTQUFLQyxNQUFMLEdBQWMsRUFBZDtBQUNEOztBQUVEQyxFQUFBQSxRQUFRLENBQUNDLEtBQUQsRUFBUTtBQUNkLFFBQUksS0FBS0YsTUFBTCxDQUFZRyxNQUFaLElBQXNCLEtBQUtMLEtBQS9CLEVBQXNDO0FBQ3BDLFlBQU1NLGNBQWMsR0FBRyxLQUFLSixNQUFMLENBQVlLLEtBQVosRUFBdkI7QUFDQSxXQUFLTixHQUFMLElBQVlLLGNBQVo7QUFDRDs7QUFDRCxTQUFLSixNQUFMLENBQVlNLElBQVosQ0FBaUJKLEtBQWpCO0FBQ0EsU0FBS0gsR0FBTCxJQUFZRyxLQUFaO0FBQ0Q7O0FBRURLLEVBQUFBLFVBQVUsR0FBRztBQUNYLFFBQUksS0FBS0MsVUFBTCxFQUFKLEVBQXVCO0FBQ3JCLGFBQU8sS0FBS1QsR0FBTCxHQUFXLEtBQUtELEtBQXZCO0FBQ0QsS0FGRCxNQUVPO0FBQ0wsYUFBTyxJ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QUYrQztBQUdyREMsVUFBQUEsSUFBSSxFQUFFO0FBQUN0QixZQUFBQSxFQUFEO0FBQUt1RCxZQUFBQTtBQUFMO0FBSCtDLFNBQXZEO0FBS0QsT0FORDs7QUFPQW5ELE1BQUFBLGFBQWEsQ0FBQzhDLE1BQWQsQ0FBcUJsRCxFQUFyQjtBQUNEO0FBQ0YsR0FiTSxNQWFBO0FBQ0wsVUFBTSxJQUFJMEQsS0FBSixDQUFXLDJCQUEwQnJDLElBQUssRUFBMUMsQ0FBTjtBQUNEO0FBQ0YsQ0E1RkQ7QUE4RkE5QyxHQUFHLENBQUM2RCxNQUFKLENBQVdyQixvQkFBWCxFQUFpQ0ksV0FBakMsRUFBOEM7QUFBQ3RCLEVBQUFBLG1CQUFEO0FBQXNCd0IsRUFBQUEsSUFBSSxFQUFFLGdCQUE1QjtBQUE4Q0MsRUFBQUEsSUFBSSxFQUFFO0FBQUNXLElBQUFBLEdBQUcsRUFBRTBCLE9BQU8sQ0FBQzFCO0FBQWQ7QUFBcEQsQ0FBOUMiLCJzb3VyY2VzQ29udGVudCI6WyJjb25zdCBxcyA9IHJlcXVpcmUoJ3F1ZXJ5c3RyaW5nJyk7XG5cbmNvbnN0IHtyZW1vdGUsIGlwY1JlbmRlcmVyOiBpcGN9ID0gcmVxdWlyZSgnZWxlY3Ryb24nKTtcbmNvbnN0IHtHaXRQcm9jZXNzfSA9IHJlcXVpcmUoJ2R1Z2l0ZScpO1xuXG5cbmNsYXNzIEF2ZXJhZ2VUcmFja2VyIHtcbiAgY29uc3RydWN0b3Ioe2xpbWl0fSA9IHtsaW1pdDogMTB9KSB7XG4gICAgLy8gZm9yIG5vdyB0aGlzIHNlcnZlcyBhIGR1YWwgcHVycG9zZSAtICMgb2YgdmFsdWVzIHRyYWNrZWQgQU5EICMgZGlzY2FyZGVkIHByaW9yIHRvIHN0YXJ0aW5nIGF2ZyBjYWxjdWxhdGlvblxuICAgIHRoaXMubGltaXQgPSBsaW1pdDtcbiAgICB0aGlzLnN1bSA9IDA7XG4gICAgdGhpcy52YWx1ZXMgPSBbXTtcbiAgfVxuXG4gIGFkZFZhbHVlKHZhbHVlKSB7XG4gICAgaWYgKHRoaXMudmFsdWVzLmxlbmd0aCA+PSB0aGlzLmxpbWl0KSB7XG4gICAgICBjb25zdCBkaXNjYXJkZWRWYWx1ZSA9IHRoaXMudmFsdWVzLnNoaWZ0KCk7XG4gICAgICB0aGlzLnN1bSAtPSBkaXNjYXJkZWRWYWx1ZTtcbiAgICB9XG4gICAgdGhpcy52YWx1ZXMucHVzaCh2YWx1ZSk7XG4gICAgdGhpcy5zdW0gKz0gdmFsdWU7XG4gIH1cblxuICBnZXRBdmVyYWdlKCkge1xuICAgIGlmICh0aGlzLmVub3VnaERhdGEoKSkge1xuICAgICAgcmV0dXJuIHRoaXMuc3VtIC8gdGhpcy5saW1pdDtcbiAgICB9IGVsc2Uge1xuICAgICAgcmV0dXJuIG51bGw7XG4gICAgfVxuICB9XG5cbiAgZ2V0TGltaXQoKSB7XG4gICAgcmV0dXJuIHRoaXMubGltaXQ7XG4gIH1cblxuICBlbm91Z2hEYXRhKCkge1xuICAgIHJldHVybiB0aGlzLnZhbHVlcy5sZW5ndGggPT09IHRoaXMubGltaXQ7XG4gIH1cbn1cblxuY29uc3QgcXVlcnkgPSBxcy5wYXJzZSh3aW5kb3cubG9jYXRpb24uc2VhcmNoLnN1YnN0cigxKSk7XG5jb25zdCBzb3VyY2VXZWJDb250ZW50c0lkID0gcmVtb3RlLmdldEN1cnJlbnRXaW5kb3coKS53ZWJDb250ZW50cy5pZDtcbmNvbnN0IG9wZXJhdGlvbkNvdW50TGltaXQgPSBwYXJzZUludChxdWVyeS5vcGVyYXRpb25Db3VudExpbWl0LCAxMCk7XG5jb25zdCBhdmVyYWdlVHJhY2tlciA9IG5ldyBBdmVyYWdlVHJhY2tlcih7bGltaXQ6IG9wZXJhdGlvbkNvdW50TGltaXR9KTtcbmNvbnN0IGNoaWxkUGlkc0J5SWQgPSBuZXcgTWFwKCk7XG5cbmNvbnN0IGRlc3Ryb3lSZW5kZXJlciA9ICgpID0+IHtcbiAgaWYgKCFtYW5hZ2VyV2ViQ29udGVudHMuaXNEZXN0cm95ZWQoKSkge1xuICAgIG1hbmFnZXJXZWJDb250ZW50cy5yZW1vdmVMaXN0ZW5lcignY3Jhc2hlZCcsIGRlc3Ryb3lSZW5kZXJlcik7XG4gICAgbWFuYWdlcldlYkNvbnRlbnRzLnJlbW92ZUxpc3RlbmVyKCdkZXN0cm95ZWQnLCBkZXN0cm95UmVuZGVyZXIpO1xuICB9XG4gIGNvbnN0IHdpbiA9IHJlbW90ZS5Ccm93c2VyV2luZG93LmZyb21XZWJDb250ZW50cyhyZW1vdGUuZ2V0Q3VycmVudFdlYkNvbnRlbnRzKCkpO1xuICBpZiAod2luICYmICF3aW4uaXNEZXN0cm95ZWQoKSkge1xuICAgIHdpbi5kZXN0cm95KCk7XG4gIH1cbn07XG5jb25zdCBtYW5hZ2VyV2ViQ29udGVudHNJZCA9IHBhcnNlSW50KHF1ZXJ5Lm1hbmFnZXJXZWJDb250ZW50c0lkLCAxMCk7XG5jb25zdCBtYW5hZ2VyV2ViQ29udGVudHMgPSByZW1vdGUud2ViQ29udGVudHMuZnJvbUlkKG1hbmFnZXJXZWJDb250ZW50c0lkKTtcbmlmIChtYW5hZ2VyV2ViQ29udGVudHMgJiYgIW1hbmFnZXJXZWJDb250ZW50cy5pc0Rlc3Ryb3llZCgpKSB7XG4gIG1hbmFnZXJXZWJDb250ZW50cy5vbignY3Jhc2hlZCcsIGRlc3Ryb3lSZW5kZXJlcik7XG4gIG1hbmFnZXJXZWJDb250ZW50cy5vbignZGVzdHJveWVkJywgZGVzdHJveVJlbmRlcmVyKTtcbiAgd2luZG93Lm9uYmVmb3JldW5sb2FkID0gKCkgPT4ge1xuICAgIG1hbmFnZXJXZWJDb250ZW50cy5yZW1vdmVMaXN0ZW5lcignY3Jhc2hlZCcsIGRlc3Ryb3lSZW5kZXJlcik7XG4gICAgbWFuYWdlcldlYkNvbnRlbnRzLnJlbW92ZUxpc3RlbmVyKCdkZXN0cm95ZWQnLCBkZXN0cm95UmVuZGVyZXIpO1xuICB9O1xufVxuXG5jb25zdCBjaGFubmVsTmFtZSA9IHF1ZXJ5LmNoYW5uZWxOYW1lO1xuaXBjLm9uKGNoYW5uZWxOYW1lLCAoZXZlbnQsIHt0eXBlLCBkYXRhfSkgPT4ge1xuICBpZiAodHlwZSA9PT0gJ2dpdC1leGVjJykge1xuICAgIGNvbnN0IHthcmdzLCB3b3JraW5nRGlyLCBvcHRpb25zLCBpZH0gPSBkYXRhO1xuICAgIGlmIChhcmdzKSB7XG4gICAgICBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgnY29tbWFuZCcpLnRleHRDb250ZW50ID0gYGdpdCAke2FyZ3Muam9pbignICcpfWA7XG4gICAgfVxuXG4gICAgb3B0aW9ucy5wcm9jZXNzQ2FsbGJhY2sgPSBjaGlsZCA9PiB7XG4gICAgICBjaGlsZFBpZHNCeUlkLnNldChpZCwgY2hpbGQucGlkKTtcblxuICAgICAgY2hpbGQub24oJ2Vycm9yJywgZXJyID0+IHtcbiAgICAgICAgZXZlbnQuc2VuZGVyLnNlbmRUbyhtYW5hZ2VyV2ViQ29udGVudHNJZCwgY2hhbm5lbE5hbWUsIHtcbiAgICAgICAgICBzb3VyY2VXZWJDb250ZW50c0lkLFxuICAgICAgICAgIHR5cGU6ICdnaXQtc3Bhd24tZXJyb3InLFxuICAgICAgICAgIGRhdGE6IHtpZCwgZXJyfSxcbiAgICAgICAgfSk7XG4gICAgICB9KTtcblxuICAgICAgY2hpbGQuc3RkaW4ub24oJ2Vycm9yJywgZXJyID0+IHtcbiAgICAgICAgZXZlbnQuc2VuZGVyLnNlbmRUbyhtYW5hZ2VyV2ViQ29udGVudHNJZCwgY2hhbm5lbE5hbWUsIHtcbiAgICAgICAgICBzb3VyY2VXZWJDb250ZW50c0lkLFxuICAgICAgICAgIHR5cGU6ICdnaXQtc3RkaW4tZXJyb3InLFxuICAgICAgICAgIGRhdGE6IHtpZCwgc3RkaW46IG9wdGlvbnMuc3RkaW4sIGVycn0sXG4gICAgICAgIH0pO1xuICAgICAgfSk7XG4gICAgfTtcblxuICAgIGNvbnN0IHNwYXduU3RhcnQgPSBwZXJmb3JtYW5jZS5ub3coKTtcbiAgICBHaXRQcm9jZXNzLmV4ZWMoYXJncywgd29ya2luZ0Rpciwgb3B0aW9ucylcbiAgICAgIC50aGVuKCh7c3Rkb3V0LCBzdGRlcnIsIGV4aXRDb2RlfSkgPT4ge1xuICAgICAgICBjb25zdCB0aW1pbmcgPSB7XG4gICAgICAgICAgc3Bhd25UaW1lOiBzcGF3bkVuZCAtIHNwYXduU3RhcnQsXG4gICAgICAgICAgZXhlY1RpbWU6IHBlcmZvcm1hbmNlLm5vdygpIC0gc3Bhd25FbmQsXG4gICAgICAgIH07XG4gICAgICAgIGNoaWxkUGlkc0J5SWQuZGVsZXRlKGlkKTtcbiAgICAgICAgZXZlbnQuc2VuZGVyLnNlbmRUbyhtYW5hZ2VyV2ViQ29udGVudHNJZCwgY2hhbm5lbE5hbWUsIHtcbiAgICAgICAgICBzb3VyY2VXZWJDb250ZW50c0lkLFxuICAgICAgICAgIHR5cGU6ICdnaXQtZGF0YScsXG4gICAgICAgICAgZGF0YToge1xuICAgICAgICAgICAgaWQsXG4gICAgICAgICAgICBhdmVyYWdlOiBhdmVyYWdlVHJhY2tlci5nZXRBdmVyYWdlKCksXG4gICAgICAgICAgICByZXN1bHRzOiB7c3Rkb3V0LCBzdGRlcnIsIGV4aXRDb2RlLCB0aW1pbmd9LFxuICAgICAgICAgIH0sXG4gICAgICAgIH0pO1xuICAgICAgfSwgZXJyID0+IHtcbiAgICAgICAgY29uc3QgdGltaW5nID0ge1xuICAgICAgICAgIHNwYXduVGltZTogc3Bhd25FbmQgLSBzcGF3blN0YXJ0LFxuICAgICAgICAgIGV4ZWNUaW1lOiBwZXJmb3JtYW5jZS5ub3coKSAtIHNwYXduRW5kLFxuICAgICAgICB9O1xuICAgICAgICBjaGlsZFBpZHNCeUlkLmRlbGV0ZShpZCk7XG4gICAgICAgIGV2ZW50LnNlbmRlci5zZW5kVG8obWFuYWdlcldlYkNvbnRlbnRzSWQsIGNoYW5uZWxOYW1lLCB7XG4gICAgICAgICAgc291cmNlV2ViQ29udGVudHNJZCxcbiAgICAgICAgICB0eXBlOiAnZ2l0LWRhdGEnLFxuICAgICAgICAgIGRhdGE6IHtcbiAgICAgICAgICAgIGlkLFxuICAgICAgICAgICAgYXZlcmFnZTogYXZlcmFnZVRyYWNrZXIuZ2V0QXZlcmFnZSgpLFxuICAgICAgICAgICAgcmVzdWx0czoge1xuICAgICAgICAgICAgICBzdGRvdXQ6IGVyci5zdGRvdXQsXG4gICAgICAgICAgICAgIHN0ZGVycjogZXJyLnN0ZGVycixcbiAgICAgICAgICAgICAgZXhpdENvZGU6IGVyci5jb2RlLFxuICAgICAgICAgICAgICBzaWduYWw6IGVyci5zaWduYWwsXG4gICAgICAgICAgICAgIHRpbWluZyxcbiAgICAgICAgICAgIH0sXG4gICAgICAgICAgfSxcbiAgICAgICAgfSk7XG4gICAgICB9KTtcbiAgICBjb25zdCBzcGF3bkVuZCA9IHBlcmZvcm1hbmNlLm5vdygpO1xuICAgIGF2ZXJhZ2VUcmFja2VyLmFkZFZhbHVlKHNwYXduRW5kIC0gc3Bhd25TdGFydCk7XG5cbiAgICAvLyBUT0RPOiBjb25zaWRlciB1c2luZyB0aGlzIHRvIGF2b2lkIGR1cGxpY2F0ZSB3cml0ZSBvcGVyYXRpb25zIHVwb24gY3Jhc2hpbmcuXG4gICAgLy8gRm9yIG5vdyB3ZSB3b24ndCBkbyB0aGlzIHRvIGF2b2lkIGNsb2dnaW5nIHVwIGlwYyBjaGFubmVsXG4gICAgLy8gZXZlbnQuc2VuZGVyLnNlbmRUbyhtYW5hZ2VyV2ViQ29udGVudHNJZCwgY2hhbm5lbE5hbWUsIHtzb3VyY2VXZWJDb250ZW50c0lkLCB0eXBlOiAnZXhlYy1zdGFydGVkJywgZGF0YToge2lkfX0pO1xuXG4gICAgaWYgKGF2ZXJhZ2VUcmFja2VyLmVub3VnaERhdGEoKSAmJiBhdmVyYWdlVHJhY2tlci5nZXRBdmVyYWdlKCkgPiAyMCkge1xuICAgICAgZXZlbnQuc2VuZGVyLnNlbmRUbyhtYW5hZ2VyV2ViQ29udGVudHNJZCwgY2hhbm5lbE5hbWUsIHt0eXBlOiAnc2xvdy1zcGF3bnMnfSk7XG4gICAgfVxuICB9IGVsc2UgaWYgKHR5cGUgPT09ICdnaXQtY2FuY2VsJykge1xuICAgIGNvbnN0IHtpZH0gPSBkYXRhO1xuICAgIGNvbnN0IGNoaWxkUGlkID0gY2hpbGRQaWRzQnlJZC5nZXQoaWQpO1xuICAgIGlmIChjaGlsZFBpZCAhPT0gdW5kZWZpbmVkKSB7XG4gICAgICByZXF1aXJlKCd0cmVlLWtpbGwnKShjaGlsZFBpZCwgJ1NJR0lOVCcsICgpID0+IHtcbiAgICAgICAgZXZlbnQuc2VuZGVyLnNlbmRUbyhtYW5hZ2VyV2ViQ29udGVudHNJZCwgY2hhbm5lbE5hbWUsIHtcbiAgICAgICAgICBzb3VyY2VXZWJDb250ZW50c0lkLFxuICAgICAgICAgIHR5cGU6ICdnaXQtY2FuY2VsbGVkJyxcbiAgICAgICAgICBkYXRhOiB7aWQsIGNoaWxkUGlkfSxcbiAgICAgICAgfSk7XG4gICAgICB9KTtcbiAgICAgIGNoaWxkUGlkc0J5SWQuZGVsZXRlKGlkKTtcbiAgICB9XG4gIH0gZWxzZSB7XG4gICAgdGhyb3cgbmV3IEVycm9yKGBDb3VsZCBub3QgaWRlbnRpZnkgdHlwZSAke3R5cGV9YCk7XG4gIH1cbn0pO1xuXG5pcGMuc2VuZFRvKG1hbmFnZXJXZWJDb250ZW50c0lkLCBjaGFubmVsTmFtZSwge3NvdXJjZVdlYkNvbnRlbnRzSWQsIHR5cGU6ICdyZW5kZXJlci1yZWFkeScsIGRhdGE6IHtwaWQ6IHByb2Nlc3MucGlkfX0pO1xuIl19