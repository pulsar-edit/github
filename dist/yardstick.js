"use strict";

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.default = void 0;

var _fsExtra = _interopRequireDefault(require("fs-extra"));

var _path = _interopRequireDefault(require("path"));

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }

// Measure elapsed durations from specific beginning points.
// The maximum number of marks within a single DurationSet. A DurationSet will be automatically finished if this many
// marks are recorded.
const MAXIMUM_MARKS = 100; // Flush all non-active DurationSets to disk each time that this many marks have been accumulated.

const PERSIST_INTERVAL = 1000; // A sequence of durations measured from a fixed beginning point.

class DurationSet {
  constructor(name) {
    this.name = name;
    this.startTimestamp = performance.now();
    this.marks = [];
    this.markCount = 0;

    if (atom.config.get('github.performanceToConsole')) {
      // eslint-disable-next-line no-console
      console.log('%cbegin %c%s:begin', 'font-weight: bold', 'font-weight: normal; font-style: italic; color: blue', this.name);
    }

    if (atom.config.get('github.performanceToProfile')) {
      // eslint-disable-next-line no-console
      console.profile(this.name);
    }
  }

  mark(eventName) {
    const duration = performance.now() - this.startTimestamp;

    if (atom.config.get('github.performanceToConsole')) {
      // eslint-disable-next-line no-console
      console.log('%cmark %c%s:%s %c%dms', 'font-weight: bold', 'font-weight: normal; font-style: italic; color: blue', this.name, eventName, 'font-style: normal; color: black', duration);
    }

    if (atom.config.get('github.performanceToDirectory') !== '') {
      this.marks.push({
        eventName,
        duration
      });
    }

    this.markCount++;

    if (this.markCount >= MAXIMUM_MARKS) {
      this.finish();
    }
  }

  finish() {
    this.mark('finish');

    if (atom.config.get('github.performanceToProfile')) {
      // eslint-disable-next-line no-console
      console.profileEnd(this.name);
    }
  }

  serialize() {
    return {
      name: this.name,
      markers: this.marks
    };
  }

  getCount() {
    return this.marks.length;
  }

}

let durationSets = [];
let totalMarkCount = 0;
const activeSets = new Map();

function shouldCapture(seriesName, eventName) {
  const anyActive = ['Console', 'Directory', 'Profile'].some(kind => {
    const value = atom.config.get(`github.performanceTo${kind}`);
    return value !== '' && value !== false;
  });

  if (!anyActive) {
    return false;
  }

  const mask = new RegExp(atom.config.get('github.performanceMask'));

  if (!mask.test(`${seriesName}:${eventName}`)) {
    return false;
  }

  return true;
}

const yardstick = {
  async save() {
    const destDir = atom.config.get('github.performanceToDirectory');

    if (destDir === '' || destDir === undefined || destDir === null) {
      return;
    }

    const fileName = _path.default.join(destDir, `performance-${Date.now()}.json`);

    await new Promise((resolve, reject) => {
      _fsExtra.default.ensureDir(destDir, err => err ? reject(err) : resolve());
    });
    const payload = JSON.stringify(durationSets.map(set => set.serialize()));
    await _fsExtra.default.writeFile(fileName, payload, {
      encoding: 'utf8'
    });

    if (atom.config.get('github.performanceToConsole')) {
      // eslint-disable-next-line no-console
      console.log('%csaved %c%d series to %s', 'font-weight: bold', 'font-weight: normal; color: black', durationSets.length, fileName);
    }

    durationSets = [];
  },

  begin(seriesName) {
    if (!shouldCapture(seriesName, 'begin')) {
      return;
    }

    const ds = new DurationSet(seriesName);
    activeSets.set(seriesName, ds);
  },

  mark(seriesName, eventName) {
    if (seriesName instanceof Array) {
      for (let i = 0; i < seriesName.length; i++) {
        this.mark(seriesName[i], eventName);
      }

      return;
    }

    if (!shouldCapture(seriesName, eventName)) {
      return;
    }

    const ds = activeSets.get(seriesName);

    if (ds === undefined) {
      return;
    }

    ds.mark(eventName);
  },

  finish(seriesName) {
    if (seriesName instanceof Array) {
      for (let i = 0; i < seriesName.length; i++) {
        this.finish(seriesName[i]);
      }

      return;
    }

    if (!shouldCapture(seriesName, 'finish')) {
      return;
    }

    const ds = activeSets.get(seriesName);

    if (ds === undefined) {
      return;
    }

    ds.finish();
    durationSets.push(ds);
    activeSets.delete(seriesName);
    totalMarkCount += ds.getCount();

    if (totalMarkCount >= PERSIST_INTERVAL) {
      totalMarkCount = 0;
      this.save();
    }
  },

  async flush() {
    durationSets.push(...activeSets.values());
    activeSets.clear();
    await this.save();
  }

};
var _default = yardstick;
exports.default = _default;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uL2xpYi95YXJkc3RpY2suanMiXSwibmFtZXMiOlsiTUFYSU1VTV9NQVJLUyIsIlBFUlNJU1RfSU5URVJWQUwiLCJEdXJhdGlvblNldCIsImNvbnN0cnVjdG9yIiwibmFtZSIsInN0YXJ0VGltZXN0YW1wIiwicGVyZm9ybWFuY2UiLCJub3ciLCJtYXJrcyIsIm1hcmtDb3VudCIsImF0b20iLCJjb25maWciLCJnZXQiLCJjb25zb2xlIiwibG9nIiwicHJvZmlsZSIsIm1hcmsiLCJldmVudE5hbWUiLCJkdXJhdGlvbiIsInB1c2giLCJmaW5pc2giLCJwcm9maWxlRW5kIiwic2VyaWFsaXplIiwibWFya2VycyIsImdldENvdW50IiwibGVuZ3RoIiwiZHVyYXRpb25TZXRzIiwidG90YWxNYXJrQ291bnQiLCJhY3RpdmVTZXRzIiwiTWFwIiwic2hvdWxkQ2FwdHVyZSIsInNlcmllc05hbWUiLCJhbnlBY3RpdmUiLCJzb21lIiwia2luZCIsInZhbHVlIiwibWFzayIsIlJlZ0V4cCIsInRlc3QiLCJ5YXJkc3RpY2siLCJzYXZlIiwiZGVzdERpciIsInVuZGVmaW5lZCIsImZpbGVOYW1lIiwicGF0aCIsImpvaW4iLCJEYXRlIiwiUHJvbWlzZSIsInJlc29sdmUiLCJyZWplY3QiLCJmcyIsImVuc3VyZURpciIsImVyciIsInBheWxvYWQiLCJKU09OIiwic3RyaW5naWZ5IiwibWFwIiwic2V0Iiwid3JpdGVGaWxlIiwiZW5jb2RpbmciLCJiZWdpbiIsImRzIiwiQXJyYXkiLCJpIiwiZGVsZXRlIiwiZmx1c2giLCJ2YWx1ZXMiLCJjbGVhciJdLCJtYXBwaW5ncyI6Ijs7Ozs7OztBQUVBOztBQUNBOzs7O0FBSEE7QUFLQTtBQUNBO0FBQ0EsTUFBTUEsYUFBYSxHQUFHLEdBQXRCLEMsQ0FFQTs7QUFDQSxNQUFNQyxnQkFBZ0IsR0FBRyxJQUF6QixDLENBRUE7O0FBQ0EsTUFBTUMsV0FBTixDQUFrQjtBQUNoQkMsRUFBQUEsV0FBVyxDQUFDQyxJQUFELEVBQU87QUFDaEIs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LEVBQWdCQSxDQUFDLEdBQUdoQyxVQUFVLENBQUNOLE1BQS9CLEVBQXVDc0MsQ0FBQyxFQUF4QyxFQUE0QztBQUMxQyxhQUFLM0MsTUFBTCxDQUFZVyxVQUFVLENBQUNnQyxDQUFELENBQXRCO0FBQ0Q7O0FBQ0Q7QUFDRDs7QUFFRCxRQUFJLENBQUNqQyxhQUFhLENBQUNDLFVBQUQsRUFBYSxRQUFiLENBQWxCLEVBQTBDO0FBQ3hDO0FBQ0Q7O0FBRUQsVUFBTThCLEVBQUUsR0FBR2pDLFVBQVUsQ0FBQ2hCLEdBQVgsQ0FBZW1CLFVBQWYsQ0FBWDs7QUFDQSxRQUFJOEIsRUFBRSxLQUFLbkIsU0FBWCxFQUFzQjtBQUNwQjtBQUNEOztBQUNEbUIsSUFBQUEsRUFBRSxDQUFDekMsTUFBSDtBQUVBTSxJQUFBQSxZQUFZLENBQUNQLElBQWIsQ0FBa0IwQyxFQUFsQjtBQUNBakMsSUFBQUEsVUFBVSxDQUFDb0MsTUFBWCxDQUFrQmpDLFVBQWxCO0FBRUFKLElBQUFBLGNBQWMsSUFBSWtDLEVBQUUsQ0FBQ3JDLFFBQUgsRUFBbEI7O0FBQ0EsUUFBSUcsY0FBYyxJQUFJMUIsZ0JBQXRCLEVBQXdDO0FBQ3RDMEIsTUFBQUEsY0FBYyxHQUFHLENBQWpCO0FBQ0EsV0FBS2EsSUFBTDtBQUNEO0FBQ0YsR0EvRWU7O0FBaUZoQixRQUFNeUIsS0FBTixHQUFjO0FBQ1p2QyxJQUFBQSxZQUFZLENBQUNQLElBQWIsQ0FBa0IsR0FBR1MsVUFBVSxDQUFDc0MsTUFBWCxFQUFyQjtBQUNBdEMsSUFBQUEsVUFBVSxDQUFDdUMsS0FBWDtBQUNBLFVBQU0sS0FBSzNCLElBQUwsRUFBTjtBQUNEOztBQXJGZSxDQUFsQjtlQXdGZUQsUyIsInNvdXJjZXNDb250ZW50IjpbIi8vIE1lYXN1cmUgZWxhcHNlZCBkdXJhdGlvbnMgZnJvbSBzcGVjaWZpYyBiZWdpbm5pbmcgcG9pbnRzLlxuXG5pbXBvcnQgZnMgZnJvbSAnZnMtZXh0cmEnO1xuaW1wb3J0IHBhdGggZnJvbSAncGF0aCc7XG5cbi8vIFRoZSBtYXhpbXVtIG51bWJlciBvZiBtYXJrcyB3aXRoaW4gYSBzaW5nbGUgRHVyYXRpb25TZXQuIEEgRHVyYXRpb25TZXQgd2lsbCBiZSBhdXRvbWF0aWNhbGx5IGZpbmlzaGVkIGlmIHRoaXMgbWFueVxuLy8gbWFya3MgYXJlIHJlY29yZGVkLlxuY29uc3QgTUFYSU1VTV9NQVJLUyA9IDEwMDtcblxuLy8gRmx1c2ggYWxsIG5vbi1hY3RpdmUgRHVyYXRpb25TZXRzIHRvIGRpc2sgZWFjaCB0aW1lIHRoYXQgdGhpcyBtYW55IG1hcmtzIGhhdmUgYmVlbiBhY2N1bXVsYXRlZC5cbmNvbnN0IFBFUlNJU1RfSU5URVJWQUwgPSAxMDAwO1xuXG4vLyBBIHNlcXVlbmNlIG9mIGR1cmF0aW9ucyBtZWFzdXJlZCBmcm9tIGEgZml4ZWQgYmVnaW5uaW5nIHBvaW50LlxuY2xhc3MgRHVyYXRpb25TZXQge1xuICBjb25zdHJ1Y3RvcihuYW1lKSB7XG4gICAgdGhpcy5uYW1lID0gbmFtZTtcbiAgICB0aGlzLnN0YXJ0VGltZXN0YW1wID0gcGVyZm9ybWFuY2Uubm93KCk7XG4gICAgdGhpcy5tYXJrcyA9IFtdO1xuICAgIHRoaXMubWFya0NvdW50ID0gMDtcblxuICAgIGlmIChhdG9tLmNvbmZpZy5nZXQoJ2dpdGh1Yi5wZXJmb3JtYW5jZVRvQ29uc29sZScpKSB7XG4gICAgICAvLyBlc2xpbnQtZGlzYWJsZS1uZXh0LWxpbmUgbm8tY29uc29sZVxuICAgICAgY29uc29sZS5sb2coJyVjYmVnaW4gJWMlczpiZWdpbicsXG4gICAgICAgICdmb250LXdlaWdodDogYm9sZCcsXG4gICAgICAgICdmb250LXdlaWdodDogbm9ybWFsOyBmb250LXN0eWxlOiBpdGFsaWM7IGNvbG9yOiBibHVlJywgdGhpcy5uYW1lKTtcbiAgICB9XG5cbiAgICBpZiAoYXRvbS5jb25maWcuZ2V0KCdnaXRodWIucGVyZm9ybWFuY2VUb1Byb2ZpbGUnKSkge1xuICAgICAgLy8gZXNsaW50LWRpc2FibGUtbmV4dC1saW5lIG5vLWNvbnNvbGVcbiAgICAgIGNvbnNvbGUucHJvZmlsZSh0aGlzLm5hbWUpO1xuICAgIH1cbiAgfVxuXG4gIG1hcmsoZXZlbnROYW1lKSB7XG4gICAgY29uc3QgZHVyYXRpb24gPSBwZXJmb3JtYW5jZS5ub3coKSAtIHRoaXMuc3RhcnRUaW1lc3RhbXA7XG5cbiAgICBpZiAoYXRvbS5jb25maWcuZ2V0KCdnaXRodWIucGVyZm9ybWFuY2VUb0NvbnNvbGUnKSkge1xuICAgICAgLy8gZXNsaW50LWRpc2FibGUtbmV4dC1saW5lIG5vLWNvbnNvbGVcbiAgICAgIGNvbnNvbGUubG9nKCclY21hcmsgJWMlczolcyAlYyVkbXMnLFxuICAgICAgICAnZm9udC13ZWlnaHQ6IGJvbGQnLFxuICAgICAgICAnZm9udC13ZWlnaHQ6IG5vcm1hbDsgZm9udC1zdHlsZTogaXRhbGljOyBjb2xvcjogYmx1ZScsIHRoaXMubmFtZSwgZXZlbnROYW1lLFxuICAgICAgICAnZm9udC1zdHlsZTogbm9ybWFsOyBjb2xvcjogYmxhY2snLCBkdXJhdGlvbik7XG4gICAgfVxuXG4gICAgaWYgKGF0b20uY29uZmlnLmdldCgnZ2l0aHViLnBlcmZvcm1hbmNlVG9EaXJlY3RvcnknKSAhPT0gJycpIHtcbiAgICAgIHRoaXMubWFya3MucHVzaCh7ZXZlbnROYW1lLCBkdXJhdGlvbn0pO1xuICAgIH1cblxuICAgIHRoaXMubWFya0NvdW50Kys7XG4gICAgaWYgKHRoaXMubWFya0NvdW50ID49IE1BWElNVU1fTUFSS1MpIHtcbiAgICAgIHRoaXMuZmluaXNoKCk7XG4gICAgfVxuICB9XG5cbiAgZmluaXNoKCkge1xuICAgIHRoaXMubWFyaygnZmluaXNoJyk7XG5cbiAgICBpZiAoYXRvbS5jb25maWcuZ2V0KCdnaXRodWIucGVyZm9ybWFuY2VUb1Byb2ZpbGUnKSkge1xuICAgICAgLy8gZXNsaW50LWRpc2FibGUtbmV4dC1saW5lIG5vLWNvbnNvbGVcbiAgICAgIGNvbnNvbGUucHJvZmlsZUVuZCh0aGlzLm5hbWUpO1xuICAgIH1cbiAgfVxuXG4gIHNlcmlhbGl6ZSgpIHtcbiAgICByZXR1cm4ge1xuICAgICAgbmFtZTogdGhpcy5uYW1lLFxuICAgICAgbWFya2VyczogdGhpcy5tYXJrcyxcbiAgICB9O1xuICB9XG5cbiAgZ2V0Q291bnQoKSB7XG4gICAgcmV0dXJuIHRoaXMubWFya3MubGVuZ3RoO1xuICB9XG59XG5cbmxldCBkdXJhdGlvblNldHMgPSBbXTtcbmxldCB0b3RhbE1hcmtDb3VudCA9IDA7XG5jb25zdCBhY3RpdmVTZXRzID0gbmV3IE1hcCgpO1xuXG5mdW5jdGlvbiBzaG91bGRDYXB0dXJlKHNlcmllc05hbWUsIGV2ZW50TmFtZSkge1xuICBjb25zdCBhbnlBY3RpdmUgPSBbJ0NvbnNvbGUnLCAnRGlyZWN0b3J5JywgJ1Byb2ZpbGUnXS5zb21lKGtpbmQgPT4ge1xuICAgIGNvbnN0IHZhbHVlID0gYXRvbS5jb25maWcuZ2V0KGBnaXRodWIucGVyZm9ybWFuY2VUbyR7a2luZH1gKTtcbiAgICByZXR1cm4gdmFsdWUgIT09ICcnICYmIHZhbHVlICE9PSBmYWxzZTtcbiAgfSk7XG4gIGlmICghYW55QWN0aXZlKSB7XG4gICAgcmV0dXJuIGZhbHNlO1xuICB9XG5cbiAgY29uc3QgbWFzayA9IG5ldyBSZWdFeHAoYXRvbS5jb25maWcuZ2V0KCdnaXRodWIucGVyZm9ybWFuY2VNYXNrJykpO1xuICBpZiAoIW1hc2sudGVzdChgJHtzZXJpZXNOYW1lfToke2V2ZW50TmFtZX1gKSkge1xuICAgIHJldHVybiBmYWxzZTtcbiAgfVxuXG4gIHJldHVybiB0cnVlO1xufVxuXG5jb25zdCB5YXJkc3RpY2sgPSB7XG4gIGFzeW5jIHNhdmUoKSB7XG4gICAgY29uc3QgZGVzdERpciA9IGF0b20uY29uZmlnLmdldCgnZ2l0aHViLnBlcmZvcm1hbmNlVG9EaXJlY3RvcnknKTtcbiAgICBpZiAoZGVzdERpciA9PT0gJycgfHwgZGVzdERpciA9PT0gdW5kZWZpbmVkIHx8IGRlc3REaXIgPT09IG51bGwpIHtcbiAgICAgIHJldHVybjtcbiAgICB9XG4gICAgY29uc3QgZmlsZU5hbWUgPSBwYXRoLmpvaW4oZGVzdERpciwgYHBlcmZvcm1hbmNlLSR7RGF0ZS5ub3coKX0uanNvbmApO1xuXG4gICAgYXdhaXQgbmV3IFByb21pc2UoKHJlc29sdmUsIHJlamVjdCkgPT4ge1xuICAgICAgZnMuZW5zdXJlRGlyKGRlc3REaXIsIGVyciA9PiAoZXJyID8gcmVqZWN0KGVycikgOiByZXNvbHZlKCkpKTtcbiAgICB9KTtcblxuICAgIGNvbnN0IHBheWxvYWQgPSBKU09OLnN0cmluZ2lmeShkdXJhdGlvblNldHMubWFwKHNldCA9PiBzZXQuc2VyaWFsaXplKCkpKTtcbiAgICBhd2FpdCBmcy53cml0ZUZpbGUoZmlsZU5hbWUsIHBheWxvYWQsIHtlbmNvZGluZzogJ3V0ZjgnfSk7XG5cbiAgICBpZiAoYXRvbS5jb25maWcuZ2V0KCdnaXRodWIucGVyZm9ybWFuY2VUb0NvbnNvbGUnKSkge1xuICAgICAgLy8gZXNsaW50LWRpc2FibGUtbmV4dC1saW5lIG5vLWNvbnNvbGVcbiAgICAgIGNvbnNvbGUubG9nKCclY3NhdmVkICVjJWQgc2VyaWVzIHRvICVzJyxcbiAgICAgICAgJ2ZvbnQtd2VpZ2h0OiBib2xkJyxcbiAgICAgICAgJ2ZvbnQtd2VpZ2h0OiBub3JtYWw7IGNvbG9yOiBibGFjaycsIGR1cmF0aW9uU2V0cy5sZW5ndGgsIGZpbGVOYW1lKTtcbiAgICB9XG5cbiAgICBkdXJhdGlvblNldHMgPSBbXTtcbiAgfSxcblxuICBiZWdpbihzZXJpZXNOYW1lKSB7XG4gICAgaWYgKCFzaG91bGRDYXB0dXJlKHNlcmllc05hbWUsICdiZWdpbicpKSB7XG4gICAgICByZXR1cm47XG4gICAgfVxuXG4gICAgY29uc3QgZHMgPSBuZXcgRHVyYXRpb25TZXQoc2VyaWVzTmFtZSk7XG4gICAgYWN0aXZlU2V0cy5zZXQoc2VyaWVzTmFtZSwgZHMpO1xuICB9LFxuXG4gIG1hcmsoc2VyaWVzTmFtZSwgZXZlbnROYW1lKSB7XG4gICAgaWYgKHNlcmllc05hbWUgaW5zdGFuY2VvZiBBcnJheSkge1xuICAgICAgZm9yIChsZXQgaSA9IDA7IGkgPCBzZXJpZXNOYW1lLmxlbmd0aDsgaSsrKSB7XG4gICAgICAgIHRoaXMubWFyayhzZXJpZXNOYW1lW2ldLCBldmVudE5hbWUpO1xuICAgICAgfVxuICAgICAgcmV0dXJuO1xuICAgIH1cblxuICAgIGlmICghc2hvdWxkQ2FwdHVyZShzZXJpZXNOYW1lLCBldmVudE5hbWUpKSB7XG4gICAgICByZXR1cm47XG4gICAgfVxuXG4gICAgY29uc3QgZHMgPSBhY3RpdmVTZXRzLmdldChzZXJpZXNOYW1lKTtcbiAgICBpZiAoZHMgPT09IHVuZGVmaW5lZCkge1xuICAgICAgcmV0dXJuO1xuICAgIH1cbiAgICBkcy5tYXJrKGV2ZW50TmFtZSk7XG4gIH0sXG5cbiAgZmluaXNoKHNlcmllc05hbWUpIHtcbiAgICBpZiAoc2VyaWVzTmFtZSBpbnN0YW5jZW9mIEFycmF5KSB7XG4gICAgICBmb3IgKGxldCBpID0gMDsgaSA8IHNlcmllc05hbWUubGVuZ3RoOyBpKyspIHtcbiAgICAgICAgdGhpcy5maW5pc2goc2VyaWVzTmFtZVtpXSk7XG4gICAgICB9XG4gICAgICByZXR1cm47XG4gICAgfVxuXG4gICAgaWYgKCFzaG91bGRDYXB0dXJlKHNlcmllc05hbWUsICdmaW5pc2gnKSkge1xuICAgICAgcmV0dXJuO1xuICAgIH1cblxuICAgIGNvbnN0IGRzID0gYWN0aXZlU2V0cy5nZXQoc2VyaWVzTmFtZSk7XG4gICAgaWYgKGRzID09PSB1bmRlZmluZWQpIHtcbiAgICAgIHJldHVybjtcbiAgICB9XG4gICAgZHMuZmluaXNoKCk7XG5cbiAgICBkdXJhdGlvblNldHMucHVzaChkcyk7XG4gICAgYWN0aXZlU2V0cy5kZWxldGUoc2VyaWVzTmFtZSk7XG5cbiAgICB0b3RhbE1hcmtDb3VudCArPSBkcy5nZXRDb3VudCgpO1xuICAgIGlmICh0b3RhbE1hcmtDb3VudCA+PSBQRVJTSVNUX0lOVEVSVkFMKSB7XG4gICAgICB0b3RhbE1hcmtDb3VudCA9IDA7XG4gICAgICB0aGlzLnNhdmUoKTtcbiAgICB9XG4gIH0sXG5cbiAgYXN5bmMgZmx1c2goKSB7XG4gICAgZHVyYXRpb25TZXRzLnB1c2goLi4uYWN0aXZlU2V0cy52YWx1ZXMoKSk7XG4gICAgYWN0aXZlU2V0cy5jbGVhcigpO1xuICAgIGF3YWl0IHRoaXMuc2F2ZSgpO1xuICB9LFxufTtcblxuZXhwb3J0IGRlZmF1bHQgeWFyZHN0aWNrO1xuIl19