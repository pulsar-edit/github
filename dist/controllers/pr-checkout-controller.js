"use strict";

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.default = exports.BarePullRequestCheckoutController = exports.checkoutStates = void 0;

var _react = _interopRequireDefault(require("react"));

var _propTypes = _interopRequireDefault(require("prop-types"));

var _reactRelay = require("react-relay");

var _enableableOperation = _interopRequireDefault(require("../models/enableable-operation"));

var _gitShellOutStrategy = require("../git-shell-out-strategy");

var _propTypes2 = require("../prop-types");

var _reporterProxy = require("../reporter-proxy");

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }

function _defineProperty(obj, key, value) { if (key in obj) { Object.defineProperty(obj, key, { value: value, enumerable: true, configurable: true, writable: true }); } else { obj[key] = value; } return obj; }

class CheckoutState {
  constructor(name) {
    this.name = name;
  }

  when(cases) {
    return cases[this.name] || cases.default;
  }

}

const checkoutStates = {
  HIDDEN: new CheckoutState('hidden'),
  DISABLED: new CheckoutState('disabled'),
  BUSY: new CheckoutState('busy'),
  CURRENT: new CheckoutState('current')
};
exports.checkoutStates = checkoutStates;

class BarePullRequestCheckoutController extends _react.default.Component {
  constructor(props) {
    super(props);
    this.state = {
      checkoutInProgress: false
    };
    this.checkoutOp = new _enableableOperation.default(() => this.checkout().catch(e => {
      if (!(e instanceof _gitShellOutStrategy.GitError)) {
        throw e;
      }
    }));
    this.checkoutOp.toggleState(this, 'checkoutInProgress');
  }

  render() {
    return this.props.children(this.nextCheckoutOp());
  }

  nextCheckoutOp() {
    const {
      repository,
      pullRequest
    } = this.props;

    if (this.props.isAbsent) {
      return this.checkoutOp.disable(checkoutStates.HIDDEN, 'No repository found');
    }

    if (this.props.isLoading) {
      return this.checkoutOp.disable(checkoutStates.DISABLED, 'Loading');
    }

    if (!this.props.isPresent) {
      return this.checkoutOp.disable(checkoutStates.DISABLED, 'No repository found');
    }

    if (this.props.isMerging) {
      return this.checkoutOp.disable(checkoutStates.DISABLED, 'Merge in progress');
    }

    if (this.props.isRebasing) {
      return this.checkoutOp.disable(checkoutStates.DISABLED, 'Rebase in progress');
    }

    if (this.state.checkoutInProgress) {
      return this.checkoutOp.disable(checkoutStates.DISABLED, 'Checking out...');
    } // determine if pullRequest.headRepository is null
    // this can happen if a repository has been deleted.


    if (!pullRequest.headRepository) {
      return this.checkoutOp.disable(checkoutStates.DISABLED, 'Pull request head repository does not exist');
    } // Determine if we already have this PR checked out.


    const headPush = this.props.branches.getHeadBranch().getPush();
    const headRemote = this.props.remotes.withName(headPush.getRemoteName()); // (detect checkout from pull/### refspec)

    const fromPullRefspec = headRemote.getOwner() === repository.owner.login && headRemote.getRepo() === repository.name && headPush.getShortRemoteRef() === `pull/${pullRequest.number}/head`; // (detect checkout from head repository)

    const fromHeadRepo = headRemote.getOwner() === pullRequest.headRepository.owner.login && headRemote.getRepo() === pullRequest.headRepository.name && headPush.getShortRemoteRef() === pullRequest.headRefName;

    if (fromPullRefspec || fromHeadRepo) {
      return this.checkoutOp.disable(checkoutStates.CURRENT, 'Current');
    }

    return this.checkoutOp.enable();
  }

  async checkout() {
    const {
      pullRequest
    } = this.props;
    const {
      headRepository
    } = pullRequest;
    const fullHeadRef = `refs/heads/${pullRequest.headRefName}`;
    let sourceRemoteName, localRefName; // Discover or create a remote pointing to the repo containing the pull request's head ref.
    // If the local repository already has the head repository specified as a remote, that remote will be used, so
    // that any related configuration is picked up for the fetch. Otherwise, the head repository fetch URL is used
    // directly.

    const headRemotes = this.props.remotes.matchingGitHubRepository(headRepository.owner.login, headRepository.name);

    if (headRemotes.length > 0) {
      sourceRemoteName = headRemotes[0].getName();
    } else {
      const url = {
        https: headRepository.url + '.git',
        ssh: headRepository.sshUrl
      }[this.props.remotes.mostUsedProtocol(['https', 'ssh'])]; // This will throw if a remote with this name already exists (and points somewhere else, or we would have found
      // it above). ¯\_(ツ)_/¯

      const remote = await this.props.localRepository.addRemote(headRepository.owner.login, url);
      sourceRemoteName = remote.getName();
    } // Identify an existing local ref that already corresponds to the pull request, if one exists. Otherwise, generate
    // a new local ref name.


    const pullTargets = this.props.branches.getPullTargets(sourceRemoteName, fullHeadRef);

    if (pullTargets.length > 0) {
      localRefName = pullTargets[0].getName(); // Check out the existing local ref.

      await this.props.localRepository.checkout(localRefName);

      try {
        await this.props.localRepository.pull(fullHeadRef, {
          remoteName: sourceRemoteName,
          ffOnly: true
        });
      } finally {
        (0, _reporterProxy.incrementCounter)('checkout-pr');
      }

      return;
    }

    await this.props.localRepository.fetch(fullHeadRef, {
      remoteName: sourceRemoteName
    }); // Check out the local ref and set it up to track the head ref.

    await this.props.localRepository.checkout(`pr-${pullRequest.number}/${headRepository.owner.login}/${pullRequest.headRefName}`, {
      createNew: true,
      track: true,
      startPoint: `refs/remotes/${sourceRemoteName}/${pullRequest.headRefName}`
    });
    (0, _reporterProxy.incrementCounter)('checkout-pr');
  }

}

exports.BarePullRequestCheckoutController = BarePullRequestCheckoutController;

_defineProperty(BarePullRequestCheckoutController, "propTypes", {
  // GraphQL response
  repository: _propTypes.default.shape({
    name: _propTypes.default.string.isRequired,
    owner: _propTypes.default.shape({
      login: _propTypes.default.string.isRequired
    }).isRequired
  }).isRequired,
  pullRequest: _propTypes.default.shape({
    number: _propTypes.default.number.isRequired,
    headRefName: _propTypes.default.string.isRequired,
    headRepository: _propTypes.default.shape({
      name: _propTypes.default.string.isRequired,
      url: _propTypes.default.string.isRequired,
      sshUrl: _propTypes.default.string.isRequired,
      owner: _propTypes.default.shape({
        login: _propTypes.default.string.isRequired
      })
    })
  }).isRequired,
  // Repository model and attributes
  localRepository: _propTypes.default.object.isRequired,
  isAbsent: _propTypes.default.bool.isRequired,
  isLoading: _propTypes.default.bool.isRequired,
  isPresent: _propTypes.default.bool.isRequired,
  isMerging: _propTypes.default.bool.isRequired,
  isRebasing: _propTypes.default.bool.isRequired,
  branches: _propTypes2.BranchSetPropType.isRequired,
  remotes: _propTypes2.RemoteSetPropType.isRequired,
  children: _propTypes.default.func.isRequired
});

var _default = (0, _reactRelay.createFragmentContainer)(BarePullRequestCheckoutController, {
  repository: function () {
    const node = require("./__generated__/prCheckoutController_repository.graphql");

    if (node.hash && node.hash !== "b2212745240c03ff8fc7cb13dfc63183") {
      console.error("The definition of 'prCheckoutController_repository' appears to have changed. Run `relay-compiler` to update the generated files to receive the expected data.");
    }

    return require("./__generated__/prCheckoutController_repository.graphql");
  },
  pullRequest: function () {
    const node = require("./__generated__/prCheckoutController_pullRequest.graphql");

    if (node.hash && node.hash !== "66e001f389a2c4f74c1369cf69b31268") {
      console.error("The definition of 'prCheckoutController_pullRequest' appears to have changed. Run `relay-compiler` to update the generated files to receive the expected data.");
    }

    return require("./__generated__/prCheckoutController_pullRequest.graphql");
  }
});

exports.default = _default;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uL2xpYi9jb250cm9sbGVycy9wci1jaGVja291dC1jb250cm9sbGVyLmpzIl0sIm5hbWVzIjpbIkNoZWNrb3V0U3RhdGUiLCJjb25zdHJ1Y3RvciIsIm5hbWUiLCJ3aGVuIiwiY2FzZXMiLCJkZWZhdWx0IiwiY2hlY2tvdXRTdGF0ZXMiLCJISURERU4iLCJESVNBQkxFRCIsIkJVU1kiLCJDVVJSRU5UIiwiQmFyZVB1bGxSZXF1ZXN0Q2hlY2tvdXRDb250cm9sbGVyIiwiUmVhY3QiLCJDb21wb25lbnQiLCJwcm9wcyIsInN0YXRlIiwiY2hlY2tvdXRJblByb2dyZXNzIiwiY2hlY2tvdXRPcCIsIkVuYWJsZWFibGVPcGVyYXRpb24iLCJjaGVja291dCIsImNhdGNoIiwiZSIsIkdpdEVycm9yIiwidG9nZ2xlU3RhdGUiLCJyZW5kZXIiLCJjaGlsZHJlbiIsIm5leHRDaGVja291dE9wIiwicmVwb3NpdG9yeSIsInB1bGxSZXF1ZXN0IiwiaXNBYnNlbnQiLCJkaXNhYmxlIiwiaXNMb2FkaW5nIiwiaXNQcmVzZW50IiwiaXNNZXJnaW5nIiwiaXNSZWJhc2luZyIsImhlYWRSZXBvc2l0b3J5IiwiaGVhZFB1c2giLCJicmFuY2hlcyIsImdldEhlYWRCcmFuY2giLCJnZXRQdXNoIiwiaGVhZFJlbW90ZSIsInJlbW90ZXMiLCJ3aXRoTmFtZSIsImdldFJlbW90ZU5hbWUiLCJmcm9tUHVsbFJlZnNwZWMiLCJnZXRPd25lciIsIm93bmVyIiwibG9naW4iLCJnZXRSZXBvIiwiZ2V0U2hvcnRSZW1vdGVSZWYiLCJudW1iZXIiLCJmcm9tSGVhZFJlcG8iLCJoZWFkUmVmTmFtZSIsImVuYWJsZSIsImZ1bGxIZWFkUmVmIiwic291cmNlUmVtb3RlTmFtZSIsImxvY2FsUmVmTmFtZSIsImhlYWRSZW1vdGVzIiwibWF0Y2hpbmdHaXRIdWJSZXBvc2l0b3J5IiwibGVuZ3RoIiwiZ2V0TmFtZSIsInVybCIsImh0dHBzIiwic3NoIiwic3NoVXJsIiwibW9zdFVzZWRQcm90b2NvbCIsInJlbW90ZSIsImxvY2FsUmVwb3NpdG9yeSIsImFkZFJlbW90ZSIsInB1bGxUYXJnZXRzIiwiZ2V0UHVsbFRhcmdldHMiLCJwdWxsIiwicmVtb3RlTmFtZSIsImZmT25seSIsImZldGNoIiwiY3JlYXRlTmV3IiwidHJhY2siLCJzdGFydFBvaW50IiwiUHJvcFR5cGVzIiwic2hhcGUiLCJzdHJpbmciLCJpc1JlcXVpcmVkIiwib2JqZWN0IiwiYm9vbCIsIkJyYW5jaFNldFByb3BUeXBlIiwiUmVtb3RlU2V0UHJvcFR5cGUiLCJmdW5jIl0sIm1hcHBpbmdzIjoiOzs7Ozs7O0FBQUE7O0FBQ0E7O0FBQ0E7O0FBRUE7O0FBQ0E7O0FBQ0E7O0FBQ0E7Ozs7OztBQUVBLE1BQU1BLGFBQU4sQ0FBb0I7QUFDbEJDLEVBQUFBLFdBQVcsQ0FBQ0MsSUFBRCxFQUFPO0FBQ2hCLFNBQUtBLElBQUwsR0FBWUEsSUFBWjtBQUNEOztBQUVEQyxFQUFBQSxJQUFJLENBQUNDLEtBQUQsRUFBUTtBQUNWLFdBQU9BLEtBQUssQ0FBQyxLQUFLRixJQUFOLENBQUwsSUFBb0JFLEtBQUssQ0FBQ0MsT0FBakM7QUFDRDs7QUFQaUI7O0FBVWIsTUFBTUMsY0FBYyxHQUFHO0FBQzVCQyxFQUFBQSxNQUFNLEVBQUUsSUFBSVAsYUFBSixDQUFrQixRQUFsQixDQURvQjtBQUU1QlEsRUFBQUEsUUFBUSxFQUFFLElBQUlSLGFBQUosQ0FBa0IsVUFBbEIsQ0FGa0I7QUFHNUJTLEVBQUFBLElBQUksRUFBRSxJQUFJVCxhQUFKLENBQWtCLE1BQWxCLENBSHNCO0FBSTVCVSxFQUFBQSxPQUFPLEVBQUUsSUFBSVYsYUFBSixDQUFrQixTQUFsQjtBQUptQixDQUF2Qjs7O0FBT0EsTUFBTVcsaUNBQU4sU0FBZ0RDLGVBQU1DLFNBQXRELENBQWdFO0FBbUNyRVosRUFBQUEsV0FBVyxDQUFDYSxLQUFELEVBQVE7QUFDakIsVUFBTUEsS0FBTjtBQUVBLFNBQUtDLEtBQUwsR0FBYTtBQUNYQyxNQUFBQSxrQkFBa0IsRUFBRTtBQURULEtBQWI7QUFJ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TUFBVixDQUFpQkM7QUFESCxPQUFoQjtBQUp1QixLQUFoQjtBQUhXLEdBQWhCLEVBV1ZBLFVBbkJjO0FBcUJqQjtBQUNBZCxFQUFBQSxlQUFlLEVBQUVXLG1CQUFVSSxNQUFWLENBQWlCRCxVQXRCakI7QUF1QmpCcEQsRUFBQUEsUUFBUSxFQUFFaUQsbUJBQVVLLElBQVYsQ0FBZUYsVUF2QlI7QUF3QmpCbEQsRUFBQUEsU0FBUyxFQUFFK0MsbUJBQVVLLElBQVYsQ0FBZUYsVUF4QlQ7QUF5QmpCakQsRUFBQUEsU0FBUyxFQUFFOEMsbUJBQVVLLElBQVYsQ0FBZUYsVUF6QlQ7QUEwQmpCaEQsRUFBQUEsU0FBUyxFQUFFNkMsbUJBQVVLLElBQVYsQ0FBZUYsVUExQlQ7QUEyQmpCL0MsRUFBQUEsVUFBVSxFQUFFNEMsbUJBQVVLLElBQVYsQ0FBZUYsVUEzQlY7QUE0QmpCNUMsRUFBQUEsUUFBUSxFQUFFK0MsOEJBQWtCSCxVQTVCWDtBQTZCakJ4QyxFQUFBQSxPQUFPLEVBQUU0Qyw4QkFBa0JKLFVBN0JWO0FBK0JqQnhELEVBQUFBLFFBQVEsRUFBRXFELG1CQUFVUSxJQUFWLENBQWVMO0FBL0JSLEM7O2VBd0tOLHlDQUF3QnRFLGlDQUF4QixFQUEyRDtBQUN4RWdCLEVBQUFBLFVBQVU7QUFBQTs7QUFBQTtBQUFBO0FBQUE7O0FBQUE7QUFBQSxHQUQ4RDtBQVN4RUMsRUFBQUEsV0FBVztBQUFBOztBQUFBO0FBQUE7QUFBQTs7QUFBQTtBQUFBO0FBVDZELENBQTNELEMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgUmVhY3QgZnJvbSAncmVhY3QnO1xuaW1wb3J0IFByb3BUeXBlcyBmcm9tICdwcm9wLXR5cGVzJztcbmltcG9ydCB7Z3JhcGhxbCwgY3JlYXRlRnJhZ21lbnRDb250YWluZXJ9IGZyb20gJ3JlYWN0LXJlbGF5JztcblxuaW1wb3J0IEVuYWJsZWFibGVPcGVyYXRpb24gZnJvbSAnLi4vbW9kZWxzL2VuYWJsZWFibGUtb3BlcmF0aW9uJztcbmltcG9ydCB7R2l0RXJyb3J9IGZyb20gJy4uL2dpdC1zaGVsbC1vdXQtc3RyYXRlZ3knO1xuaW1wb3J0IHtSZW1vdGVTZXRQcm9wVHlwZSwgQnJhbmNoU2V0UHJvcFR5cGV9IGZyb20gJy4uL3Byb3AtdHlwZXMnO1xuaW1wb3J0IHtpbmNyZW1lbnRDb3VudGVyfSBmcm9tICcuLi9yZXBvcnRlci1wcm94eSc7XG5cbmNsYXNzIENoZWNrb3V0U3RhdGUge1xuICBjb25zdHJ1Y3RvcihuYW1lKSB7XG4gICAgdGhpcy5uYW1lID0gbmFtZTtcbiAgfVxuXG4gIHdoZW4oY2FzZXMpIHtcbiAgICByZXR1cm4gY2FzZXNbdGhpcy5uYW1lXSB8fCBjYXNlcy5kZWZhdWx0O1xuICB9XG59XG5cbmV4cG9ydCBjb25zdCBjaGVja291dFN0YXRlcyA9IHtcbiAgSElEREVOOiBuZXcgQ2hlY2tvdXRTdGF0ZSgnaGlkZGVuJyksXG4gIERJU0FCTEVEOiBuZXcgQ2hlY2tvdXRTdGF0ZSgnZGlzYWJsZWQnKSxcbiAgQlVTWTogbmV3IENoZWNrb3V0U3RhdGUoJ2J1c3knKSxcbiAgQ1VSUkVOVDogbmV3IENoZWNrb3V0U3RhdGUoJ2N1cnJlbnQnKSxcbn07XG5cbmV4cG9ydCBjbGFzcyBCYXJlUHVsbFJlcXVlc3RDaGVja291dENvbnRyb2xsZXIgZXh0ZW5kcyBSZWFjdC5Db21wb25lbnQge1xuICBzdGF0aWMgcHJvcFR5cGVzID0ge1xuICAgIC8vIEdyYXBoUUwgcmVzcG9uc2VcbiAgICByZXBvc2l0b3J5OiBQcm9wVHlwZXMuc2hhcGUoe1xuICAgICAgbmFtZTogUHJvcFR5cGVzLnN0cmluZy5pc1JlcXVpcmVkLFxuICAgICAgb3duZXI6IFByb3BUeXBlcy5zaGFwZSh7XG4gICAgICAgIGxvZ2luOiBQcm9wVHlwZXMuc3RyaW5nLmlzUmVxdWlyZWQsXG4gICAgICB9KS5pc1JlcXVpcmVkLFxuICAgIH0pLmlzUmVxdWlyZWQsXG4gICAgcHVsbFJlcXVlc3Q6IFByb3BUeXBlcy5zaGFwZSh7XG4gICAgICBudW1iZXI6IFByb3BUeXBlcy5udW1iZXIuaXNSZXF1aXJlZCxcbiAgICAgIGhlYWRSZWZOYW1lOiBQcm9wVHlwZXMuc3RyaW5nLmlzUmVxdWlyZWQsXG4gICAgICBoZWFkUmVwb3NpdG9yeTogUHJvcFR5cGVzLnNoYXBlKHtcbiAgICAgICAgbmFtZTogUHJvcFR5cGVzLnN0cmluZy5pc1JlcXVpcmVkLFxuICAgICAgICB1cmw6IFByb3BUeXBlcy5zdHJpbmcuaXNSZXF1aXJlZCxcbiAgICAgICAgc3NoVXJsOiBQcm9wVHlwZXMuc3RyaW5nLmlzUmVxdWlyZWQsXG4gICAgICAgIG93bmVyOiBQcm9wVHlwZXMuc2hhcGUoe1xuICAgICAgICAgIGxvZ2luOiBQcm9wVHlwZXMuc3RyaW5nLmlzUmVxdWlyZWQsXG4gICAgICAgIH0pLFxuICAgICAgfSksXG4gICAgfSkuaXNSZXF1aXJlZCxcblxuICAgIC8vIFJlcG9zaXRvcnkgbW9kZWwgYW5kIGF0dHJpYnV0ZXNcbiAgICBsb2NhbFJlcG9zaXRvcnk6IFByb3BUeXBlcy5vYmplY3QuaXNSZXF1aXJlZCxcbiAgICBpc0Fic2VudDogUHJvcFR5cGVzLmJvb2wuaXNSZXF1aXJlZCxcbiAgICBpc0xvYWRpbmc6IFByb3BUeXBlcy5ib29sLmlzUmVxdWlyZWQsXG4gICAgaXNQcmVzZW50OiBQcm9wVHlwZXMuYm9vbC5pc1JlcXVpcmVkLFxuICAgIGlzTWVyZ2luZzogUHJvcFR5cGVzLmJvb2wuaXNSZXF1aXJlZCxcbiAgICBpc1JlYmFzaW5nOiBQcm9wVHlwZXMuYm9vbC5pc1JlcXVpcmVkLFxuICAgIGJyYW5jaGVzOiBCcmFuY2hTZXRQcm9wVHlwZS5pc1JlcXVpcmVkLFxuICAgIHJlbW90ZXM6IFJlbW90ZVNldFByb3BUeXBlLmlzUmVxdWlyZWQsXG5cbiAgICBjaGlsZHJlbjogUHJvcFR5cGVzLmZ1bmMuaXNSZXF1aXJlZCxcbiAgfVxuXG4gIGNvbnN0cnVjdG9yKHByb3BzKSB7XG4gICAgc3VwZXIocHJvcHMpO1xuXG4gICAgdGhpcy5zdGF0ZSA9IHtcbiAgICAgIGNoZWNrb3V0SW5Qcm9ncmVzczogZmFsc2UsXG4gICAgfTtcblxuICAgIHRoaXMuY2hlY2tvdXRPcCA9IG5ldyBFbmFibGVhYmxlT3BlcmF0aW9uKFxuICAgICAgKCkgPT4gdGhpcy5jaGVja291dCgpLmNhdGNoKGUgPT4ge1xuICAgICAgICBpZiAoIShlIGluc3RhbmNlb2YgR2l0RXJyb3IpKSB7XG4gICAgICAgICAgdGhyb3cgZTtcbiAgICAgICAgfVxuICAgICAgfSksXG4gICAgKTtcbiAgICB0aGlzLmNoZWNrb3V0T3AudG9nZ2xlU3RhdGUodGhpcywgJ2NoZWNrb3V0SW5Qcm9ncmVzcycpO1xuICB9XG5cbiAgcmVuZGVyKCkge1xuICAgIHJldHVybiB0aGlzLnByb3BzLmNoaWxkcmVuKHRoaXMubmV4dENoZWNrb3V0T3AoKSk7XG4gIH1cblxuICBuZXh0Q2hlY2tvdXRPcCgpIHtcbiAgICBjb25zdCB7cmVwb3NpdG9yeSwgcHVsbFJlcXVlc3R9ID0gdGhpcy5wcm9wcztcblxuICAgIGlmICh0aGlzLnByb3BzLmlzQWJzZW50KSB7XG4gICAgICByZXR1cm4gdGhpcy5jaGVja291dE9wLmRpc2FibGUoY2hlY2tvdXRTdGF0ZXMuSElEREVOLCAnTm8gcmVwb3NpdG9yeSBmb3VuZCcpO1xuICAgIH1cblxuICAgIGlmICh0aGlzLnByb3BzLmlzTG9hZGluZykge1xuICAgICAgcmV0dXJuIHRoaXMuY2hlY2tvdXRPcC5kaXNhYmxlKGNoZWNrb3V0U3RhdGVzLkRJU0FCTEVELCAnTG9hZGluZycpO1xuICAgIH1cblxuICAgIGlmICghdGhpcy5wcm9wcy5pc1ByZXNlbnQpIHtcbiAgICAgIHJldHVybiB0aGlzLmNoZWNrb3V0T3AuZGlzYWJsZShjaGVja291dFN0YXRlcy5ESVNBQkxFRCwgJ05vIHJlcG9zaXRvcnkgZm91bmQnKTtcbiAgICB9XG5cbiAgICBpZiAodGhpcy5wcm9wcy5pc01lcmdpbmcpIHtcbiAgICAgIHJldHVybiB0aGlzLmNoZWNrb3V0T3AuZGlzYWJsZShjaGVja291dFN0YXRlcy5ESVNBQkxFRCwgJ01lcmdlIGluIHByb2dyZXNzJyk7XG4gICAgfVxuXG4gICAgaWYgKHRoaXMucHJvcHMuaXNSZWJhc2luZykge1xuICAgICAgcmV0dXJuIHRoaXMuY2hlY2tvdXRPcC5kaXNhYmxlKGNoZWNrb3V0U3RhdGVzLkRJU0FCTEVELCAnUmViYXNlIGluIHByb2dyZXNzJyk7XG4gICAgfVxuXG4gICAgaWYgKHRoaXMuc3RhdGUuY2hlY2tvdXRJblByb2dyZXNzKSB7XG4gICAgICByZXR1cm4gdGhpcy5jaGVja291dE9wLmRpc2FibGUoY2hlY2tvdXRTdGF0ZXMuRElTQUJMRUQsICdDaGVja2luZyBvdXQuLi4nKTtcbiAgICB9XG5cbiAgICAvLyBkZXRlcm1pbmUgaWYgcHVsbFJlcXVlc3QuaGVhZFJlcG9zaXRvcnkgaXMgbnVsbFxuICAgIC8vIHRoaXMgY2FuIGhhcHBlbiBpZiBhIHJlcG9zaXRvcnkgaGFzIGJlZW4gZGVsZXRlZC5cbiAgICBpZiAoIXB1bGxSZXF1ZXN0LmhlYWRSZXBvc2l0b3J5KSB7XG4gICAgICByZXR1cm4gdGhpcy5jaGVja291dE9wLmRpc2FibGUoY2hlY2tvdXRTdGF0ZXMuRElTQUJMRUQsICdQdWxsIHJlcXVlc3QgaGVhZCByZXBvc2l0b3J5IGRvZXMgbm90IGV4aXN0Jyk7XG4gICAgfVxuXG4gICAgLy8gRGV0ZXJtaW5lIGlmIHdlIGFscmVhZHkgaGF2ZSB0aGlzIFBSIGNoZWNrZWQgb3V0LlxuXG4gICAgY29uc3QgaGVhZFB1c2ggPSB0aGlzLnByb3BzLmJyYW5jaGVzLmdldEhlYWRCcmFuY2goKS5nZXRQdXNoKCk7XG4gICAgY29uc3QgaGVhZFJlbW90ZSA9IHRoaXMucHJvcHMucmVtb3Rlcy53aXRoTmFtZShoZWFkUHVzaC5nZXRSZW1vdGVOYW1lKCkpO1xuXG4gICAgLy8gKGRldGVjdCBjaGVja291dCBmcm9tIHB1bGwvIyMjIHJlZnNwZWMpXG4gICAgY29uc3QgZnJvbVB1bGxSZWZzcGVjID1cbiAgICAgIGhlYWRSZW1vdGUuZ2V0T3duZXIoKSA9PT0gcmVwb3NpdG9yeS5vd25lci5sb2dpbiAmJlxuICAgICAgaGVhZFJlbW90ZS5nZXRSZXBvKCkgPT09IHJlcG9zaXRvcnkubmFtZSAmJlxuICAgICAgaGVhZFB1c2guZ2V0U2hvcnRSZW1vdGVSZWYoKSA9PT0gYHB1bGwvJHtwdWxsUmVxdWVzdC5udW1iZXJ9L2hlYWRgO1xuXG4gICAgLy8gKGRldGVjdCBjaGVja291dCBmcm9tIGhlYWQgcmVwb3NpdG9yeSlcbiAgICBjb25zdCBmcm9tSGVhZFJlcG8gPVxuICAgICAgaGVhZFJlbW90ZS5nZXRPd25lcigpID09PSBwdWxsUmVxdWVzdC5oZWFkUmVwb3NpdG9yeS5vd25lci5sb2dpbiAmJlxuICAgICAgaGVhZFJlbW90ZS5nZXRSZXBvKCkgPT09IHB1bGxSZXF1ZXN0LmhlYWRSZXBvc2l0b3J5Lm5hbWUgJiZcbiAgICAgIGhlYWRQdXNoLmdldFNob3J0UmVtb3RlUmVmKCkgPT09IHB1bGxSZXF1ZXN0LmhlYWRSZWZOYW1lO1xuXG4gICAgaWYgKGZyb21QdWxsUmVmc3BlYyB8fCBmcm9tSGVhZFJlcG8pIHtcbiAgICAgIHJldHVybiB0aGlzLmNoZWNrb3V0T3AuZGlzYWJsZShjaGVja291dFN0YXRlcy5DVVJSRU5ULCAnQ3VycmVudCcpO1xuICAgIH1cblxuICAgIHJldHVybiB0aGlzLmNoZWNrb3V0T3AuZW5hYmxlKCk7XG4gIH1cblxuICBhc3luYyBjaGVja291dCgpIHtcbiAgICBjb25zdCB7cHVsbFJlcXVlc3R9ID0gdGhpcy5wcm9wcztcbiAgICBjb25zdCB7aGVhZFJlcG9zaXRvcnl9ID0gcHVsbFJlcXVlc3Q7XG5cbiAgICBjb25zdCBmdWxsSGVhZFJlZiA9IGByZWZzL2hlYWRzLyR7cHVsbFJlcXVlc3QuaGVhZFJlZk5hbWV9YDtcblxuICAgIGxldCBzb3VyY2VSZW1vdGVOYW1lLCBsb2NhbFJlZk5hbWU7XG5cbiAgICAvLyBEaXNjb3ZlciBvciBjcmVhdGUgYSByZW1vdGUgcG9pbnRpbmcgdG8gdGhlIHJlcG8gY29udGFpbmluZyB0aGUgcHVsbCByZXF1ZXN0J3MgaGVhZCByZWYuXG4gICAgLy8gSWYgdGhlIGxvY2FsIHJlcG9zaXRvcnkgYWxyZWFkeSBoYXMgdGhlIGhlYWQgcmVwb3NpdG9yeSBzcGVjaWZpZWQgYXMgYSByZW1vdGUsIHRoYXQgcmVtb3RlIHdpbGwgYmUgdXNlZCwgc29cbiAgICAvLyB0aGF0IGFueSByZWxhdGVkIGNvbmZpZ3VyYXRpb24gaXMgcGlja2VkIHVwIGZvciB0aGUgZmV0Y2guIE90aGVyd2lzZSwgdGhlIGhlYWQgcmVwb3NpdG9yeSBmZXRjaCBVUkwgaXMgdXNlZFxuICAgIC8vIGRpcmVjdGx5LlxuICAgIGNvbnN0IGhlYWRSZW1vdGVzID0gdGhpcy5wcm9wcy5yZW1vdGVzLm1hdGNoaW5nR2l0SHViUmVwb3NpdG9yeShoZWFkUmVwb3NpdG9yeS5vd25lci5sb2dpbiwgaGVhZFJlcG9zaXRvcnkubmFtZSk7XG4gICAgaWYgKGhlYWRSZW1vdGVzLmxlbmd0aCA+IDApIHtcbiAgICAgIHNvdXJjZVJlbW90ZU5hbWUgPSBoZWFkUmVtb3Rlc1swXS5nZXROYW1lKCk7XG4gICAgfSBlbHNlIHtcbiAgICAgIGNvbnN0IHVybCA9IHtcbiAgICAgICAgaHR0cHM6IGhlYWRSZXBvc2l0b3J5LnVybCArICcuZ2l0JyxcbiAgICAgICAgc3NoOiBoZWFkUmVwb3NpdG9yeS5zc2hVcmwsXG4gICAgICB9W3RoaXMucHJvcHMucmVtb3Rlcy5tb3N0VXNlZFByb3RvY29sKFsnaHR0cHMnLCAnc3NoJ10pXTtcblxuICAgICAgLy8gVGhpcyB3aWxsIHRocm93IGlmIGEgcmVtb3RlIHdpdGggdGhpcyBuYW1lIGFscmVhZHkgZXhpc3RzIChhbmQgcG9pbnRzIHNvbWV3aGVyZSBlbHNlLCBvciB3ZSB3b3VsZCBoYXZlIGZvdW5kXG4gICAgICAvLyBpdCBhYm92ZSkuIMKvXFxfKOODhClfL8KvXG4gICAgICBjb25zdCByZW1vdGUgPSBhd2FpdCB0aGlzLnByb3BzLmxvY2FsUmVwb3NpdG9yeS5hZGRSZW1vdGUoaGVhZFJlcG9zaXRvcnkub3duZXIubG9naW4sIHVybCk7XG4gICAgICBzb3VyY2VSZW1vdGVOYW1lID0gcmVtb3RlLmdldE5hbWUoKTtcbiAgICB9XG5cbiAgICAvLyBJZGVudGlmeSBhbiBleGlzdGluZyBsb2NhbCByZWYgdGhhdCBhbHJlYWR5IGNvcnJlc3BvbmRzIHRvIHRoZSBwdWxsIHJlcXVlc3QsIGlmIG9uZSBleGlzdHMuIE90aGVyd2lzZSwgZ2VuZXJhdGVcbiAgICAvLyBhIG5ldyBsb2NhbCByZWYgbmFtZS5cbiAgICBjb25zdCBwdWxsVGFyZ2V0cyA9IHRoaXMucHJvcHMuYnJhbmNoZXMuZ2V0UHVsbFRhcmdldHMoc291cmNlUmVtb3RlTmFtZSwgZnVsbEhlYWRSZWYpO1xuICAgIGlmIChwdWxsVGFyZ2V0cy5sZW5ndGggPiAwKSB7XG4gICAgICBsb2NhbFJlZk5hbWUgPSBwdWxsVGFyZ2V0c1swXS5nZXROYW1lKCk7XG5cbiAgICAgIC8vIENoZWNrIG91dCB0aGUgZXhpc3RpbmcgbG9jYWwgcmVmLlxuICAgICAgYXdhaXQgdGhpcy5wcm9wcy5sb2NhbFJlcG9zaXRvcnkuY2hlY2tvdXQobG9jYWxSZWZOYW1lKTtcbiAgICAgIHRyeSB7XG4gICAgICAgIGF3YWl0IHRoaXMucHJvcHMubG9jYWxSZXBvc2l0b3J5LnB1bGwoZnVsbEhlYWRSZWYsIHtyZW1vdGVOYW1lOiBzb3VyY2VSZW1vdGVOYW1lLCBmZk9ubHk6IHRydWV9KTtcbiAgICAgIH0gZmluYWxseSB7XG4gICAgICAgIGluY3JlbWVudENvdW50ZXIoJ2NoZWNrb3V0LXByJyk7XG4gICAgICB9XG5cbiAgICAgIHJldHVybjtcbiAgICB9XG5cbiAgICBhd2FpdCB0aGlzLnByb3BzLmxvY2FsUmVwb3NpdG9yeS5mZXRjaChmdWxsSGVhZFJlZiwge3JlbW90ZU5hbWU6IHNvdXJjZVJlbW90ZU5hbWV9KTtcblxuICAgIC8vIENoZWNrIG91dCB0aGUgbG9jYWwgcmVmIGFuZCBzZXQgaXQgdXAgdG8gdHJhY2sgdGhlIGhlYWQgcmVmLlxuICAgIGF3YWl0IHRoaXMucHJvcHMubG9jYWxSZXBvc2l0b3J5LmNoZWNrb3V0KFxuICAgICAgYHByLSR7cHVsbFJlcXVlc3QubnVtYmVyfS8ke2hlYWRSZXBvc2l0b3J5Lm93bmVyLmxvZ2lufS8ke3B1bGxSZXF1ZXN0LmhlYWRSZWZOYW1lfWAsXG4gICAgICB7Y3JlYXRlTmV3OiB0cnVlLCB0cmFjazogdHJ1ZSwgc3RhcnRQb2ludDogYHJlZnMvcmVtb3Rlcy8ke3NvdXJjZVJlbW90ZU5hbWV9LyR7cHVsbFJlcXVlc3QuaGVhZFJlZk5hbWV9YCxcbiAgICAgIH0pO1xuXG4gICAgaW5jcmVtZW50Q291bnRlcignY2hlY2tvdXQtcHInKTtcbiAgfVxufVxuXG5leHBvcnQgZGVmYXVsdCBjcmVhdGVGcmFnbWVudENvbnRhaW5lcihCYXJlUHVsbFJlcXVlc3RDaGVja291dENvbnRyb2xsZXIsIHtcbiAgcmVwb3NpdG9yeTogZ3JhcGhxbGBcbiAgICBmcmFnbWVudCBwckNoZWNrb3V0Q29udHJvbGxlcl9yZXBvc2l0b3J5IG9uIFJlcG9zaXRvcnkge1xuICAgICAgbmFtZVxuICAgICAgb3duZXIge1xuICAgICAgICBsb2dpblxuICAgICAgfVxuICAgIH1cbiAgYCxcbiAgcHVsbFJlcXVlc3Q6IGdyYXBocWxgXG4gICAgZnJhZ21lbnQgcHJDaGVja291dENvbnRyb2xsZXJfcHVsbFJlcXVlc3Qgb24gUHVsbFJlcXVlc3Qge1xuICAgICAgbnVtYmVyXG4gICAgICBoZWFkUmVmTmFtZVxuICAgICAgaGVhZFJlcG9zaXRvcnkge1xuICAgICAgICBuYW1lXG4gICAgICAgIHVybFxuICAgICAgICBzc2hVcmxcbiAgICAgICAgb3duZXIge1xuICAgICAgICAgIGxvZ2luXG4gICAgICAgIH1cbiAgICAgIH1cbiAgICB9XG4gIGAsXG59KTtcbiJdfQ==