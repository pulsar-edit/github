"use strict";

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.default = void 0;

var _react = _interopRequireDefault(require("react"));

var _propTypes = _interopRequireDefault(require("prop-types"));

var _reporterProxy = require("../reporter-proxy");

var _eventKit = require("event-kit");

var _commitDetailItem = _interopRequireDefault(require("../items/commit-detail-item"));

var _uriPattern = _interopRequireDefault(require("../atom/uri-pattern"));

var _recentCommitsView = _interopRequireDefault(require("../views/recent-commits-view"));

var _refHolder = _interopRequireDefault(require("../models/ref-holder"));

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }

function _defineProperty(obj, key, value) { if (key in obj) { Object.defineProperty(obj, key, { value: value, enumerable: true, configurable: true, writable: true }); } else { obj[key] = value; } return obj; }

class RecentCommitsController extends _react.default.Component {
  constructor(props, context) {
    super(props, context);

    _defineProperty(this, "updateSelectedCommit", () => {
      const activeItem = this.props.workspace.getActivePaneItem();
      const pattern = new _uriPattern.default(decodeURIComponent(_commitDetailItem.default.buildURI(this.props.repository.getWorkingDirectoryPath(), '{sha}')));

      if (activeItem && activeItem.getURI) {
        const match = pattern.matches(activeItem.getURI());
        const {
          sha
        } = match.getParams();

        if (match.ok() && sha && sha !== this.state.selectedCommitSha) {
          return new Promise(resolve => this.setState({
            selectedCommitSha: sha
          }, resolve));
        }
      }

      return Promise.resolve();
    });

    _defineProperty(this, "openCommit", async ({
      sha,
      preserveFocus
    }) => {
      const workdir = this.props.repository.getWorkingDirectoryPath();

      const uri = _commitDetailItem.default.buildURI(workdir, sha);

      const item = await this.props.workspace.open(uri, {
        pending: true
      });

      if (preserveFocus) {
        item.preventFocus();
        this.setFocus(this.constructor.focus.RECENT_COMMIT);
      }

      (0, _reporterProxy.addEvent)('open-commit-in-pane', {
        package: 'github',
        from: this.constructor.name
      });
    });

    _defineProperty(this, "selectNextCommit", () => this.setSelectedCommitIndex(this.getSelectedCommitIndex() + 1));

    _defineProperty(this, "selectPreviousCommit", () => this.setSelectedCommitIndex(Math.max(this.getSelectedCommitIndex() - 1, 0)));

    this.subscriptions = new _eventKit.CompositeDisposable(this.props.workspace.onDidChangeActivePaneItem(this.updateSelectedCommit));
    this.refView = new _refHolder.default();
    this.state = {
      selectedCommitSha: ''
    };
  }

  render() {
    return _react.default.createElement(_recentCommitsView.default, {
      ref: this.refView.setter,
      commits: this.props.commits,
      isLoading: this.props.isLoading,
      undoLastCommit: this.props.undoLastCommit,
      openCommit: this.openCommit,
      selectNextCommit: this.selectNextCommit,
      selectPreviousCommit: this.selectPreviousCommit,
      selectedCommitSha: this.state.selectedCommitSha,
      commands: this.props.commands,
      clipboard: atom.clipboard
    });
  }

  getSelectedCommitIndex() {
    return this.props.commits.findIndex(commit => commit.getSha() === this.state.selectedCommitSha);
  }

  setSelectedCommitIndex(ind) {
    const commit = this.props.commits[ind];

    if (commit) {
      return new Promise(resolve => this.setState({
        selectedCommitSha: commit.getSha()
      }, resolve));
    } else {
      return Promise.resolve();
    }
  }

  getFocus(element) {
    return this.refView.map(view => view.getFocus(element)).getOr(null);
  }

  setFocus(focus) {
    return this.refView.map(view => {
      const wasFocused = view.setFocus(focus);

      if (wasFocused && this.getSelectedCommitIndex() === -1) {
        this.setSelectedCommitIndex(0);
      }

      return wasFocused;
    }).getOr(false);
  }

  advanceFocusFrom(focus) {
    return this.refView.map(view => view.advanceFocusFrom(focus)).getOr(Promise.resolve(null));
  }

  retreatFocusFrom(focus) {
    return this.refView.map(view => view.retreatFocusFrom(focus)).getOr(Promise.resolve(null));
  }

}

exports.default = RecentCommitsController;

_defineProperty(RecentCommitsController, "propTypes", {
  commits: _propTypes.default.arrayOf(_propTypes.default.object).isRequired,
  isLoading: _propTypes.default.bool.isRequired,
  undoLastCommit: _propTypes.default.func.isRequired,
  workspace: _propTypes.default.object.isRequired,
  repository: _propTypes.default.object.isRequired,
  commands: _propTypes.default.object.isRequired
});

_defineProperty(RecentCommitsController, "focus", _recentCommitsView.default.focus);
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uL2xpYi9jb250cm9sbGVycy9yZWNlbnQtY29tbWl0cy1jb250cm9sbGVyLmpzIl0sIm5hbWVzIjpbIlJlY2VudENvbW1pdHNDb250cm9sbGVyIiwiUmVhY3QiLCJDb21wb25lbnQiLCJjb25zdHJ1Y3RvciIsInByb3BzIiwiY29udGV4dCIsImFjdGl2ZUl0ZW0iLCJ3b3Jrc3BhY2UiLCJnZXRBY3RpdmVQYW5lSXRlbSIsInBhdHRlcm4iLCJVUklQYXR0ZXJuIiwiZGVjb2RlVVJJQ29tcG9uZW50IiwiQ29tbWl0RGV0YWlsSXRlbSIsImJ1aWxkVVJJIiwicmVwb3NpdG9yeSIsImdldFdvcmtpbmdEaXJlY3RvcnlQYXRoIiwiZ2V0VVJJIiwibWF0Y2giLCJtYXRjaGVzIiwic2hhIiwiZ2V0UGFyYW1zIiwib2siLCJzdGF0ZSIsInNlbGVjdGVkQ29tbWl0U2hhIiwiUHJvbWlzZSIsInJlc29sdmUiLCJzZXRTdGF0ZSIsInByZXNlcnZlRm9jdXMiLCJ3b3JrZGlyIiwidXJpIiwiaXRlbSIsIm9wZW4iLCJwZW5kaW5nIiwicHJldmVudEZvY3VzIiwic2V0Rm9jdXMiLCJmb2N1cyIsIlJFQ0VOVF9DT01NSVQiLCJwYWNrYWdlIiwiZnJvbSIsIm5hbWUiLCJzZXRTZWxlY3RlZENvbW1pdEluZGV4IiwiZ2V0U2VsZWN0ZWRDb21taXRJbmRleCIsIk1hdGgiLCJtYXgiLCJzdWJzY3JpcHRpb25zIiwiQ29tcG9zaXRlRGlzcG9zYWJsZSIsIm9uRGlkQ2hhbmdlQWN0aXZlUGFuZUl0ZW0iLCJ1cGRhdGVTZWxlY3RlZENvbW1pdCIsInJlZlZpZXciLCJSZWZIb2xkZXIiLCJyZW5kZXIiLCJzZXR0ZXIiLCJjb21taXRzIiwiaXNMb2FkaW5nIiwidW5kb0xhc3RDb21taXQiLCJvcGVuQ29tbWl0Iiwic2VsZWN0TmV4dENvbW1pdCIsInNlbGVjdFByZXZpb3VzQ29tbWl0IiwiY29tbWFuZHMiLCJhdG9tIiwiY2xpcGJvYXJkIiwiZmluZEluZGV4IiwiY29tbWl0IiwiZ2V0U2hhIiwiaW5kIiwiZ2V0Rm9jdXMiLCJlbGVtZW50IiwibWFwIiwidmlldyIsImdldE9yIiwid2FzRm9jdXNlZCIsImFkdmFuY2VGb2N1c0Zyb20iLCJyZXRyZWF0Rm9jdXNGcm9tIiwiUHJvcFR5cGVzIiwiYXJyYXlPZiIsIm9iamVjdCIsImlzUmVxdWlyZWQiLCJib29sIiwiZnVuYyIsIlJlY2VudENvbW1pdHNWaWV3Il0sIm1hcHBpbmdzIjoiOzs7Ozs7O0FBQUE7O0FBQ0E7O0FBQ0E7O0FBQ0E7O0FBRUE7O0FBQ0E7O0FBQ0E7O0FBQ0E7Ozs7OztBQUVlLE1BQU1BLHVCQUFOLFNBQXNDQyxlQUFNQyxTQUE1QyxDQUFzRDtBQVluRUMsRUFBQUEsV0FBVyxDQUFDQyxLQUFELEVBQVFDLE9BQVIsRUFBaUI7QUFDMUIsVUFBTUQsS0FBTixFQUFhQyxPQUFiOztBQUQwQixrREFZTCxNQUFNO0FBQzNCLFlBQU1DLFVBQVUsR0FBRyxLQUFLRixLQUFMLENBQVdHLFNBQVgsQ0FBcUJDLGlCQUFyQixFQUFuQjtBQUVBLFlBQU1DLE9BQU8sR0FBRyxJQUFJQyxtQkFBSixDQUFlQyxrQkFBa0IsQ0FDL0NDLDBCQUFpQkMsUUFBakIsQ0FDRSxLQUFLVCxLQUFMLENBQVdVLFVBQVgsQ0FBc0JDLHVCQUF0QixFQURGLEVBRUUsT0FGRixDQUQrQyxDQUFqQyxDQUFoQjs7QUFNQSxVQUFJVCxVQUFVLElBQUlBLFVBQVUsQ0FBQ1UsTUFBN0IsRUFBcUM7QUFDbkMsY0FBTUMsS0FBSyxHQUFHUixPQUFPLENBQUNTLE9BQVIsQ0FBZ0JaLFVBQVUsQ0FBQ1UsTUFBWCxFQUFoQixDQUFkO0FBQ0EsY0FBTTtBQUFDRyxVQUFBQTtBQUFELFlBQVFGLEtBQUssQ0FBQ0csU0FBTixFQUFkOztBQUNBLFlBQUlILEtBQUssQ0FBQ0ksRUFBTixNQUFjRixHQUFkLElBQXFCQSxHQUFHLEtBQUssS0FBS0csS0FBTCxDQUFXQyxpQkFBNUMsRUFBK0Q7QUFDN0QsaUJBQU8sSUFBSUMsT0FBSixDQUFZQyxPQUFPLElBQUksS0FBS0Ms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QixHQUFiLENBQWlCQyxJQUFJLElBQUlBLElBQUksQ0FBQ0ksZ0JBQUwsQ0FBc0JyQyxLQUF0QixDQUF6QixFQUF1RGtDLEtBQXZELENBQTZEN0MsT0FBTyxDQUFDQyxPQUFSLENBQWdCLElBQWhCLENBQTdELENBQVA7QUFDRDs7QUE3R2tFOzs7O2dCQUFoRHpCLHVCLGVBQ0E7QUFDakJvRCxFQUFBQSxPQUFPLEVBQUVxQixtQkFBVUMsT0FBVixDQUFrQkQsbUJBQVVFLE1BQTVCLEVBQW9DQyxVQUQ1QjtBQUVqQnZCLEVBQUFBLFNBQVMsRUFBRW9CLG1CQUFVSSxJQUFWLENBQWVELFVBRlQ7QUFHakJ0QixFQUFBQSxjQUFjLEVBQUVtQixtQkFBVUssSUFBVixDQUFlRixVQUhkO0FBSWpCckUsRUFBQUEsU0FBUyxFQUFFa0UsbUJBQVVFLE1BQVYsQ0FBaUJDLFVBSlg7QUFLakI5RCxFQUFBQSxVQUFVLEVBQUUyRCxtQkFBVUUsTUFBVixDQUFpQkMsVUFMWjtBQU1qQmxCLEVBQUFBLFFBQVEsRUFBRWUsbUJBQVVFLE1BQVYsQ0FBaUJDO0FBTlYsQzs7Z0JBREE1RSx1QixXQVVKK0UsMkJBQWtCNUMsSyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCBSZWFjdCBmcm9tICdyZWFjdCc7XG5pbXBvcnQgUHJvcFR5cGVzIGZyb20gJ3Byb3AtdHlwZXMnO1xuaW1wb3J0IHthZGRFdmVudH0gZnJvbSAnLi4vcmVwb3J0ZXItcHJveHknO1xuaW1wb3J0IHtDb21wb3NpdGVEaXNwb3NhYmxlfSBmcm9tICdldmVudC1raXQnO1xuXG5pbXBvcnQgQ29tbWl0RGV0YWlsSXRlbSBmcm9tICcuLi9pdGVtcy9jb21taXQtZGV0YWlsLWl0ZW0nO1xuaW1wb3J0IFVSSVBhdHRlcm4gZnJvbSAnLi4vYXRvbS91cmktcGF0dGVybic7XG5pbXBvcnQgUmVjZW50Q29tbWl0c1ZpZXcgZnJvbSAnLi4vdmlld3MvcmVjZW50LWNvbW1pdHMtdmlldyc7XG5pbXBvcnQgUmVmSG9sZGVyIGZyb20gJy4uL21vZGVscy9yZWYtaG9sZGVyJztcblxuZXhwb3J0IGRlZmF1bHQgY2xhc3MgUmVjZW50Q29tbWl0c0NvbnRyb2xsZXIgZXh0ZW5kcyBSZWFjdC5Db21wb25lbnQge1xuICBzdGF0aWMgcHJvcFR5cGVzID0ge1xuICAgIGNvbW1pdHM6IFByb3BUeXBlcy5hcnJheU9mKFByb3BUeXBlcy5vYmplY3QpLmlzUmVxdWlyZWQsXG4gICAgaXNMb2FkaW5nOiBQcm9wVHlwZXMuYm9vbC5pc1JlcXVpcmVkLFxuICAgIHVuZG9MYXN0Q29tbWl0OiBQcm9wVHlwZXMuZnVuYy5pc1JlcXVpcmVkLFxuICAgIHdvcmtzcGFjZTogUHJvcFR5cGVzLm9iamVjdC5pc1JlcXVpcmVkLFxuICAgIHJlcG9zaXRvcnk6IFByb3BUeXBlcy5vYmplY3QuaXNSZXF1aXJlZCxcbiAgICBjb21tYW5kczogUHJvcFR5cGVzLm9iamVjdC5pc1JlcXVpcmVkLFxuICB9XG5cbiAgc3RhdGljIGZvY3VzID0gUmVjZW50Q29tbWl0c1ZpZXcuZm9jdXNcblxuICBjb25zdHJ1Y3Rvcihwcm9wcywgY29udGV4dCkge1xuICAgIHN1cGVyKHByb3BzLCBjb250ZXh0KTtcblxuICAgIHRoaXMuc3Vic2NyaXB0aW9ucyA9IG5ldyBDb21wb3NpdGVEaXNwb3NhYmxlKFxuICAgICAgdGhpcy5wcm9wcy53b3Jrc3BhY2Uub25EaWRDaGFuZ2VBY3RpdmVQYW5lSXRlbSh0aGlzLnVwZGF0ZVNlbGVjdGVkQ29tbWl0KSxcbiAgICApO1xuXG4gICAgdGhpcy5yZWZWaWV3ID0gbmV3IFJlZkhvbGRlcigpO1xuXG4gICAgdGhpcy5zdGF0ZSA9IHtzZWxlY3RlZENvbW1pdFNoYTogJyd9O1xuICB9XG5cbiAgdXBkYXRlU2VsZWN0ZWRDb21taXQgPSAoKSA9PiB7XG4gICAgY29uc3QgYWN0aXZlSXRlbSA9IHRoaXMucHJvcHMud29ya3NwYWNlLmdldEFjdGl2ZVBhbmVJdGVtKCk7XG5cbiAgICBjb25zdCBwYXR0ZXJuID0gbmV3IFVSSVBhdHRlcm4oZGVjb2RlVVJJQ29tcG9uZW50KFxuICAgICAgQ29tbWl0RGV0YWlsSXRlbS5idWlsZFVSSShcbiAgICAgICAgdGhpcy5wcm9wcy5yZXBvc2l0b3J5LmdldFdvcmtpbmdEaXJlY3RvcnlQYXRoKCksXG4gICAgICAgICd7c2hhfScpLFxuICAgICkpO1xuXG4gICAgaWYgKGFjdGl2ZUl0ZW0gJiYgYWN0aXZlSXRlbS5nZXRVUkkpIHtcbiAgICAgIGNvbnN0IG1hdGNoID0gcGF0dGVybi5tYXRjaGVzKGFjdGl2ZUl0ZW0uZ2V0VVJJKCkpO1xuICAgICAgY29uc3Qge3NoYX0gPSBtYXRjaC5nZXRQYXJhbXMoKTtcbiAgICAgIGlmIChtYXRjaC5vaygpICYmIHNoYSAmJiBzaGEgIT09IHRoaXMuc3RhdGUuc2VsZWN0ZWRDb21taXRTaGEpIHtcbiAgICAgICAgcmV0dXJuIG5ldyBQcm9taXNlKHJlc29sdmUgPT4gdGhpcy5zZXRTdGF0ZSh7c2VsZWN0ZWRDb21taXRTaGE6IHNoYX0sIHJlc29sdmUpKTtcbiAgICAgIH1cbiAgICB9XG4gICAgcmV0dXJuIFByb21pc2UucmVzb2x2ZSgpO1xuICB9XG5cbiAgcmVuZGVyKCkge1xuICAgIHJldHVybiAoXG4gICAgICA8UmVjZW50Q29tbWl0c1ZpZXdcbiAgICAgICAgcmVmPXt0aGlzLnJlZlZpZXcuc2V0dGVyfVxuICAgICAgICBjb21taXRzPXt0aGlzLnByb3BzLmNvbW1pdHN9XG4gICAgICAgIGlzTG9hZGluZz17dGhpcy5wcm9wcy5pc0xvYWRpbmd9XG4gICAgICAgIHVuZG9MYXN0Q29tbWl0PXt0aGlzLnByb3BzLnVuZG9MYXN0Q29tbWl0fVxuICAgICAgICBvcGVuQ29tbWl0PXt0aGlzLm9wZW5Db21taXR9XG4gICAgICAgIHNlbGVjdE5leHRDb21taXQ9e3RoaXMuc2VsZWN0TmV4dENvbW1pdH1cbiAgICAgICAgc2VsZWN0UHJldmlvdXNDb21taXQ9e3RoaXMuc2VsZWN0UHJldmlvdXNDb21taXR9XG4gICAgICAgIHNlbGVjdGVkQ29tbWl0U2hhPXt0aGlzLnN0YXRlLnNlbGVjdGVkQ29tbWl0U2hhfVxuICAgICAgICBjb21tYW5kcz17dGhpcy5wcm9wcy5jb21tYW5kc31cbiAgICAgICAgY2xpcGJvYXJkPXthdG9tLmNsaXBib2FyZH1cbiAgICAgIC8+XG4gICAgKTtcbiAgfVxuXG4gIG9wZW5Db21taXQgPSBhc3luYyAoe3NoYSwgcHJlc2VydmVGb2N1c30pID0+IHtcbiAgICBjb25zdCB3b3JrZGlyID0gdGhpcy5wcm9wcy5yZXBvc2l0b3J5LmdldFdvcmtpbmdEaXJlY3RvcnlQYXRoKCk7XG4gICAgY29uc3QgdXJpID0gQ29tbWl0RGV0YWlsSXRlbS5idWlsZFVSSSh3b3JrZGlyLCBzaGEpO1xuICAgIGNvbnN0IGl0ZW0gPSBhd2FpdCB0aGlzLnByb3BzLndvcmtzcGFjZS5vcGVuKHVyaSwge3BlbmRpbmc6IHRydWV9KTtcbiAgICBpZiAocHJlc2VydmVGb2N1cykge1xuICAgICAgaXRlbS5wcmV2ZW50Rm9jdXMoKTtcbiAgICAgIHRoaXMuc2V0Rm9jdXModGhpcy5jb25zdHJ1Y3Rvci5mb2N1cy5SRUNFTlRfQ09NTUlUKTtcbiAgICB9XG4gICAgYWRkRXZlbnQoJ29wZW4tY29tbWl0LWluLXBhbmUnLCB7cGFja2FnZTogJ2dpdGh1YicsIGZyb206IHRoaXMuY29uc3RydWN0b3IubmFtZX0pO1xuICB9XG5cbiAgLy8gV2hlbiBubyBjb21taXQgaXMgc2VsZWN0ZWQsIGBnZXRTZWxlY3RlZENvbW1pdEluZGV4YCByZXR1cm5zIC0xICYgdGhlIGNvbW1pdCBhdCBpbmRleCAwIChmaXJzdCBjb21taXQpIGlzIHNlbGVjdGVkXG4gIHNlbGVjdE5leHRDb21taXQgPSAoKSA9PiB0aGlzLnNldFNlbGVjdGVkQ29tbWl0SW5kZXgodGhpcy5nZXRTZWxlY3RlZENvbW1pdEluZGV4KCkgKyAxKTtcblxuICBzZWxlY3RQcmV2aW91c0NvbW1pdCA9ICgpID0+IHRoaXMuc2V0U2VsZWN0ZWRDb21taXRJbmRleChNYXRoLm1heCh0aGlzLmdldFNlbGVjdGVkQ29tbWl0SW5kZXgoKSAtIDEsIDApKTtcblxuICBnZXRTZWxlY3RlZENvbW1pdEluZGV4KCkge1xuICAgIHJldHVybiB0aGlzLnByb3BzLmNvbW1pdHMuZmluZEluZGV4KGNvbW1pdCA9PiBjb21taXQuZ2V0U2hhKCkgPT09IHRoaXMuc3RhdGUuc2VsZWN0ZWRDb21taXRTaGEpO1xuICB9XG5cbiAgc2V0U2VsZWN0ZWRDb21taXRJbmRleChpbmQpIHtcbiAgICBjb25zdCBjb21taXQgPSB0aGlzLnByb3BzLmNvbW1pdHNbaW5kXTtcbiAgICBpZiAoY29tbWl0KSB7XG4gICAgICByZXR1cm4gbmV3IFByb21pc2UocmVzb2x2ZSA9PiB0aGlzLnNldFN0YXRlKHtzZWxlY3RlZENvbW1pdFNoYTogY29tbWl0LmdldFNoYSgpfSwgcmVzb2x2ZSkpO1xuICAgIH0gZWxzZSB7XG4gICAgICByZXR1cm4gUHJvbWlzZS5yZXNvbHZlKCk7XG4gICAgfVxuICB9XG5cbiAgZ2V0Rm9jdXMoZWxlbWVudCkge1xuICAgIHJldHVybiB0aGlzLnJlZlZpZXcubWFwKHZpZXcgPT4gdmlldy5nZXRGb2N1cyhlbGVtZW50KSkuZ2V0T3IobnVsbCk7XG4gIH1cblxuICBzZXRGb2N1cyhmb2N1cykge1xuICAgIHJldHVybiB0aGlzLnJlZlZpZXcubWFwKHZpZXcgPT4ge1xuICAgICAgY29uc3Qgd2FzRm9jdXNlZCA9IHZpZXcuc2V0Rm9jdXMoZm9jdXMpO1xuICAgICAgaWYgKHdhc0ZvY3VzZWQgJiYgdGhpcy5nZXRTZWxlY3RlZENvbW1pdEluZGV4KCkgPT09IC0xKSB7XG4gICAgICAgIHRoaXMuc2V0U2VsZWN0ZWRDb21taXRJbmRleCgwKTtcbiAgICAgIH1cbiAgICAgIHJldHVybiB3YXNGb2N1c2VkO1xuICAgIH0pLmdldE9yKGZhbHNlKTtcbiAgfVxuXG4gIGFkdmFuY2VGb2N1c0Zyb20oZm9jdXMpIHtcbiAgICByZXR1cm4gdGhpcy5yZWZWaWV3Lm1hcCh2aWV3ID0+IHZpZXcuYWR2YW5jZUZvY3VzRnJvbShmb2N1cykpLmdldE9yKFByb21pc2UucmVzb2x2ZShudWxsKSk7XG4gIH1cblxuICByZXRyZWF0Rm9jdXNGcm9tKGZvY3VzKSB7XG4gICAgcmV0dXJuIHRoaXMucmVmVmlldy5tYXAodmlldyA9PiB2aWV3LnJldHJlYXRGb2N1c0Zyb20oZm9jdXMpKS5nZXRPcihQcm9taXNlLnJlc29sdmUobnVsbCkpO1xuICB9XG59XG4iXX0=