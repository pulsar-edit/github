"use strict";

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.default = void 0;

var _react = _interopRequireDefault(require("react"));

var _propTypes = _interopRequireDefault(require("prop-types"));

var _path = _interopRequireDefault(require("path"));

var _helpers = require("../helpers");

var _reporterProxy = require("../reporter-proxy");

var _propTypes2 = require("../prop-types");

var _changedFileItem = _interopRequireDefault(require("../items/changed-file-item"));

var _multiFilePatchView = _interopRequireDefault(require("../views/multi-file-patch-view"));

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }

function _extends() { _extends = Object.assign || function (target) { for (var i = 1; i < arguments.length; i++) { var source = arguments[i]; for (var key in source) { if (Object.prototype.hasOwnProperty.call(source, key)) { target[key] = source[key]; } } } return target; }; return _extends.apply(this, arguments); }

function _defineProperty(obj, key, value) { if (key in obj) { Object.defineProperty(obj, key, { value: value, enumerable: true, configurable: true, writable: true }); } else { obj[key] = value; } return obj; }

class MultiFilePatchController extends _react.default.Component {
  constructor(props) {
    super(props);
    (0, _helpers.autobind)(this, 'selectedRowsChanged', 'undoLastDiscard', 'diveIntoMirrorPatch', 'openFile', 'toggleFile', 'toggleRows', 'toggleModeChange', 'toggleSymlinkChange', 'discardRows');
    this.state = {
      selectionMode: 'hunk',
      selectedRows: new Set(),
      hasMultipleFileSelections: false
    };
    this.mouseSelectionInProgress = false;
    this.stagingOperationInProgress = false;
    this.lastPatchString = null;
    this.patchChangePromise = new Promise(resolve => {
      this.resolvePatchChangePromise = resolve;
    });
  }

  componentDidUpdate(prevProps) {
    if (this.lastPatchString !== null && this.lastPatchString !== this.props.multiFilePatch.toString()) {
      this.resolvePatchChangePromise();
      this.patchChangePromise = new Promise(resolve => {
        this.resolvePatchChangePromise = resolve;
      });
    }
  }

  render() {
    return _react.default.createElement(_multiFilePatchView.default, _extends({}, this.props, {
      selectedRows: this.state.selectedRows,
      selectionMode: this.state.selectionMode,
      hasMultipleFileSelections: this.state.hasMultipleFileSelections,
      selectedRowsChanged: this.selectedRowsChanged,
      diveIntoMirrorPatch: this.diveIntoMirrorPatch,
      openFile: this.openFile,
      toggleFile: this.toggleFile,
      toggleRows: this.toggleRows,
      toggleModeChange: this.toggleModeChange,
      toggleSymlinkChange: this.toggleSymlinkChange,
      undoLastDiscard: this.undoLastDiscard,
      discardRows: this.discardRows,
      selectNextHunk: this.selectNextHunk,
      selectPreviousHunk: this.selectPreviousHunk,
      switchToIssueish: this.props.switchToIssueish
    }));
  }

  undoLastDiscard(filePatch, {
    eventSource
  } = {}) {
    (0, _reporterProxy.addEvent)('undo-last-discard', {
      package: 'github',
      component: this.constructor.name,
      eventSource
    });
    return this.props.undoLastDiscard(filePatch.getPath(), this.props.repository);
  }

  diveIntoMirrorPatch(filePatch) {
    const mirrorStatus = this.withStagingStatus({
      staged: 'unstaged',
      unstaged: 'staged'
    });
    const workingDirectory = this.props.repository.getWorkingDirectoryPath();

    const uri = _changedFileItem.default.buildURI(filePatch.getPath(), workingDirectory, mirrorStatus);

    this.props.destroy();
    return this.props.workspace.open(uri);
  }

  async openFile(filePatch, positions, pending) {
    const absolutePath = _path.default.join(this.props.repository.getWorkingDirectoryPath(), filePatch.getPath());

    const editor = await this.props.workspace.open(absolutePath, {
      pending
    });

    if (positions.length > 0) {
      editor.setCursorBufferPosition(positions[0], {
        autoscroll: false
      });

      for (const position of positions.slice(1)) {
        editor.addCursorAtBufferPosition(position);
      }

      editor.scrollToBufferPosition(positions[positions.length - 1], {
        center: true
      });
    }

    return editor;
  }

  toggleFile(filePatch) {
    return this.stagingOperation(() => {
      const methodName = this.withStagingStatus({
        staged: 'unstageFiles',
        unstaged: 'stageFiles'
      });
      return this.props.repository[methodName]([filePatch.getPath()]);
    });
  }

  async toggleRows(rowSet, nextSelectionMode) {
    let chosenRows = rowSet;

    if (chosenRows) {
      const nextMultipleFileSelections = this.props.multiFilePatch.spansMultipleFiles(chosenRows);
      await this.selectedRowsChanged(chosenRows, nextSelectionMode, nextMultipleFileSelections);
    } else {
      chosenRows = this.state.selectedRows;
    }

    if (chosenRows.size === 0) {
      return Promise.resolve();
    }

    return this.stagingOperation(() => {
      const patch = this.withStagingStatus({
        staged: () => this.props.multiFilePatch.getUnstagePatchForLines(chosenRows),
        unstaged: () => this.props.multiFilePatch.getStagePatchForLines(chosenRows)
      });
      return this.props.repository.applyPatchToIndex(patch);
    });
  }

  toggleModeChange(filePatch) {
    return this.stagingOperation(() => {
      const targetMode = this.withStagingStatus({
        unstaged: filePatch.getNewMode(),
        staged: filePatch.getOldMode()
      });
      return this.props.repository.stageFileModeChange(filePatch.getPath(), targetMode);
    });
  }

  toggleSymlinkChange(filePatch) {
    return this.stagingOperation(() => {
      const relPath = filePatch.getPath();
      const repository = this.props.repository;
      return this.withStagingStatus({
        unstaged: () => {
          if (filePatch.hasTypechange() && filePatch.getStatus() === 'added') {
            return repository.stageFileSymlinkChange(relPath);
          }

          return repository.stageFiles([relPath]);
        },
        staged: () => {
          if (filePatch.hasTypechange() && filePatch.getStatus() === 'deleted') {
            return repository.stageFileSymlinkChange(relPath);
          }

          return repository.unstageFiles([relPath]);
        }
      });
    });
  }

  async discardRows(rowSet, nextSelectionMode, {
    eventSource
  } = {}) {
    // (kuychaco) For now we only support discarding rows for MultiFilePatches that contain a single file patch
    // The only way to access this method from the UI is to be in a ChangedFileItem, which only has a single file patch
    // This check is duplicated in RootController#discardLines. We also want it here to prevent us from sending metrics
    // unnecessarily
    if (this.props.multiFilePatch.getFilePatches().length !== 1) {
      return Promise.resolve(null);
    }

    let chosenRows = rowSet;

    if (chosenRows) {
      const nextMultipleFileSelections = this.props.multiFilePatch.spansMultipleFiles(chosenRows);
      await this.selectedRowsChanged(chosenRows, nextSelectionMode, nextMultipleFileSelections);
    } else {
      chosenRows = this.state.selectedRows;
    }

    (0, _reporterProxy.addEvent)('discard-unstaged-changes', {
      package: 'github',
      component: this.constructor.name,
      lineCount: chosenRows.size,
      eventSource
    });
    return this.props.discardLines(this.props.multiFilePatch, chosenRows, this.props.repository);
  }

  selectedRowsChanged(rows, nextSelectionMode, nextMultipleFileSelections) {
    if ((0, _helpers.equalSets)(this.state.selectedRows, rows) && this.state.selectionMode === nextSelectionMode && this.state.hasMultipleFileSelections === nextMultipleFileSelections) {
      return Promise.resolve();
    }

    return new Promise(resolve => {
      this.setState({
        selectedRows: rows,
        selectionMode: nextSelectionMode,
        hasMultipleFileSelections: nextMultipleFileSelections
      }, resolve);
    });
  }

  withStagingStatus(callbacks) {
    const callback = callbacks[this.props.stagingStatus];
    /* istanbul ignore if */

    if (!callback) {
      throw new Error(`Unknown staging status: ${this.props.stagingStatus}`);
    }

    return callback instanceof Function ? callback() : callback;
  }

  stagingOperation(fn) {
    if (this.stagingOperationInProgress) {
      return null;
    }

    this.stagingOperationInProgress = true;
    this.lastPatchString = this.props.multiFilePatch.toString();
    const operationPromise = fn();
    operationPromise.then(() => this.patchChangePromise).then(() => {
      this.stagingOperationInProgress = false;
      this.lastPatchString = null;
    });
    return operationPromise;
  }

}

exports.default = MultiFilePatchController;

_defineProperty(MultiFilePatchController, "propTypes", {
  repository: _propTypes.default.object.isRequired,
  stagingStatus: _propTypes.default.oneOf(['staged', 'unstaged']),
  multiFilePatch: _propTypes2.MultiFilePatchPropType.isRequired,
  hasUndoHistory: _propTypes.default.bool,
  reviewCommentsLoading: _propTypes.default.bool,
  reviewCommentThreads: _propTypes.default.arrayOf(_propTypes.default.shape({
    thread: _propTypes.default.object.isRequired,
    comments: _propTypes.default.arrayOf(_propTypes.default.object).isRequired
  })),
  workspace: _propTypes.default.object.isRequired,
  commands: _propTypes.default.object.isRequired,
  keymaps: _propTypes.default.object.isRequired,
  tooltips: _propTypes.default.object.isRequired,
  config: _propTypes.default.object.isRequired,
  destroy: _propTypes.default.func.isRequired,
  discardLines: _propTypes.default.func,
  undoLastDiscard: _propTypes.default.func,
  surface: _propTypes.default.func,
  switchToIssueish: _propTypes.default.func
});
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uL2xpYi9jb250cm9sbGVycy9tdWx0aS1maWxlLXBhdGNoLWNvbnRyb2xsZXIuanMiXSwibmFtZXMiOlsiTXVsdGlGaWxlUGF0Y2hDb250cm9sbGVyIiwiUmVhY3QiLCJDb21wb25lbnQiLCJjb25zdHJ1Y3RvciIsInByb3BzIiwic3RhdGUiLCJzZWxlY3Rpb25Nb2RlIiwic2VsZWN0ZWRSb3dzIiwiU2V0IiwiaGFzTXVsdGlwbGVGaWxlU2VsZWN0aW9ucyIsIm1vdXNlU2VsZWN0aW9uSW5Qcm9ncmVzcyIsInN0YWdpbmdPcGVyYXRpb25JblByb2dyZXNzIiwibGFzdFBhdGNoU3RyaW5nIiwicGF0Y2hDaGFuZ2VQcm9taXNlIiwiUHJvbWlzZSIsInJlc29sdmUiLCJyZXNvbHZlUGF0Y2hDaGFuZ2VQcm9taXNlIiwiY29tcG9uZW50RGlkVXBkYXRlIiwicHJldlByb3BzIiwibXVsdGlGaWxlUGF0Y2giLCJ0b1N0cmluZyIsInJlbmRlciIsInNlbGVjdGVkUm93c0NoYW5nZWQiLCJkaXZlSW50b01pcnJvclBhdGNoIiwib3BlbkZpbGUiLCJ0b2dnbGVGaWxlIiwidG9nZ2xlUm93cyIsInRvZ2dsZU1vZGVDaGFuZ2UiLCJ0b2dnbGVTeW1saW5rQ2hhbmdlIiwidW5kb0xhc3REaXNjYXJkIiwiZGlzY2FyZFJvd3MiLCJzZWxlY3ROZXh0SHVuayIsInNlbGVjdFByZXZpb3VzSHVuayIsInN3aXRjaFRvSXNzdWVpc2giLCJmaWxlUGF0Y2giLCJldmVudFNvdXJjZSIsInBhY2thZ2UiLCJjb21wb25lbnQiLCJuYW1lIiwiZ2V0UGF0aCIsInJlcG9zaXRvcnkiLCJtaXJyb3JTdGF0dXMiLCJ3aXRoU3RhZ2luZ1N0YXR1cyIsInN0YWdlZCIsInVuc3RhZ2VkIiwid29ya2luZ0RpcmVjdG9yeSIsImdldFdvcmtpbmdEaXJlY3RvcnlQYXRoIiwidXJpIiwiQ2hhbmdlZEZpbGVJdGVtIiwiYnVpbGRVUkkiLCJkZXN0cm95Iiwid29ya3NwYWNlIiwib3BlbiIsInBvc2l0aW9ucyIsInBlbmRpbmciLCJhYnNvbHV0ZVBhdGgiLCJwYXRoIiwiam9pbiIsImVkaXRvciIsImxlbmd0aCIsInNldEN1cnNvckJ1ZmZlclBvc2l0aW9uIiwiYXV0b3Njcm9sbCIsInBvc2l0aW9uIiwic2xpY2UiLCJhZGRDdXJzb3JBdEJ1ZmZlclBvc2l0aW9uIiwic2Nyb2xsVG9CdWZmZXJQb3NpdGlvbiIsImNlbnRlciIsInN0YWdpbmdPcGVyYXRpb24iLCJtZXRob2ROYW1lIiwicm93U2V0IiwibmV4dFNlbGVjdGlvbk1vZGUiLCJjaG9zZW5Sb3dzIiwibmV4dE11bHRpcGxlRmlsZVNlbGVjdGlvbnMiLCJzcGFuc011bHRpcGxlRmlsZXMiLCJzaXplIiwicGF0Y2giLCJnZXRVbnN0YWdlUGF0Y2hGb3JMaW5lcyIsImdldFN0YWdlUGF0Y2hGb3JMaW5lcyIsImFwcGx5UGF0Y2hUb0luZGV4IiwidGFyZ2V0TW9kZSIsImdldE5ld01vZGUiLCJnZXRPbGRNb2RlIiwic3RhZ2VGaWxlTW9kZUNoYW5nZSIsInJlbFBhdGgiLCJoYXNUeXBlY2hhbmdlIiwiZ2V0U3RhdHVzIiwic3RhZ2VGaWxlU3ltbGlua0NoYW5nZSIsInN0YWdlRmlsZXMiLCJ1bnN0YWdlRmlsZXMiLCJnZXRGaWxlUGF0Y2hlcyIsImxpbmVDb3VudCIsImRpc2NhcmRMaW5lcyIsInJvd3MiLCJzZXRTdGF0ZSIsImNhbGxiYWNrcyIsImNhbGxiYWNrIiwic3RhZ2luZ1N0YXR1cyIsIkVycm9yIiwiRnVuY3Rpb24iLCJmbiIsIm9wZXJhdGlvblByb21pc2UiLCJ0aGVuIiwiUHJvcFR5cGVzIiwib2JqZWN0IiwiaXNSZXF1aXJlZCIsIm9uZU9mIiwiTXVsdGlGaWxlUGF0Y2hQcm9wVHlwZSIsImhhc1VuZG9IaXN0b3J5IiwiYm9vbCIsInJldmlld0NvbW1lbnRzTG9hZGluZyIsInJldmlld0NvbW1lbnRUaHJlYWRzIiwiYXJyYXlPZiIsInNoYXBlIiwidGhyZWFkIiwiY29tbWVudHMiLCJjb21tYW5kcyIsImtleW1hcHMiLCJ0b29s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O0FBQ3REQyxJQUFBQSxNQUFNLEVBQUVYLG1CQUFVQyxNQUFWLENBQWlCQyxVQUQ2QjtBQUV0RFUsSUFBQUEsUUFBUSxFQUFFWixtQkFBVVMsT0FBVixDQUFrQlQsbUJBQVVDLE1BQTVCLEVBQW9DQztBQUZRLEdBQWhCLENBQWxCLENBUEw7QUFZakJyRCxFQUFBQSxTQUFTLEVBQUVtRCxtQkFBVUMsTUFBVixDQUFpQkMsVUFaWDtBQWFqQlcsRUFBQUEsUUFBUSxFQUFFYixtQkFBVUMsTUFBVixDQUFpQkMsVUFiVjtBQWNqQlksRUFBQUEsT0FBTyxFQUFFZCxtQkFBVUMsTUFBVixDQUFpQkMsVUFkVDtBQWVqQmEsRUFBQUEsUUFBUSxFQUFFZixtQkFBVUMsTUFBVixDQUFpQkMsVUFmVjtBQWdCakJjLEVBQUFBLE1BQU0sRUFBRWhCLG1CQUFVQyxNQUFWLENBQWlCQyxVQWhCUjtBQWtCakJ0RCxFQUFBQSxPQUFPLEVBQUVvRCxtQkFBVWlCLElBQVYsQ0FBZWYsVUFsQlA7QUFtQmpCYixFQUFBQSxZQUFZLEVBQUVXLG1CQUFVaUIsSUFuQlA7QUFvQmpCMUYsRUFBQUEsZUFBZSxFQUFFeUUsbUJBQVVpQixJQXBCVjtBQXFCakJDLEVBQUFBLE9BQU8sRUFBRWxCLG1CQUFVaUIsSUFyQkY7QUFzQmpCdEYsRUFBQUEsZ0JBQWdCLEVBQUVxRSxtQkFBVWlCO0FBdEJYLEMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgUmVhY3QgZnJvbSAncmVhY3QnO1xuaW1wb3J0IFByb3BUeXBlcyBmcm9tICdwcm9wLXR5cGVzJztcbmltcG9ydCBwYXRoIGZyb20gJ3BhdGgnO1xuXG5pbXBvcnQge2F1dG9iaW5kLCBlcXVhbFNldHN9IGZyb20gJy4uL2hlbHBlcnMnO1xuaW1wb3J0IHthZGRFdmVudH0gZnJvbSAnLi4vcmVwb3J0ZXItcHJveHknO1xuaW1wb3J0IHtNdWx0aUZpbGVQYXRjaFByb3BUeXBlfSBmcm9tICcuLi9wcm9wLXR5cGVzJztcbmltcG9ydCBDaGFuZ2VkRmlsZUl0ZW0gZnJvbSAnLi4vaXRlbXMvY2hhbmdlZC1maWxlLWl0ZW0nO1xuaW1wb3J0IE11bHRpRmlsZVBhdGNoVmlldyBmcm9tICcuLi92aWV3cy9tdWx0aS1maWxlLXBhdGNoLXZpZXcnO1xuXG5leHBvcnQgZGVmYXVsdCBjbGFzcyBNdWx0aUZpbGVQYXRjaENvbnRyb2xsZXIgZXh0ZW5kcyBSZWFjdC5Db21wb25lbnQge1xuICBzdGF0aWMgcHJvcFR5cGVzID0ge1xuICAgIHJlcG9zaXRvcnk6IFByb3BUeXBlcy5vYmplY3QuaXNSZXF1aXJlZCxcbiAgICBzdGFnaW5nU3RhdHVzOiBQcm9wVHlwZXMub25lT2YoWydzdGFnZWQnLCAndW5zdGFnZWQnXSksXG4gICAgbXVsdGlGaWxlUGF0Y2g6IE11bHRpRmlsZVBhdGNoUHJvcFR5cGUuaXNSZXF1aXJlZCxcbiAgICBoYXNVbmRvSGlzdG9yeTogUHJvcFR5cGVzLmJvb2wsXG5cbiAgICByZXZpZXdDb21tZW50c0xvYWRpbmc6IFByb3BUeXBlcy5ib29sLFxuICAgIHJldmlld0NvbW1lbnRUaHJlYWRzOiBQcm9wVHlwZXMuYXJyYXlPZihQcm9wVHlwZXMuc2hhcGUoe1xuICAgICAgdGhyZWFkOiBQcm9wVHlwZXMub2JqZWN0LmlzUmVxdWlyZWQsXG4gICAgICBjb21tZW50czogUHJvcFR5cGVzLmFycmF5T2YoUHJvcFR5cGVzLm9iamVjdCkuaXNSZXF1aXJlZCxcbiAgICB9KSksXG5cbiAgICB3b3Jrc3BhY2U6IFByb3BUeXBlcy5vYmplY3QuaXNSZXF1aXJlZCxcbiAgICBjb21tYW5kczogUHJvcFR5cGVzLm9iamVjdC5pc1JlcXVpcmVkLFxuICAgIGtleW1hcHM6IFByb3BUeXBlcy5vYmplY3QuaXNSZXF1aXJlZCxcbiAgICB0b29sdGlwczogUHJvcFR5cGVzLm9iamVjdC5pc1JlcXVpcmVkLFxuICAgIGNvbmZpZzogUHJvcFR5cGVzLm9iamVjdC5pc1JlcXVpcmVkLFxuXG4gICAgZGVzdHJveTogUHJvcFR5cGVzLmZ1bmMuaXNSZXF1aXJlZCxcbiAgICBkaXNjYXJkTGluZXM6IFByb3BUeXBlcy5mdW5jLFxuICAgIHVuZG9MYXN0RGlzY2FyZDogUHJvcFR5cGVzLmZ1bmMsXG4gICAgc3VyZmFjZTogUHJvcFR5cGVzLmZ1bmMsXG4gICAgc3dpdGNoVG9Jc3N1ZWlzaDogUHJvcFR5cGVzLmZ1bmMsXG4gIH1cblxuICBjb25zdHJ1Y3Rvcihwcm9wcykge1xuICAgIHN1cGVyKHByb3BzKTtcbiAgICBhdXRvYmluZChcbiAgICAgIHRoaXMsXG4gICAgICAnc2VsZWN0ZWRSb3dzQ2hhbmdlZCcsXG4gICAgICAndW5kb0xhc3REaXNjYXJkJywgJ2RpdmVJbnRvTWlycm9yUGF0Y2gnLCAnb3BlbkZpbGUnLFxuICAgICAgJ3RvZ2dsZUZpbGUnLCAndG9nZ2xlUm93cycsICd0b2dnbGVNb2RlQ2hhbmdlJywgJ3RvZ2dsZVN5bWxpbmtDaGFuZ2UnLCAnZGlzY2FyZFJvd3MnLFxuICAgICk7XG5cbiAgICB0aGlzLnN0YXRlID0ge1xuICAgICAgc2VsZWN0aW9uTW9kZTogJ2h1bmsnLFxuICAgICAgc2VsZWN0ZWRSb3dzOiBuZXcgU2V0KCksXG4gICAgICBoYXNNdWx0aXBsZUZpbGVTZWxlY3Rpb25zOiBmYWxzZSxcbiAgICB9O1xuXG4gICAgdGhpcy5tb3VzZVNlbGVjdGlvbkluUHJvZ3Jlc3MgPSBmYWxzZTtcbiAgICB0aGlzLnN0YWdpbmdPcGVyYXRpb25JblByb2dyZXNzID0gZmFsc2U7XG5cbiAgICB0aGlzLmxhc3RQYXRjaFN0cmluZyA9IG51bGw7XG4gICAgdGhpcy5wYXRjaENoYW5nZVByb21pc2UgPSBuZXcgUHJvbWlzZShyZXNvbHZlID0+IHtcbiAgICAgIHRoaXMucmVzb2x2ZVBhdGNoQ2hhbmdlUHJvbWlzZSA9IHJlc29sdmU7XG4gICAgfSk7XG4gIH1cblxuICBjb21wb25lbnREaWRVcGRhdGUocHJldlByb3BzKSB7XG4gICAgaWYgKFxuICAgICAgdGhpcy5sYXN0UGF0Y2hTdHJpbmcgIT09IG51bGwgJiZcbiAgICAgIHRoaXMubGFzdFBhdGNoU3RyaW5nICE9PSB0aGlzLnByb3BzLm11bHRpRmlsZVBhdGNoLnRvU3RyaW5nKClcbiAgICApIHtcbiAgICAgIHRoaXMucmVzb2x2ZVBhdGNoQ2hhbmdlUHJvbWlzZSgpO1xuICAgICAgdGhpcy5wYXRjaENoYW5nZVByb21pc2UgPSBuZXcgUHJvbWlzZShyZXNvbHZlID0+IHtcbiAgICAgICAgdGhpcy5yZXNvbHZlUGF0Y2hDaGFuZ2VQcm9taXNlID0gcmVzb2x2ZTtcbiAgICAgIH0pO1xuICAgIH1cbiAgfVxuXG4gIHJlbmRlcigpIHtcbiAgICByZXR1cm4gKFxuICAgICAgPE11bHRpRmlsZVBhdGNoVmlld1xuICAgICAgICB7Li4udGhpcy5wcm9wc31cblxuICAgICAgICBzZWxlY3RlZFJvd3M9e3RoaXMuc3RhdGUuc2VsZWN0ZWRSb3dzfVxuICAgICAgICBzZWxlY3Rpb25Nb2RlPXt0aGlzLnN0YXRlLnNlbGVjdGlvbk1vZGV9XG4gICAgICAgIGhhc011bHRpcGxlRmlsZVNlbGVjdGlvbnM9e3RoaXMuc3RhdGUuaGFzTXVsdGlwbGVGaWxlU2VsZWN0aW9uc31cbiAgICAgICAgc2VsZWN0ZWRSb3dzQ2hhbmdlZD17dGhpcy5zZWxlY3RlZFJvd3NDaGFuZ2VkfVxuXG4gICAgICAgIGRpdmVJbnRvTWlycm9yUGF0Y2g9e3RoaXMuZGl2ZUludG9NaXJyb3JQYXRjaH1cbiAgICAgICAgb3BlbkZpbGU9e3RoaXMub3BlbkZpbGV9XG4gICAgICAgIHRvZ2dsZUZpbGU9e3RoaXMudG9nZ2xlRmlsZX1cbiAgICAgICAgdG9nZ2xlUm93cz17dGhpcy50b2dnbGVSb3dzfVxuICAgICAgICB0b2dnbGVNb2RlQ2hhbmdlPXt0aGlzLnRvZ2dsZU1vZGVDaGFuZ2V9XG4gICAgICAgIHRvZ2dsZVN5bWxpbmtDaGFuZ2U9e3RoaXMudG9nZ2xlU3ltbGlua0NoYW5nZX1cbiAgICAgICAgdW5kb0xhc3REaXNjYXJkPXt0aGlzLnVuZG9MYXN0RGlzY2FyZH1cbiAgICAgICAgZGlzY2FyZFJvd3M9e3RoaXMuZGlzY2FyZFJvd3N9XG4gICAgICAgIHNlbGVjdE5leHRIdW5rPXt0aGlzLnNlbGVjdE5leHRIdW5rfVxuICAgICAgICBzZWxlY3RQcmV2aW91c0h1bms9e3RoaXMuc2VsZWN0UHJldmlvdXNIdW5rfVxuICAgICAgICBzd2l0Y2hUb0lzc3VlaXNoPXt0aGlzLnByb3BzLnN3aXRjaFRvSXNzdWVpc2h9XG4gICAgICAvPlxuICAgICk7XG4gIH1cblxuICB1bmRvTGFzdERpc2NhcmQoZmlsZVBhdGNoLCB7ZXZlbnRTb3VyY2V9ID0ge30pIHtcbiAgICBhZGRFdmVudCgndW5kby1sYXN0LWRpc2NhcmQnLCB7XG4gICAgICBwYWNrYWdlOiAnZ2l0aHViJyxcbiAgICAgIGNvbXBvbmVudDogdGhpcy5jb25zdHJ1Y3Rvci5uYW1lLFxuICAgICAgZXZlbnRTb3VyY2UsXG4gICAgfSk7XG5cbiAgICByZXR1cm4gdGhpcy5wcm9wcy51bmRvTGFzdERpc2NhcmQoZmlsZVBhdGNoLmdldFBhdGgoKSwgdGhpcy5wcm9wcy5yZXBvc2l0b3J5KTtcbiAgfVxuXG4gIGRpdmVJbnRvTWlycm9yUGF0Y2goZmlsZVBhdGNoKSB7XG4gICAgY29uc3QgbWlycm9yU3RhdHVzID0gdGhpcy53aXRoU3RhZ2luZ1N0YXR1cyh7c3RhZ2VkOiAndW5zdGFnZWQnLCB1bnN0YWdlZDogJ3N0YWdlZCd9KTtcbiAgICBjb25zdCB3b3JraW5nRGlyZWN0b3J5ID0gdGhpcy5wcm9wcy5yZXBvc2l0b3J5LmdldFdvcmtpbmdEaXJlY3RvcnlQYXRoKCk7XG4gICAgY29uc3QgdXJpID0gQ2hhbmdlZEZpbGVJdGVtLmJ1aWxkVVJJKGZpbGVQYXRjaC5nZXRQYXRoKCksIHdvcmtpbmdEaXJlY3RvcnksIG1pcnJvclN0YXR1cyk7XG5cbiAgICB0aGlzLnByb3BzLmRlc3Ryb3koKTtcbiAgICByZXR1cm4gdGhpcy5wcm9wcy53b3Jrc3BhY2Uub3Blbih1cmkpO1xuICB9XG5cbiAgYXN5bmMgb3BlbkZpbGUoZmlsZVBhdGNoLCBwb3NpdGlvbnMsIHBlbmRpbmcpIHtcbiAgICBjb25zdCBhYnNvbHV0ZVBhdGggPSBwYXRoLmpvaW4odGhpcy5wcm9wcy5yZXBvc2l0b3J5LmdldFdvcmtpbmdEaXJlY3RvcnlQYXRoKCksIGZpbGVQYXRjaC5nZXRQYXRoKCkpO1xuICAgIGNvbnN0IGVkaXRvciA9IGF3YWl0IHRoaXMucHJvcHMud29ya3NwYWNlLm9wZW4oYWJzb2x1dGVQYXRoLCB7cGVuZGluZ30pO1xuICAgIGlmIChwb3NpdGlvbnMubGVuZ3RoID4gMCkge1xuICAgICAgZWRpdG9yLnNldEN1cnNvckJ1ZmZlclBvc2l0aW9uKHBvc2l0aW9uc1swXSwge2F1dG9zY3JvbGw6IGZhbHNlfSk7XG4gICAgICBmb3IgKGNvbnN0IHBvc2l0aW9uIG9mIHBvc2l0aW9ucy5zbGljZSgxKSkge1xuICAgICAgICBlZGl0b3IuYWRkQ3Vyc29yQXRCdWZmZXJQb3NpdGlvbihwb3NpdGlvbik7XG4gICAgICB9XG4gICAgICBlZGl0b3Iuc2Nyb2xsVG9CdWZmZXJQb3NpdGlvbihwb3NpdGlvbnNbcG9zaXRpb25zLmxlbmd0aCAtIDFdLCB7Y2VudGVyOiB0cnVlfSk7XG4gICAgfVxuICAgIHJldHVybiBlZGl0b3I7XG4gIH1cblxuICB0b2dnbGVGaWxlKGZpbGVQYXRjaCkge1xuICAgIHJldHVybiB0aGlzLnN0YWdpbmdPcGVyYXRpb24oKCkgPT4ge1xuICAgICAgY29uc3QgbWV0aG9kTmFtZSA9IHRoaXMud2l0aFN0YWdpbmdTdGF0dXMoe3N0YWdlZDogJ3Vuc3RhZ2VGaWxlcycsIHVuc3RhZ2VkOiAnc3RhZ2VGaWxlcyd9KTtcbiAgICAgIHJldHVybiB0aGlzLnByb3BzLnJlcG9zaXRvcnlbbWV0aG9kTmFtZV0oW2ZpbGVQYXRjaC5nZXRQYXRoKCldKTtcbiAgICB9KTtcbiAgfVxuXG4gIGFzeW5jIHRvZ2dsZVJvd3Mocm93U2V0LCBuZXh0U2VsZWN0aW9uTW9kZSkge1xuICAgIGxldCBjaG9zZW5Sb3dzID0gcm93U2V0O1xuICAgIGlmIChjaG9zZW5Sb3dzKSB7XG4gICAgICBjb25zdCBuZXh0TXVsdGlwbGVGaWxlU2VsZWN0aW9ucyA9IHRoaXMucHJvcHMubXVsdGlGaWxlUGF0Y2guc3BhbnNNdWx0aXBsZUZpbGVzKGNob3NlblJvd3MpO1xuICAgICAgYXdhaXQgdGhpcy5zZWxlY3RlZFJvd3NDaGFuZ2VkKGNob3NlblJvd3MsIG5leHRTZWxlY3Rpb25Nb2RlLCBuZXh0TXVsdGlwbGVGaWxlU2VsZWN0aW9ucyk7XG4gICAgfSBlbHNlIHtcbiAgICAgIGNob3NlblJvd3MgPSB0aGlzLnN0YXRlLnNlbGVjdGVkUm93cztcbiAgICB9XG5cbiAgICBpZiAoY2hvc2VuUm93cy5zaXplID09PSAwKSB7XG4gICAgICByZXR1cm4gUHJvbWlzZS5yZXNvbHZlKCk7XG4gICAgfVxuXG4gICAgcmV0dXJuIHRoaXMuc3RhZ2luZ09wZXJhdGlvbigoKSA9PiB7XG4gICAgICBjb25zdCBwYXRjaCA9IHRoaXMud2l0aFN0YWdpbmdTdGF0dXMoe1xuICAgICAgICBzdGFnZWQ6ICgpID0+IHRoaXMucHJvcHMubXVsdGlGaWxlUGF0Y2guZ2V0VW5zdGFnZVBhdGNoRm9yTGluZXMoY2hvc2VuUm93cyksXG4gICAgICAgIHVuc3RhZ2VkOiAoKSA9PiB0aGlzLnByb3BzLm11bHRpRmlsZVBhdGNoLmdldFN0YWdlUGF0Y2hGb3JMaW5lcyhjaG9zZW5Sb3dzKSxcbiAgICAgIH0pO1xuICAgICAgcmV0dXJuIHRoaXMucHJvcHMucmVwb3NpdG9yeS5hcHBseVBhdGNoVG9JbmRleChwYXRjaCk7XG4gICAgfSk7XG4gIH1cblxuICB0b2dnbGVNb2RlQ2hhbmdlKGZpbGVQYXRjaCkge1xuICAgIHJldHVybiB0aGlzLnN0YWdpbmdPcGVyYXRpb24oKCkgPT4ge1xuICAgICAgY29uc3QgdGFyZ2V0TW9kZSA9IHRoaXMud2l0aFN0YWdpbmdTdGF0dXMoe1xuICAgICAgICB1bnN0YWdlZDogZmlsZVBhdGNoLmdldE5ld01vZGUoKSxcbiAgICAgICAgc3RhZ2VkOiBmaWxlUGF0Y2guZ2V0T2xkTW9kZSgpLFxuICAgICAgfSk7XG4gICAgICByZXR1cm4gdGhpcy5wcm9wcy5yZXBvc2l0b3J5LnN0YWdlRmlsZU1vZGVDaGFuZ2UoZmlsZVBhdGNoLmdldFBhdGgoKSwgdGFyZ2V0TW9kZSk7XG4gICAgfSk7XG4gIH1cblxuICB0b2dnbGVTeW1saW5rQ2hhbmdlKGZpbGVQYXRjaCkge1xuICAgIHJldHVybiB0aGlzLnN0YWdpbmdPcGVyYXRpb24oKCkgPT4ge1xuICAgICAgY29uc3QgcmVsUGF0aCA9IGZpbGVQYXRjaC5nZXRQYXRoKCk7XG4gICAgICBjb25zdCByZXBvc2l0b3J5ID0gdGhpcy5wcm9wcy5yZXBvc2l0b3J5O1xuICAgICAgcmV0dXJuIHRoaXMud2l0aFN0YWdpbmdTdGF0dXMoe1xuICAgICAgICB1bnN0YWdlZDogKCkgPT4ge1xuICAgICAgICAgIGlmIChmaWxlUGF0Y2guaGFzVHlwZWNoYW5nZSgpICYmIGZpbGVQYXRjaC5nZXRTdGF0dXMoKSA9PT0gJ2FkZGVkJykge1xuICAgICAgICAgICAgcmV0dXJuIHJlcG9zaXRvcnkuc3RhZ2VGaWxlU3ltbGlua0NoYW5nZShyZWxQYXRoKTtcbiAgICAgICAgICB9XG5cbiAgICAgICAgICByZXR1cm4gcmVwb3NpdG9yeS5zdGFnZUZpbGVzKFtyZWxQYXRoXSk7XG4gICAgICAgIH0sXG4gICAgICAgIHN0YWdlZDogKCkgPT4ge1xuICAgICAgICAgIGlmIChmaWxlUGF0Y2guaGFzVHlwZWNoYW5nZSgpICYmIGZpbGVQYXRjaC5nZXRTdGF0dXMoKSA9PT0gJ2RlbGV0ZWQnKSB7XG4gICAgICAgICAgICByZXR1cm4gcmVwb3NpdG9yeS5zdGFnZUZpbGVTeW1saW5rQ2hhbmdlKHJlbFBhdGgpO1xuICAgICAgICAgIH1cblxuICAgICAgICAgIHJldHVybiByZXBvc2l0b3J5LnVuc3RhZ2VGaWxlcyhbcmVsUGF0aF0pO1xuICAgICAgICB9LFxuICAgICAgfSk7XG4gICAgfSk7XG4gIH1cblxuICBhc3luYyBkaXNjYXJkUm93cyhyb3dTZXQsIG5leHRTZWxlY3Rpb25Nb2RlLCB7ZXZlbnRTb3VyY2V9ID0ge30pIHtcbiAgICAvLyAoa3V5Y2hhY28pIEZvciBub3cgd2Ugb25seSBzdXBwb3J0IGRpc2NhcmRpbmcgcm93cyBmb3IgTXVsdGlGaWxlUGF0Y2hlcyB0aGF0IGNvbnRhaW4gYSBzaW5nbGUgZmlsZSBwYXRjaFxuICAgIC8vIFRoZSBvbmx5IHdheSB0byBhY2Nlc3MgdGhpcyBtZXRob2QgZnJvbSB0aGUgVUkgaXMgdG8gYmUgaW4gYSBDaGFuZ2VkRmlsZUl0ZW0sIHdoaWNoIG9ubHkgaGFzIGEgc2luZ2xlIGZpbGUgcGF0Y2hcbiAgICAvLyBUaGlzIGNoZWNrIGlzIGR1cGxpY2F0ZWQgaW4gUm9vdENvbnRyb2xsZXIjZGlzY2FyZExpbmVzLiBXZSBhbHNvIHdhbnQgaXQgaGVyZSB0byBwcmV2ZW50IHVzIGZyb20gc2VuZGluZyBtZXRyaWNzXG4gICAgLy8gdW5uZWNlc3NhcmlseVxuICAgIGlmICh0aGlzLnByb3BzLm11bHRpRmlsZVBhdGNoLmdldEZpbGVQYXRjaGVzKCkubGVuZ3RoICE9PSAxKSB7XG4gICAgICByZXR1cm4gUHJvbWlzZS5yZXNvbHZlKG51bGwpO1xuICAgIH1cblxuICAgIGxldCBjaG9zZW5Sb3dzID0gcm93U2V0O1xuICAgIGlmIChjaG9zZW5Sb3dzKSB7XG4gICAgICBjb25zdCBuZXh0TXVsdGlwbGVGaWxlU2VsZWN0aW9ucyA9IHRoaXMucHJvcHMubXVsdGlGaWxlUGF0Y2guc3BhbnNNdWx0aXBsZUZpbGVzKGNob3NlblJvd3MpO1xuICAgICAgYXdhaXQgdGhpcy5zZWxlY3RlZFJvd3NDaGFuZ2VkKGNob3NlblJvd3MsIG5leHRTZWxlY3Rpb25Nb2RlLCBuZXh0TXVsdGlwbGVGaWxlU2VsZWN0aW9ucyk7XG4gICAgfSBlbHNlIHtcbiAgICAgIGNob3NlblJvd3MgPSB0aGlzLnN0YXRlLnNlbGVjdGVkUm93cztcbiAgICB9XG5cbiAgICBhZGRFdmVudCgnZGlzY2FyZC11bnN0YWdlZC1jaGFuZ2VzJywge1xuICAgICAgcGFja2FnZTogJ2dpdGh1YicsXG4gICAgICBjb21wb25lbnQ6IHRoaXMuY29uc3RydWN0b3IubmFtZSxcbiAgICAgIGxpbmVDb3VudDogY2hvc2VuUm93cy5zaXplLFxuICAgICAgZXZlbnRTb3VyY2UsXG4gICAgfSk7XG5cbiAgICByZXR1cm4gdGhpcy5wcm9wcy5kaXNjYXJkTGluZXModGhpcy5wcm9wcy5tdWx0aUZpbGVQYXRjaCwgY2hvc2VuUm93cywgdGhpcy5wcm9wcy5yZXBvc2l0b3J5KTtcbiAgfVxuXG4gIHNlbGVjdGVkUm93c0NoYW5nZWQocm93cywgbmV4dFNlbGVjdGlvbk1vZGUsIG5leHRNdWx0aXBsZUZpbGVTZWxlY3Rpb25zKSB7XG4gICAgaWYgKFxuICAgICAgZXF1YWxTZXRzKHRoaXMuc3RhdGUuc2VsZWN0ZWRSb3dzLCByb3dzKSAmJlxuICAgICAgdGhpcy5zdGF0ZS5zZWxlY3Rpb25Nb2RlID09PSBuZXh0U2VsZWN0aW9uTW9kZSAmJlxuICAgICAgdGhpcy5zdGF0ZS5oYXNNdWx0aXBsZUZpbGVTZWxlY3Rpb25zID09PSBuZXh0TXVsdGlwbGVGaWxlU2VsZWN0aW9uc1xuICAgICkge1xuICAgICAgcmV0dXJuIFByb21pc2UucmVzb2x2ZSgpO1xuICAgIH1cblxuICAgIHJldHVybiBuZXcgUHJvbWlzZShyZXNvbHZlID0+IHtcbiAgICAgIHRoaXMuc2V0U3RhdGUoe1xuICAgICAgICBzZWxlY3RlZFJvd3M6IHJvd3MsXG4gICAgICAgIHNlbGVjdGlvbk1vZGU6IG5leHRTZWxlY3Rpb25Nb2RlLFxuICAgICAgICBoYXNNdWx0aXBsZUZpbGVTZWxlY3Rpb25zOiBuZXh0TXVsdGlwbGVGaWxlU2VsZWN0aW9ucyxcbiAgICAgIH0sIHJlc29sdmUpO1xuICAgIH0pO1xuICB9XG5cbiAgd2l0aFN0YWdpbmdTdGF0dXMoY2FsbGJhY2tzKSB7XG4gICAgY29uc3QgY2FsbGJhY2sgPSBjYWxsYmFja3NbdGhpcy5wcm9wcy5zdGFnaW5nU3RhdHVzXTtcbiAgICAvKiBpc3RhbmJ1bCBpZ25vcmUgaWYgKi9cbiAgICBpZiAoIWNhbGxiYWNrKSB7XG4gICAgICB0aHJvdyBuZXcgRXJyb3IoYFVua25vd24gc3RhZ2luZyBzdGF0dXM6ICR7dGhpcy5wcm9wcy5zdGFnaW5nU3RhdHVzfWApO1xuICAgIH1cbiAgICByZXR1cm4gY2FsbGJhY2sgaW5zdGFuY2VvZiBGdW5jdGlvbiA/IGNhbGxiYWNrKCkgOiBjYWxsYmFjaztcbiAgfVxuXG4gIHN0YWdpbmdPcGVyYXRpb24oZm4pIHtcbiAgICBpZiAodGhpcy5zdGFnaW5nT3BlcmF0aW9uSW5Qcm9ncmVzcykge1xuICAgICAgcmV0dXJuIG51bGw7XG4gICAgfVxuXG4gICAgdGhpcy5zdGFnaW5nT3BlcmF0aW9uSW5Qcm9ncmVzcyA9IHRydWU7XG4gICAgdGhpcy5sYXN0UGF0Y2hTdHJpbmcgPSB0aGlzLnByb3BzLm11bHRpRmlsZVBhdGNoLnRvU3RyaW5nKCk7XG4gICAgY29uc3Qgb3BlcmF0aW9uUHJvbWlzZSA9IGZuKCk7XG5cbiAgICBvcGVyYXRpb25Qcm9taXNlXG4gICAgICAudGhlbigoKSA9PiB0aGlzLnBhdGNoQ2hhbmdlUHJvbWlzZSlcbiAgICAgIC50aGVuKCgpID0+IHtcbiAgICAgICAgdGhpcy5zdGFnaW5nT3BlcmF0aW9uSW5Qcm9ncmVzcyA9IGZhbHNlO1xuICAgICAgICB0aGlzLmxhc3RQYXRjaFN0cmluZyA9IG51bGw7XG4gICAgICB9KTtcblxuICAgIHJldHVybiBvcGVyYXRpb25Qcm9taXNlO1xuICB9XG59XG4iXX0=