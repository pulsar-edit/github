"use strict";

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.expectRelayQuery = expectRelayQuery;
exports.clearRelayExpectations = clearRelayExpectations;
exports.default = void 0;

var _util = _interopRequireDefault(require("util"));

var _relayRuntime = require("relay-runtime");

var _moment = _interopRequireDefault(require("moment"));

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }

const LODASH_ISEQUAL = 'lodash.isequal';
let isEqual = null;
const relayEnvironmentPerURL = new Map();
const tokenPerURL = new Map();
const fetchPerURL = new Map();
const responsesByQuery = new Map();

function logRatelimitApi(headers) {
  const remaining = headers.get('x-ratelimit-remaining');
  const total = headers.get('x-ratelimit-limit');
  const resets = headers.get('x-ratelimit-reset');

  const resetsIn = _moment.default.unix(parseInt(resets, 10)).from(); // eslint-disable-next-line no-console


  console.debug(`GitHub API Rate Limiting Info: ${remaining}/${total} requests left â€” resets ${resetsIn}`);
}

function expectRelayQuery(operationPattern, response) {
  let resolve, reject;
  const handler = typeof response === 'function' ? response : () => ({
    data: response
  });
  const promise = new Promise((resolve0, reject0) => {
    resolve = resolve0;
    reject = reject0;
  });
  const existing = responsesByQuery.get(operationPattern.name) || [];
  existing.push({
    promise,
    handler,
    variables: operationPattern.variables || {},
    trace: operationPattern.trace
  });
  responsesByQuery.set(operationPattern.name, existing);

  const disable = () => responsesByQuery.delete(operationPattern.name);

  return {
    promise,
    resolve,
    reject,
    disable
  };
}

function clearRelayExpectations() {
  responsesByQuery.clear();
  relayEnvironmentPerURL.clear();
  tokenPerURL.clear();
  fetchPerURL.clear();
  responsesByQuery.clear();
}

function createFetchQuery(url) {
  if (atom.inSpecMode()) {
    return function specFetchQuery(operation, variables, _cacheConfig, _uploadables) {
      const expectations = responsesByQuery.get(operation.name) || [];
      const match = expectations.find(expectation => {
        if (isEqual === null) {
          // Lazily require lodash.isequal so we can keep it as a dev dependency.
          // Require indirectly to trick electron-link into not following this.
          isEqual = require(LODASH_ISEQUAL);
        }

        return isEqual(expectation.variables, variables);
      });

      if (!match) {
        // eslint-disable-next-line no-console
        console.log(`GraphQL query ${operation.name} was:\n  ${operation.text.replace(/\n/g, '\n  ')}\n` + _util.default.inspect(variables));
        const e = new Error(`Unexpected GraphQL query: ${operation.name}`);
        e.rawStack = e.stack;
        throw e;
      }

      const responsePromise = match.promise.then(() => {
        return match.handler(operation);
      });

      if (match.trace) {
        // eslint-disable-next-line no-console
        console.log(`[Relay] query "${operation.name}":\n${operation.text}`);
        responsePromise.then(result => {
          // eslint-disable-next-line no-console
          console.log(`[Relay] response "${operation.name}":`, result);
        }, err => {
          // eslint-disable-next-line no-console
          console.error(`[Relay] error "${operation.name}":\n${err.stack || err}`);
          throw err;
        });
      }

      return responsePromise;
    };
  }

  return async function fetchQuery(operation, variables, _cacheConfig, _uploadables) {
    const currentToken = tokenPerURL.get(url);
    let response;

    try {
      response = await fetch(url, {
        method: 'POST',
        headers: {
          'content-type': 'application/json',
          'Authorization': `bearer ${currentToken}`,
          'Accept': 'application/vnd.github.antiope-preview+json'
        },
        body: JSON.stringify({
          query: operation.text,
          variables
        })
      });
    } catch (e) {
      // A network error was encountered. Mark it so that QueryErrorView and ErrorView can distinguish these, because
      // the errors from "fetch" are TypeErrors without much information.
      e.network = true;
      e.rawStack = e.stack;
      throw e;
    }

    try {
      atom && atom.inDevMode() && logRatelimitApi(response.headers);
    } catch (_e) {
      /* do nothing */
    }

    if (response.status !== 200) {
      const e = new Error(`GraphQL API endpoint at ${url} returned ${response.status}`);
      e.response = response;
      e.responseText = await response.text();
      e.rawStack = e.stack;
      throw e;
    }

    const payload = await response.json();

    if (payload && payload.errors && payload.errors.length > 0) {
      const e = new Error(`GraphQL API endpoint at ${url} returned an error for query ${operation.name}.`);
      e.response = response;
      e.errors = payload.errors;
      e.rawStack = e.stack;
      throw e;
    }

    return payload;
  };
}

class RelayNetworkLayerManager {
  static getEnvironmentForHost(endpoint, token) {
    const url = endpoint.getGraphQLRoot();
    let {
      environment,
      network
    } = relayEnvironmentPerURL.get(url) || {};
    tokenPerURL.set(url, token);

    if (!environment) {
      if (!token) {
        throw new Error(`You must authenticate to ${endpoint.getHost()} first.`);
      }

      const source = new _relayRuntime.RecordSource();
      const store = new _relayRuntime.Store(source);
      network = _relayRuntime.Network.create(this.getFetchQuery(endpoint, token));
      environment = new _relayRuntime.Environment({
        network,
        store
      });
      relayEnvironmentPerURL.set(url, {
        environment,
        network
      });
    }

    return environment;
  }

  static getFetchQuery(endpoint, token) {
    const url = endpoint.getGraphQLRoot();
    tokenPerURL.set(url, token);
    let fetch = fetchPerURL.get(url);

    if (!fetch) {
      fetch = createFetchQuery(url);
      fetchPerURL.set(fetch);
    }

    return fetch;
  }

}

exports.default = RelayNetworkLayerManager;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uL2xpYi9yZWxheS1uZXR3b3JrLWxheWVyLW1hbmFnZXIuanMiXSwibmFtZXMiOlsiTE9EQVNIX0lTRVFVQUwiLCJpc0VxdWFsIiwicmVsYXlFbnZpcm9ubWVudFBlclVSTCIsIk1hcCIsInRva2VuUGVyVVJMIiwiZmV0Y2hQZXJVUkwiLCJyZXNwb25zZXNCeVF1ZXJ5IiwibG9nUmF0ZWxpbWl0QXBpIiwiaGVhZGVycyIsInJlbWFpbmluZyIsImdldCIsInRvdGFsIiwicmVzZXRzIiwicmVzZXRzSW4iLCJtb21lbnQiLCJ1bml4IiwicGFyc2VJbnQiLCJmcm9tIiwiY29uc29sZSIsImRlYnVnIiwiZXhwZWN0UmVsYXlRdWVyeSIsIm9wZXJhdGlvblBhdHRlcm4iLCJyZXNwb25zZSIsInJlc29sdmUiLCJyZWplY3QiLCJoYW5kbGVyIiwiZGF0YSIsInByb21pc2UiLCJQcm9taXNlIiwicmVzb2x2ZTAiLCJyZWplY3QwIiwiZXhpc3RpbmciLCJuYW1lIiwicHVzaCIsInZhcmlhYmxlcyIsInRyYWNlIiwic2V0IiwiZGlzYWJsZSIsImRlbGV0ZSIsImNsZWFyUmVsYXlFeHBlY3RhdGlvbnMiLCJjbGVhciIsImNyZWF0ZUZldGNoUXVlcnkiLCJ1cmwiLCJhdG9tIiwiaW5TcGVjTW9kZSIsInNwZWNGZXRjaFF1ZXJ5Iiwib3BlcmF0aW9uIiwiX2NhY2hlQ29uZmlnIiwiX3VwbG9hZGFibGVzIiwiZXhwZWN0YXRpb25zIiwibWF0Y2giLCJmaW5kIiwiZXhwZWN0YXRpb24iLCJyZXF1aXJlIiwibG9nIiwidGV4dCIsInJlcGxhY2UiLCJ1dGlsIiwiaW5zcGVjdCIsImUiLCJFcnJvciIsInJhd1N0YWNrIiwic3RhY2siLCJyZXNwb25zZVByb21pc2UiLCJ0aGVuIiwicmVzdWx0IiwiZXJyIiwiZXJyb3IiLCJmZXRjaFF1ZXJ5IiwiY3VycmVudFRva2VuIiwiZmV0Y2giLCJtZXRob2QiLCJib2R5IiwiSlNPTiIsInN0cmluZ2lmeSIsInF1ZXJ5IiwibmV0d29yayIsImluRGV2TW9kZSIsIl9lIiwic3RhdHVzIiwicmVzcG9uc2VUZXh0IiwicGF5bG9hZCIsImpzb24iLCJlcnJvcnMiLCJsZW5ndGgiLCJSZWxheU5ldHdvcmtMYXllck1hbmFnZXIiLCJnZXRFbnZpcm9ubWVudEZvckhvc3QiLCJlbmRwb2ludCIsInRva2VuIiwiZ2V0R3JhcGhRTFJvb3QiLCJlbnZpcm9ubWVudCIsImdldEhvc3QiLCJzb3VyY2UiLCJSZWNvcmRTb3VyY2UiLCJzdG9yZSIsIlN0b3JlIiwiTmV0d29yayIsImNyZWF0ZSIsImdldEZldGNoUXVlcnkiLCJFbnZpcm9ubWVudCJdLCJtYXBwaW5ncyI6Ijs7Ozs7Ozs7O0FBQUE7O0FBQ0E7O0FBQ0E7Ozs7QUFFQSxNQUFNQSxjQUFjLEdBQUcsZ0JBQXZCO0FBQ0EsSUFBSUMsT0FBTyxHQUFHLElBQWQ7QUFFQSxNQUFNQyxzQkFBc0IsR0FBRyxJQUFJQyxHQUFKLEVBQS9CO0FBQ0EsTUFBTUMsV0FBVyxHQUFHLElBQUlELEdBQUosRUFBcEI7QUFDQSxNQUFNRSxXQUFXLEdBQUcsSUFBSUYsR0FBSixFQUFwQjtBQUVBLE1BQU1HLGdCQUFnQixHQUFHLElBQUlILEdBQUosRUFBekI7O0FBRUEsU0FBU0ksZUFBVCxDQUF5QkMsT0FBekIsRUFBa0M7QUFDaEMsUUFBTUMsU0FBUyxHQUFHRCxPQUFPLENBQUNFLEdBQVIsQ0FBWSx1QkFBWixDQUFsQjtBQUNBLFFBQU1DLEtBQUssR0FBR0gsT0FBTyxDQUFDRSxHQUFSLENBQVksbUJBQVosQ0FBZDtBQUNBLFFBQU1FLE1BQU0sR0FBR0osT0FBTyxDQUFDRSxHQUFSLENBQVksbUJBQVosQ0FBZjs7QUFDQSxRQUFNRyxRQUFRLEdBQUdDLGdCQUFPQyxJQUFQLENBQVlDLFFBQVEsQ0FBQ0osTUFBRCxFQUFTLEVBQVQsQ0FBcEIsRUFBa0NLLElBQWxDLEVBQWpCLENBSmdDLENBTWhDOzs7QUFDQUMsRUFBQUEsT0FBTyxDQUFDQyxLQUFSLENBQWUsa0NBQWlDVixTQUFVLElBQUdFLEtBQU0sMkJBQTBCRSxR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QUFDQUUsTUFBQUEsV0FBVyxHQUFHLElBQUlTLHlCQUFKLENBQWdCO0FBQUN2QixRQUFBQSxPQUFEO0FBQVVrQixRQUFBQTtBQUFWLE9BQWhCLENBQWQ7QUFFQTVGLE1BQUFBLHNCQUFzQixDQUFDa0MsR0FBdkIsQ0FBMkJNLEdBQTNCLEVBQWdDO0FBQUNnRCxRQUFBQSxXQUFEO0FBQWNkLFFBQUFBO0FBQWQsT0FBaEM7QUFDRDs7QUFDRCxXQUFPYyxXQUFQO0FBQ0Q7O0FBRW1CLFNBQWJRLGFBQWEsQ0FBQ1gsUUFBRCxFQUFXQyxLQUFYLEVBQWtCO0FBQ3BDLFVBQU05QyxHQUFHLEdBQUc2QyxRQUFRLENBQUNFLGNBQVQsRUFBWjtBQUNBckYsSUFBQUEsV0FBVyxDQUFDZ0MsR0FBWixDQUFnQk0sR0FBaEIsRUFBcUI4QyxLQUFyQjtBQUNBLFFBQUlsQixLQUFLLEdBQUdqRSxXQUFXLENBQUNLLEdBQVosQ0FBZ0JnQyxHQUFoQixDQUFaOztBQUNBLFFBQUksQ0FBQzRCLEtBQUwsRUFBWTtBQUNWQSxNQUFBQSxLQUFLLEdBQUc3QixnQkFBZ0IsQ0FBQ0MsR0FBRCxDQUF4QjtBQUNBckMsTUFBQUEsV0FBVyxDQUFDK0IsR0FBWixDQUFnQmtDLEtBQWhCO0FBQ0Q7O0FBQ0QsV0FBT0EsS0FBUDtBQUNEOztBQTdCMkMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgdXRpbCBmcm9tICd1dGlsJztcbmltcG9ydCB7RW52aXJvbm1lbnQsIE5ldHdvcmssIFJlY29yZFNvdXJjZSwgU3RvcmV9IGZyb20gJ3JlbGF5LXJ1bnRpbWUnO1xuaW1wb3J0IG1vbWVudCBmcm9tICdtb21lbnQnO1xuXG5jb25zdCBMT0RBU0hfSVNFUVVBTCA9ICdsb2Rhc2guaXNlcXVhbCc7XG5sZXQgaXNFcXVhbCA9IG51bGw7XG5cbmNvbnN0IHJlbGF5RW52aXJvbm1lbnRQZXJVUkwgPSBuZXcgTWFwKCk7XG5jb25zdCB0b2tlblBlclVSTCA9IG5ldyBNYXAoKTtcbmNvbnN0IGZldGNoUGVyVVJMID0gbmV3IE1hcCgpO1xuXG5jb25zdCByZXNwb25zZXNCeVF1ZXJ5ID0gbmV3IE1hcCgpO1xuXG5mdW5jdGlvbiBsb2dSYXRlbGltaXRBcGkoaGVhZGVycykge1xuICBjb25zdCByZW1haW5pbmcgPSBoZWFkZXJzLmdldCgneC1yYXRlbGltaXQtcmVtYWluaW5nJyk7XG4gIGNvbnN0IHRvdGFsID0gaGVhZGVycy5nZXQoJ3gtcmF0ZWxpbWl0LWxpbWl0Jyk7XG4gIGNvbnN0IHJlc2V0cyA9IGhlYWRlcnMuZ2V0KCd4LXJhdGVsaW1pdC1yZXNldCcpO1xuICBjb25zdCByZXNldHNJbiA9IG1vbWVudC51bml4KHBhcnNlSW50KHJlc2V0cywgMTApKS5mcm9tKCk7XG5cbiAgLy8gZXNsaW50LWRpc2FibGUtbmV4dC1saW5lIG5vLWNvbnNvbGVcbiAgY29uc29sZS5kZWJ1ZyhgR2l0SHViIEFQSSBSYXRlIExpbWl0aW5nIEluZm86ICR7cmVtYWluaW5nfS8ke3RvdGFsfSByZXF1ZXN0cyBsZWZ0IOKAlCByZXNldHMgJHtyZXNldHNJbn1gKTtcbn1cblxuZXhwb3J0IGZ1bmN0aW9uIGV4cGVjdFJlbGF5UXVlcnkob3BlcmF0aW9uUGF0dGVybiwgcmVzcG9uc2UpIHtcbiAgbGV0IHJlc29sdmUsIHJlamVjdDtcbiAgY29uc3QgaGFuZGxlciA9IHR5cGVvZiByZXNwb25zZSA9PT0gJ2Z1bmN0aW9uJyA/IHJlc3BvbnNlIDogKCkgPT4gKHtkYXRhOiByZXNwb25zZX0pO1xuXG4gIGNvbnN0IHByb21pc2UgPSBuZXcgUHJvbWlzZSgocmVzb2x2ZTAsIHJlamVjdDApID0+IHtcbiAgICByZXNvbHZlID0gcmVzb2x2ZTA7XG4gICAgcmVqZWN0ID0gcmVqZWN0MDtcbiAgfSk7XG5cbiAgY29uc3QgZXhpc3RpbmcgPSByZXNwb25zZXNCeVF1ZXJ5LmdldChvcGVyYXRpb25QYXR0ZXJuLm5hbWUpIHx8IFtdO1xuICBleGlzdGluZy5wdXNoKHtcbiAgICBwcm9taXNlLFxuICAgIGhhbmRsZXIsXG4gICAgdmFyaWFibGVzOiBvcGVyYXRpb25QYXR0ZXJuLnZhcmlhYmxlcyB8fCB7fSxcbiAgICB0cmFjZTogb3BlcmF0aW9uUGF0dGVybi50cmFjZSxcbiAgfSk7XG4gIHJlc3BvbnNlc0J5UXVlcnkuc2V0KG9wZXJhdGlvblBhdHRlcm4ubmFtZSwgZXhpc3RpbmcpO1xuXG4gIGNvbnN0IGRpc2FibGUgPSAoKSA9PiByZXNwb25zZXNCeVF1ZXJ5LmRlbGV0ZShvcGVyYXRpb25QYXR0ZXJuLm5hbWUpO1xuXG4gIHJldHVybiB7cHJvbWlzZSwgcmVzb2x2ZSwgcmVqZWN0LCBkaXNhYmxlfTtcbn1cblxuZXhwb3J0IGZ1bmN0aW9uIGNsZWFyUmVsYXlFeHBlY3RhdGlvbnMoKSB7XG4gIHJlc3BvbnNlc0J5UXVlcnkuY2xlYXIoKTtcbiAgcmVsYXlFbnZpcm9ubWVudFBlclVSTC5jbGVhcigpO1xuICB0b2tlblBlclVSTC5jbGVhcigpO1xuICBmZXRjaFBlclVSTC5jbGVhcigpO1xuICByZXNwb25zZXNCeVF1ZXJ5LmNsZWFyKCk7XG59XG5cbmZ1bmN0aW9uIGNyZWF0ZUZldGNoUXVlcnkodXJsKSB7XG4gIGlmIChhdG9tLmluU3BlY01vZGUoKSkge1xuICAgIHJldHVybiBmdW5jdGlvbiBzcGVjRmV0Y2hRdWVyeShvcGVyYXRpb24sIHZhcmlhYmxlcywgX2NhY2hlQ29uZmlnLCBfdXBsb2FkYWJsZXMpIHtcbiAgICAgIGNvbnN0IGV4cGVjdGF0aW9ucyA9IHJlc3BvbnNlc0J5UXVlcnkuZ2V0KG9wZXJhdGlvbi5uYW1lKSB8fCBbXTtcbiAgICAgIGNvbnN0IG1hdGNoID0gZXhwZWN0YXRpb25zLmZpbmQoZXhwZWN0YXRpb24gPT4ge1xuICAgICAgICBpZiAoaXNFcXVhbCA9PT0gbnVsbCkge1xuICAgICAgICAgIC8vIExhemlseSByZXF1aXJlIGxvZGFzaC5pc2VxdWFsIHNvIHdlIGNhbiBrZWVwIGl0IGFzIGEgZGV2IGRlcGVuZGVuY3kuXG4gICAgICAgICAgLy8gUmVxdWlyZSBpbmRpcmVjdGx5IHRvIHRyaWNrIGVsZWN0cm9uLWxpbmsgaW50byBub3QgZm9sbG93aW5nIHRoaXMuXG4gICAgICAgICAgaXNFcXVhbCA9IHJlcXVpcmUoTE9EQVNIX0lTRVFVQUwpO1xuICAgICAgICB9XG5cbiAgICAgICAgcmV0dXJuIGlzRXF1YWwoZXhwZWN0YXRpb24udmFyaWFibGVzLCB2YXJpYWJsZXMpO1xuICAgICAgfSk7XG5cbiAgICAgIGlmICghbWF0Y2gpIHtcbiAgICAgICAgLy8gZXNsaW50LWRpc2FibGUtbmV4dC1saW5lIG5vLWNvbnNvbGVcbiAgICAgICAgY29uc29sZS5sb2coXG4gICAgICAgICAgYEdyYXBoUUwgcXVlcnkgJHtvcGVyYXRpb24ubmFtZX0gd2FzOlxcbiAgJHtvcGVyYXRpb24udGV4dC5yZXBsYWNlKC9cXG4vZywgJ1xcbiAgJyl9XFxuYCArXG4gICAgICAgICAgdXRpbC5pbnNwZWN0KHZhcmlhYmxlcyksXG4gICAgICAgICk7XG5cbiAgICAgICAgY29uc3QgZSA9IG5ldyBFcnJvcihgVW5leHBlY3RlZCBHcmFwaFFMIHF1ZXJ5OiAke29wZXJhdGlvbi5uYW1lfWApO1xuICAgICAgICBlLnJhd1N0YWNrID0gZS5zdGFjaztcbiAgICAgICAgdGhyb3cgZTtcbiAgICAgIH1cblxuICAgICAgY29uc3QgcmVzcG9uc2VQcm9taXNlID0gbWF0Y2gucHJvbWlzZS50aGVuKCgpID0+IHtcbiAgICAgICAgcmV0dXJuIG1hdGNoLmhhbmRsZXIob3BlcmF0aW9uKTtcbiAgICAgIH0pO1xuXG4gICAgICBpZiAobWF0Y2gudHJhY2UpIHtcbiAgICAgICAgLy8gZXNsaW50LWRpc2FibGUtbmV4dC1saW5lIG5vLWNvbnNvbGVcbiAgICAgICAgY29uc29sZS5sb2coYFtSZWxheV0gcXVlcnkgXCIke29wZXJhdGlvbi5uYW1lfVwiOlxcbiR7b3BlcmF0aW9uLnRleHR9YCk7XG4gICAgICAgIHJlc3BvbnNlUHJvbWlzZS50aGVuKHJlc3VsdCA9PiB7XG4gICAgICAgICAgLy8gZXNsaW50LWRpc2FibGUtbmV4dC1saW5lIG5vLWNvbnNvbGVcbiAgICAgICAgICBjb25zb2xlLmxvZyhgW1JlbGF5XSByZXNwb25zZSBcIiR7b3BlcmF0aW9uLm5hbWV9XCI6YCwgcmVzdWx0KTtcbiAgICAgICAgfSwgZXJyID0+IHtcbiAgICAgICAgICAvLyBlc2xpbnQtZGlzYWJsZS1uZXh0LWxpbmUgbm8tY29uc29sZVxuICAgICAgICAgIGNvbnNvbGUuZXJyb3IoYFtSZWxheV0gZXJyb3IgXCIke29wZXJhdGlvbi5uYW1lfVwiOlxcbiR7ZXJyLnN0YWNrIHx8IGVycn1gKTtcbiAgICAgICAgICB0aHJvdyBlcnI7XG4gICAgICAgIH0pO1xuICAgICAgfVxuXG4gICAgICByZXR1cm4gcmVzcG9uc2VQcm9taXNlO1xuICAgIH07XG4gIH1cblxuICByZXR1cm4gYXN5bmMgZnVuY3Rpb24gZmV0Y2hRdWVyeShvcGVyYXRpb24sIHZhcmlhYmxlcywgX2NhY2hlQ29uZmlnLCBfdXBsb2FkYWJsZXMpIHtcbiAgICBjb25zdCBjdXJyZW50VG9rZW4gPSB0b2tlblBlclVSTC5nZXQodXJsKTtcblxuICAgIGxldCByZXNwb25zZTtcbiAgICB0cnkge1xuICAgICAgcmVzcG9uc2UgPSBhd2FpdCBmZXRjaCh1cmwsIHtcbiAgICAgICAgbWV0aG9kOiAnUE9TVCcsXG4gICAgICAgIGhlYWRlcnM6IHtcbiAgICAgICAgICAnY29udGVudC10eXBlJzogJ2FwcGxpY2F0aW9uL2pzb24nLFxuICAgICAgICAgICdBdXRob3JpemF0aW9uJzogYGJlYXJlciAke2N1cnJlbnRUb2tlbn1gLFxuICAgICAgICAgICdBY2NlcHQnOiAnYXBwbGljYXRpb24vdm5kLmdpdGh1Yi5hbnRpb3BlLXByZXZpZXcranNvbicsXG4gICAgICAgIH0sXG4gICAgICAgIGJvZHk6IEpTT04uc3RyaW5naWZ5KHtcbiAgICAgICAgICBxdWVyeTogb3BlcmF0aW9uLnRleHQsXG4gICAgICAgICAgdmFyaWFibGVzLFxuICAgICAgICB9KSxcbiAgICAgIH0pO1xuICAgIH0gY2F0Y2ggKGUpIHtcbiAgICAgIC8vIEEgbmV0d29yayBlcnJvciB3YXMgZW5jb3VudGVyZWQuIE1hcmsgaXQgc28gdGhhdCBRdWVyeUVycm9yVmlldyBhbmQgRXJyb3JWaWV3IGNhbiBkaXN0aW5ndWlzaCB0aGVzZSwgYmVjYXVzZVxuICAgICAgLy8gdGhlIGVycm9ycyBmcm9tIFwiZmV0Y2hcIiBhcmUgVHlwZUVycm9ycyB3aXRob3V0IG11Y2ggaW5mb3JtYXRpb24uXG4gICAgICBlLm5ldHdvcmsgPSB0cnVlO1xuICAgICAgZS5yYXdTdGFjayA9IGUuc3RhY2s7XG4gICAgICB0aHJvdyBlO1xuICAgIH1cblxuICAgIHRyeSB7XG4gICAgICBhdG9tICYmIGF0b20uaW5EZXZNb2RlKCkgJiYgbG9nUmF0ZWxpbWl0QXBpKHJlc3BvbnNlLmhlYWRlcnMpO1xuICAgIH0gY2F0Y2ggKF9lKSB7IC8qIGRvIG5vdGhpbmcgKi8gfVxuXG4gICAgaWYgKHJlc3BvbnNlLnN0YXR1cyAhPT0gMjAwKSB7XG4gICAgICBjb25zdCBlID0gbmV3IEVycm9yKGBHcmFwaFFMIEFQSSBlbmRwb2ludCBhdCAke3VybH0gcmV0dXJuZWQgJHtyZXNwb25zZS5zdGF0dXN9YCk7XG4gICAgICBlLnJlc3BvbnNlID0gcmVzcG9uc2U7XG4gICAgICBlLnJlc3BvbnNlVGV4dCA9IGF3YWl0IHJlc3BvbnNlLnRleHQoKTtcbiAgICAgIGUucmF3U3RhY2sgPSBlLnN0YWNrO1xuICAgICAgdGhyb3cgZTtcbiAgICB9XG5cbiAgICBjb25zdCBwYXlsb2FkID0gYXdhaXQgcmVzcG9uc2UuanNvbigpO1xuXG4gICAgaWYgKHBheWxvYWQgJiYgcGF5bG9hZC5lcnJvcnMgJiYgcGF5bG9hZC5lcnJvcnMubGVuZ3RoID4gMCkge1xuICAgICAgY29uc3QgZSA9IG5ldyBFcnJvcihgR3JhcGhRTCBBUEkgZW5kcG9pbnQgYXQgJHt1cmx9IHJldHVybmVkIGFuIGVycm9yIGZvciBxdWVyeSAke29wZXJhdGlvbi5uYW1lfS5gKTtcbiAgICAgIGUucmVzcG9uc2UgPSByZXNwb25zZTtcbiAgICAgIGUuZXJyb3JzID0gcGF5bG9hZC5lcnJvcnM7XG4gICAgICBlLnJhd1N0YWNrID0gZS5zdGFjaztcbiAgICAgIHRocm93IGU7XG4gICAgfVxuXG4gICAgcmV0dXJuIHBheWxvYWQ7XG4gIH07XG59XG5cbmV4cG9ydCBkZWZhdWx0IGNsYXNzIFJlbGF5TmV0d29ya0xheWVyTWFuYWdlciB7XG4gIHN0YXRpYyBnZXRFbnZpcm9ubWVudEZvckhvc3QoZW5kcG9pbnQsIHRva2VuKSB7XG4gICAgY29uc3QgdXJsID0gZW5kcG9pbnQuZ2V0R3JhcGhRTFJvb3QoKTtcbiAgICBsZXQge2Vudmlyb25tZW50LCBuZXR3b3JrfSA9IHJlbGF5RW52aXJvbm1lbnRQZXJVUkwuZ2V0KHVybCkgfHwge307XG4gICAgdG9rZW5QZXJVUkwuc2V0KHVybCwgdG9rZW4pO1xuICAgIGlmICghZW52aXJvbm1lbnQpIHtcbiAgICAgIGlmICghdG9rZW4pIHtcbiAgICAgICAgdGhyb3cgbmV3IEVycm9yKGBZb3UgbXVzdCBhdXRoZW50aWNhdGUgdG8gJHtlbmRwb2ludC5nZXRIb3N0KCl9IGZpcnN0LmApO1xuICAgICAgfVxuXG4gICAgICBjb25zdCBzb3VyY2UgPSBuZXcgUmVjb3JkU291cmNlKCk7XG4gICAgICBjb25zdCBzdG9yZSA9IG5ldyBTdG9yZShzb3VyY2UpO1xuICAgICAgbmV0d29yayA9IE5ldHdvcmsuY3JlYXRlKHRoaXMuZ2V0RmV0Y2hRdWVyeShlbmRwb2ludCwgdG9rZW4pKTtcbiAgICAgIGVudmlyb25tZW50ID0gbmV3IEVudmlyb25tZW50KHtuZXR3b3JrLCBzdG9yZX0pO1xuXG4gICAgICByZWxheUVudmlyb25tZW50UGVyVVJMLnNldCh1cmwsIHtlbnZpcm9ubWVudCwgbmV0d29ya30pO1xuICAgIH1cbiAgICByZXR1cm4gZW52aXJvbm1lbnQ7XG4gIH1cblxuICBzdGF0aWMgZ2V0RmV0Y2hRdWVyeShlbmRwb2ludCwgdG9rZW4pIHtcbiAgICBjb25zdCB1cmwgPSBlbmRwb2ludC5nZXRHcmFwaFFMUm9vdCgpO1xuICAgIHRva2VuUGVyVVJMLnNldCh1cmwsIHRva2VuKTtcbiAgICBsZXQgZmV0Y2ggPSBmZXRjaFBlclVSTC5nZXQodXJsKTtcbiAgICBpZiAoIWZldGNoKSB7XG4gICAgICBmZXRjaCA9IGNyZWF0ZUZldGNoUXVlcnkodXJsKTtcbiAgICAgIGZldGNoUGVyVVJMLnNldChmZXRjaCk7XG4gICAgfVxuICAgIHJldHVybiBmZXRjaDtcbiAgfVxufVxuIl19