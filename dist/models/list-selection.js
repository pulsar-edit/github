"use strict";

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.default = void 0;

var _helpers = require("../helpers");

const COPY = Symbol('copy');

class ListSelection {
  constructor(options = {}) {
    (0, _helpers.autobind)(this, 'isItemSelectable');

    if (options._copy !== COPY) {
      this.options = {
        isItemSelectable: options.isItemSelectable || (item => !!item)
      };
      this.items = options.items || [];
      this.selections = this.items.length > 0 ? [{
        head: 0,
        tail: 0
      }] : [];
    } else {
      this.options = {
        isItemSelectable: options.isItemSelectable
      };
      this.items = options.items;
      this.selections = options.selections;
    }
  }

  copy(options = {}) {
    return new ListSelection({
      _copy: COPY,
      isItemSelectable: options.isItemSelectable || this.options.isItemSelectable,
      items: options.items || this.items,
      selections: options.selections || this.selections
    });
  }

  isItemSelectable(item) {
    return this.options.isItemSelectable(item);
  }

  setItems(items) {
    let newSelectionIndex;

    if (this.selections.length > 0) {
      const [{
        head,
        tail
      }] = this.selections;
      newSelectionIndex = Math.min(head, tail, items.length - 1);
    } else {
      newSelectionIndex = 0;
    }

    const newSelections = items.length > 0 ? [{
      head: newSelectionIndex,
      tail: newSelectionIndex
    }] : [];
    return this.copy({
      items,
      selections: newSelections
    });
  }

  getItems() {
    return this.items;
  }

  getLastItem() {
    return this.items[this.items.length - 1];
  }

  selectFirstItem(preserveTail) {
    for (let i = 0; i < this.items.length; i++) {
      const item = this.items[i];

      if (this.isItemSelectable(item)) {
        return this.selectItem(item, preserveTail);
      }
    }

    return this;
  }

  selectLastItem(preserveTail) {
    for (let i = this.items.length - 1; i > 0; i--) {
      const item = this.items[i];

      if (this.isItemSelectable(item)) {
        return this.selectItem(item, preserveTail);
      }
    }

    return this;
  }

  selectAllItems() {
    return this.selectFirstItem().selectLastItem(true);
  }

  selectNextItem(preserveTail) {
    if (this.selections.length === 0) {
      return this.selectFirstItem();
    }

    let itemIndex = this.selections[0].head;
    let nextItemIndex = itemIndex;

    while (itemIndex < this.items.length - 1) {
      itemIndex++;

      if (this.isItemSelectable(this.items[itemIndex])) {
        nextItemIndex = itemIndex;
        break;
      }
    }

    return this.selectItem(this.items[nextItemIndex], preserveTail);
  }

  selectPreviousItem(preserveTail) {
    if (this.selections.length === 0) {
      return this.selectLastItem();
    }

    let itemIndex = this.selections[0].head;
    let previousItemIndex = itemIndex;

    while (itemIndex > 0) {
      itemIndex--;

      if (this.isItemSelectable(this.items[itemIndex])) {
        previousItemIndex = itemIndex;
        break;
      }
    }

    return this.selectItem(this.items[previousItemIndex], preserveTail);
  }

  selectItem(item, preserveTail, addOrSubtract) {
    if (addOrSubtract && preserveTail) {
      throw new Error('addOrSubtract and preserveTail cannot both be true at the same time');
    }

    const itemIndex = this.items.indexOf(item);

    if (preserveTail && this.selections[0]) {
      const newSelections = [{
        head: itemIndex,
        tail: this.selections[0].tail,
        negate: this.selections[0].negate
      }, ...this.selections.slice(1)];
      return this.copy({
        selections: newSelections
      });
    } else {
      const selection = {
        head: itemIndex,
        tail: itemIndex
      };

      if (addOrSubtract) {
        if (this.getSelectedItems().has(item)) {
          selection.negate = true;
        }

        return this.copy({
          selections: [selection, ...this.selections]
        });
      } else {
        return this.copy({
          selections: [selection]
        });
      }
    }
  }

  addOrSubtractSelection(item) {
    return this.selectItem(item, false, true);
  }

  coalesce() {
    if (this.selections.length === 0) {
      return this;
    }

    const mostRecent = this.selections[0];
    let mostRecentStart = Math.min(mostRecent.head, mostRecent.tail);
    let mostRecentEnd = Math.max(mostRecent.head, mostRecent.tail);

    while (mostRecentStart > 0 && !this.isItemSelectable(this.items[mostRecentStart - 1])) {
      mostRecentStart--;
    }

    while (mostRecentEnd < this.items.length - 1 && !this.isItemSelectable(this.items[mostRecentEnd + 1])) {
      mostRecentEnd++;
    }

    let changed = false;
    const newSelections = [mostRecent];

    for (let i = 1; i < this.selections.length;) {
      const current = this.selections[i];
      const currentStart = Math.min(current.head, current.tail);
      const currentEnd = Math.max(current.head, current.tail);

      if (mostRecentStart <= currentEnd + 1 && currentStart - 1 <= mostRecentEnd) {
        if (mostRecent.negate) {
          if (current.head > current.tail) {
            if (currentEnd > mostRecentEnd) {
              // suffix
              newSelections.push({
                tail: mostRecentEnd + 1,
                head: currentEnd
              });
            }

            if (currentStart < mostRecentStart) {
              // prefix
              newSelections.push({
                tail: currentStart,
                head: mostRecentStart - 1
              });
            }
          } else {
            if (currentStart < mostRecentStart) {
              // prefix
              newSelections.push({
                head: currentStart,
                tail: mostRecentStart - 1
              });
            }

            if (currentEnd > mostRecentEnd) {
              // suffix
              newSelections.push({
                head: mostRecentEnd + 1,
                tail: currentEnd
              });
            }
          }

          changed = true;
          i++;
        } else {
          mostRecentStart = Math.min(mostRecentStart, currentStart);
          mostRecentEnd = Math.max(mostRecentEnd, currentEnd);

          if (mostRecent.head >= mostRecent.tail) {
            mostRecent.head = mostRecentEnd;
            mostRecent.tail = mostRecentStart;
          } else {
            mostRecent.head = mostRecentStart;
            mostRecent.tail = mostRecentEnd;
          }

          changed = true;
          i++;
        }
      } else {
        newSelections.push(current);
        i++;
      }
    }

    if (mostRecent.negate) {
      changed = true;
      newSelections.shift();
    }

    return changed ? this.copy({
      selections: newSelections
    }) : this;
  }

  getSelectedItems() {
    const selectedItems = new Set();

    for (const {
      head,
      tail,
      negate
    } of this.selections.slice().reverse()) {
      const start = Math.min(head, tail);
      const end = Math.max(head, tail);

      for (let i = start; i <= end; i++) {
        const item = this.items[i];

        if (this.isItemSelectable(item)) {
          if (negate) {
            selectedItems.delete(item);
          } else {
            selectedItems.add(item);
          }
        }
      }
    }

    return selectedItems;
  }

  getHeadItem() {
    return this.selections.length > 0 ? this.items[this.selections[0].head] : null;
  }

  getMostRecentSelectionStartIndex() {
    const selection = this.selections[0];
    return Math.min(selection.head, selection.tail);
  }

  getTailIndex() {
    return this.selections[0] ? this.selections[0].tail : null;
  }

}

exports.default = ListSelection;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uL2xpYi9tb2RlbHMvbGlzdC1zZWxlY3Rpb24uanMiXSwibmFtZXMiOlsiQ09QWSIsIlN5bWJvbCIsIkxpc3RTZWxlY3Rpb24iLCJjb25zdHJ1Y3RvciIsIm9wdGlvbnMiLCJfY29weSIsImlzSXRlbVNlbGVjdGFibGUiLCJpdGVtIiwiaXRlbXMiLCJzZWxlY3Rpb25zIiwibGVuZ3RoIiwiaGVhZCIsInRhaWwiLCJjb3B5Iiwic2V0SXRlbXMiLCJuZXdTZWxlY3Rpb25JbmRleCIsIk1hdGgiLCJtaW4iLCJuZXdTZWxlY3Rpb25zIiwiZ2V0SXRlbXMiLCJnZXRMYXN0SXRlbSIsInNlbGVjdEZpcnN0SXRlbSIsInByZXNlcnZlVGFpbCIsImkiLCJzZWxlY3RJdGVtIiwic2VsZWN0TGFzdEl0ZW0iLCJzZWxlY3RBbGxJdGVtcyIsInNlbGVjdE5leHRJdGVtIiwiaXRlbUluZGV4IiwibmV4dEl0ZW1JbmRleCIsInNlbGVjdFByZXZpb3VzSXRlbSIsInByZXZpb3VzSXRlbUluZGV4IiwiYWRkT3JTdWJ0cmFjdCIsIkVycm9yIiwiaW5kZXhPZiIsIm5lZ2F0ZSIsInNsaWNlIiwic2VsZWN0aW9uIiwiZ2V0U2VsZWN0ZWRJdGVtcyIsImhhcyIsImFkZE9yU3VidHJhY3RTZWxlY3Rpb24iLCJjb2FsZXNjZSIsIm1vc3RSZWNlbnQiLCJtb3N0UmVjZW50U3RhcnQiLCJtb3N0UmVjZW50RW5kIiwibWF4IiwiY2hhbmdlZCIsImN1cnJlbnQiLCJjdXJyZW50U3RhcnQiLCJjdXJyZW50RW5kIiwicHVzaCIsInNoaWZ0Iiwic2VsZWN0ZWRJdGVtcyIsIlNldCIsInJldmVyc2UiLCJzdGFydCIsImVuZCIsImRlbGV0ZSIsImFkZCIsImdldEhlYWRJdGVtIiwiZ2V0TW9zdFJlY2VudFNlbGVjdGlvblN0YXJ0SW5kZXgiLCJnZXRUYWlsSW5kZXgiXSwibWFwcGluZ3MiOiI7Ozs7Ozs7QUFBQTs7QUFFQSxNQUFNQSxJQUFJLEdBQUdDLE1BQU0sQ0FBQyxNQUFELENBQW5C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QUFPTyxJQUFJLENBQUNDLEdBQUwsQ0FBU29CLFNBQVMsQ0FBQzFCLElBQW5CLEVBQXlCMEIsU0FBUyxDQUFDekIsSUFBbkMsQ0FBUDtBQUNEOztBQUVEaUQsRUFBQUEsWUFBWSxHQUFHO0FBQ2IsV0FBTyxLQUFLcEQsVUFBTCxDQUFnQixDQUFoQixJQUFxQixLQUFLQSxVQUFMLENBQWdCLENBQWhCLEVBQW1CRyxJQUF4QyxHQUErQyxJQUF0RDtBQUNEOztBQTdPZ0MiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQge2F1dG9iaW5kfSBmcm9tICcuLi9oZWxwZXJzJztcblxuY29uc3QgQ09QWSA9IFN5bWJvbCgnY29weScpO1xuXG5leHBvcnQgZGVmYXVsdCBjbGFzcyBMaXN0U2VsZWN0aW9uIHtcbiAgY29uc3RydWN0b3Iob3B0aW9ucyA9IHt9KSB7XG4gICAgYXV0b2JpbmQodGhpcywgJ2lzSXRlbVNlbGVjdGFibGUnKTtcblxuICAgIGlmIChvcHRpb25zLl9jb3B5ICE9PSBDT1BZKSB7XG4gICAgICB0aGlzLm9wdGlvbnMgPSB7XG4gICAgICAgIGlzSXRlbVNlbGVjdGFibGU6IG9wdGlvbnMuaXNJdGVtU2VsZWN0YWJsZSB8fCAoaXRlbSA9PiAhIWl0ZW0pLFxuICAgICAgfTtcblxuICAgICAgdGhpcy5pdGVtcyA9IG9wdGlvbnMuaXRlbXMgfHwgW107XG4gICAgICB0aGlzLnNlbGVjdGlvbnMgPSB0aGlzLml0ZW1zLmxlbmd0aCA+IDAgPyBbe2hlYWQ6IDAsIHRhaWw6IDB9XSA6IFtdO1xuICAgIH0gZWxzZSB7XG4gICAgICB0aGlzLm9wdGlvbnMgPSB7XG4gICAgICAgIGlzSXRlbVNlbGVjdGFibGU6IG9wdGlvbnMuaXNJdGVtU2VsZWN0YWJsZSxcbiAgICAgIH07XG4gICAgICB0aGlzLml0ZW1zID0gb3B0aW9ucy5pdGVtcztcbiAgICAgIHRoaXMuc2VsZWN0aW9ucyA9IG9wdGlvbnMuc2VsZWN0aW9ucztcbiAgICB9XG4gIH1cblxuICBjb3B5KG9wdGlvbnMgPSB7fSkge1xuICAgIHJldHVybiBuZXcgTGlzdFNlbGVjdGlvbih7XG4gICAgICBfY29weTogQ09QWSxcbiAgICAgIGlzSXRlbVNlbGVjdGFibGU6IG9wdGlvbnMuaXNJdGVtU2VsZWN0YWJsZSB8fCB0aGlzLm9wdGlvbnMuaXNJdGVtU2VsZWN0YWJsZSxcbiAgICAgIGl0ZW1zOiBvcHRpb25zLml0ZW1zIHx8IHRoaXMuaXRlbXMsXG4gICAgICBzZWxlY3Rpb25zOiBvcHRpb25zLnNlbGVjdGlvbnMgfHwgdGhpcy5zZWxlY3Rpb25zLFxuICAgIH0pO1xuICB9XG5cbiAgaXNJdGVtU2VsZWN0YWJsZShpdGVtKSB7XG4gICAgcmV0dXJuIHRoaXMub3B0aW9ucy5pc0l0ZW1TZWxlY3RhYmxlKGl0ZW0pO1xuICB9XG5cbiAgc2V0SXRlbXMoaXRlbXMpIHtcbiAgICBsZXQgbmV3U2VsZWN0aW9uSW5kZXg7XG4gICAgaWYgKHRoaXMuc2VsZWN0aW9ucy5sZW5ndGggPiAwKSB7XG4gICAgICBjb25zdCBbe2hlYWQsIHRhaWx9XSA9IHRoaXMuc2VsZWN0aW9ucztcbiAgICAgIG5ld1NlbGVjdGlvbkluZGV4ID0gTWF0aC5taW4oaGVhZCwgdGFpbCwgaXRlbXMubGVuZ3RoIC0gMSk7XG4gICAgfSBlbHNlIHtcbiAgICAgIG5ld1NlbGVjdGlvbkluZGV4ID0gMDtcbiAgICB9XG5cbiAgICBjb25zdCBuZXdTZWxlY3Rpb25zID0gaXRlbXMubGVuZ3RoID4gMCA/IFt7aGVhZDogbmV3U2VsZWN0aW9uSW5kZXgsIHRhaWw6IG5ld1NlbGVjdGlvbkluZGV4fV0gOiBbXTtcbiAgICByZXR1cm4gdGhpcy5jb3B5KHtpdGVtcywgc2VsZWN0aW9uczogbmV3U2VsZWN0aW9uc30pO1xuICB9XG5cbiAgZ2V0SXRlbXMoKSB7XG4gICAgcmV0dXJuIHRoaXMuaXRlbXM7XG4gIH1cblxuICBnZXRMYXN0SXRlbSgpIHtcbiAgICByZXR1cm4gdGhpcy5pdGVtc1t0aGlzLml0ZW1zLmxlbmd0aCAtIDFdO1xuICB9XG5cbiAgc2VsZWN0Rmlyc3RJdGVtKHByZXNlcnZlVGFpbCkge1xuICAgIGZvciAobGV0IGkgPSAwOyBpIDwgdGhpcy5pdGVtcy5sZW5ndGg7IGkrKykge1xuICAgICAgY29uc3QgaXRlbSA9IHRoaXMuaXRlbXNbaV07XG4gICAgICBpZiAodGhpcy5pc0l0ZW1TZWxlY3RhYmxlKGl0ZW0pKSB7XG4gICAgICAgIHJldHVybiB0aGlzLnNlbGVjdEl0ZW0oaXRlbSwgcHJlc2VydmVUYWlsKTtcbiAgICAgIH1cbiAgICB9XG4gICAgcmV0dXJuIHRoaXM7XG4gIH1cblxuICBzZWxlY3RMYXN0SXRlbShwcmVzZXJ2ZVRhaWwpIHtcbiAgICBmb3IgKGxldCBpID0gdGhpcy5pdGVtcy5sZW5ndGggLSAxOyBpID4gMDsgaS0tKSB7XG4gICAgICBjb25zdCBpdGVtID0gdGhpcy5pdGVtc1tpXTtcbiAgICAgIGlmICh0aGlzLmlzSXRlbVNlbGVjdGFibGUoaXRlbSkpIHtcbiAgICAgICAgcmV0dXJuIHRoaXMuc2VsZWN0SXRlbShpdGVtLCBwcmVzZXJ2ZVRhaWwpO1xuICAgICAgfVxuICAgIH1cbiAgICByZXR1cm4gdGhpcztcbiAgfVxuXG4gIHNlbGVjdEFsbEl0ZW1zKCkge1xuICAgIHJldHVybiB0aGlzLnNlbGVjdEZpcnN0SXRlbSgpLnNlbGVjdExhc3RJdGVtKHRydWUpO1xuICB9XG5cbiAgc2VsZWN0TmV4dEl0ZW0ocHJlc2VydmVUYWlsKSB7XG4gICAgaWYgKHRoaXMuc2VsZWN0aW9ucy5sZW5ndGggPT09IDApIHtcbiAgICAgIHJldHVybiB0aGlzLnNlbGVjdEZpcnN0SXRlbSgpO1xuICAgIH1cblxuICAgIGxldCBpdGVtSW5kZXggPSB0aGlzLnNlbGVjdGlvbnNbMF0uaGVhZDtcbiAgICBsZXQgbmV4dEl0ZW1JbmRleCA9IGl0ZW1JbmRleDtcbiAgICB3aGlsZSAoaXRlbUluZGV4IDwgdGhpcy5pdGVtcy5sZW5ndGggLSAxKSB7XG4gICAgICBpdGVtSW5kZXgrKztcbiAgICAgIGlmICh0aGlzLmlzSXRlbVNlbGVjdGFibGUodGhpcy5pdGVtc1tpdGVtSW5kZXhdKSkge1xuICAgICAgICBuZXh0SXRlbUluZGV4ID0gaXRlbUluZGV4O1xuICAgICAgICBicmVhaztcbiAgICAgIH1cbiAgICB9XG5cbiAgICByZXR1cm4gdGhpcy5zZWxlY3RJdGVtKHRoaXMuaXRlbXNbbmV4dEl0ZW1JbmRleF0sIHByZXNlcnZlVGFpbCk7XG4gIH1cblxuICBzZWxlY3RQcmV2aW91c0l0ZW0ocHJlc2VydmVUYWlsKSB7XG4gICAgaWYgKHRoaXMuc2VsZWN0aW9ucy5sZW5ndGggPT09IDApIHtcbiAgICAgIHJldHVybiB0aGlzLnNlbGVjdExhc3RJdGVtKCk7XG4gICAgfVxuXG4gICAgbGV0IGl0ZW1JbmRleCA9IHRoaXMuc2VsZWN0aW9uc1swXS5oZWFkO1xuICAgIGxldCBwcmV2aW91c0l0ZW1JbmRleCA9IGl0ZW1JbmRleDtcblxuICAgIHdoaWxlIChpdGVtSW5kZXggPiAwKSB7XG4gICAgICBpdGVtSW5kZXgtLTtcbiAgICAgIGlmICh0aGlzLmlzSXRlbVNlbGVjdGFibGUodGhpcy5pdGVtc1tpdGVtSW5kZXhdKSkge1xuICAgICAgICBwcmV2aW91c0l0ZW1JbmRleCA9IGl0ZW1JbmRleDtcbiAgICAgICAgYnJlYWs7XG4gICAgICB9XG4gICAgfVxuXG4gICAgcmV0dXJuIHRoaXMuc2VsZWN0SXRlbSh0aGlzLml0ZW1zW3ByZXZpb3VzSXRlbUluZGV4XSwgcHJlc2VydmVUYWlsKTtcbiAgfVxuXG4gIHNlbGVjdEl0ZW0oaXRlbSwgcHJlc2VydmVUYWlsLCBhZGRPclN1YnRyYWN0KSB7XG4gICAgaWYgKGFkZE9yU3VidHJhY3QgJiYgcHJlc2VydmVUYWlsKSB7XG4gICAgICB0aHJvdyBuZXcgRXJyb3IoJ2FkZE9yU3VidHJhY3QgYW5kIHByZXNlcnZlVGFpbCBjYW5ub3QgYm90aCBiZSB0cnVlIGF0IHRoZSBzYW1lIHRpbWUnKTtcbiAgICB9XG5cbiAgICBjb25zdCBpdGVtSW5kZXggPSB0aGlzLml0ZW1zLmluZGV4T2YoaXRlbSk7XG4gICAgaWYgKHByZXNlcnZlVGFpbCAmJiB0aGlzLnNlbGVjdGlvbnNbMF0pIHtcbiAgICAgIGNvbnN0IG5ld1NlbGVjdGlvbnMgPSBbXG4gICAgICAgIHtoZWFkOiBpdGVtSW5kZXgsIHRhaWw6IHRoaXMuc2VsZWN0aW9uc1swXS50YWlsLCBuZWdhdGU6IHRoaXMuc2VsZWN0aW9uc1swXS5uZWdhdGV9LFxuICAgICAgICAuLi50aGlzLnNlbGVjdGlvbnMuc2xpY2UoMSksXG4gICAgICBdO1xuICAgICAgcmV0dXJuIHRoaXMuY29weSh7c2VsZWN0aW9uczogbmV3U2VsZWN0aW9uc30pO1xuICAgIH0gZWxzZSB7XG4gICAgICBjb25zdCBzZWxlY3Rpb24gPSB7aGVhZDogaXRlbUluZGV4LCB0YWlsOiBpdGVtSW5kZXh9O1xuICAgICAgaWYgKGFkZE9yU3VidHJhY3QpIHtcbiAgICAgICAgaWYgKHRoaXMuZ2V0U2VsZWN0ZWRJdGVtcygpLmhhcyhpdGVtKSkgeyBzZWxlY3Rpb24ubmVnYXRlID0gdHJ1ZTsgfVxuICAgICAgICByZXR1cm4gdGhpcy5jb3B5KHtzZWxlY3Rpb25zOiBbc2VsZWN0aW9uLCAuLi50aGlzLnNlbGVjdGlvbnNdfSk7XG4gICAgICB9IGVsc2Uge1xuICAgICAgICByZXR1cm4gdGhpcy5jb3B5KHtzZWxlY3Rpb25zOiBbc2VsZWN0aW9uXX0pO1xuICAgICAgfVxuICAgIH1cbiAgfVxuXG4gIGFkZE9yU3VidHJhY3RTZWxlY3Rpb24oaXRlbSkge1xuICAgIHJldHVybiB0aGlzLnNlbGVjdEl0ZW0oaXRlbSwgZmFsc2UsIHRydWUpO1xuICB9XG5cbiAgY29hbGVzY2UoKSB7XG4gICAgaWYgKHRoaXMuc2VsZWN0aW9ucy5sZW5ndGggPT09IDApIHsgcmV0dXJuIHRoaXM7IH1cblxuICAgIGNvbnN0IG1vc3RSZWNlbnQgPSB0aGlzLnNlbGVjdGlvbnNbMF07XG4gICAgbGV0IG1vc3RSZWNlbnRTdGFydCA9IE1hdGgubWluKG1vc3RSZWNlbnQuaGVhZCwgbW9zdFJlY2VudC50YWlsKTtcbiAgICBsZXQgbW9zdFJlY2VudEVuZCA9IE1hdGgubWF4KG1vc3RSZWNlbnQuaGVhZCwgbW9zdFJlY2VudC50YWlsKTtcbiAgICB3aGlsZSAobW9zdFJlY2VudFN0YXJ0ID4gMCAmJiAhdGhpcy5pc0l0ZW1TZWxlY3RhYmxlKHRoaXMuaXRlbXNbbW9zdFJlY2VudFN0YXJ0IC0gMV0pKSB7XG4gICAgICBtb3N0UmVjZW50U3RhcnQtLTtcbiAgICB9XG4gICAgd2hpbGUgKG1vc3RSZWNlbnRFbmQgPCAodGhpcy5pdGVtcy5sZW5ndGggLSAxKSAmJiAhdGhpcy5pc0l0ZW1TZWxlY3RhYmxlKHRoaXMuaXRlbXNbbW9zdFJlY2VudEVuZCArIDFdKSkge1xuICAgICAgbW9zdFJlY2VudEVuZCsrO1xuICAgIH1cblxuICAgIGxldCBjaGFuZ2VkID0gZmFsc2U7XG4gICAgY29uc3QgbmV3U2VsZWN0aW9ucyA9IFttb3N0UmVjZW50XTtcbiAgICBmb3IgKGxldCBpID0gMTsgaSA8IHRoaXMuc2VsZWN0aW9ucy5sZW5ndGg7KSB7XG4gICAgICBjb25zdCBjdXJyZW50ID0gdGhpcy5zZWxlY3Rpb25zW2ldO1xuICAgICAgY29uc3QgY3VycmVudFN0YXJ0ID0gTWF0aC5taW4oY3VycmVudC5oZWFkLCBjdXJyZW50LnRhaWwpO1xuICAgICAgY29uc3QgY3VycmVudEVuZCA9IE1hdGgubWF4KGN1cnJlbnQuaGVhZCwgY3VycmVudC50YWlsKTtcbiAgICAgIGlmIChtb3N0UmVjZW50U3RhcnQgPD0gY3VycmVudEVuZCArIDEgJiYgY3VycmVudFN0YXJ0IC0gMSA8PSBtb3N0UmVjZW50RW5kKSB7XG4gICAgICAgIGlmIChtb3N0UmVjZW50Lm5lZ2F0ZSkge1xuICAgICAgICAgIGlmIChjdXJyZW50LmhlYWQgPiBjdXJyZW50LnRhaWwpIHtcbiAgICAgICAgICAgIGlmIChjdXJyZW50RW5kID4gbW9zdFJlY2VudEVuZCkgeyAvLyBzdWZmaXhcbiAgICAgICAgICAgICAgbmV3U2VsZWN0aW9ucy5wdXNoKHt0YWlsOiBtb3N0UmVjZW50RW5kICsgMSwgaGVhZDogY3VycmVudEVuZH0pO1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgaWYgKGN1cnJlbnRTdGFydCA8IG1vc3RSZWNlbnRTdGFydCkgeyAvLyBwcmVmaXhcbiAgICAgICAgICAgICAgbmV3U2VsZWN0aW9ucy5wdXNoKHt0YWlsOiBjdXJyZW50U3RhcnQsIGhlYWQ6IG1vc3RSZWNlbnRTdGFydCAtIDF9KTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgaWYgKGN1cnJlbnRTdGFydCA8IG1vc3RSZWNlbnRTdGFydCkgeyAvLyBwcmVmaXhcbiAgICAgICAgICAgICAgbmV3U2VsZWN0aW9ucy5wdXNoKHtoZWFkOiBjdXJyZW50U3RhcnQsIHRhaWw6IG1vc3RSZWNlbnRTdGFydCAtIDF9KTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIGlmIChjdXJyZW50RW5kID4gbW9zdFJlY2VudEVuZCkgeyAvLyBzdWZmaXhcbiAgICAgICAgICAgICAgbmV3U2VsZWN0aW9ucy5wdXNoKHtoZWFkOiBtb3N0UmVjZW50RW5kICsgMSwgdGFpbDogY3VycmVudEVuZH0pO1xuICAgICAgICAgICAgfVxuICAgICAgICAgIH1cbiAgICAgICAgICBjaGFuZ2VkID0gdHJ1ZTtcbiAgICAgICAgICBpKys7XG4gICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgbW9zdFJlY2VudFN0YXJ0ID0gTWF0aC5taW4obW9zdFJlY2VudFN0YXJ0LCBjdXJyZW50U3RhcnQpO1xuICAgICAgICAgIG1vc3RSZWNlbnRFbmQgPSBNYXRoLm1heChtb3N0UmVjZW50RW5kLCBjdXJyZW50RW5kKTtcbiAgICAgICAgICBpZiAobW9zdFJlY2VudC5oZWFkID49IG1vc3RSZWNlbnQudGFpbCkge1xuICAgICAgICAgICAgbW9zdFJlY2VudC5oZWFkID0gbW9zdFJlY2VudEVuZDtcbiAgICAgICAgICAgIG1vc3RSZWNlbnQudGFpbCA9IG1vc3RSZWNlbnRTdGFydDtcbiAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgbW9zdFJlY2VudC5oZWFkID0gbW9zdFJlY2VudFN0YXJ0O1xuICAgICAgICAgICAgbW9zdFJlY2VudC50YWlsID0gbW9zdFJlY2VudEVuZDtcbiAgICAgICAgICB9XG4gICAgICAgICAgY2hhbmdlZCA9IHRydWU7XG4gICAgICAgICAgaSsrO1xuICAgICAgICB9XG4gICAgICB9IGVsc2Uge1xuICAgICAgICBuZXdTZWxlY3Rpb25zLnB1c2goY3VycmVudCk7XG4gICAgICAgIGkrKztcbiAgICAgIH1cbiAgICB9XG5cbiAgICBpZiAobW9zdFJlY2VudC5uZWdhdGUpIHtcbiAgICAgIGNoYW5nZWQgPSB0cnVlO1xuICAgICAgbmV3U2VsZWN0aW9ucy5zaGlmdCgpO1xuICAgIH1cblxuICAgIHJldHVybiBjaGFuZ2VkID8gdGhpcy5jb3B5KHtzZWxlY3Rpb25zOiBuZXdTZWxlY3Rpb25zfSkgOiB0aGlzO1xuICB9XG5cbiAgZ2V0U2VsZWN0ZWRJdGVtcygpIHtcbiAgICBjb25zdCBzZWxlY3RlZEl0ZW1zID0gbmV3IFNldCgpO1xuICAgIGZvciAoY29uc3Qge2hlYWQsIHRhaWwsIG5lZ2F0ZX0gb2YgdGhpcy5zZWxlY3Rpb25zLnNsaWNlKCkucmV2ZXJzZSgpKSB7XG4gICAgICBjb25zdCBzdGFydCA9IE1hdGgubWluKGhlYWQsIHRhaWwpO1xuICAgICAgY29uc3QgZW5kID0gTWF0aC5tYXgoaGVhZCwgdGFpbCk7XG4gICAgICBmb3IgKGxldCBpID0gc3RhcnQ7IGkgPD0gZW5kOyBpKyspIHtcbiAgICAgICAgY29uc3QgaXRlbSA9IHRoaXMuaXRlbXNbaV07XG4gICAgICAgIGlmICh0aGlzLmlzSXRlbVNlbGVjdGFibGUoaXRlbSkpIHtcbiAgICAgICAgICBpZiAobmVnYXRlKSB7XG4gICAgICAgICAgICBzZWxlY3RlZEl0ZW1zLmRlbGV0ZShpdGVtKTtcbiAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgc2VsZWN0ZWRJdGVtcy5hZGQoaXRlbSk7XG4gICAgICAgICAgfVxuICAgICAgICB9XG4gICAgICB9XG4gICAgfVxuICAgIHJldHVybiBzZWxlY3RlZEl0ZW1zO1xuICB9XG5cbiAgZ2V0SGVhZEl0ZW0oKSB7XG4gICAgcmV0dXJuIHRoaXMuc2VsZWN0aW9ucy5sZW5ndGggPiAwID8gdGhpcy5pdGVtc1t0aGlzLnNlbGVjdGlvbnNbMF0uaGVhZF0gOiBudWxsO1xuICB9XG5cbiAgZ2V0TW9zdFJlY2VudFNlbGVjdGlvblN0YXJ0SW5kZXgoKSB7XG4gICAgY29uc3Qgc2VsZWN0aW9uID0gdGhpcy5zZWxlY3Rpb25zWzBdO1xuICAgIHJldHVybiBNYXRoLm1pbihzZWxlY3Rpb24uaGVhZCwgc2VsZWN0aW9uLnRhaWwpO1xuICB9XG5cbiAgZ2V0VGFpbEluZGV4KCkge1xuICAgIHJldHVybiB0aGlzLnNlbGVjdGlvbnNbMF0gPyB0aGlzLnNlbGVjdGlvbnNbMF0udGFpbCA6IG51bGw7XG4gIH1cbn1cbiJdfQ==