"use strict";

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.nullCommit = exports.default = void 0;

var _patch = require("./patch");

function _defineProperty(obj, key, value) { if (key in obj) { Object.defineProperty(obj, key, { value: value, enumerable: true, configurable: true, writable: true }); } else { obj[key] = value; } return obj; }

const UNBORN = Symbol('unborn'); // Truncation elipsis styles

const WORD_ELIPSES = '...';
const NEWLINE_ELIPSES = '\n...';
const PARAGRAPH_ELIPSES = '\n\n...';

class Commit {
  static createUnborn() {
    return new Commit({
      unbornRef: UNBORN
    });
  }

  constructor({
    sha,
    author,
    coAuthors,
    authorDate,
    messageSubject,
    messageBody,
    unbornRef,
    patch
  }) {
    this.sha = sha;
    this.author = author;
    this.coAuthors = coAuthors || [];
    this.authorDate = authorDate;
    this.messageSubject = messageSubject;
    this.messageBody = messageBody;
    this.unbornRef = unbornRef === UNBORN;
    this.multiFileDiff = patch ? (0, _patch.buildMultiFilePatch)(patch) : (0, _patch.buildMultiFilePatch)([]);
  }

  getSha() {
    return this.sha;
  }

  getAuthor() {
    return this.author;
  }

  getAuthorEmail() {
    return this.author.getEmail();
  }

  getAuthorAvatarUrl() {
    return this.author.getAvatarUrl();
  }

  getAuthorName() {
    return this.author.getFullName();
  }

  getAuthorDate() {
    return this.authorDate;
  }

  getCoAuthors() {
    return this.coAuthors;
  }

  getMessageSubject() {
    return this.messageSubject;
  }

  getMessageBody() {
    return this.messageBody;
  }

  isBodyLong() {
    if (this.getMessageBody().length > this.constructor.LONG_MESSAGE_THRESHOLD) {
      return true;
    }

    if ((this.getMessageBody().match(/\r?\n/g) || []).length > this.constructor.NEWLINE_THRESHOLD) {
      return true;
    }

    return false;
  }

  getFullMessage() {
    return `${this.getMessageSubject()}\n\n${this.getMessageBody()}`.trim();
  }
  /*
   * Return the messageBody truncated to at most LONG_MESSAGE_THRESHOLD characters or NEWLINE_THRESHOLD newlines,
   * whichever comes first.
   *
   * If NEWLINE_THRESHOLD newlines are encountered before LONG_MESSAGE_THRESHOLD characters, the body will be truncated
   * at the last counted newline and elipses added.
   *
   * If a paragraph boundary is found before LONG_MESSAGE_THRESHOLD characters, the message will be truncated at the end
   * of the previous paragraph and an elipses added. If no paragraph boundary is found, but a word boundary is, the text
   * is truncated at the last word boundary and an elipsis added. If neither are found, the text is truncated hard at
   * LONG_MESSAGE_THRESHOLD - 3 characters and an elipsis is added.
   */


  abbreviatedBody() {
    if (!this.isBodyLong()) {
      return this.getMessageBody();
    }

    const {
      LONG_MESSAGE_THRESHOLD,
      NEWLINE_THRESHOLD
    } = this.constructor;
    let lastNewlineCutoff = null;
    let lastParagraphCutoff = null;
    let lastWordCutoff = null;
    const searchText = this.getMessageBody().substring(0, LONG_MESSAGE_THRESHOLD);
    const boundaryRx = /\s+/g;
    let result;
    let lineCount = 0;

    while ((result = boundaryRx.exec(searchText)) !== null) {
      const newlineCount = (result[0].match(/\r?\n/g) || []).length;
      lineCount += newlineCount;

      if (lineCount > NEWLINE_THRESHOLD) {
        lastNewlineCutoff = result.index;
        break;
      }

      if (newlineCount < 2 && result.index <= LONG_MESSAGE_THRESHOLD - WORD_ELIPSES.length) {
        lastWordCutoff = result.index;
      } else if (result.index < LONG_MESSAGE_THRESHOLD - PARAGRAPH_ELIPSES.length) {
        lastParagraphCutoff = result.index;
      }
    }

    let elipses = WORD_ELIPSES;
    let cutoffIndex = LONG_MESSAGE_THRESHOLD - WORD_ELIPSES.length;

    if (lastNewlineCutoff !== null) {
      elipses = NEWLINE_ELIPSES;
      cutoffIndex = lastNewlineCutoff;
    } else if (lastParagraphCutoff !== null) {
      elipses = PARAGRAPH_ELIPSES;
      cutoffIndex = lastParagraphCutoff;
    } else if (lastWordCutoff !== null) {
      cutoffIndex = lastWordCutoff;
    }

    return this.getMessageBody().substring(0, cutoffIndex) + elipses;
  }

  setMultiFileDiff(multiFileDiff) {
    this.multiFileDiff = multiFileDiff;
  }

  getMultiFileDiff() {
    return this.multiFileDiff;
  }

  isUnbornRef() {
    return this.unbornRef;
  }

  isPresent() {
    return true;
  }

  isEqual(other) {
    // Directly comparable properties
    const properties = ['sha', 'authorDate', 'messageSubject', 'messageBody', 'unbornRef'];

    for (const property of properties) {
      if (this[property] !== other[property]) {
        return false;
      }
    } // Author


    if (this.author.getEmail() !== other.getAuthorEmail() || this.author.getFullName() !== other.getAuthorName()) {
      return false;
    } // Co-author array


    if (this.coAuthors.length !== other.coAuthors.length) {
      return false;
    }

    for (let i = 0; i < this.coAuthors.length; i++) {
      const thisCoAuthor = this.coAuthors[i];
      const otherCoAuthor = other.coAuthors[i];

      if (thisCoAuthor.getFullName() !== otherCoAuthor.getFullName() || thisCoAuthor.getEmail() !== otherCoAuthor.getEmail()) {
        return false;
      }
    } // Multi-file patch


    if (!this.multiFileDiff.isEqual(other.multiFileDiff)) {
      return false;
    }

    return true;
  }

}

exports.default = Commit;

_defineProperty(Commit, "LONG_MESSAGE_THRESHOLD", 400);

_defineProperty(Commit, "NEWLINE_THRESHOLD", 5);

const nullCommit = {
  getSha() {
    return '';
  },

  getMessageSubject() {
    return '';
  },

  isUnbornRef() {
    return false;
  },

  isPresent() {
    return false;
  },

  isBodyLong() {
    return false;
  }

};
exports.nullCommit = nullCommit;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uL2xpYi9tb2RlbHMvY29tbWl0LmpzIl0sIm5hbWVzIjpbIlVOQk9STiIsIlN5bWJvbCIsIldPUkRfRUxJUFNFUyIsIk5FV0xJTkVfRUxJUFNFUyIsIlBBUkFHUkFQSF9FTElQU0VTIiwiQ29tbWl0IiwiY3JlYXRlVW5ib3JuIiwidW5ib3JuUmVmIiwiY29uc3RydWN0b3IiLCJzaGEiLCJhdXRob3IiLCJjb0F1dGhvcnMiLCJhdXRob3JEYXRlIiwibWVzc2FnZVN1YmplY3QiLCJtZXNzYWdlQm9keSIsInBhdGNoIiwibXVsdGlGaWxlRGlmZiIsImdldFNoYSIsImdldEF1dGhvciIsImdldEF1dGhvckVtYWlsIiwiZ2V0RW1haWwiLCJnZXRBdXRob3JBdmF0YXJVcmwiLCJnZXRBdmF0YXJVcmwiLCJnZXRBdXRob3JOYW1lIiwiZ2V0RnVsbE5hbWUiLCJnZXRBdXRob3JEYXRlIiwiZ2V0Q29BdXRob3JzIiwiZ2V0TWVzc2FnZVN1YmplY3QiLCJnZXRNZXNzYWdlQm9keSIsImlzQm9keUxvbmciLCJsZW5ndGgiLCJMT05HX01FU1NBR0VfVEhSRVNIT0xEIiwibWF0Y2giLCJORVdMSU5FX1RIUkVTSE9MRCIsImdldEZ1bGxNZXNzYWdlIiwidHJpbSIsImFiYnJldmlhdGVkQm9keSIsImxhc3ROZXdsaW5lQ3V0b2ZmIiwibGFzdFBhcmFncmFwaEN1dG9mZiIsImxhc3RXb3JkQ3V0b2ZmIiwic2VhcmNoVGV4dCIsInN1YnN0cmluZyIsImJvdW5kYXJ5UngiLCJyZXN1bHQiLCJsaW5lQ291bnQiLCJleGVjIiwibmV3bGluZUNvdW50IiwiaW5kZXgiLCJlbGlwc2VzIiwiY3V0b2ZmSW5kZXgiLCJzZXRNdWx0aUZpbGVEaWZmIiwiZ2V0TXVsdGlGaWxlRGlmZiIsImlzVW5ib3JuUmVmIiwiaXNQcmVzZW50IiwiaXNFcXVhbCIsIm90aGVyIiwicHJvcGVydGllcyIsInByb3BlcnR5IiwiaSIsInRoaXNDb0F1dGhvciIsIm90aGVyQ29BdXRob3IiLCJudWxsQ29t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Q0QsR0FQdUI7O0FBU3hCeUIsRUFBQUEsV0FBVyxHQUFHO0FBQ1osV0FBTyxLQUFQO0FBQ0QsR0FYdUI7O0FBYXhCQyxFQUFBQSxTQUFTLEdBQUc7QUFDVixXQUFPLEtBQVA7QUFDRCxHQWZ1Qjs7QUFpQnhCeEIsRUFBQUEsVUFBVSxHQUFHO0FBQ1gsV0FBTyxLQUFQO0FBQ0Q7O0FBbkJ1QixDQUFuQiIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7YnVpbGRNdWx0aUZpbGVQYXRjaH0gZnJvbSAnLi9wYXRjaCc7XG5cbmNvbnN0IFVOQk9STiA9IFN5bWJvbCgndW5ib3JuJyk7XG5cbi8vIFRydW5jYXRpb24gZWxpcHNpcyBzdHlsZXNcbmNvbnN0IFdPUkRfRUxJUFNFUyA9ICcuLi4nO1xuY29uc3QgTkVXTElORV9FTElQU0VTID0gJ1xcbi4uLic7XG5jb25zdCBQQVJBR1JBUEhfRUxJUFNFUyA9ICdcXG5cXG4uLi4nO1xuXG5leHBvcnQgZGVmYXVsdCBjbGFzcyBDb21taXQge1xuICBzdGF0aWMgTE9OR19NRVNTQUdFX1RIUkVTSE9MRCA9IDQwMDtcblxuICBzdGF0aWMgTkVXTElORV9USFJFU0hPTEQgPSA1O1xuXG4gIHN0YXRpYyBjcmVhdGVVbmJvcm4oKSB7XG4gICAgcmV0dXJuIG5ldyBDb21taXQoe3VuYm9yblJlZjogVU5CT1JOfSk7XG4gIH1cblxuICBjb25zdHJ1Y3Rvcih7c2hhLCBhdXRob3IsIGNvQXV0aG9ycywgYXV0aG9yRGF0ZSwgbWVzc2FnZVN1YmplY3QsIG1lc3NhZ2VCb2R5LCB1bmJvcm5SZWYsIHBhdGNofSkge1xuICAgIHRoaXMuc2hhID0gc2hhO1xuICAgIHRoaXMuYXV0aG9yID0gYXV0aG9yO1xuICAgIHRoaXMuY29BdXRob3JzID0gY29BdXRob3JzIHx8IFtdO1xuICAgIHRoaXMuYXV0aG9yRGF0ZSA9IGF1dGhvckRhdGU7XG4gICAgdGhpcy5tZXNzYWdlU3ViamVjdCA9IG1lc3NhZ2VTdWJqZWN0O1xuICAgIHRoaXMubWVzc2FnZUJvZHkgPSBtZXNzYWdlQm9keTtcbiAgICB0aGlzLnVuYm9yblJlZiA9IHVuYm9yblJlZiA9PT0gVU5CT1JOO1xuXG4gICAgdGhpcy5tdWx0aUZpbGVEaWZmID0gcGF0Y2ggPyBidWlsZE11bHRpRmlsZVBhdGNoKHBhdGNoKSA6IGJ1aWxkTXVsdGlGaWxlUGF0Y2goW10pO1xuICB9XG5cbiAgZ2V0U2hhKCkge1xuICAgIHJldHVybiB0aGlzLnNoYTtcbiAgfVxuXG4gIGdldEF1dGhvcigpIHtcbiAgICByZXR1cm4gdGhpcy5hdXRob3I7XG4gIH1cblxuICBnZXRBdXRob3JFbWFpbCgpIHtcbiAgICByZXR1cm4gdGhpcy5hdXRob3IuZ2V0RW1haWwoKTtcbiAgfVxuXG4gIGdldEF1dGhvckF2YXRhclVybCgpIHtcbiAgICByZXR1cm4gdGhpcy5hdXRob3IuZ2V0QXZhdGFyVXJsKCk7XG4gIH1cblxuICBnZXRBdXRob3JOYW1lKCkge1xuICAgIHJldHVybiB0aGlzLmF1dGhvci5nZXRGdWxsTmFtZSgpO1xuICB9XG5cbiAgZ2V0QXV0aG9yRGF0ZSgpIHtcbiAgICByZXR1cm4gdGhpcy5hdXRob3JEYXRlO1xuICB9XG5cbiAgZ2V0Q29BdXRob3JzKCkge1xuICAgIHJldHVybiB0aGlzLmNvQXV0aG9ycztcbiAgfVxuXG4gIGdldE1lc3NhZ2VTdWJqZWN0KCkge1xuICAgIHJldHVybiB0aGlzLm1lc3NhZ2VTdWJqZWN0O1xuICB9XG5cbiAgZ2V0TWVzc2FnZUJvZHkoKSB7XG4gICAgcmV0dXJuIHRoaXMubWVzc2FnZUJvZHk7XG4gIH1cblxuICBpc0JvZHlMb25nKCkge1xuICAgIGlmICh0aGlzLmdldE1lc3NhZ2VCb2R5KCkubGVuZ3RoID4gdGhpcy5jb25zdHJ1Y3Rvci5MT05HX01FU1NBR0VfVEhSRVNIT0xEKSB7XG4gICAgICByZXR1cm4gdHJ1ZTtcbiAgICB9XG5cbiAgICBpZiAoKHRoaXMuZ2V0TWVzc2FnZUJvZHkoKS5tYXRjaCgvXFxyP1xcbi9nKSB8fCBbXSkubGVuZ3RoID4gdGhpcy5jb25zdHJ1Y3Rvci5ORVdMSU5FX1RIUkVTSE9MRCkge1xuICAgICAgcmV0dXJuIHRydWU7XG4gICAgfVxuXG4gICAgcmV0dXJuIGZhbHNlO1xuICB9XG5cbiAgZ2V0RnVsbE1lc3NhZ2UoKSB7XG4gICAgcmV0dXJuIGAke3RoaXMuZ2V0TWVzc2FnZVN1YmplY3QoKX1cXG5cXG4ke3RoaXMuZ2V0TWVzc2FnZUJvZHkoKX1gLnRyaW0oKTtcbiAgfVxuXG4gIC8qXG4gICAqIFJldHVybiB0aGUgbWVzc2FnZUJvZHkgdHJ1bmNhdGVkIHRvIGF0IG1vc3QgTE9OR19NRVNTQUdFX1RIUkVTSE9MRCBjaGFyYWN0ZXJzIG9yIE5FV0xJTkVfVEhSRVNIT0xEIG5ld2xpbmVzLFxuICAgKiB3aGljaGV2ZXIgY29tZXMgZmlyc3QuXG4gICAqXG4gICAqIElmIE5FV0xJTkVfVEhSRVNIT0xEIG5ld2xpbmVzIGFyZSBlbmNvdW50ZXJlZCBiZWZvcmUgTE9OR19NRVNTQUdFX1RIUkVTSE9MRCBjaGFyYWN0ZXJzLCB0aGUgYm9keSB3aWxsIGJlIHRydW5jYXRlZFxuICAgKiBhdCB0aGUgbGFzdCBjb3VudGVkIG5ld2xpbmUgYW5kIGVsaXBzZXMgYWRkZWQuXG4gICAqXG4gICAqIElmIGEgcGFyYWdyYXBoIGJvdW5kYXJ5IGlzIGZvdW5kIGJlZm9yZSBMT05HX01FU1NBR0VfVEhSRVNIT0xEIGNoYXJhY3RlcnMsIHRoZSBtZXNzYWdlIHdpbGwgYmUgdHJ1bmNhdGVkIGF0IHRoZSBlbmRcbiAgICogb2YgdGhlIHByZXZpb3VzIHBhcmFncmFwaCBhbmQgYW4gZWxpcHNlcyBhZGRlZC4gSWYgbm8gcGFyYWdyYXBoIGJvdW5kYXJ5IGlzIGZvdW5kLCBidXQgYSB3b3JkIGJvdW5kYXJ5IGlzLCB0aGUgdGV4dFxuICAgKiBpcyB0cnVuY2F0ZWQgYXQgdGhlIGxhc3Qgd29yZCBib3VuZGFyeSBhbmQgYW4gZWxpcHNpcyBhZGRlZC4gSWYgbmVpdGhlciBhcmUgZm91bmQsIHRoZSB0ZXh0IGlzIHRydW5jYXRlZCBoYXJkIGF0XG4gICAqIExPTkdfTUVTU0FHRV9USFJFU0hPTEQgLSAzIGNoYXJhY3RlcnMgYW5kIGFuIGVsaXBzaXMgaXMgYWRkZWQuXG4gICAqL1xuICBhYmJyZXZpYXRlZEJvZHkoKSB7XG4gICAgaWYgKCF0aGlzLmlzQm9keUxvbmcoKSkge1xuICAgICAgcmV0dXJuIHRoaXMuZ2V0TWVzc2FnZUJvZHkoKTtcbiAgICB9XG5cbiAgICBjb25zdCB7TE9OR19NRVNTQUdFX1RIUkVTSE9MRCwgTkVXTElORV9USFJFU0hPTER9ID0gdGhpcy5jb25zdHJ1Y3RvcjtcblxuICAgIGxldCBsYXN0TmV3bGluZUN1dG9mZiA9IG51bGw7XG4gICAgbGV0IGxhc3RQYXJhZ3JhcGhDdXRvZmYgPSBudWxsO1xuICAgIGxldCBsYXN0V29yZEN1dG9mZiA9IG51bGw7XG5cbiAgICBjb25zdCBzZWFyY2hUZXh0ID0gdGhpcy5nZXRNZXNzYWdlQm9keSgpLnN1YnN0cmluZygwLCBMT05HX01FU1NBR0VfVEhSRVNIT0xEKTtcbiAgICBjb25zdCBib3VuZGFyeVJ4ID0gL1xccysvZztcbiAgICBsZXQgcmVzdWx0O1xuICAgIGxldCBsaW5lQ291bnQgPSAwO1xuICAgIHdoaWxlICgocmVzdWx0ID0gYm91bmRhcnlSeC5leGVjKHNlYXJjaFRleHQpKSAhPT0gbnVsbCkge1xuICAgICAgY29uc3QgbmV3bGluZUNvdW50ID0gKHJlc3VsdFswXS5tYXRjaCgvXFxyP1xcbi9nKSB8fCBbXSkubGVuZ3RoO1xuXG4gICAgICBsaW5lQ291bnQgKz0gbmV3bGluZUNvdW50O1xuICAgICAgaWYgKGxpbmVDb3VudCA+IE5FV0xJTkVfVEhSRVNIT0xEKSB7XG4gICAgICAgIGxhc3ROZXdsaW5lQ3V0b2ZmID0gcmVzdWx0LmluZGV4O1xuICAgICAgICBicmVhaztcbiAgICAgIH1cblxuICAgICAgaWYgKG5ld2xpbmVDb3VudCA8IDIgJiYgcmVzdWx0LmluZGV4IDw9IExPTkdfTUVTU0FHRV9USFJFU0hPTEQgLSBXT1JEX0VMSVBTRVMubGVuZ3RoKSB7XG4gICAgICAgIGxhc3RXb3JkQ3V0b2ZmID0gcmVzdWx0LmluZGV4O1xuICAgICAgfSBlbHNlIGlmIChyZXN1bHQuaW5kZXggPCBMT05HX01FU1NBR0VfVEhSRVNIT0xEIC0gUEFSQUdSQVBIX0VMSVBTRVMubGVuZ3RoKSB7XG4gICAgICAgIGxhc3RQYXJhZ3JhcGhDdXRvZmYgPSByZXN1bHQuaW5kZXg7XG4gICAgICB9XG4gICAgfVxuXG4gICAgbGV0IGVsaXBzZXMgPSBXT1JEX0VMSVBTRVM7XG4gICAgbGV0IGN1dG9mZkluZGV4ID0gTE9OR19NRVNTQUdFX1RIUkVTSE9MRCAtIFdPUkRfRUxJUFNFUy5sZW5ndGg7XG4gICAgaWYgKGxhc3ROZXdsaW5lQ3V0b2ZmICE9PSBudWxsKSB7XG4gICAgICBlbGlwc2VzID0gTkVXTElORV9FTElQU0VTO1xuICAgICAgY3V0b2ZmSW5kZXggPSBsYXN0TmV3bGluZUN1dG9mZjtcbiAgICB9IGVsc2UgaWYgKGxhc3RQYXJhZ3JhcGhDdXRvZmYgIT09IG51bGwpIHtcbiAgICAgIGVsaXBzZXMgPSBQQVJBR1JBUEhfRUxJUFNFUztcbiAgICAgIGN1dG9mZkluZGV4ID0gbGFzdFBhcmFncmFwaEN1dG9mZjtcbiAgICB9IGVsc2UgaWYgKGxhc3RXb3JkQ3V0b2ZmICE9PSBudWxsKSB7XG4gICAgICBjdXRvZmZJbmRleCA9IGxhc3RXb3JkQ3V0b2ZmO1xuICAgIH1cblxuICAgIHJldHVybiB0aGlzLmdldE1lc3NhZ2VCb2R5KCkuc3Vic3RyaW5nKDAsIGN1dG9mZkluZGV4KSArIGVsaXBzZXM7XG4gIH1cblxuICBzZXRNdWx0aUZpbGVEaWZmKG11bHRpRmlsZURpZmYpIHtcbiAgICB0aGlzLm11bHRpRmlsZURpZmYgPSBtdWx0aUZpbGVEaWZmO1xuICB9XG5cbiAgZ2V0TXVsdGlGaWxlRGlmZigpIHtcbiAgICByZXR1cm4gdGhpcy5tdWx0aUZpbGVEaWZmO1xuICB9XG5cbiAgaXNVbmJvcm5SZWYoKSB7XG4gICAgcmV0dXJuIHRoaXMudW5ib3JuUmVmO1xuICB9XG5cbiAgaXNQcmVzZW50KCkge1xuICAgIHJldHVybiB0cnVlO1xuICB9XG5cbiAgaXNFcXVhbChvdGhlcikge1xuICAgIC8vIERpcmVjdGx5IGNvbXBhcmFibGUgcHJvcGVydGllc1xuICAgIGNvbnN0IHByb3BlcnRpZXMgPSBbJ3NoYScsICdhdXRob3JEYXRlJywgJ21lc3NhZ2VTdWJqZWN0JywgJ21lc3NhZ2VCb2R5JywgJ3VuYm9yblJlZiddO1xuICAgIGZvciAoY29uc3QgcHJvcGVydHkgb2YgcHJvcGVydGllcykge1xuICAgICAgaWYgKHRoaXNbcHJvcGVydHldICE9PSBvdGhlcltwcm9wZXJ0eV0pIHtcbiAgICAgICAgcmV0dXJuIGZhbHNlO1xuICAgICAgfVxuICAgIH1cblxuICAgIC8vIEF1dGhvclxuICAgIGlmICh0aGlzLmF1dGhvci5nZXRFbWFpbCgpICE9PSBvdGhlci5nZXRBdXRob3JFbWFpbCgpIHx8IHRoaXMuYXV0aG9yLmdldEZ1bGxOYW1lKCkgIT09IG90aGVyLmdldEF1dGhvck5hbWUoKSkge1xuICAgICAgcmV0dXJuIGZhbHNlO1xuICAgIH1cblxuICAgIC8vIENvLWF1dGhvciBhcnJheVxuICAgIGlmICh0aGlzLmNvQXV0aG9ycy5sZW5ndGggIT09IG90aGVyLmNvQXV0aG9ycy5sZW5ndGgpIHtcbiAgICAgIHJldHVybiBmYWxzZTtcbiAgICB9XG4gICAgZm9yIChsZXQgaSA9IDA7IGkgPCB0aGlzLmNvQXV0aG9ycy5sZW5ndGg7IGkrKykge1xuICAgICAgY29uc3QgdGhpc0NvQXV0aG9yID0gdGhpcy5jb0F1dGhvcnNbaV07XG4gICAgICBjb25zdCBvdGhlckNvQXV0aG9yID0gb3RoZXIuY29BdXRob3JzW2ldO1xuXG4gICAgICBpZiAoXG4gICAgICAgIHRoaXNDb0F1dGhvci5nZXRGdWxsTmFtZSgpICE9PSBvdGhlckNvQXV0aG9yLmdldEZ1bGxOYW1lKClcbiAgICAgICAgfHwgdGhpc0NvQXV0aG9yLmdldEVtYWlsKCkgIT09IG90aGVyQ29BdXRob3IuZ2V0RW1haWwoKVxuICAgICAgKSB7XG4gICAgICAgIHJldHVybiBmYWxzZTtcbiAgICAgIH1cbiAgICB9XG5cbiAgICAvLyBNdWx0aS1maWxlIHBhdGNoXG4gICAgaWYgKCF0aGlzLm11bHRpRmlsZURpZmYuaXNFcXVhbChvdGhlci5tdWx0aUZpbGVEaWZmKSkge1xuICAgICAgcmV0dXJuIGZhbHNlO1xuICAgIH1cblxuICAgIHJldHVybiB0cnVlO1xuICB9XG59XG5cbmV4cG9ydCBjb25zdCBudWxsQ29tbWl0ID0ge1xuICBnZXRTaGEoKSB7XG4gICAgcmV0dXJuICcnO1xuICB9LFxuXG4gIGdldE1lc3NhZ2VTdWJqZWN0KCkge1xuICAgIHJldHVybiAnJztcbiAgfSxcblxuICBpc1VuYm9yblJlZigpIHtcbiAgICByZXR1cm4gZmFsc2U7XG4gIH0sXG5cbiAgaXNQcmVzZW50KCkge1xuICAgIHJldHVybiBmYWxzZTtcbiAgfSxcblxuICBpc0JvZHlMb25nKCkge1xuICAgIHJldHVybiBmYWxzZTtcbiAgfSxcbn07XG4iXX0=