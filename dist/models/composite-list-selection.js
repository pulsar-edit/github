"use strict";

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.default = void 0;

var _listSelection = _interopRequireDefault(require("./list-selection"));

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }

const COPY = Symbol('COPY');

class CompositeListSelection {
  constructor(options) {
    if (options._copy !== COPY) {
      this.keysBySelection = new Map();
      this.selections = [];

      this.idForItem = options.idForItem || (item => item);

      this.resolveNextUpdatePromise = () => {};

      this.activeSelectionIndex = null;

      for (const [key, items] of options.listsByKey) {
        const selection = new _listSelection.default({
          items
        });
        this.keysBySelection.set(selection, key);
        this.selections.push(selection);

        if (this.activeSelectionIndex === null && selection.getItems().length) {
          this.activeSelectionIndex = this.selections.length - 1;
        }
      }

      if (this.activeSelectionIndex === null) {
        this.activeSelectionIndex = 0;
      }
    } else {
      this.keysBySelection = options.keysBySelection;
      this.selections = options.selections;
      this.idForItem = options.idForItem;
      this.activeSelectionIndex = options.activeSelectionIndex;
      this.resolveNextUpdatePromise = options.resolveNextUpdatePromise;
    }
  }

  copy(options = {}) {
    let selections = [];
    let keysBySelection = new Map();

    if (options.keysBySelection || options.selections) {
      if (!options.keysBySelection || !options.selections) {
        throw new Error('keysBySelection and selection must always be updated simultaneously');
      }

      selections = options.selections;
      keysBySelection = options.keysBySelection;
    } else {
      selections = this.selections;
      keysBySelection = this.keysBySelection;
    }

    return new CompositeListSelection({
      keysBySelection,
      selections,
      activeSelectionIndex: options.activeSelectionIndex !== undefined ? options.activeSelectionIndex : this.activeSelectionIndex,
      idForItem: options.idForItem || this.idForItem,
      resolveNextUpdatePromise: options.resolveNextUpdatePromise || this.resolveNextUpdatePromise,
      _copy: COPY
    });
  }

  updateLists(listsByKey) {
    let isDifferent = false;

    if (listsByKey.length === 0) {
      return this;
    }

    const newKeysBySelection = new Map();
    const newSelections = [];

    for (let i = 0; i < listsByKey.length; i++) {
      const [key, newItems] = listsByKey[i];
      let selection = this.selections[i];
      const oldItems = selection.getItems();

      if (!isDifferent) {
        isDifferent = oldItems.length !== newItems.length || oldItems.some((oldItem, j) => oldItem === newItems[j]);
      }

      const oldHeadItem = selection.getHeadItem();
      selection = selection.setItems(newItems);
      let newHeadItem = null;

      if (oldHeadItem) {
        newHeadItem = newItems.find(item => this.idForItem(item) === this.idForItem(oldHeadItem));
      }

      if (newHeadItem) {
        selection = selection.selectItem(newHeadItem);
      }

      newKeysBySelection.set(selection, key);
      newSelections.push(selection);
    }

    let updated = this.copy({
      keysBySelection: newKeysBySelection,
      selections: newSelections
    });

    if (updated.getActiveSelection().getItems().length === 0) {
      const next = updated.activateNextSelection();
      updated = next !== updated ? next : updated.activatePreviousSelection();
    }

    updated.resolveNextUpdatePromise();
    return updated;
  }

  updateActiveSelection(fn) {
    const oldSelection = this.getActiveSelection();
    const newSelection = fn(oldSelection);

    if (oldSelection === newSelection) {
      return this;
    }

    const key = this.keysBySelection.get(oldSelection);
    const newKeysBySelection = new Map(this.keysBySelection);
    newKeysBySelection.delete(oldSelection);
    newKeysBySelection.set(newSelection, key);
    const newSelections = this.selections.slice();
    newSelections[this.activeSelectionIndex] = newSelection;
    return this.copy({
      keysBySelection: newKeysBySelection,
      selections: newSelections
    });
  }

  getNextUpdatePromise() {
    return new Promise((resolve, reject) => {
      this.resolveNextUpdatePromise = resolve;
    });
  }

  selectFirstNonEmptyList() {
    return this.copy({
      activeSelectionIndex: this.selections.findIndex(selection => selection.getItems().length > 0)
    });
  }

  getActiveListKey() {
    return this.keysBySelection.get(this.getActiveSelection());
  }

  getSelectedItems() {
    return this.getActiveSelection().getSelectedItems();
  }

  getHeadItem() {
    return this.getActiveSelection().getHeadItem();
  }

  getActiveSelection() {
    return this.selections[this.activeSelectionIndex];
  }

  activateSelection(selection) {
    const index = this.selections.indexOf(selection);

    if (index === -1) {
      throw new Error('Selection not found');
    }

    return this.copy({
      activeSelectionIndex: index
    });
  }

  activateNextSelection() {
    for (let i = this.activeSelectionIndex + 1; i < this.selections.length; i++) {
      if (this.selections[i].getItems().length > 0) {
        return this.copy({
          activeSelectionIndex: i
        });
      }
    }

    return this;
  }

  activatePreviousSelection() {
    for (let i = this.activeSelectionIndex - 1; i >= 0; i--) {
      if (this.selections[i].getItems().length > 0) {
        return this.copy({
          activeSelectionIndex: i
        });
      }
    }

    return this;
  }

  activateLastSelection() {
    for (let i = this.selections.length - 1; i >= 0; i--) {
      if (this.selections[i].getItems().length > 0) {
        return this.copy({
          activeSelectionIndex: i
        });
      }
    }

    return this;
  }

  selectItem(item, preserveTail = false) {
    const selection = this.selectionForItem(item);

    if (!selection) {
      throw new Error(`No item found: ${item}`);
    }

    let next = this;

    if (!preserveTail) {
      next = next.activateSelection(selection);
    }

    if (selection === next.getActiveSelection()) {
      next = next.updateActiveSelection(s => s.selectItem(item, preserveTail));
    }

    return next;
  }

  addOrSubtractSelection(item) {
    const selection = this.selectionForItem(item);

    if (!selection) {
      throw new Error(`No item found: ${item}`);
    }

    if (selection === this.getActiveSelection()) {
      return this.updateActiveSelection(s => s.addOrSubtractSelection(item));
    } else {
      return this.activateSelection(selection).updateActiveSelection(s => s.selectItem(item));
    }
  }

  selectAllItems() {
    return this.updateActiveSelection(s => s.selectAllItems());
  }

  selectFirstItem(preserveTail) {
    return this.updateActiveSelection(s => s.selectFirstItem(preserveTail));
  }

  selectLastItem(preserveTail) {
    return this.updateActiveSelection(s => s.selectLastItem(preserveTail));
  }

  coalesce() {
    return this.updateActiveSelection(s => s.coalesce());
  }

  selectionForItem(item) {
    return this.selections.find(selection => selection.getItems().includes(item));
  }

  listKeyForItem(item) {
    return this.keysBySelection.get(this.selectionForItem(item));
  }

  selectNextItem(preserveTail = false) {
    let next = this;

    if (!preserveTail && next.getActiveSelection().getHeadItem() === next.getActiveSelection().getLastItem()) {
      next = next.activateNextSelection();

      if (next !== this) {
        return next.updateActiveSelection(s => s.selectFirstItem());
      } else {
        return next.updateActiveSelection(s => s.selectLastItem());
      }
    } else {
      return next.updateActiveSelection(s => s.selectNextItem(preserveTail));
    }
  }

  selectPreviousItem(preserveTail = false) {
    let next = this;

    if (!preserveTail && next.getActiveSelection().getHeadItem() === next.getActiveSelection().getItems()[0]) {
      next = next.activatePreviousSelection();

      if (next !== this) {
        return next.updateActiveSelection(s => s.selectLastItem());
      } else {
        return next.updateActiveSelection(s => s.selectFirstItem());
      }
    } else {
      return next.updateActiveSelection(s => s.selectPreviousItem(preserveTail));
    }
  }

  findItem(predicate) {
    for (let i = 0; i < this.selections.length; i++) {
      const selection = this.selections[i];
      const key = this.keysBySelection.get(selection);
      const found = selection.getItems().find(item => predicate(item, key));

      if (found !== undefined) {
        return found;
      }
    }

    return null;
  }

}

exports.default = CompositeListSelection;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uL2xpYi9tb2RlbHMvY29tcG9zaXRlLWxpc3Qtc2VsZWN0aW9uLmpzIl0sIm5hbWVzIjpbIkNPUFkiLCJTeW1ib2wiLCJDb21wb3NpdGVMaXN0U2VsZWN0aW9uIiwiY29uc3RydWN0b3IiLCJvcHRpb25zIiwiX2NvcHkiLCJrZXlzQnlTZWxlY3Rpb24iLCJNYXAiLCJzZWxlY3Rpb25zIiwiaWRGb3JJdGVtIiwiaXRlbSIsInJlc29sdmVOZXh0VXBkYXRlUHJvbWlzZSIsImFjdGl2ZVNlbGVjdGlvbkluZGV4Iiwia2V5IiwiaXRlbXMiLCJsaXN0c0J5S2V5Iiwic2VsZWN0aW9uIiwiTGlzdFNlbGVjdGlvbiIsInNldCIsInB1c2giLCJnZXRJdGVtcyIsImxlbmd0aCIsImNvcHkiLCJFcnJvciIsInVuZGVmaW5lZCIsInVwZGF0ZUxpc3RzIiwiaXNEaWZmZXJlbnQiLCJuZXdLZXlzQnlTZWxlY3Rpb24iLCJuZXdTZWxlY3Rpb25zIiwiaSIsIm5ld0l0ZW1zIiwib2xkSXRlbXMiLCJzb21lIiwib2xkSXRlbSIsImoiLCJvbGRIZWFkSXRlbSIsImdldEhlYWRJdGVtIiwic2V0SXRlbXMiLCJuZXdIZWFkSXRlbSIsImZpbmQiLCJzZWxlY3RJdGVtIiwidXBkYXRlZCIsImdldEFjdGl2ZVNlbGVjdGlvbiIsIm5leHQiLCJhY3RpdmF0ZU5leHRTZWxlY3Rpb24iLCJhY3RpdmF0ZVByZXZpb3VzU2VsZWN0aW9uIiwidXBkYXRlQWN0aXZlU2VsZWN0aW9uIiwiZm4iLCJvbGRTZWxlY3Rpb24iLCJuZXdTZWxlY3Rpb24iLCJnZXQiLCJkZWxldGUiLCJzbGljZSIsImdldE5leHRVcGRhdGVQcm9taXNlIiwiUHJvbWlzZSIsInJlc29sdmUiLCJyZWplY3QiLCJzZWxlY3RGaXJzdE5vbkVtcHR5TGlzdCIsImZpbmRJbmRleCIsImdldEFjdGl2ZUxpc3RLZXkiLCJnZXRTZWxlY3RlZEl0ZW1zIiwiYWN0aXZhdGVTZWxlY3Rpb24iLCJpbmRleCIsImluZGV4T2YiLCJhY3RpdmF0ZUxhc3RTZWxlY3Rpb24iLCJwcmVzZXJ2ZVRhaWwiLCJzZWxlY3Rpb25Gb3JJdGVtIiwicyIsImFkZE9yU3VidHJhY3RTZWxlY3Rpb24iLCJzZWxlY3RBbGxJdGVtcyIsInNlbGVjdEZpcnN0SXRlbSIsInNlbGVjdExhc3RJdGVtIiwiY29hbGVzY2UiLCJpbmNsdWRlcyIsImxpc3RLZXlGb3JJdGVtIiwic2VsZWN0TmV4dEl0ZW0iLCJnZXRMYXN0SXRlbSIsInNlbGVjdFByZXZpb3VzSXRlbSIsImZpbmRJdGVtIiwicHJlZGljYXRlIiwiZm91bmQiXSwibWFwcGluZ3MiOiI7Ozs7Ozs7QUFBQTs7OztBQUVBLE1BQU1BLElBQUksR0FBR0MsTUFBTSxDQUFDLE1BQUQsQ0FBbkI7O0FBRWUsTUFBTUMsc0JBQU4sQ0FBNkI7QUFDMUNDLEVBQUFBLFdBQVcsQ0FBQ0MsT0FBRCxFQUFVO0FBQ25CLFFBQUlBLE9BQU8sQ0FBQ0MsS0FBUixLQUFrQkwsSUFBdEIsRUFBNEI7QUFDMUIsV0FBS00sZUFBTCxHQUF1QixJQUFJQyxHQUFKLEVBQXZCO0FBQ0EsV0FBS0MsVUFBTCxHQUFrQixFQUFsQjs7QUFDQSxXQUFLQyxTQUFMLEdBQWlCTCxPQUFPLENBQUNLLFNBQVIsS0FBc0JDLElBQUksSUFBSUEsSUFBOUIsQ0FBakI7O0FBQ0EsV0FBS0Msd0JBQUwsR0FBZ0MsTUFBTSxDQUFFLENBQXhDOztBQUNBLFdBQUtDLG9CQUFMLEdBQTRCLElBQTVCOztBQUVBLFdBQUssTUFBTSxDQUFDQyxHQUFELEVBQU1DLEtBQU4sQ0FBWCxJQUEyQlYsT0FBTyxDQUFDVyxVQUFuQyxFQUErQztBQUM3QyxjQUFNQyxTQUFTLEdBQUcsSUFBSUMsc0JBQUosQ0FBa0I7QUFBQ0gsVUFBQUE7QUFBRCxTQUFsQixDQUFsQjtBQUNBLGFBQUtSLGVBQUwsQ0FBcUJZLEdBQXJCLENBQXlCRixTQUF6QixFQUFvQ0gsR0FBcEM7QUFDQSxhQUFLTCxVQUFMLENBQWdCVyxJQUFoQixDQUFxQkgsU0FBckI7O0FBRUEsWUFBSSxLQUFLSixv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LFNBQVMsR0FBRyxLQUFLUixVQUFMLENBQWdCcUIsQ0FBaEIsQ0FBbEI7QUFDQSxZQUFNaEIsR0FBRyxHQUFHLEtBQUtQLGVBQUwsQ0FBcUI0QyxHQUFyQixDQUF5QmxDLFNBQXpCLENBQVo7QUFDQSxZQUFNZ0UsS0FBSyxHQUFHaEUsU0FBUyxDQUFDSSxRQUFWLEdBQXFCbUIsSUFBckIsQ0FBMEI3QixJQUFJLElBQUlxRSxTQUFTLENBQUNyRSxJQUFELEVBQU9HLEdBQVAsQ0FBM0MsQ0FBZDs7QUFDQSxVQUFJbUUsS0FBSyxLQUFLeEQsU0FBZCxFQUF5QjtBQUN2QixlQUFPd0QsS0FBUDtBQUNEO0FBQ0Y7O0FBQ0QsV0FBTyxJQUFQO0FBQ0Q7O0FBeFJ5QyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCBMaXN0U2VsZWN0aW9uIGZyb20gJy4vbGlzdC1zZWxlY3Rpb24nO1xuXG5jb25zdCBDT1BZID0gU3ltYm9sKCdDT1BZJyk7XG5cbmV4cG9ydCBkZWZhdWx0IGNsYXNzIENvbXBvc2l0ZUxpc3RTZWxlY3Rpb24ge1xuICBjb25zdHJ1Y3RvcihvcHRpb25zKSB7XG4gICAgaWYgKG9wdGlvbnMuX2NvcHkgIT09IENPUFkpIHtcbiAgICAgIHRoaXMua2V5c0J5U2VsZWN0aW9uID0gbmV3IE1hcCgpO1xuICAgICAgdGhpcy5zZWxlY3Rpb25zID0gW107XG4gICAgICB0aGlzLmlkRm9ySXRlbSA9IG9wdGlvbnMuaWRGb3JJdGVtIHx8IChpdGVtID0+IGl0ZW0pO1xuICAgICAgdGhpcy5yZXNvbHZlTmV4dFVwZGF0ZVByb21pc2UgPSAoKSA9PiB7fTtcbiAgICAgIHRoaXMuYWN0aXZlU2VsZWN0aW9uSW5kZXggPSBudWxsO1xuXG4gICAgICBmb3IgKGNvbnN0IFtrZXksIGl0ZW1zXSBvZiBvcHRpb25zLmxpc3RzQnlLZXkpIHtcbiAgICAgICAgY29uc3Qgc2VsZWN0aW9uID0gbmV3IExpc3RTZWxlY3Rpb24oe2l0ZW1zfSk7XG4gICAgICAgIHRoaXMua2V5c0J5U2VsZWN0aW9uLnNldChzZWxlY3Rpb24sIGtleSk7XG4gICAgICAgIHRoaXMuc2VsZWN0aW9ucy5wdXNoKHNlbGVjdGlvbik7XG5cbiAgICAgICAgaWYgKHRoaXMuYWN0aXZlU2VsZWN0aW9uSW5kZXggPT09IG51bGwgJiYgc2VsZWN0aW9uLmdldEl0ZW1zKCkubGVuZ3RoKSB7XG4gICAgICAgICAgdGhpcy5hY3RpdmVTZWxlY3Rpb25JbmRleCA9IHRoaXMuc2VsZWN0aW9ucy5sZW5ndGggLSAxO1xuICAgICAgICB9XG4gICAgICB9XG5cbiAgICAgIGlmICh0aGlzLmFjdGl2ZVNlbGVjdGlvbkluZGV4ID09PSBudWxsKSB7XG4gICAgICAgIHRoaXMuYWN0aXZlU2VsZWN0aW9uSW5kZXggPSAwO1xuICAgICAgfVxuICAgIH0gZWxzZSB7XG4gICAgICB0aGlzLmtleXNCeVNlbGVjdGlvbiA9IG9wdGlvbnMua2V5c0J5U2VsZWN0aW9uO1xuICAgICAgdGhpcy5zZWxlY3Rpb25zID0gb3B0aW9ucy5zZWxlY3Rpb25zO1xuICAgICAgdGhpcy5pZEZvckl0ZW0gPSBvcHRpb25zLmlkRm9ySXRlbTtcbiAgICAgIHRoaXMuYWN0aXZlU2VsZWN0aW9uSW5kZXggPSBvcHRpb25zLmFjdGl2ZVNlbGVjdGlvbkluZGV4O1xuICAgICAgdGhpcy5yZXNvbHZlTmV4dFVwZGF0ZVByb21pc2UgPSBvcHRpb25zLnJlc29sdmVOZXh0VXBkYXRlUHJvbWlzZTtcbiAgICB9XG4gIH1cblxuICBjb3B5KG9wdGlvbnMgPSB7fSkge1xuICAgIGxldCBzZWxlY3Rpb25zID0gW107XG4gICAgbGV0IGtleXNCeVNlbGVjdGlvbiA9IG5ldyBNYXAoKTtcblxuICAgIGlmIChvcHRpb25zLmtleXNCeVNlbGVjdGlvbiB8fCBvcHRpb25zLnNlbGVjdGlvbnMpIHtcbiAgICAgIGlmICghb3B0aW9ucy5rZXlzQnlTZWxlY3Rpb24gfHwgIW9wdGlvbnMuc2VsZWN0aW9ucykge1xuICAgICAgICB0aHJvdyBuZXcgRXJyb3IoJ2tleXNCeVNlbGVjdGlvbiBhbmQgc2VsZWN0aW9uIG11c3QgYWx3YXlzIGJlIHVwZGF0ZWQgc2ltdWx0YW5lb3VzbHknKTtcbiAgICAgIH1cblxuICAgICAgc2VsZWN0aW9ucyA9IG9wdGlvbnMuc2VsZWN0aW9ucztcbiAgICAgIGtleXNCeVNlbGVjdGlvbiA9IG9wdGlvbnMua2V5c0J5U2VsZWN0aW9uO1xuICAgIH0gZWxzZSB7XG4gICAgICBzZWxlY3Rpb25zID0gdGhpcy5zZWxlY3Rpb25zO1xuICAgICAga2V5c0J5U2VsZWN0aW9uID0gdGhpcy5rZXlzQnlTZWxlY3Rpb247XG4gICAgfVxuXG4gICAgcmV0dXJuIG5ldyBDb21wb3NpdGVMaXN0U2VsZWN0aW9uKHtcbiAgICAgIGtleXNCeVNlbGVjdGlvbixcbiAgICAgIHNlbGVjdGlvbnMsXG4gICAgICBhY3RpdmVTZWxlY3Rpb25JbmRleDogb3B0aW9ucy5hY3RpdmVTZWxlY3Rpb25JbmRleCAhPT0gdW5kZWZpbmVkXG4gICAgICAgID8gb3B0aW9ucy5hY3RpdmVTZWxlY3Rpb25JbmRleFxuICAgICAgICA6IHRoaXMuYWN0aXZlU2VsZWN0aW9uSW5kZXgsXG4gICAgICBpZEZvckl0ZW06IG9wdGlvbnMuaWRGb3JJdGVtIHx8IHRoaXMuaWRGb3JJdGVtLFxuICAgICAgcmVzb2x2ZU5leHRVcGRhdGVQcm9taXNlOiBvcHRpb25zLnJlc29sdmVOZXh0VXBkYXRlUHJvbWlzZSB8fCB0aGlzLnJlc29sdmVOZXh0VXBkYXRlUHJvbWlzZSxcbiAgICAgIF9jb3B5OiBDT1BZLFxuICAgIH0pO1xuICB9XG5cbiAgdXBkYXRlTGlzdHMobGlzdHNCeUtleSkge1xuICAgIGxldCBpc0RpZmZlcmVudCA9IGZhbHNlO1xuXG4gICAgaWYgKGxpc3RzQnlLZXkubGVuZ3RoID09PSAwKSB7XG4gICAgICByZXR1cm4gdGhpcztcbiAgICB9XG5cbiAgICBjb25zdCBuZXdLZXlzQnlTZWxlY3Rpb24gPSBuZXcgTWFwKCk7XG4gICAgY29uc3QgbmV3U2VsZWN0aW9ucyA9IFtdO1xuXG4gICAgZm9yIChsZXQgaSA9IDA7IGkgPCBsaXN0c0J5S2V5Lmxlbmd0aDsgaSsrKSB7XG4gICAgICBjb25zdCBba2V5LCBuZXdJdGVtc10gPSBsaXN0c0J5S2V5W2ldO1xuICAgICAgbGV0IHNlbGVjdGlvbiA9IHRoaXMuc2VsZWN0aW9uc1tpXTtcblxuICAgICAgY29uc3Qgb2xkSXRlbXMgPSBzZWxlY3Rpb24uZ2V0SXRlbXMoKTtcbiAgICAgIGlmICghaXNEaWZmZXJlbnQpIHtcbiAgICAgICAgaXNEaWZmZXJlbnQgPSBvbGRJdGVtcy5sZW5ndGggIT09IG5ld0l0ZW1zLmxlbmd0aCB8fCBvbGRJdGVtcy5zb21lKChvbGRJdGVtLCBqKSA9PiBvbGRJdGVtID09PSBuZXdJdGVtc1tqXSk7XG4gICAgICB9XG5cbiAgICAgIGNvbnN0IG9sZEhlYWRJdGVtID0gc2VsZWN0aW9uLmdldEhlYWRJdGVtKCk7XG4gICAgICBzZWxlY3Rpb24gPSBzZWxlY3Rpb24uc2V0SXRlbXMobmV3SXRlbXMpO1xuICAgICAgbGV0IG5ld0hlYWRJdGVtID0gbnVsbDtcbiAgICAgIGlmIChvbGRIZWFkSXRlbSkge1xuICAgICAgICBuZXdIZWFkSXRlbSA9IG5ld0l0ZW1zLmZpbmQoaXRlbSA9PiB0aGlzLmlkRm9ySXRlbShpdGVtKSA9PT0gdGhpcy5pZEZvckl0ZW0ob2xkSGVhZEl0ZW0pKTtcbiAgICAgIH1cbiAgICAgIGlmIChuZXdIZWFkSXRlbSkge1xuICAgICAgICBzZWxlY3Rpb24gPSBzZWxlY3Rpb24uc2VsZWN0SXRlbShuZXdIZWFkSXRlbSk7XG4gICAgICB9XG5cbiAgICAgIG5ld0tleXNCeVNlbGVjdGlvbi5zZXQoc2VsZWN0aW9uLCBrZXkpO1xuICAgICAgbmV3U2VsZWN0aW9ucy5wdXNoKHNlbGVjdGlvbik7XG4gICAgfVxuXG4gICAgbGV0IHVwZGF0ZWQgPSB0aGlzLmNvcHkoe1xuICAgICAga2V5c0J5U2VsZWN0aW9uOiBuZXdLZXlzQnlTZWxlY3Rpb24sXG4gICAgICBzZWxlY3Rpb25zOiBuZXdTZWxlY3Rpb25zLFxuICAgIH0pO1xuXG4gICAgaWYgKHVwZGF0ZWQuZ2V0QWN0aXZlU2VsZWN0aW9uKCkuZ2V0SXRlbXMoKS5sZW5ndGggPT09IDApIHtcbiAgICAgIGNvbnN0IG5leHQgPSB1cGRhdGVkLmFjdGl2YXRlTmV4dFNlbGVjdGlvbigpO1xuICAgICAgdXBkYXRlZCA9IG5leHQgIT09IHVwZGF0ZWQgPyBuZXh0IDogdXBkYXRlZC5hY3RpdmF0ZVByZXZpb3VzU2VsZWN0aW9uKCk7XG4gICAgfVxuXG4gICAgdXBkYXRlZC5yZXNvbHZlTmV4dFVwZGF0ZVByb21pc2UoKTtcbiAgICByZXR1cm4gdXBkYXRlZDtcbiAgfVxuXG4gIHVwZGF0ZUFjdGl2ZVNlbGVjdGlvbihmbikge1xuICAgIGNvbnN0IG9sZFNlbGVjdGlvbiA9IHRoaXMuZ2V0QWN0aXZlU2VsZWN0aW9uKCk7XG4gICAgY29uc3QgbmV3U2VsZWN0aW9uID0gZm4ob2xkU2VsZWN0aW9uKTtcbiAgICBpZiAob2xkU2VsZWN0aW9uID09PSBuZXdTZWxlY3Rpb24pIHtcbiAgICAgIHJldHVybiB0aGlzO1xuICAgIH1cblxuICAgIGNvbnN0IGtleSA9IHRoaXMua2V5c0J5U2VsZWN0aW9uLmdldChvbGRTZWxlY3Rpb24pO1xuXG4gICAgY29uc3QgbmV3S2V5c0J5U2VsZWN0aW9uID0gbmV3IE1hcCh0aGlzLmtleXNCeVNlbGVjdGlvbik7XG4gICAgbmV3S2V5c0J5U2VsZWN0aW9uLmRlbGV0ZShvbGRTZWxlY3Rpb24pO1xuICAgIG5ld0tleXNCeVNlbGVjdGlvbi5zZXQobmV3U2VsZWN0aW9uLCBrZXkpO1xuXG4gICAgY29uc3QgbmV3U2VsZWN0aW9ucyA9IHRoaXMuc2VsZWN0aW9ucy5zbGljZSgpO1xuICAgIG5ld1NlbGVjdGlvbnNbdGhpcy5hY3RpdmVTZWxlY3Rpb25JbmRleF0gPSBuZXdTZWxlY3Rpb247XG5cbiAgICByZXR1cm4gdGhpcy5jb3B5KHtcbiAgICAgIGtleXNCeVNlbGVjdGlvbjogbmV3S2V5c0J5U2VsZWN0aW9uLFxuICAgICAgc2VsZWN0aW9uczogbmV3U2VsZWN0aW9ucyxcbiAgICB9KTtcbiAgfVxuXG4gIGdldE5leHRVcGRhdGVQcm9taXNlKCkge1xuICAgIHJldHVybiBuZXcgUHJvbWlzZSgocmVzb2x2ZSwgcmVqZWN0KSA9PiB7XG4gICAgICB0aGlzLnJlc29sdmVOZXh0VXBkYXRlUHJvbWlzZSA9IHJlc29sdmU7XG4gICAgfSk7XG4gIH1cblxuICBzZWxlY3RGaXJzdE5vbkVtcHR5TGlzdCgpIHtcbiAgICByZXR1cm4gdGhpcy5jb3B5KHtcbiAgICAgIGFjdGl2ZVNlbGVjdGlvbkluZGV4OiB0aGlzLnNlbGVjdGlvbnMuZmluZEluZGV4KHNlbGVjdGlvbiA9PiBzZWxlY3Rpb24uZ2V0SXRlbXMoKS5sZW5ndGggPiAwKSxcbiAgICB9KTtcbiAgfVxuXG4gIGdldEFjdGl2ZUxpc3RLZXkoKSB7XG4gICAgcmV0dXJuIHRoaXMua2V5c0J5U2VsZWN0aW9uLmdldCh0aGlzLmdldEFjdGl2ZVNlbGVjdGlvbigpKTtcbiAgfVxuXG4gIGdldFNlbGVjdGVkSXRlbXMoKSB7XG4gICAgcmV0dXJuIHRoaXMuZ2V0QWN0aXZlU2VsZWN0aW9uKCkuZ2V0U2VsZWN0ZWRJdGVtcygpO1xuICB9XG5cbiAgZ2V0SGVhZEl0ZW0oKSB7XG4gICAgcmV0dXJuIHRoaXMuZ2V0QWN0aXZlU2VsZWN0aW9uKCkuZ2V0SGVhZEl0ZW0oKTtcbiAgfVxuXG4gIGdldEFjdGl2ZVNlbGVjdGlvbigpIHtcbiAgICByZXR1cm4gdGhpcy5zZWxlY3Rpb25zW3RoaXMuYWN0aXZlU2VsZWN0aW9uSW5kZXhdO1xuICB9XG5cbiAgYWN0aXZhdGVTZWxlY3Rpb24oc2VsZWN0aW9uKSB7XG4gICAgY29uc3QgaW5kZXggPSB0aGlzLnNlbGVjdGlvbnMuaW5kZXhPZihzZWxlY3Rpb24pO1xuICAgIGlmIChpbmRleCA9PT0gLTEpIHsgdGhyb3cgbmV3IEVycm9yKCdTZWxlY3Rpb24gbm90IGZvdW5kJyk7IH1cbiAgICByZXR1cm4gdGhpcy5jb3B5KHthY3RpdmVTZWxlY3Rpb25JbmRleDogaW5kZXh9KTtcbiAgfVxuXG4gIGFjdGl2YXRlTmV4dFNlbGVjdGlvbigpIHtcbiAgICBmb3IgKGxldCBpID0gdGhpcy5hY3RpdmVTZWxlY3Rpb25JbmRleCArIDE7IGkgPCB0aGlzLnNlbGVjdGlvbnMubGVuZ3RoOyBpKyspIHtcbiAgICAgIGlmICh0aGlzLnNlbGVjdGlvbnNbaV0uZ2V0SXRlbXMoKS5sZW5ndGggPiAwKSB7XG4gICAgICAgIHJldHVybiB0aGlzLmNvcHkoe2FjdGl2ZVNlbGVjdGlvbkluZGV4OiBpfSk7XG4gICAgICB9XG4gICAgfVxuICAgIHJldHVybiB0aGlzO1xuICB9XG5cbiAgYWN0aXZhdGVQcmV2aW91c1NlbGVjdGlvbigpIHtcbiAgICBmb3IgKGxldCBpID0gdGhpcy5hY3RpdmVTZWxlY3Rpb25JbmRleCAtIDE7IGkgPj0gMDsgaS0tKSB7XG4gICAgICBpZiAodGhpcy5zZWxlY3Rpb25zW2ldLmdldEl0ZW1zKCkubGVuZ3RoID4gMCkge1xuICAgICAgICByZXR1cm4gdGhpcy5jb3B5KHthY3RpdmVTZWxlY3Rpb25JbmRleDogaX0pO1xuICAgICAgfVxuICAgIH1cbiAgICByZXR1cm4gdGhpcztcbiAgfVxuXG4gIGFjdGl2YXRlTGFzdFNlbGVjdGlvbigpIHtcbiAgICBmb3IgKGxldCBpID0gdGhpcy5zZWxlY3Rpb25zLmxlbmd0aCAtIDE7IGkgPj0gMDsgaS0tKSB7XG4gICAgICBpZiAodGhpcy5zZWxlY3Rpb25zW2ldLmdldEl0ZW1zKCkubGVuZ3RoID4gMCkge1xuICAgICAgICByZXR1cm4gdGhpcy5jb3B5KHthY3RpdmVTZWxlY3Rpb25JbmRleDogaX0pO1xuICAgICAgfVxuICAgIH1cbiAgICByZXR1cm4gdGhpcztcbiAgfVxuXG4gIHNlbGVjdEl0ZW0oaXRlbSwgcHJlc2VydmVUYWlsID0gZmFsc2UpIHtcbiAgICBjb25zdCBzZWxlY3Rpb24gPSB0aGlzLnNlbGVjdGlvbkZvckl0ZW0oaXRlbSk7XG4gICAgaWYgKCFzZWxlY3Rpb24pIHtcbiAgICAgIHRocm93IG5ldyBFcnJvcihgTm8gaXRlbSBmb3VuZDogJHtpdGVtfWApO1xuICAgIH1cblxuICAgIGxldCBuZXh0ID0gdGhpcztcbiAgICBpZiAoIXByZXNlcnZlVGFpbCkge1xuICAgICAgbmV4dCA9IG5leHQuYWN0aXZhdGVTZWxlY3Rpb24oc2VsZWN0aW9uKTtcbiAgICB9XG4gICAgaWYgKHNlbGVjdGlvbiA9PT0gbmV4dC5nZXRBY3RpdmVTZWxlY3Rpb24oKSkge1xuICAgICAgbmV4dCA9IG5leHQudXBkYXRlQWN0aXZlU2VsZWN0aW9uKHMgPT4gcy5zZWxlY3RJdGVtKGl0ZW0sIHByZXNlcnZlVGFpbCkpO1xuICAgIH1cbiAgICByZXR1cm4gbmV4dDtcbiAgfVxuXG4gIGFkZE9yU3VidHJhY3RTZWxlY3Rpb24oaXRlbSkge1xuICAgIGNvbnN0IHNlbGVjdGlvbiA9IHRoaXMuc2VsZWN0aW9uRm9ySXRlbShpdGVtKTtcbiAgICBpZiAoIXNlbGVjdGlvbikge1xuICAgICAgdGhyb3cgbmV3IEVycm9yKGBObyBpdGVtIGZvdW5kOiAke2l0ZW19YCk7XG4gICAgfVxuXG4gICAgaWYgKHNlbGVjdGlvbiA9PT0gdGhpcy5nZXRBY3RpdmVTZWxlY3Rpb24oKSkge1xuICAgICAgcmV0dXJuIHRoaXMudXBkYXRlQWN0aXZlU2VsZWN0aW9uKHMgPT4gcy5hZGRPclN1YnRyYWN0U2VsZWN0aW9uKGl0ZW0pKTtcbiAgICB9IGVsc2Uge1xuICAgICAgcmV0dXJuIHRoaXMuYWN0aXZhdGVTZWxlY3Rpb24oc2VsZWN0aW9uKS51cGRhdGVBY3RpdmVTZWxlY3Rpb24ocyA9PiBzLnNlbGVjdEl0ZW0oaXRlbSkpO1xuICAgIH1cbiAgfVxuXG4gIHNlbGVjdEFsbEl0ZW1zKCkge1xuICAgIHJldHVybiB0aGlzLnVwZGF0ZUFjdGl2ZVNlbGVjdGlvbihzID0+IHMuc2VsZWN0QWxsSXRlbXMoKSk7XG4gIH1cblxuICBzZWxlY3RGaXJzdEl0ZW0ocHJlc2VydmVUYWlsKSB7XG4gICAgcmV0dXJuIHRoaXMudXBkYXRlQWN0aXZlU2VsZWN0aW9uKHMgPT4gcy5zZWxlY3RGaXJzdEl0ZW0ocHJlc2VydmVUYWlsKSk7XG4gIH1cblxuICBzZWxlY3RMYXN0SXRlbShwcmVzZXJ2ZVRhaWwpIHtcbiAgICByZXR1cm4gdGhpcy51cGRhdGVBY3RpdmVTZWxlY3Rpb24ocyA9PiBzLnNlbGVjdExhc3RJdGVtKHByZXNlcnZlVGFpbCkpO1xuICB9XG5cbiAgY29hbGVzY2UoKSB7XG4gICAgcmV0dXJuIHRoaXMudXBkYXRlQWN0aXZlU2VsZWN0aW9uKHMgPT4gcy5jb2FsZXNjZSgpKTtcbiAgfVxuXG4gIHNlbGVjdGlvbkZvckl0ZW0oaXRlbSkge1xuICAgIHJldHVybiB0aGlzLnNlbGVjdGlvbnMuZmluZChzZWxlY3Rpb24gPT4gc2VsZWN0aW9uLmdldEl0ZW1zKCkuaW5jbHVkZXMoaXRlbSkpO1xuICB9XG5cbiAgbGlzdEtleUZvckl0ZW0oaXRlbSkge1xuICAgIHJldHVybiB0aGlzLmtleXNCeVNlbGVjdGlvbi5nZXQodGhpcy5zZWxlY3Rpb25Gb3JJdGVtKGl0ZW0pKTtcbiAgfVxuXG4gIHNlbGVjdE5leHRJdGVtKHByZXNlcnZlVGFpbCA9IGZhbHNlKSB7XG4gICAgbGV0IG5leHQgPSB0aGlzO1xuICAgIGlmICghcHJlc2VydmVUYWlsICYmIG5leHQuZ2V0QWN0aXZlU2VsZWN0aW9uKCkuZ2V0SGVhZEl0ZW0oKSA9PT0gbmV4dC5nZXRBY3RpdmVTZWxlY3Rpb24oKS5nZXRMYXN0SXRlbSgpKSB7XG4gICAgICBuZXh0ID0gbmV4dC5hY3RpdmF0ZU5leHRTZWxlY3Rpb24oKTtcbiAgICAgIGlmIChuZXh0ICE9PSB0aGlzKSB7XG4gICAgICAgIHJldHVybiBuZXh0LnVwZGF0ZUFjdGl2ZVNlbGVjdGlvbihzID0+IHMuc2VsZWN0Rmlyc3RJdGVtKCkpO1xuICAgICAgfSBlbHNlIHtcbiAgICAgICAgcmV0dXJuIG5leHQudXBkYXRlQWN0aXZlU2VsZWN0aW9uKHMgPT4gcy5zZWxlY3RMYXN0SXRlbSgpKTtcbiAgICAgIH1cbiAgICB9IGVsc2Uge1xuICAgICAgcmV0dXJuIG5leHQudXBkYXRlQWN0aXZlU2VsZWN0aW9uKHMgPT4gcy5zZWxlY3ROZXh0SXRlbShwcmVzZXJ2ZVRhaWwpKTtcbiAgICB9XG4gIH1cblxuICBzZWxlY3RQcmV2aW91c0l0ZW0ocHJlc2VydmVUYWlsID0gZmFsc2UpIHtcbiAgICBsZXQgbmV4dCA9IHRoaXM7XG4gICAgaWYgKCFwcmVzZXJ2ZVRhaWwgJiYgbmV4dC5nZXRBY3RpdmVTZWxlY3Rpb24oKS5nZXRIZWFkSXRlbSgpID09PSBuZXh0LmdldEFjdGl2ZVNlbGVjdGlvbigpLmdldEl0ZW1zKClbMF0pIHtcbiAgICAgIG5leHQgPSBuZXh0LmFjdGl2YXRlUHJldmlvdXNTZWxlY3Rpb24oKTtcbiAgICAgIGlmIChuZXh0ICE9PSB0aGlzKSB7XG4gICAgICAgIHJldHVybiBuZXh0LnVwZGF0ZUFjdGl2ZVNlbGVjdGlvbihzID0+IHMuc2VsZWN0TGFzdEl0ZW0oKSk7XG4gICAgICB9IGVsc2Uge1xuICAgICAgICByZXR1cm4gbmV4dC51cGRhdGVBY3RpdmVTZWxlY3Rpb24ocyA9PiBzLnNlbGVjdEZpcnN0SXRlbSgpKTtcbiAgICAgIH1cbiAgICB9IGVsc2Uge1xuICAgICAgcmV0dXJuIG5leHQudXBkYXRlQWN0aXZlU2VsZWN0aW9uKHMgPT4gcy5zZWxlY3RQcmV2aW91c0l0ZW0ocHJlc2VydmVUYWlsKSk7XG4gICAgfVxuICB9XG5cbiAgZmluZEl0ZW0ocHJlZGljYXRlKSB7XG4gICAgZm9yIChsZXQgaSA9IDA7IGkgPCB0aGlzLnNlbGVjdGlvbnMubGVuZ3RoOyBpKyspIHtcbiAgICAgIGNvbnN0IHNlbGVjdGlvbiA9IHRoaXMuc2VsZWN0aW9uc1tpXTtcbiAgICAgIGNvbnN0IGtleSA9IHRoaXMua2V5c0J5U2VsZWN0aW9uLmdldChzZWxlY3Rpb24pO1xuICAgICAgY29uc3QgZm91bmQgPSBzZWxlY3Rpb24uZ2V0SXRlbXMoKS5maW5kKGl0ZW0gPT4gcHJlZGljYXRlKGl0ZW0sIGtleSkpO1xuICAgICAgaWYgKGZvdW5kICE9PSB1bmRlZmluZWQpIHtcbiAgICAgICAgcmV0dXJuIGZvdW5kO1xuICAgICAgfVxuICAgIH1cbiAgICByZXR1cm4gbnVsbDtcbiAgfVxufVxuIl19