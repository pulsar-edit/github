"use strict";

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.default = void 0;

class Task {
  constructor(fn, parallel = true) {
    this.fn = fn;
    this.parallel = parallel;
    this.promise = new Promise((resolve, reject) => {
      this.resolve = resolve;
      this.reject = reject;
    });
  }

  async execute() {
    try {
      const value = await this.fn.call(undefined);
      this.resolve(value);
    } catch (err) {
      this.reject(err);
    }
  }

  runsInParallel() {
    return this.parallel;
  }

  runsInSerial() {
    return !this.parallel;
  }

  getPromise() {
    return this.promise;
  }

}

class AsyncQueue {
  constructor(options = {}) {
    this.parallelism = options.parallelism || 1;
    this.nonParallelizableOperation = false;
    this.tasksInProgress = 0;
    this.queue = [];
  }

  push(fn, {
    parallel
  } = {
    parallel: true
  }) {
    const task = new Task(fn, parallel);
    this.queue.push(task);
    this.processQueue();
    return task.getPromise();
  }

  processQueue() {
    if (!this.queue.length || this.nonParallelizableOperation || this.disposed) {
      return;
    }

    const task = this.queue[0];
    const canRunParallelOp = task.runsInParallel() && this.tasksInProgress < this.parallelism;
    const canRunSerialOp = task.runsInSerial() && this.tasksInProgress === 0;

    if (canRunSerialOp || canRunParallelOp) {
      this.processTask(task, task.runsInParallel());
      this.queue.shift();
      this.processQueue();
    }
  }

  async processTask(task, runsInParallel) {
    if (this.disposed) {
      return;
    }

    this.tasksInProgress++;

    if (!runsInParallel) {
      this.nonParallelizableOperation = true;
    }

    try {
      await task.execute();
    } finally {
      this.tasksInProgress--;
      this.nonParallelizableOperation = false;
      this.processQueue();
    }
  }

  dispose() {
    this.queue = [];
    this.disposed = true;
  }

}

exports.default = AsyncQueue;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uL2xpYi9hc3luYy1xdWV1ZS5qcyJdLCJuYW1lcyI6WyJUYXNrIiwiY29uc3RydWN0b3IiLCJmbiIsInBhcmFsbGVsIiwicHJvbWlzZSIsIlByb21pc2UiLCJyZXNvbHZlIiwicmVqZWN0IiwiZXhlY3V0ZSIsInZhbHVlIiwiY2FsbCIsInVuZGVmaW5lZCIsImVyciIsInJ1bnNJblBhcmFsbGVsIiwicnVuc0luU2VyaWFsIiwiZ2V0UHJvbWlzZSIsIkFzeW5jUXVldWUiLCJvcHRpb25zIiwicGFyYWxsZWxpc20iLCJub25QYXJhbGxlbGl6YWJsZU9wZXJhdGlvbiIsInRhc2tzSW5Qcm9ncmVzcyIsInF1ZXVlIiwicHVzaCIsInRhc2siLCJwcm9jZXNzUXVldWUiLCJsZW5ndGgiLCJkaXNwb3NlZCIsImNhblJ1blBhcmFsbGVsT3AiLCJjYW5SdW5TZXJpYWxPcCIsInByb2Nlc3NUYXNrIiwic2hpZnQiLCJkaXNwb3NlIl0sIm1hcHBpbmdzIjoiOzs7Ozs7O0FBQUEsTUFBTUEsSUFBTixDQUFXO0FBQ1RDLEVBQUFBLFdBQVcsQ0FBQ0MsRUFBRCxFQUFLQyxRQUFRLEdBQUcsSUFBaEIsRUFBc0I7QUFDL0IsU0FBS0QsRUFBTCxHQUFVQSxFQUFWO0FBQ0EsU0FBS0MsUUFBTCxHQUFnQkEsUUFBaEI7QUFDQSxTQUFLQyxPQUFMLEdBQWUsSUFBSUMsT0FBSixDQUFZLENBQUNDLE9BQUQsRUFBVUMsTUFBVixLQUFxQjtBQUM5QyxXQUFLRCxPQUFMLEdBQWVBLE9BQWY7QUFDQSxXQUFLQyxNQUFMLEdBQWNBLE1BQWQ7QUFDRCxLQUhjLENBQWY7QUFJRDs7QUFFWSxRQUFQQyxPQUFPLEdBQUc7QUFDZCxRQUFJO0FBQ0YsWUFBTUMsS0FBSyxHQUFHLE1BQU0sS0FBS1AsRUFBTCxDQUFRUSxJQUFSLENBQWFDLFNBQWIsQ0FBcEI7QUFDQSxXQUFLTCxPQUFMLENBQWFHLEtBQWI7QUFDRCxLQUhELENBR0UsT0FBT0csR0FBUCxFQUFZO0FBQ1osV0FBS0wsTUFBTCxDQUFZSyxHQUFaO0FBQ0Q7QUFDRjs7QUFFREMsRUFBQUEsY0FBYyxHQUFHO0FBQ2YsV0FBTyxLQUFLVixRQUFaO0FBQ0Q7O0FBRURXLEVBQUFBLFlBQVksR0FBRztBQUNiLFdBQU8sQ0FBQyxLQUFLWCxRQUFiO0FBQ0Q7O0FBRURZLEVBQUFBLFVBQVUsR0FBRztBQUNYLFdBQU8sS0FBS1gsT0FBWjtBQUNEOztBQTdCUTs7QUFnQ0ksTUFBTVksVUFBTixDQUFpQjtBQUM5QmYsRUFBQUEsV0FBVyxDQUFDZ0IsT0FBTyxHQUFHLEVBQVgsRUFBZTtBQUN4QixTQUFLQyxXQUFMLEdBQW1CRCxPQUFPLENBQUNDLFdBQVIsSUFBdUIsQ0FBMUM7QUFDQSxTQUFLQywwQkFBTCxHQUFrQyxLQUFsQztBQUNBLFNBQUtDLGVBQUwsR0FBdUIsQ0FBdkI7QUFDQSxTQUFLQyxLQUFMLEdBQWEsRUFBYjtBQUNEOztBQUVEQyxFQUFBQSxJQUFJLENBQUNwQixFQUFELEVBQUs7QUFBQ0MsSUFBQUE7QUFBRCxNQUFhO0FBQUNBLElBQUFBLFFBQVEsRUFBRTtBQUFYLEdBQWxCLEVBQW9DO0FBQ3RDLFVBQU1vQixJQUFJLEdBQUcsSUFBSXZCLElBQUosQ0FBU0UsRUFBVCxFQUFhQyxRQUFiLENBQWI7QUFDQSxTQUFLa0IsS0FBTCxDQUFXQyxJQUFYLENBQWdCQyxJQUFoQjtBQUNBLFNBQUtDLFlBQUw7QUFDQSxXQUFPRCxJQUFJLENBQUNSLFVBQUwsRUFBUDtBQUNEOztBQUVEUyxFQUFBQSxZQUFZLEdBQUc7QUFDYixRQUFJLENBQUMsS0FBS0gsS0FBTCxDQUFXSSxNQUFaLElBQXNCLEtBQUtOLDBCQUEzQixJQUF5RCxLQUFLTyxRQUFsRSxFQUE0RTtBQUFFO0FBQVM7O0FBRXZGLFVBQU1ILElBQUksR0FBRyxLQUFLRixLQUFMLENBQVcsQ0FBWCxDQUFiO0FBQ0EsVUFBTU0sZ0JBQWdCLEdBQUdKLElBQUksQ0FBQ1YsY0FBTCxNQUF5QixLQUFLTyxlQUFMLEdBQXVCLEtBQUtGLFdBQTlFO0FBQ0EsVUFBTVUsY0FBYyxHQUFHTCxJQUFJLENBQUNULFlBQUwsTUFBdUIsS0FBS00sZUFBTCxLQUF5QixDQUF2RTs7QUFDQSxRQUFJUSxjQUFjLElBQUlELGdCQUF0QixFQUF3QztBQUN0QyxXQUFLRSxXQUFMLENBQWlCTixJQUFqQixFQUF1QkEsSUFBSSxDQUFDVixjQUFMLEVBQXZCO0FBQ0EsV0FBS1EsS0FBTCxDQUFXUyxLQUFYO0FBQ0EsV0FBS04sWUFBTDtBQUNEO0FBQ0Y7O0FBRWdCLFFBQVhLLFdBQVcsQ0FBQ04sSUFBRCxFQUFPVixjQUFQLEVBQXVCO0FBQ3RDLFFBQUksS0FBS2EsUUFBVCxFQUFtQjtBQUFFO0FBQVM7O0FBRTlCLFNBQUtOLGVBQUw7O0FBQ0EsUUFBSSxDQUFDUCxjQUFMLEVBQXFCO0FBQ25CLFdBQUtNLDBCQUFMLEdBQWtDLElBQWxDO0FBQ0Q7O0FBRUQsUUFBSTtBQUNGLFlBQU1JLElBQUksQ0FBQ2YsT0FBTCxFQUFOO0FBQ0QsS0FGRCxTQUVVO0FBQ1IsV0FBS1ksZUFBTDtBQUNBLFdBQUtELDBCQUFMLEdBQWtDLEtBQWxDO0FBQ0EsV0FBS0ssWUFBTDtBQUNEO0FBQ0Y7O0FBRURPLEVBQUFBLE9BQU8sR0FBRztBQUNSLFNBQUtWLEtBQUwsR0FBYSxFQUFiO0FBQ0EsU0FBS0ssUUFBTCxHQUFnQixJQUFoQjtBQUNEOztBQWhENkIiLCJzb3VyY2VzQ29udGVudCI6WyJjbGFzcyBUYXNrIHtcbiAgY29uc3RydWN0b3IoZm4sIHBhcmFsbGVsID0gdHJ1ZSkge1xuICAgIHRoaXMuZm4gPSBmbjtcbiAgICB0aGlzLnBhcmFsbGVsID0gcGFyYWxsZWw7XG4gICAgdGhpcy5wcm9taXNlID0gbmV3IFByb21pc2UoKHJlc29sdmUsIHJlamVjdCkgPT4ge1xuICAgICAgdGhpcy5yZXNvbHZlID0gcmVzb2x2ZTtcbiAgICAgIHRoaXMucmVqZWN0ID0gcmVqZWN0O1xuICAgIH0pO1xuICB9XG5cbiAgYXN5bmMgZXhlY3V0ZSgpIHtcbiAgICB0cnkge1xuICAgICAgY29uc3QgdmFsdWUgPSBhd2FpdCB0aGlzLmZuLmNhbGwodW5kZWZpbmVkKTtcbiAgICAgIHRoaXMucmVzb2x2ZSh2YWx1ZSk7XG4gICAgfSBjYXRjaCAoZXJyKSB7XG4gICAgICB0aGlzLnJlamVjdChlcnIpO1xuICAgIH1cbiAgfVxuXG4gIHJ1bnNJblBhcmFsbGVsKCkge1xuICAgIHJldHVybiB0aGlzLnBhcmFsbGVsO1xuICB9XG5cbiAgcnVuc0luU2VyaWFsKCkge1xuICAgIHJldHVybiAhdGhpcy5wYXJhbGxlbDtcbiAgfVxuXG4gIGdldFByb21pc2UoKSB7XG4gICAgcmV0dXJuIHRoaXMucHJvbWlzZTtcbiAgfVxufVxuXG5leHBvcnQgZGVmYXVsdCBjbGFzcyBBc3luY1F1ZXVlIHtcbiAgY29uc3RydWN0b3Iob3B0aW9ucyA9IHt9KSB7XG4gICAgdGhpcy5wYXJhbGxlbGlzbSA9IG9wdGlvbnMucGFyYWxsZWxpc20gfHwgMTtcbiAgICB0aGlzLm5vblBhcmFsbGVsaXphYmxlT3BlcmF0aW9uID0gZmFsc2U7XG4gICAgdGhpcy50YXNrc0luUHJvZ3Jlc3MgPSAwO1xuICAgIHRoaXMucXVldWUgPSBbXTtcbiAgfVxuXG4gIHB1c2goZm4sIHtwYXJhbGxlbH0gPSB7cGFyYWxsZWw6IHRydWV9KSB7XG4gICAgY29uc3QgdGFzayA9IG5ldyBUYXNrKGZuLCBwYXJhbGxlbCk7XG4gICAgdGhpcy5xdWV1ZS5wdXNoKHRhc2spO1xuICAgIHRoaXMucHJvY2Vzc1F1ZXVlKCk7XG4gICAgcmV0dXJuIHRhc2suZ2V0UHJvbWlzZSgpO1xuICB9XG5cbiAgcHJvY2Vzc1F1ZXVlKCkge1xuICAgIGlmICghdGhpcy5xdWV1ZS5sZW5ndGggfHwgdGhpcy5ub25QYXJhbGxlbGl6YWJsZU9wZXJhdGlvbiB8fCB0aGlzLmRpc3Bvc2VkKSB7IHJldHVybjsgfVxuXG4gICAgY29uc3QgdGFzayA9IHRoaXMucXVldWVbMF07XG4gICAgY29uc3QgY2FuUnVuUGFyYWxsZWxPcCA9IHRhc2sucnVuc0luUGFyYWxsZWwoKSAmJiB0aGlzLnRhc2tzSW5Qcm9ncmVzcyA8IHRoaXMucGFyYWxsZWxpc207XG4gICAgY29uc3QgY2FuUnVuU2VyaWFsT3AgPSB0YXNrLnJ1bnNJblNlcmlhbCgpICYmIHRoaXMudGFza3NJblByb2dyZXNzID09PSAwO1xuICAgIGlmIChjYW5SdW5TZXJpYWxPcCB8fCBjYW5SdW5QYXJhbGxlbE9wKSB7XG4gICAgICB0aGlzLnByb2Nlc3NUYXNrKHRhc2ssIHRhc2sucnVuc0luUGFyYWxsZWwoKSk7XG4gICAgICB0aGlzLnF1ZXVlLnNoaWZ0KCk7XG4gICAgICB0aGlzLnByb2Nlc3NRdWV1ZSgpO1xuICAgIH1cbiAgfVxuXG4gIGFzeW5jIHByb2Nlc3NUYXNrKHRhc2ssIHJ1bnNJblBhcmFsbGVsKSB7XG4gICAgaWYgKHRoaXMuZGlzcG9zZWQpIHsgcmV0dXJuOyB9XG5cbiAgICB0aGlzLnRhc2tzSW5Qcm9ncmVzcysrO1xuICAgIGlmICghcnVuc0luUGFyYWxsZWwpIHtcbiAgICAgIHRoaXMubm9uUGFyYWxsZWxpemFibGVPcGVyYXRpb24gPSB0cnVlO1xuICAgIH1cblxuICAgIHRyeSB7XG4gICAgICBhd2FpdCB0YXNrLmV4ZWN1dGUoKTtcbiAgICB9IGZpbmFsbHkge1xuICAgICAgdGhpcy50YXNrc0luUHJvZ3Jlc3MtLTtcbiAgICAgIHRoaXMubm9uUGFyYWxsZWxpemFibGVPcGVyYXRpb24gPSBmYWxzZTtcbiAgICAgIHRoaXMucHJvY2Vzc1F1ZXVlKCk7XG4gICAgfVxuICB9XG5cbiAgZGlzcG9zZSgpIHtcbiAgICB0aGlzLnF1ZXVlID0gW107XG4gICAgdGhpcy5kaXNwb3NlZCA9IHRydWU7XG4gIH1cbn1cbiJdfQ==