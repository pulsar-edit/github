"use strict";

/* eslint comma-dangle: ["error", {
    "arrays": "never",
    "objects": "never",
    "imports": "never",
    "exports": "never",
    "functions": "never"
  }] */
const {
  execFile
} = require('child_process');

const fs = require('fs');

if (typeof atom === 'undefined') {
  global.atom = {
    inSpecMode() {
      return !!process.env.ATOM_GITHUB_SPEC_MODE;
    },

    inDevMode() {
      return false;
    }

  };
} // No token available in your OS keychain.


const UNAUTHENTICATED = Symbol('UNAUTHENTICATED'); // The token in your keychain isn't granted all of the required OAuth scopes.

const INSUFFICIENT = Symbol('INSUFFICIENT'); // The token in your keychain is not accepted by GitHub.

const UNAUTHORIZED = Symbol('UNAUTHORIZED');

class KeytarStrategy {
  static get keytar() {
    return require('keytar');
  }

  static async isValid() {
    // Allow for disabling Keytar on problematic CI environments
    if (process.env.ATOM_GITHUB_DISABLE_KEYTAR) {
      return false;
    }

    const keytar = this.keytar;

    try {
      const rand = Math.floor(Math.random() * 10e20).toString(16);
      await keytar.setPassword('atom-test-service', rand, rand);
      const pass = await keytar.getPassword('atom-test-service', rand);
      const success = pass === rand;
      keytar.deletePassword('atom-test-service', rand);
      return success;
    } catch (err) {
      return false;
    }
  }

  async getPassword(service, account) {
    const password = await this.constructor.keytar.getPassword(service, account);
    return password !== null ? password : UNAUTHENTICATED;
  }

  replacePassword(service, account, password) {
    return this.constructor.keytar.setPassword(service, account, password);
  }

  deletePassword(service, account) {
    return this.constructor.keytar.deletePassword(service, account);
  }

}

class SecurityBinaryStrategy {
  static isValid() {
    return process.platform === 'darwin';
  }

  async getPassword(service, account) {
    try {
      const password = await this.exec(['find-generic-password', '-s', service, '-a', account, '-w']);
      return password.trim() || UNAUTHENTICATED;
    } catch (err) {
      return UNAUTHENTICATED;
    }
  }

  replacePassword(service, account, newPassword) {
    return this.exec(['add-generic-password', '-s', service, '-a', account, '-w', newPassword, '-U']);
  }

  deletePassword(service, account) {
    return this.exec(['delete-generic-password', '-s', service, '-a', account]);
  }

  exec(securityArgs, {
    binary
  } = {
    binary: 'security'
  }) {
    return new Promise((resolve, reject) => {
      execFile(binary, securityArgs, (error, stdout) => {
        if (error) {
          return reject(error);
        }

        return resolve(stdout);
      });
    });
  }

}

class InMemoryStrategy {
  static isValid() {
    return true;
  }

  constructor() {
    if (!atom.inSpecMode()) {
      // eslint-disable-next-line no-console
      console.warn('Using an InMemoryStrategy strategy for storing tokens. ' + 'The tokens will only be stored for the current window.');
    }

    this.passwordsByService = new Map();
  }

  getPassword(service, account) {
    const passwords = this.passwordsByService.get(service) || new Map();
    const password = passwords.get(account);
    return password || UNAUTHENTICATED;
  }

  replacePassword(service, account, newPassword) {
    const passwords = this.passwordsByService.get(service) || new Map();
    passwords.set(account, newPassword);
    this.passwordsByService.set(service, passwords);
  }

  deletePassword(service, account) {
    const passwords = this.passwordsByService.get(service);

    if (passwords) {
      passwords.delete(account);
    }
  }

}

class FileStrategy {
  static isValid() {
    if (!atom.inSpecMode() && !atom.inDevMode()) {
      return false;
    }

    return Boolean(process.env.ATOM_GITHUB_KEYTAR_FILE);
  }

  constructor() {
    this.filePath = process.env.ATOM_GITHUB_KEYTAR_FILE;

    if (!atom.inSpecMode()) {
      // eslint-disable-next-line no-console
      console.warn('Using a FileStrategy strategy for storing tokens. ' + 'The tokens will be stored %cin the clear%c in a file at %s. ' + "You probably shouldn't use real credentials while this strategy is in use. " + 'Unset ATOM_GITHUB_KEYTAR_FILE_STRATEGY to disable it.', 'color: red; font-weight: bold; font-style: italic', 'color: black; font-weight: normal; font-style: normal', this.filePath);
    }
  }

  async getPassword(service, account) {
    const payload = await this.load();
    const forService = payload[service];

    if (forService === undefined) {
      return UNAUTHENTICATED;
    }

    const passwd = forService[account];

    if (passwd === undefined) {
      return UNAUTHENTICATED;
    }

    return passwd;
  }

  replacePassword(service, account, password) {
    return this.modify(payload => {
      let forService = payload[service];

      if (forService === undefined) {
        forService = {};
        payload[service] = forService;
      }

      forService[account] = password;
    });
  }

  deletePassword(service, account) {
    return this.modify(payload => {
      const forService = payload[service];

      if (forService === undefined) {
        return;
      }

      delete forService[account];

      if (Object.keys(forService).length === 0) {
        delete payload[service];
      }
    });
  }

  load() {
    return new Promise((resolve, reject) => {
      fs.readFile(this.filePath, 'utf8', (err, content) => {
        if (err && err.code === 'ENOENT') {
          return resolve({});
        }

        if (err) {
          return reject(err);
        }

        return resolve(JSON.parse(content));
      });
    });
  }

  save(payload) {
    return new Promise((resolve, reject) => {
      fs.writeFile(this.filePath, JSON.stringify(payload), 'utf8', err => {
        if (err) {
          reject(err);
        } else {
          resolve();
        }
      });
    });
  }

  async modify(callback) {
    const payload = await this.load();
    callback(payload);
    await this.save(payload);
  }

}

const strategies = [FileStrategy, KeytarStrategy, SecurityBinaryStrategy, InMemoryStrategy];
let ValidStrategy = null;

async function createStrategy() {
  if (ValidStrategy) {
    return new ValidStrategy();
  }

  for (let i = 0; i < strategies.length; i++) {
    const strat = strategies[i];
    const isValid = await strat.isValid();

    if (isValid) {
      ValidStrategy = strat;
      break;
    }
  }

  if (!ValidStrategy) {
    throw new Error('None of the listed keytar strategies returned true for `isValid`');
  }

  return new ValidStrategy();
}

module.exports = {
  UNAUTHENTICATED,
  INSUFFICIENT,
  UNAUTHORIZED,
  KeytarStrategy,
  SecurityBinaryStrategy,
  InMemoryStrategy,
  FileStrategy,
  createStrategy
};
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uL2xpYi9zaGFyZWQva2V5dGFyLXN0cmF0ZWd5LmpzIl0sIm5hbWVzIjpbImV4ZWNGaWxlIiwicmVxdWlyZSIsImZzIiwiYXRvbSIsImdsb2JhbCIsImluU3BlY01vZGUiLCJwcm9jZXNzIiwiZW52IiwiQVRPTV9HSVRIVUJfU1BFQ19NT0RFIiwiaW5EZXZNb2RlIiwiVU5BVVRIRU5USUNBVEVEIiwiU3ltYm9sIiwiSU5TVUZGSUNJRU5UIiwiVU5BVVRIT1JJWkVEIiwiS2V5dGFyU3RyYXRlZ3kiLCJrZXl0YXIiLCJpc1ZhbGlkIiwiQVRPTV9HSVRIVUJfRElTQUJMRV9LRVlUQVIiLCJyYW5kIiwiTWF0aCIsImZsb29yIiwicmFuZG9tIiwidG9TdHJpbmciLCJzZXRQYXNzd29yZCIsInBhc3MiLCJnZXRQYXNzd29yZCIsInN1Y2Nlc3MiLCJkZWxldGVQYXNzd29yZCIsImVyciIsInNlcnZpY2UiLCJhY2NvdW50IiwicGFzc3dvcmQiLCJjb25zdHJ1Y3RvciIsInJlcGxhY2VQYXNzd29yZCIsIlNlY3VyaXR5QmluYXJ5U3RyYXRlZ3kiLCJwbGF0Zm9ybSIsImV4ZWMiLCJ0cmltIiwibmV3UGFzc3dvcmQiLCJzZWN1cml0eUFyZ3MiLCJiaW5hcnkiLCJQcm9taXNlIiwicmVzb2x2ZSIsInJlamVjdCIsImVycm9yIiwic3Rkb3V0IiwiSW5NZW1vcnlTdHJhdGVneSIsImNvbnNvbGUiLCJ3YXJuIiwicGFzc3dvcmRzQnlTZXJ2aWNlIiwiTWFwIiwicGFzc3dvcmRzIiwiZ2V0Iiwic2V0IiwiZGVsZXRlIiwiRmlsZVN0cmF0ZWd5IiwiQm9vbGVhbiIsIkFUT01fR0lUSFVCX0tFWVRBUl9GSUxFIiwiZmlsZVBhdGgiLCJwYXlsb2FkIiwibG9hZCIsImZvclNlcnZpY2UiLCJ1bmRlZmluZWQiLCJwYXNzd2QiLCJtb2RpZnkiLCJPYmplY3QiLCJrZXlzIiwibGVuZ3RoIiwicmVhZEZpbGUiLCJjb250ZW50IiwiY29kZSIsIkpTT04iLCJwYXJzZSIsInNhdmUiLCJ3cml0ZUZpbGUiLCJzdHJpbmdpZnkiLCJjYWxsYmFjayIsInN0cmF0ZWdpZXMiLCJWYWxpZFN0cmF0ZWd5IiwiY3JlYXRlU3RyYXRlZ3kiLCJpIiwic3RyYXQiLCJFcnJvciIsIm1vZHVsZSIsImV4cG9ydHMiXSwibWFwcGluZ3MiOiI7O0FBQUE7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFFQSxNQUFNO0FBQUNBLEVBQUFBO0FBQUQsSUFBYUMsT0FBTyxDQUFDLGVBQUQsQ0FBMUI7O0FBQ0EsTUFBTUMsRUFBRSxHQUFHRCxPQUFPLENBQUMsSUFBRCxDQUFsQjs7QUFFQSxJQUFJLE9BQU9FLElBQVAsS0FBZ0IsV0FBcEIsRUFBaUM7QUFDL0JDLEVBQUFBLE1BQU0sQ0FBQ0QsSUFBUCxHQUFjO0FBQ1pFLElBQUFBLFVBQVUsR0FBRztBQUFFLGFBQU8sQ0FBQyxDQUFDQyxPQUFPLENBQUNDLEdBQVIsQ0FBWUMscUJBQXJCO0FBQTZDLEtBRGhEOztBQUVaQyxJQUFBQSxTQUFTLEdBQUc7QUFBRSxhQUFPLEtBQVA7QUFBZTs7QUFGakIsR0FBZDtBQUlELEMsQ0FFRDs7O0FBQ0EsTUFBTUMsZUFBZSxHQUFHQyxNQUFNLENBQUMsaUJBQUQsQ0FBOUIsQyxDQUVBOztBQUNBLE1BQU1DLFlBQVksR0FBR0QsTUFBTSxDQUFDLGNBQUQsQ0FBM0IsQyxDQUVBOztBQUNBLE1BQU1FLFlBQVksR0FBR0YsTUFBTSxDQUFDLGNBQUQsQ0FBM0I7O0FBRUEsTUFBTUcsY0FBTixDQUFxQjtBQUNGLGFBQU5DLE1BQU0sR0FBRztBQUNsQixXQUFPZCxPQUFPLENBQUMsUUFBRCxDQUFkO0FBQ0Q7O0FBRW1CLGVBQVBlLE9BQU8sR0FBRztBQUNyQjtBQUNBLFFBQUlWLE9BQU8sQ0FBQ0MsR0FBUixDQUFZVSwwQkFBaEIsRUFBNEM7QUFDMUMsYUFBTyxLQUFQO0FBQ0Q7O0FBRUQsVUFBTUYsTUFBTSxHQUFHLEtBQUtBLE1BQXBCOztBQUVBLFFBQUk7QUFDRixZQUFNRyxJQUFJLEdBQUdDLElBQUksQ0FBQ0MsS0FB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QUFJRCxhQUFKLEVBQW1CO0FBQ2pCLFdBQU8sSUFBSUEsYUFBSixFQUFQO0FBQ0Q7O0FBRUQsT0FBSyxJQUFJRSxDQUFDLEdBQUcsQ0FBYixFQUFnQkEsQ0FBQyxHQUFHSCxVQUFVLENBQUNWLE1BQS9CLEVBQXVDYSxDQUFDLEVBQXhDLEVBQTRDO0FBQzFDLFVBQU1DLEtBQUssR0FBR0osVUFBVSxDQUFDRyxDQUFELENBQXhCO0FBQ0EsVUFBTWhFLE9BQU8sR0FBRyxNQUFNaUUsS0FBSyxDQUFDakUsT0FBTixFQUF0Qjs7QUFDQSxRQUFJQSxPQUFKLEVBQWE7QUFDWDhELE1BQUFBLGFBQWEsR0FBR0csS0FBaEI7QUFDQTtBQUNEO0FBQ0Y7O0FBQ0QsTUFBSSxDQUFDSCxhQUFMLEVBQW9CO0FBQ2xCLFVBQU0sSUFBSUksS0FBSixDQUFVLGtFQUFWLENBQU47QUFDRDs7QUFDRCxTQUFPLElBQUlKLGFBQUosRUFBUDtBQUNEOztBQUVESyxNQUFNLENBQUNDLE9BQVAsR0FBaUI7QUFDZjFFLEVBQUFBLGVBRGU7QUFFZkUsRUFBQUEsWUFGZTtBQUdmQyxFQUFBQSxZQUhlO0FBSWZDLEVBQUFBLGNBSmU7QUFLZm9CLEVBQUFBLHNCQUxlO0FBTWZZLEVBQUFBLGdCQU5lO0FBT2ZTLEVBQUFBLFlBUGU7QUFRZndCLEVBQUFBO0FBUmUsQ0FBakIiLCJzb3VyY2VzQ29udGVudCI6WyIvKiBlc2xpbnQgY29tbWEtZGFuZ2xlOiBbXCJlcnJvclwiLCB7XG4gICAgXCJhcnJheXNcIjogXCJuZXZlclwiLFxuICAgIFwib2JqZWN0c1wiOiBcIm5ldmVyXCIsXG4gICAgXCJpbXBvcnRzXCI6IFwibmV2ZXJcIixcbiAgICBcImV4cG9ydHNcIjogXCJuZXZlclwiLFxuICAgIFwiZnVuY3Rpb25zXCI6IFwibmV2ZXJcIlxuICB9XSAqL1xuXG5jb25zdCB7ZXhlY0ZpbGV9ID0gcmVxdWlyZSgnY2hpbGRfcHJvY2VzcycpO1xuY29uc3QgZnMgPSByZXF1aXJlKCdmcycpO1xuXG5pZiAodHlwZW9mIGF0b20gPT09ICd1bmRlZmluZWQnKSB7XG4gIGdsb2JhbC5hdG9tID0ge1xuICAgIGluU3BlY01vZGUoKSB7IHJldHVybiAhIXByb2Nlc3MuZW52LkFUT01fR0lUSFVCX1NQRUNfTU9ERTsgfSxcbiAgICBpbkRldk1vZGUoKSB7IHJldHVybiBmYWxzZTsgfVxuICB9O1xufVxuXG4vLyBObyB0b2tlbiBhdmFpbGFibGUgaW4geW91ciBPUyBrZXljaGFpbi5cbmNvbnN0IFVOQVVUSEVOVElDQVRFRCA9IFN5bWJvbCgnVU5BVVRIRU5USUNBVEVEJyk7XG5cbi8vIFRoZSB0b2tlbiBpbiB5b3VyIGtleWNoYWluIGlzbid0IGdyYW50ZWQgYWxsIG9mIHRoZSByZXF1aXJlZCBPQXV0aCBzY29wZXMuXG5jb25zdCBJTlNVRkZJQ0lFTlQgPSBTeW1ib2woJ0lOU1VGRklDSUVOVCcpO1xuXG4vLyBUaGUgdG9rZW4gaW4geW91ciBrZXljaGFpbiBpcyBub3QgYWNjZXB0ZWQgYnkgR2l0SHViLlxuY29uc3QgVU5BVVRIT1JJWkVEID0gU3ltYm9sKCdVTkFVVEhPUklaRUQnKTtcblxuY2xhc3MgS2V5dGFyU3RyYXRlZ3kge1xuICBzdGF0aWMgZ2V0IGtleXRhcigpIHtcbiAgICByZXR1cm4gcmVxdWlyZSgna2V5dGFyJyk7XG4gIH1cblxuICBzdGF0aWMgYXN5bmMgaXNWYWxpZCgpIHtcbiAgICAvLyBBbGxvdyBmb3IgZGlzYWJsaW5nIEtleXRhciBvbiBwcm9ibGVtYXRpYyBDSSBlbnZpcm9ubWVudHNcbiAgICBpZiAocHJvY2Vzcy5lbnYuQVRPTV9HSVRIVUJfRElTQUJMRV9LRVlUQVIpIHtcbiAgICAgIHJldHVybiBmYWxzZTtcbiAgICB9XG5cbiAgICBjb25zdCBrZXl0YXIgPSB0aGlzLmtleXRhcjtcblxuICAgIHRyeSB7XG4gICAgICBjb25zdCByYW5kID0gTWF0aC5mbG9vcihNYXRoLnJhbmRvbSgpICogMTBlMjApLnRvU3RyaW5nKDE2KTtcbiAgICAgIGF3YWl0IGtleXRhci5zZXRQYXNzd29yZCgnYXRvbS10ZXN0LXNlcnZpY2UnLCByYW5kLCByYW5kKTtcbiAgICAgIGNvbnN0IHBhc3MgPSBhd2FpdCBrZXl0YXIuZ2V0UGFzc3dvcmQoJ2F0b20tdGVzdC1zZXJ2aWNlJywgcmFuZCk7XG4gICAgICBjb25zdCBzdWNjZXNzID0gcGFzcyA9PT0gcmFuZDtcbiAgICAgIGtleXRhci5kZWxldGVQYXNzd29yZCgnYXRvbS10ZXN0LXNlcnZpY2UnLCByYW5kKTtcbiAgICAgIHJldHVybiBzdWNjZXNzO1xuICAgIH0gY2F0Y2ggKGVycikge1xuICAgICAgcmV0dXJuIGZhbHNlO1xuICAgIH1cbiAgfVxuXG4gIGFzeW5jIGdldFBhc3N3b3JkKHNlcnZpY2UsIGFjY291bnQpIHtcbiAgICBjb25zdCBwYXNzd29yZCA9IGF3YWl0IHRoaXMuY29uc3RydWN0b3Iua2V5dGFyLmdldFBhc3N3b3JkKHNlcnZpY2UsIGFjY291bnQpO1xuICAgIHJldHVybiBwYXNzd29yZCAhPT0gbnVsbCA/IHBhc3N3b3JkIDogVU5BVVRIRU5USUNBVEVEO1xuICB9XG5cbiAgcmVwbGFjZVBhc3N3b3JkKHNlcnZpY2UsIGFjY291bnQsIHBhc3N3b3JkKSB7XG4gICAgcmV0dXJuIHRoaXMuY29uc3RydWN0b3Iua2V5dGFyLnNldFBhc3N3b3JkKHNlcnZpY2UsIGFjY291bnQsIHBhc3N3b3JkKTtcbiAgfVxuXG4gIGRlbGV0ZVBhc3N3b3JkKHNlcnZpY2UsIGFjY291bnQpIHtcbiAgICByZXR1cm4gdGhpcy5jb25zdHJ1Y3Rvci5rZXl0YXIuZGVsZXRlUGFzc3dvcmQoc2VydmljZSwgYWNjb3VudCk7XG4gIH1cbn1cblxuY2xhc3MgU2VjdXJpdHlCaW5hcnlTdHJhdGVneSB7XG4gIHN0YXRpYyBpc1ZhbGlkKCkge1xuICAgIHJldHVybiBwcm9jZXNzLnBsYXRmb3JtID09PSAnZGFyd2luJztcbiAgfVxuXG4gIGFzeW5jIGdldFBhc3N3b3JkKHNlcnZpY2UsIGFjY291bnQpIHtcbiAgICB0cnkge1xuICAgICAgY29uc3QgcGFzc3dvcmQgPSBhd2FpdCB0aGlzLmV4ZWMoWydmaW5kLWdlbmVyaWMtcGFzc3dvcmQnLCAnLXMnLCBzZXJ2aWNlLCAnLWEnLCBhY2NvdW50LCAnLXcnXSk7XG4gICAgICByZXR1cm4gcGFzc3dvcmQudHJpbSgpIHx8IFVOQVVUSEVOVElDQVRFRDtcbiAgICB9IGNhdGNoIChlcnIpIHtcbiAgICAgIHJldHVybiBVTkFVVEhFTlRJQ0FURUQ7XG4gICAgfVxuICB9XG5cbiAgcmVwbGFjZVBhc3N3b3JkKHNlcnZpY2UsIGFjY291bnQsIG5ld1Bhc3N3b3JkKSB7XG4gICAgcmV0dXJuIHRoaXMuZXhlYyhbJ2FkZC1nZW5lcmljLXBhc3N3b3JkJywgJy1zJywgc2VydmljZSwgJy1hJywgYWNjb3VudCwgJy13JywgbmV3UGFzc3dvcmQsICctVSddKTtcbiAgfVxuXG4gIGRlbGV0ZVBhc3N3b3JkKHNlcnZpY2UsIGFjY291bnQpIHtcbiAgICByZXR1cm4gdGhpcy5leGVjKFsnZGVsZXRlLWdlbmVyaWMtcGFzc3dvcmQnLCAnLXMnLCBzZXJ2aWNlLCAnLWEnLCBhY2NvdW50XSk7XG4gIH1cblxuICBleGVjKHNlY3VyaXR5QXJncywge2JpbmFyeX0gPSB7YmluYXJ5OiAnc2VjdXJpdHknfSkge1xuICAgIHJldHVybiBuZXcgUHJvbWlzZSgocmVzb2x2ZSwgcmVqZWN0KSA9PiB7XG4gICAgICBleGVjRmlsZShiaW5hcnksIHNlY3VyaXR5QXJncywgKGVycm9yLCBzdGRvdXQpID0+IHtcbiAgICAgICAgaWYgKGVycm9yKSB7IHJldHVybiByZWplY3QoZXJyb3IpOyB9XG4gICAgICAgIHJldHVybiByZXNvbHZlKHN0ZG91dCk7XG4gICAgICB9KTtcbiAgICB9KTtcbiAgfVxufVxuXG5jbGFzcyBJbk1lbW9yeVN0cmF0ZWd5IHtcbiAgc3RhdGljIGlzVmFsaWQoKSB7XG4gICAgcmV0dXJuIHRydWU7XG4gIH1cblxuICBjb25zdHJ1Y3RvcigpIHtcbiAgICBpZiAoIWF0b20uaW5TcGVjTW9kZSgpKSB7XG4gICAgICAvLyBlc2xpbnQtZGlzYWJsZS1uZXh0LWxpbmUgbm8tY29uc29sZVxuICAgICAgY29uc29sZS53YXJuKFxuICAgICAgICAnVXNpbmcgYW4gSW5NZW1vcnlTdHJhdGVneSBzdHJhdGVneSBmb3Igc3RvcmluZyB0b2tlbnMuICcgK1xuICAgICAgICAnVGhlIHRva2VucyB3aWxsIG9ubHkgYmUgc3RvcmVkIGZvciB0aGUgY3VycmVudCB3aW5kb3cuJ1xuICAgICAgKTtcbiAgICB9XG4gICAgdGhpcy5wYXNzd29yZHNCeVNlcnZpY2UgPSBuZXcgTWFwKCk7XG4gIH1cblxuICBnZXRQYXNzd29yZChzZXJ2aWNlLCBhY2NvdW50KSB7XG4gICAgY29uc3QgcGFzc3dvcmRzID0gdGhpcy5wYXNzd29yZHNCeVNlcnZpY2UuZ2V0KHNlcnZpY2UpIHx8IG5ldyBNYXAoKTtcbiAgICBjb25zdCBwYXNzd29yZCA9IHBhc3N3b3Jkcy5nZXQoYWNjb3VudCk7XG4gICAgcmV0dXJuIHBhc3N3b3JkIHx8IFVOQVVUSEVOVElDQVRFRDtcbiAgfVxuXG4gIHJlcGxhY2VQYXNzd29yZChzZXJ2aWNlLCBhY2NvdW50LCBuZXdQYXNzd29yZCkge1xuICAgIGNvbnN0IHBhc3N3b3JkcyA9IHRoaXMucGFzc3dvcmRzQnlTZXJ2aWNlLmdldChzZXJ2aWNlKSB8fCBuZXcgTWFwKCk7XG4gICAgcGFzc3dvcmRzLnNldChhY2NvdW50LCBuZXdQYXNzd29yZCk7XG4gICAgdGhpcy5wYXNzd29yZHNCeVNlcnZpY2Uuc2V0KHNlcnZpY2UsIHBhc3N3b3Jkcyk7XG4gIH1cblxuICBkZWxldGVQYXNzd29yZChzZXJ2aWNlLCBhY2NvdW50KSB7XG4gICAgY29uc3QgcGFzc3dvcmRzID0gdGhpcy5wYXNzd29yZHNCeVNlcnZpY2UuZ2V0KHNlcnZpY2UpO1xuICAgIGlmIChwYXNzd29yZHMpIHtcbiAgICAgIHBhc3N3b3Jkcy5kZWxldGUoYWNjb3VudCk7XG4gICAgfVxuICB9XG59XG5cbmNsYXNzIEZpbGVTdHJhdGVneSB7XG4gIHN0YXRpYyBpc1ZhbGlkKCkge1xuICAgIGlmICghYXRvbS5pblNwZWNNb2RlKCkgJiYgIWF0b20uaW5EZXZNb2RlKCkpIHtcbiAgICAgIHJldHVybiBmYWxzZTtcbiAgICB9XG5cbiAgICByZXR1cm4gQm9vbGVhbihwcm9jZXNzLmVudi5BVE9NX0dJVEhVQl9LRVlUQVJfRklMRSk7XG4gIH1cblxuICBjb25zdHJ1Y3RvcigpIHtcbiAgICB0aGlzLmZpbGVQYXRoID0gcHJvY2Vzcy5lbnYuQVRPTV9HSVRIVUJfS0VZVEFSX0ZJTEU7XG5cbiAgICBpZiAoIWF0b20uaW5TcGVjTW9kZSgpKSB7XG4gICAgICAvLyBlc2xpbnQtZGlzYWJsZS1uZXh0LWxpbmUgbm8tY29uc29sZVxuICAgICAgY29uc29sZS53YXJuKFxuICAgICAgICAnVXNpbmcgYSBGaWxlU3RyYXRlZ3kgc3RyYXRlZ3kgZm9yIHN0b3JpbmcgdG9rZW5zLiAnICtcbiAgICAgICAgJ1RoZSB0b2tlbnMgd2lsbCBiZSBzdG9yZWQgJWNpbiB0aGUgY2xlYXIlYyBpbiBhIGZpbGUgYXQgJXMuICcgK1xuICAgICAgICBcIllvdSBwcm9iYWJseSBzaG91bGRuJ3QgdXNlIHJlYWwgY3JlZGVudGlhbHMgd2hpbGUgdGhpcyBzdHJhdGVneSBpcyBpbiB1c2UuIFwiICtcbiAgICAgICAgJ1Vuc2V0IEFUT01fR0lUSFVCX0tFWVRBUl9GSUxFX1NUUkFURUdZIHRvIGRpc2FibGUgaXQuJyxcbiAgICAgICAgJ2NvbG9yOiByZWQ7IGZvbnQtd2VpZ2h0OiBib2xkOyBmb250LXN0eWxlOiBpdGFsaWMnLFxuICAgICAgICAnY29sb3I6IGJsYWNrOyBmb250LXdlaWdodDogbm9ybWFsOyBmb250LXN0eWxlOiBub3JtYWwnLFxuICAgICAgICB0aGlzLmZpbGVQYXRoXG4gICAgICApO1xuICAgIH1cbiAgfVxuXG4gIGFzeW5jIGdldFBhc3N3b3JkKHNlcnZpY2UsIGFjY291bnQpIHtcbiAgICBjb25zdCBwYXlsb2FkID0gYXdhaXQgdGhpcy5sb2FkKCk7XG4gICAgY29uc3QgZm9yU2VydmljZSA9IHBheWxvYWRbc2VydmljZV07XG4gICAgaWYgKGZvclNlcnZpY2UgPT09IHVuZGVmaW5lZCkge1xuICAgICAgcmV0dXJuIFVOQVVUSEVOVElDQVRFRDtcbiAgICB9XG4gICAgY29uc3QgcGFzc3dkID0gZm9yU2VydmljZVthY2NvdW50XTtcbiAgICBpZiAocGFzc3dkID09PSB1bmRlZmluZWQpIHtcbiAgICAgIHJldHVybiBVTkFVVEhFTlRJQ0FURUQ7XG4gICAgfVxuICAgIHJldHVybiBwYXNzd2Q7XG4gIH1cblxuICByZXBsYWNlUGFzc3dvcmQoc2VydmljZSwgYWNjb3VudCwgcGFzc3dvcmQpIHtcbiAgICByZXR1cm4gdGhpcy5tb2RpZnkocGF5bG9hZCA9PiB7XG4gICAgICBsZXQgZm9yU2VydmljZSA9IHBheWxvYWRbc2VydmljZV07XG4gICAgICBpZiAoZm9yU2VydmljZSA9PT0gdW5kZWZpbmVkKSB7XG4gICAgICAgIGZvclNlcnZpY2UgPSB7fTtcbiAgICAgICAgcGF5bG9hZFtzZXJ2aWNlXSA9IGZvclNlcnZpY2U7XG4gICAgICB9XG4gICAgICBmb3JTZXJ2aWNlW2FjY291bnRdID0gcGFzc3dvcmQ7XG4gICAgfSk7XG4gIH1cblxuICBkZWxldGVQYXNzd29yZChzZXJ2aWNlLCBhY2NvdW50KSB7XG4gICAgcmV0dXJuIHRoaXMubW9kaWZ5KHBheWxvYWQgPT4ge1xuICAgICAgY29uc3QgZm9yU2VydmljZSA9IHBheWxvYWRbc2VydmljZV07XG4gICAgICBpZiAoZm9yU2VydmljZSA9PT0gdW5kZWZpbmVkKSB7XG4gICAgICAgIHJldHVybjtcbiAgICAgIH1cbiAgICAgIGRlbGV0ZSBmb3JTZXJ2aWNlW2FjY291bnRdO1xuICAgICAgaWYgKE9iamVjdC5rZXlzKGZvclNlcnZpY2UpLmxlbmd0aCA9PT0gMCkge1xuICAgICAgICBkZWxldGUgcGF5bG9hZFtzZXJ2aWNlXTtcbiAgICAgIH1cbiAgICB9KTtcbiAgfVxuXG4gIGxvYWQoKSB7XG4gICAgcmV0dXJuIG5ldyBQcm9taXNlKChyZXNvbHZlLCByZWplY3QpID0+IHtcbiAgICAgIGZzLnJlYWRGaWxlKHRoaXMuZmlsZVBhdGgsICd1dGY4JywgKGVyciwgY29udGVudCkgPT4ge1xuICAgICAgICBpZiAoZXJyICYmIGVyci5jb2RlID09PSAnRU5PRU5UJykge1xuICAgICAgICAgIHJldHVybiByZXNvbHZlKHt9KTtcbiAgICAgICAgfVxuICAgICAgICBpZiAoZXJyKSB7XG4gICAgICAgICAgcmV0dXJuIHJlamVjdChlcnIpO1xuICAgICAgICB9XG4gICAgICAgIHJldHVybiByZXNvbHZlKEpTT04ucGFyc2UoY29udGVudCkpO1xuICAgICAgfSk7XG4gICAgfSk7XG4gIH1cblxuICBzYXZlKHBheWxvYWQpIHtcbiAgICByZXR1cm4gbmV3IFByb21pc2UoKHJlc29sdmUsIHJlamVjdCkgPT4ge1xuICAgICAgZnMud3JpdGVGaWxlKHRoaXMuZmlsZVBhdGgsIEpTT04uc3RyaW5naWZ5KHBheWxvYWQpLCAndXRmOCcsIGVyciA9PiB7XG4gICAgICAgIGlmIChlcnIpIHtcbiAgICAgICAgICByZWplY3QoZXJyKTtcbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICByZXNvbHZlKCk7XG4gICAgICAgIH1cbiAgICAgIH0pO1xuICAgIH0pO1xuICB9XG5cbiAgYXN5bmMgbW9kaWZ5KGNhbGxiYWNrKSB7XG4gICAgY29uc3QgcGF5bG9hZCA9IGF3YWl0IHRoaXMubG9hZCgpO1xuICAgIGNhbGxiYWNrKHBheWxvYWQpO1xuICAgIGF3YWl0IHRoaXMuc2F2ZShwYXlsb2FkKTtcbiAgfVxufVxuXG5jb25zdCBzdHJhdGVnaWVzID0gW0ZpbGVTdHJhdGVneSwgS2V5dGFyU3RyYXRlZ3ksIFNlY3VyaXR5QmluYXJ5U3RyYXRlZ3ksIEluTWVtb3J5U3RyYXRlZ3ldO1xubGV0IFZhbGlkU3RyYXRlZ3kgPSBudWxsO1xuXG5hc3luYyBmdW5jdGlvbiBjcmVhdGVTdHJhdGVneSgpIHtcbiAgaWYgKFZhbGlkU3RyYXRlZ3kpIHtcbiAgICByZXR1cm4gbmV3IFZhbGlkU3RyYXRlZ3koKTtcbiAgfVxuXG4gIGZvciAobGV0IGkgPSAwOyBpIDwgc3RyYXRlZ2llcy5sZW5ndGg7IGkrKykge1xuICAgIGNvbnN0IHN0cmF0ID0gc3RyYXRlZ2llc1tpXTtcbiAgICBjb25zdCBpc1ZhbGlkID0gYXdhaXQgc3RyYXQuaXNWYWxpZCgpO1xuICAgIGlmIChpc1ZhbGlkKSB7XG4gICAgICBWYWxpZFN0cmF0ZWd5ID0gc3RyYXQ7XG4gICAgICBicmVhaztcbiAgICB9XG4gIH1cbiAgaWYgKCFWYWxpZFN0cmF0ZWd5KSB7XG4gICAgdGhyb3cgbmV3IEVycm9yKCdOb25lIG9mIHRoZSBsaXN0ZWQga2V5dGFyIHN0cmF0ZWdpZXMgcmV0dXJuZWQgdHJ1ZSBmb3IgYGlzVmFsaWRgJyk7XG4gIH1cbiAgcmV0dXJuIG5ldyBWYWxpZFN0cmF0ZWd5KCk7XG59XG5cbm1vZHVsZS5leHBvcnRzID0ge1xuICBVTkFVVEhFTlRJQ0FURUQsXG4gIElOU1VGRklDSUVOVCxcbiAgVU5BVVRIT1JJWkVELFxuICBLZXl0YXJTdHJhdGVneSxcbiAgU2VjdXJpdHlCaW5hcnlTdHJhdGVneSxcbiAgSW5NZW1vcnlTdHJhdGVneSxcbiAgRmlsZVN0cmF0ZWd5LFxuICBjcmVhdGVTdHJhdGVneVxufTtcbiJdfQ==