"use strict";

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.default = void 0;

var _react = _interopRequireDefault(require("react"));

var _reactDom = _interopRequireDefault(require("react-dom"));

var _propTypes = _interopRequireDefault(require("prop-types"));

var _eventKit = require("event-kit");

var _propTypes2 = require("../prop-types");

var _helpers = require("../helpers");

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }

function _defineProperty(obj, key, value) { if (key in obj) { Object.defineProperty(obj, key, { value: value, enumerable: true, configurable: true, writable: true }); } else { obj[key] = value; } return obj; }

const VERBATIM_OPTION_PROPS = ['title', 'html', 'placement', 'trigger', 'keyBindingCommand', 'keyBindingTarget'];
const OPTION_PROPS = [...VERBATIM_OPTION_PROPS, 'tooltips', 'className', 'showDelay', 'hideDelay'];

class Tooltip extends _react.default.Component {
  constructor(props, context) {
    super(props, context);
    this.refSub = new _eventKit.Disposable();
    this.tipSub = new _eventKit.Disposable();
    this.domNode = null;

    if (this.props.children !== undefined) {
      this.domNode = document.createElement('div');
      this.domNode.className = 'react-atom-tooltip';
    }

    this.lastTooltipProps = {};
  }

  componentDidMount() {
    this.setupTooltip();
  }

  render() {
    if (this.props.children !== undefined) {
      return _reactDom.default.createPortal(this.props.children, this.domNode);
    } else {
      return null;
    }
  }

  componentDidUpdate() {
    if (this.shouldRecreateTooltip()) {
      this.refSub.dispose();
      this.tipSub.dispose();
      this.setupTooltip();
    }
  }

  componentWillUnmount() {
    this.refSub.dispose();
    this.tipSub.dispose();
  }

  getTooltipProps() {
    const p = {};

    for (const key of OPTION_PROPS) {
      p[key] = this.props[key];
    }

    return p;
  }

  shouldRecreateTooltip() {
    return OPTION_PROPS.some(key => this.lastTooltipProps[key] !== this.props[key]);
  }

  setupTooltip() {
    this.lastTooltipProps = this.getTooltipProps();
    const options = {};
    VERBATIM_OPTION_PROPS.forEach(key => {
      if (this.props[key] !== undefined) {
        options[key] = this.props[key];
      }
    });

    if (this.props.className !== undefined) {
      options.class = this.props.className;
    }

    if (this.props.showDelay !== undefined || this.props.hideDelay !== undefined) {
      const delayDefaults = (this.props.trigger === 'hover' || this.props.trigger === undefined) && {
        show: 1000,
        hide: 100
      } || {
        show: 0,
        hide: 0
      };
      options.delay = {
        show: this.props.showDelay !== undefined ? this.props.showDelay : delayDefaults.show,
        hide: this.props.hideDelay !== undefined ? this.props.hideDelay : delayDefaults.hide
      };
    }

    if (this.props.children !== undefined) {
      options.item = (0, _helpers.createItem)(this.domNode, this.props.itemHolder);
    }

    this.refSub = this.props.target.observe(t => {
      this.tipSub.dispose();
      this.tipSub = this.props.manager.add(t, options);
      const h = this.props.tooltipHolder;

      if (h) {
        h.setter(this.tipSub);
      }
    });
  }

}

exports.default = Tooltip;

_defineProperty(Tooltip, "propTypes", {
  manager: _propTypes.default.object.isRequired,
  target: _propTypes2.RefHolderPropType.isRequired,
  title: _propTypes.default.oneOfType([_propTypes.default.string, _propTypes.default.func]),
  html: _propTypes.default.bool,
  className: _propTypes.default.string,
  placement: _propTypes.default.oneOfType([_propTypes.default.string, _propTypes.default.func]),
  trigger: _propTypes.default.oneOf(['hover', 'click', 'focus', 'manual']),
  showDelay: _propTypes.default.number,
  hideDelay: _propTypes.default.number,
  keyBindingCommand: _propTypes.default.string,
  keyBindingTarget: _propTypes.default.element,
  children: _propTypes.default.element,
  itemHolder: _propTypes2.RefHolderPropType,
  tooltipHolder: _propTypes2.RefHolderPropType
});

_defineProperty(Tooltip, "defaultProps", {
  getItemComponent: () => {}
});
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uL2xpYi9hdG9tL3Rvb2x0aXAuanMiXSwibmFtZXMiOlsiVkVSQkFUSU1fT1BUSU9OX1BST1BTIiwiT1BUSU9OX1BST1BTIiwiVG9vbHRpcCIsIlJlYWN0IiwiQ29tcG9uZW50IiwiY29uc3RydWN0b3IiLCJwcm9wcyIsImNvbnRleHQiLCJyZWZTdWIiLCJEaXNwb3NhYmxlIiwidGlwU3ViIiwiZG9tTm9kZSIsImNoaWxkcmVuIiwidW5kZWZpbmVkIiwiZG9jdW1lbnQiLCJjcmVhdGVFbGVtZW50IiwiY2xhc3NOYW1lIiwibGFzdFRvb2x0aXBQcm9wcyIsImNvbXBvbmVudERpZE1vdW50Iiwic2V0dXBUb29sdGlwIiwicmVuZGVyIiwiUmVhY3RET00iLCJjcmVhdGVQb3J0YWwiLCJjb21wb25lbnREaWRVcGRhdGUiLCJzaG91bGRSZWNyZWF0ZVRvb2x0aXAiLCJkaXNwb3NlIiwiY29tcG9uZW50V2lsbFVubW91bnQiLCJnZXRUb29sdGlwUHJvcHMiLCJwIiwia2V5Iiwic29tZSIsIm9wdGlvbnMiLCJmb3JFYWNoIiwiY2xhc3MiLCJzaG93RGVsYXkiLCJoaWRlRGVsYXkiLCJkZWxheURlZmF1bHRzIiwidHJpZ2dlciIsInNob3ciLCJoaWRlIiwiZGVsYXkiLCJpdGVtIiwiaXRlbUhvbGRlciIsInRhcmdldCIsIm9ic2VydmUiLCJ0IiwibWFuYWdlciIsImFkZCIsImgiLCJ0b29sdGlwSG9sZGVyIiwic2V0dGVyIiwiUHJvcFR5cGVzIiwib2JqZWN0IiwiaXNSZXF1aXJlZCIsIlJlZkhvbGRlclByb3BUeXBlIiwidGl0bGUiLCJvbmVPZlR5cGUiLCJzdHJpbmciLCJmdW5jIiwiaHRtbCIsImJvb2wiLCJwbGFjZW1lbnQiLCJvbmVPZiIsIm51bWJlciIsImtleUJpbmRpbmdDb21tYW5kIiwia2V5QmluZGluZ1RhcmdldCIsImVsZW1lbnQiLCJnZXRJdGVtQ29tcG9uZW50Il0sIm1hcHBpbmdzIjoiOzs7Ozs7O0FBQUE7O0FBQ0E7O0FBQ0E7O0FBQ0E7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QUFBLGFBQWEsRUFBRUs7QUFwQkUsQzs7Z0JBREFwRCxPLGtCQXdCRztBQUNwQmlFLEVBQUFBLGdCQUFnQixFQUFFLE1BQU0sQ0FBRTtBQUROLEMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgUmVhY3QgZnJvbSAncmVhY3QnO1xuaW1wb3J0IFJlYWN0RE9NIGZyb20gJ3JlYWN0LWRvbSc7XG5pbXBvcnQgUHJvcFR5cGVzIGZyb20gJ3Byb3AtdHlwZXMnO1xuaW1wb3J0IHtEaXNwb3NhYmxlfSBmcm9tICdldmVudC1raXQnO1xuXG5pbXBvcnQge1JlZkhvbGRlclByb3BUeXBlfSBmcm9tICcuLi9wcm9wLXR5cGVzJztcbmltcG9ydCB7Y3JlYXRlSXRlbX0gZnJvbSAnLi4vaGVscGVycyc7XG5cbmNvbnN0IFZFUkJBVElNX09QVElPTl9QUk9QUyA9IFtcbiAgJ3RpdGxlJywgJ2h0bWwnLCAncGxhY2VtZW50JywgJ3RyaWdnZXInLCAna2V5QmluZGluZ0NvbW1hbmQnLCAna2V5QmluZGluZ1RhcmdldCcsXG5dO1xuXG5jb25zdCBPUFRJT05fUFJPUFMgPSBbXG4gIC4uLlZFUkJBVElNX09QVElPTl9QUk9QUyxcbiAgJ3Rvb2x0aXBzJywgJ2NsYXNzTmFtZScsICdzaG93RGVsYXknLCAnaGlkZURlbGF5Jyxcbl07XG5cbmV4cG9ydCBkZWZhdWx0IGNsYXNzIFRvb2x0aXAgZXh0ZW5kcyBSZWFjdC5Db21wb25lbnQge1xuICBzdGF0aWMgcHJvcFR5cGVzID0ge1xuICAgIG1hbmFnZXI6IFByb3BUeXBlcy5vYmplY3QuaXNSZXF1aXJlZCxcbiAgICB0YXJnZXQ6IFJlZkhvbGRlclByb3BUeXBlLmlzUmVxdWlyZWQsXG4gICAgdGl0bGU6IFByb3BUeXBlcy5vbmVPZlR5cGUoW1xuICAgICAgUHJvcFR5cGVzLnN0cmluZyxcbiAgICAgIFByb3BUeXBlcy5mdW5jLFxuICAgIF0pLFxuICAgIGh0bWw6IFByb3BUeXBlcy5ib29sLFxuICAgIGNsYXNzTmFtZTogUHJvcFR5cGVzLnN0cmluZyxcbiAgICBwbGFjZW1lbnQ6IFByb3BUeXBlcy5vbmVPZlR5cGUoW1xuICAgICAgUHJvcFR5cGVzLnN0cmluZyxcbiAgICAgIFByb3BUeXBlcy5mdW5jLFxuICAgIF0pLFxuICAgIHRyaWdnZXI6IFByb3BUeXBlcy5vbmVPZihbJ2hvdmVyJywgJ2NsaWNrJywgJ2ZvY3VzJywgJ21hbnVhbCddKSxcbiAgICBzaG93RGVsYXk6IFByb3BUeXBlcy5udW1iZXIsXG4gICAgaGlkZURlbGF5OiBQcm9wVHlwZXMubnVtYmVyLFxuICAgIGtleUJpbmRpbmdDb21tYW5kOiBQcm9wVHlwZXMuc3RyaW5nLFxuICAgIGtleUJpbmRpbmdUYXJnZXQ6IFByb3BUeXBlcy5lbGVtZW50LFxuICAgIGNoaWxkcmVuOiBQcm9wVHlwZXMuZWxlbWVudCxcbiAgICBpdGVtSG9sZGVyOiBSZWZIb2xkZXJQcm9wVHlwZSxcbiAgICB0b29sdGlwSG9sZGVyOiBSZWZIb2xkZXJQcm9wVHlwZSxcbiAgfVxuXG4gIHN0YXRpYyBkZWZhdWx0UHJvcHMgPSB7XG4gICAgZ2V0SXRlbUNvbXBvbmVudDogKCkgPT4ge30sXG4gIH1cblxuICBjb25zdHJ1Y3Rvcihwcm9wcywgY29udGV4dCkge1xuICAgIHN1cGVyKHByb3BzLCBjb250ZXh0KTtcblxuICAgIHRoaXMucmVmU3ViID0gbmV3IERpc3Bvc2FibGUoKTtcbiAgICB0aGlzLnRpcFN1YiA9IG5ldyBEaXNwb3NhYmxlKCk7XG5cbiAgICB0aGlzLmRvbU5vZGUgPSBudWxsO1xuICAgIGlmICh0aGlzLnByb3BzLmNoaWxkcmVuICE9PSB1bmRlZmluZWQpIHtcbiAgICAgIHRoaXMuZG9tTm9kZSA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoJ2RpdicpO1xuICAgICAgdGhpcy5kb21Ob2RlLmNsYXNzTmFtZSA9ICdyZWFjdC1hdG9tLXRvb2x0aXAnO1xuICAgIH1cblxuICAgIHRoaXMubGFzdFRvb2x0aXBQcm9wcyA9IHt9O1xuICB9XG5cbiAgY29tcG9uZW50RGlkTW91bnQoKSB7XG4gICAgdGhpcy5zZXR1cFRvb2x0aXAoKTtcbiAgfVxuXG4gIHJlbmRlcigpIHtcbiAgICBpZiAodGhpcy5wcm9wcy5jaGlsZHJlbiAhPT0gdW5kZWZpbmVkKSB7XG4gICAgICByZXR1cm4gUmVhY3RET00uY3JlYXRlUG9ydGFsKFxuICAgICAgICB0aGlzLnByb3BzLmNoaWxkcmVuLFxuICAgICAgICB0aGlzLmRvbU5vZGUsXG4gICAgICApO1xuICAgIH0gZWxzZSB7XG4gICAgICByZXR1cm4gbnVsbDtcbiAgICB9XG4gIH1cblxuICBjb21wb25lbnREaWRVcGRhdGUoKSB7XG4gICAgaWYgKHRoaXMuc2hvdWxkUmVjcmVhdGVUb29sdGlwKCkpIHtcbiAgICAgIHRoaXMucmVmU3ViLmRpc3Bvc2UoKTtcbiAgICAgIHRoaXMudGlwU3ViLmRpc3Bvc2UoKTtcbiAgICAgIHRoaXMuc2V0dXBUb29sdGlwKCk7XG4gICAgfVxuICB9XG5cbiAgY29tcG9uZW50V2lsbFVubW91bnQoKSB7XG4gICAgdGhpcy5yZWZTdWIuZGlzcG9zZSgpO1xuICAgIHRoaXMudGlwU3ViLmRpc3Bvc2UoKTtcbiAgfVxuXG4gIGdldFRvb2x0aXBQcm9wcygpIHtcbiAgICBjb25zdCBwID0ge307XG4gICAgZm9yIChjb25zdCBrZXkgb2YgT1BUSU9OX1BST1BTKSB7XG4gICAgICBwW2tleV0gPSB0aGlzLnByb3BzW2tleV07XG4gICAgfVxuICAgIHJldHVybiBwO1xuICB9XG5cbiAgc2hvdWxkUmVjcmVhdGVUb29sdGlwKCkge1xuICAgIHJldHVybiBPUFRJT05fUFJPUFMuc29tZShrZXkgPT4gdGhpcy5sYXN0VG9vbHRpcFByb3BzW2tleV0gIT09IHRoaXMucHJvcHNba2V5XSk7XG4gIH1cblxuICBzZXR1cFRvb2x0aXAoKSB7XG4gICAgdGhpcy5sYXN0VG9vbHRpcFByb3BzID0gdGhpcy5nZXRUb29sdGlwUHJvcHMoKTtcblxuICAgIGNvbnN0IG9wdGlvbnMgPSB7fTtcbiAgICBWRVJCQVRJTV9PUFRJT05fUFJPUFMuZm9yRWFjaChrZXkgPT4ge1xuICAgICAgaWYgKHRoaXMucHJvcHNba2V5XSAhPT0gdW5kZWZpbmVkKSB7XG4gICAgICAgIG9wdGlvbnNba2V5XSA9IHRoaXMucHJvcHNba2V5XTtcbiAgICAgIH1cbiAgICB9KTtcbiAgICBpZiAodGhpcy5wcm9wcy5jbGFzc05hbWUgIT09IHVuZGVmaW5lZCkge1xuICAgICAgb3B0aW9ucy5jbGFzcyA9IHRoaXMucHJvcHMuY2xhc3NOYW1lO1xuICAgIH1cbiAgICBpZiAodGhpcy5wcm9wcy5zaG93RGVsYXkgIT09IHVuZGVmaW5lZCB8fCB0aGlzLnByb3BzLmhpZGVEZWxheSAhPT0gdW5kZWZpbmVkKSB7XG4gICAgICBjb25zdCBkZWxheURlZmF1bHRzID0gKHRoaXMucHJvcHMudHJpZ2dlciA9PT0gJ2hvdmVyJyB8fCB0aGlzLnByb3BzLnRyaWdnZXIgPT09IHVuZGVmaW5lZClcbiAgICAgICAgJiYge3Nob3c6IDEwMDAsIGhpZGU6IDEwMH1cbiAgICAgICAgfHwge3Nob3c6IDAsIGhpZGU6IDB9O1xuXG4gICAgICBvcHRpb25zLmRlbGF5ID0ge1xuICAgICAgICBzaG93OiB0aGlzLnByb3BzLnNob3dEZWxheSAhPT0gdW5kZWZpbmVkID8gdGhpcy5wcm9wcy5zaG93RGVsYXkgOiBkZWxheURlZmF1bHRzLnNob3csXG4gICAgICAgIGhpZGU6IHRoaXMucHJvcHMuaGlkZURlbGF5ICE9PSB1bmRlZmluZWQgPyB0aGlzLnByb3BzLmhpZGVEZWxheSA6IGRlbGF5RGVmYXVsdHMuaGlkZSxcbiAgICAgIH07XG4gICAgfVxuICAgIGlmICh0aGlzLnByb3BzLmNoaWxkcmVuICE9PSB1bmRlZmluZWQpIHtcbiAgICAgIG9wdGlvbnMuaXRlbSA9IGNyZWF0ZUl0ZW0odGhpcy5kb21Ob2RlLCB0aGlzLnByb3BzLml0ZW1Ib2xkZXIpO1xuICAgIH1cblxuICAgIHRoaXMucmVmU3ViID0gdGhpcy5wcm9wcy50YXJnZXQub2JzZXJ2ZSh0ID0+IHtcbiAgICAgIHRoaXMudGlwU3ViLmRpc3Bvc2UoKTtcbiAgICAgIHRoaXMudGlwU3ViID0gdGhpcy5wcm9wcy5tYW5hZ2VyLmFkZCh0LCBvcHRpb25zKTtcbiAgICAgIGNvbnN0IGggPSB0aGlzLnByb3BzLnRvb2x0aXBIb2xkZXI7XG4gICAgICBpZiAoaCkge1xuICAgICAgICBoLnNldHRlcih0aGlzLnRpcFN1Yik7XG4gICAgICB9XG4gICAgfSk7XG4gIH1cbn1cbiJdfQ==