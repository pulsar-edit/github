"use strict";

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.default = void 0;
var _react = _interopRequireDefault(require("react"));
var _propTypes = _interopRequireDefault(require("prop-types"));
var _whatTheDiff = require("what-the-diff");
var _helpers = require("../helpers");
var _propTypes2 = require("../prop-types");
var _filter = require("../models/patch/filter");
var _patch = require("../models/patch");
function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }
function ownKeys(object, enumerableOnly) { var keys = Object.keys(object); if (Object.getOwnPropertySymbols) { var symbols = Object.getOwnPropertySymbols(object); enumerableOnly && (symbols = symbols.filter(function (sym) { return Object.getOwnPropertyDescriptor(object, sym).enumerable; })), keys.push.apply(keys, symbols); } return keys; }
function _objectSpread(target) { for (var i = 1; i < arguments.length; i++) { var source = null != arguments[i] ? arguments[i] : {}; i % 2 ? ownKeys(Object(source), !0).forEach(function (key) { _defineProperty(target, key, source[key]); }) : Object.getOwnPropertyDescriptors ? Object.defineProperties(target, Object.getOwnPropertyDescriptors(source)) : ownKeys(Object(source)).forEach(function (key) { Object.defineProperty(target, key, Object.getOwnPropertyDescriptor(source, key)); }); } return target; }
function _defineProperty(obj, key, value) { key = _toPropertyKey(key); if (key in obj) { Object.defineProperty(obj, key, { value: value, enumerable: true, configurable: true, writable: true }); } else { obj[key] = value; } return obj; }
function _toPropertyKey(arg) { var key = _toPrimitive(arg, "string"); return typeof key === "symbol" ? key : String(key); }
function _toPrimitive(input, hint) { if (typeof input !== "object" || input === null) return input; var prim = input[Symbol.toPrimitive]; if (prim !== undefined) { var res = prim.call(input, hint || "default"); if (typeof res !== "object") return res; throw new TypeError("@@toPrimitive must return a primitive value."); } return (hint === "string" ? String : Number)(input); }
class PullRequestPatchContainer extends _react.default.Component {
  constructor(...args) {
    super(...args);
    _defineProperty(this, "state", {
      multiFilePatch: null,
      error: null,
      last: {
        url: null,
        patch: null,
        etag: null
      }
    });
  }
  componentDidMount() {
    this.mounted = true;
    this.fetchDiff(this.state.last);
  }
  componentDidUpdate(prevProps) {
    const explicitRefetch = this.props.refetch && !prevProps.refetch;
    const requestedURLChange = this.state.last.url !== this.getDiffURL();
    if (explicitRefetch || requestedURLChange) {
      const {
        last
      } = this.state;
      this.setState({
        multiFilePatch: null,
        error: null,
        last: {
          url: this.getDiffURL(),
          patch: null,
          etag: null
        }
      });
      this.fetchDiff(last);
    }
  }
  componentWillUnmount() {
    this.mounted = false;
  }
  render() {
    return this.props.children(this.state.error, this.state.multiFilePatch);
  }

  // Generate a v3 GitHub API REST URL for the pull request resource.
  // Example: https://api.github.com/repos/atom/github/pulls/1829
  getDiffURL() {
    return this.props.endpoint.getRestURI('repos', this.props.owner, this.props.repo, 'pulls', this.props.number);
  }
  buildPatch(rawDiff) {
    const {
      filtered,
      removed
    } = (0, _filter.filter)(rawDiff);
    const diffs = (0, _whatTheDiff.parse)(filtered).map(diff => {
      // diff coming from API will have the defaul git diff prefixes a/ and b/ and use *nix-style / path separators.
      // e.g. a/dir/file1.js and b/dir/file2.js
      // see https://git-scm.com/docs/git-diff#_generating_patches_with_p
      return _objectSpread({}, diff, {
        newPath: diff.newPath ? (0, _helpers.toNativePathSep)(diff.newPath.replace(/^[a|b]\//, '')) : diff.newPath,
        oldPath: diff.oldPath ? (0, _helpers.toNativePathSep)(diff.oldPath.replace(/^[a|b]\//, '')) : diff.oldPath
      });
    });
    const options = {
      preserveOriginal: true,
      removed
    };
    if (this.props.largeDiffThreshold) {
      options.largeDiffThreshold = this.props.largeDiffThreshold;
    }
    const mfp = (0, _patch.buildMultiFilePatch)(diffs, options);
    return mfp;
  }
  async fetchDiff(last) {
    const url = this.getDiffURL();
    let response;
    try {
      const headers = {
        Accept: 'application/vnd.github.v3.diff',
        Authorization: `bearer ${this.props.token}`
      };
      if (url === last.url && last.etag !== null) {
        headers['If-None-Match'] = last.etag;
      }
      response = await fetch(url, {
        headers
      });
    } catch (err) {
      return this.reportDiffError(`Network error encountered fetching the patch: ${err.message}.`, err);
    }
    if (response.status === 304) {
      // Not modified.
      if (!this.mounted) {
        return null;
      }
      return new Promise(resolve => this.setState({
        multiFilePatch: last.patch,
        error: null,
        last
      }));
    }
    if (!response.ok) {
      return this.reportDiffError(`Unable to fetch the diff for this pull request: ${response.statusText}.`);
    }
    try {
      const etag = response.headers.get('ETag');
      const rawDiff = await response.text();
      if (!this.mounted) {
        return null;
      }
      const multiFilePatch = this.buildPatch(rawDiff);
      return new Promise(resolve => this.setState({
        multiFilePatch,
        error: null,
        last: {
          url,
          patch: multiFilePatch,
          etag
        }
      }, resolve));
    } catch (err) {
      return this.reportDiffError('Unable to parse the diff for this pull request.', err);
    }
  }
  reportDiffError(message, error) {
    if (!this.mounted) {
      return null;
    }
    return new Promise(resolve => {
      if (error) {
        // eslint-disable-next-line no-console
        console.error(error);
      }
      if (!this.mounted) {
        resolve();
        return;
      }
      this.setState({
        error: message
      }, resolve);
    });
  }
}
exports.default = PullRequestPatchContainer;
_defineProperty(PullRequestPatchContainer, "propTypes", {
  // Pull request properties
  owner: _propTypes.default.string.isRequired,
  repo: _propTypes.default.string.isRequired,
  number: _propTypes.default.number.isRequired,
  // Connection properties
  endpoint: _propTypes2.EndpointPropType.isRequired,
  token: _propTypes.default.string.isRequired,
  // Fetching and parsing
  refetch: _propTypes.default.bool,
  largeDiffThreshold: _propTypes.default.number,
  // Render prop. Called with (error or null, multiFilePatch or null)
  children: _propTypes.default.func.isRequired
});
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJuYW1lcyI6WyJfcmVhY3QiLCJfaW50ZXJvcFJlcXVpcmVEZWZhdWx0IiwicmVxdWlyZSIsIl9wcm9wVHlwZXMiLCJfd2hhdFRoZURpZmYiLCJfaGVscGVycyIsIl9wcm9wVHlwZXMyIiwiX2ZpbHRlciIsIl9wYXRjaCIsIm9iaiIsIl9fZXNNb2R1bGUiLCJkZWZhdWx0Iiwib3duS2V5cyIsIm9iamVjdCIsImVudW1lcmFibGVPbmx5Iiwia2V5cyIsIk9iamVjdCIsImdldE93blByb3BlcnR5U3ltYm9scyIsInN5bWJvbHMiLCJmaWx0ZXIiLCJzeW0iLCJnZXRPd25Qcm9wZXJ0eURlc2NyaXB0b3IiLCJlbnVtZXJhYmxlIiwicHVzaCIsImFwcGx5IiwiX29iamVjdFNwcmVhZCIsInRhcmdldCIsImkiLCJhcmd1bWVudHMiLCJsZW5ndGgiLCJzb3VyY2UiLCJmb3JFYWNoIiwia2V5IiwiX2RlZmluZVByb3BlcnR5IiwiZ2V0T3duUHJvcGVydHlEZXNjcmlwdG9ycyIsImRlZmluZVByb3BlcnRpZXMiLCJkZWZpbmVQcm9wZXJ0eSIsInZhbHVlIiwiX3RvUHJvcGVydHlLZXkiLCJjb25maWd1cmFibGUiLCJ3cml0YWJsZSIsImFyZyIsIl90b1ByaW1pdGl2ZSIsIlN0cmluZyIsImlucHV0IiwiaGludCIsInByaW0iLCJTeW1ib2wiLCJ0b1ByaW1pdGl2ZSIsInVuZGVmaW5lZCIsInJlcyIsImNhbGwiLCJUeXBlRXJyb3IiLCJOdW1iZXIiLCJQdWxsUmVxdWVzdFBhdGNoQ29udGFpbmVyIiwiUmVhY3QiLCJDb21wb25lbnQiLCJjb25zdHJ1Y3RvciIsImFyZ3MiLCJtdWx0aUZpbGVQYXRjaCIsImVycm9yIiwibGFzdCIsInVybCIsInBhdGNoIiwiZXRhZyIsImNvbXBvbmVudERpZE1vdW50IiwibW91bnRlZCIsImZldGNoRGlmZiIsInN0YXRlIiwiY29tcG9uZW50RGlkVXBkYXRlIiwicHJldlByb3BzIiwiZXhwbGljaXRSZWZldGNoIiwicHJvcHMiLCJyZWZldGNoIiwicmVxdWVzdGVkVVJMQ2hhbmdlIiwiZ2V0RGlmZlVSTCIsInNldFN0YXRlIiwiY29tcG9uZW50V2lsbFVubW91bnQiLCJyZW5kZXIiLCJjaGlsZHJlbiIsImVuZHBvaW50IiwiZ2V0UmVzdFVSSSIsIm93bmVyIiwicmVwbyIsIm51bWJlciIsImJ1aWxkUGF0Y2giLCJyYXdEaWZmIiwiZmlsdGVyZWQiLCJyZW1vdmVkIiwiZmlsdGVyRGlmZiIsImRpZmZzIiwicGFyc2VEaWZmIiwibWFwIiwiZGlmZiIsIm5ld1BhdGgiLCJ0b05hdGl2ZVBhdGhTZXAiLCJyZXBsYWNlIiwib2xkUGF0aCIsIm9wdGlvbnMiLCJwcmVzZXJ2ZU9yaWdpbmFsIiwibGFyZ2VEaWZmVGhyZXNob2xkIiwibWZwIiwiYnVpbGRNdWx0aUZpbGVQYXRjaCIsInJlc3BvbnNlIiwiaGVhZGVycyIsIkFjY2VwdCIsIkF1dGhvcml6YXRpb24iLCJ0b2tlbiIsImZldGNoIiwiZXJyIiwicmVwb3J0RGlmZkVycm9yIiwibWVzc2FnZSIsInN0YXR1cyIsIlByb21pc2UiLCJyZXNvbHZlIiwib2siLCJzdGF0dXNUZXh0IiwiZ2V0IiwidGV4dCIsImNvbnNvbGUiLCJleHBvcnRzIiwiUHJvcFR5cGVzIiwic3RyaW5nIiwiaXNSZXF1aXJlZCIsIkVuZHBvaW50UHJvcFR5cGUiLCJib29sIiwiZnVuYyJdLCJzb3VyY2VzIjpbInByLXBhdGNoLWNvbnRhaW5lci5qcyJdLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgUmVhY3QgZnJvbSAncmVhY3QnO1xuaW1wb3J0IFByb3BUeXBlcyBmcm9tICdwcm9wLXR5cGVzJztcbmltcG9ydCB7cGFyc2UgYXMgcGFyc2VEaWZmfSBmcm9tICd3aGF0LXRoZS1kaWZmJztcblxuaW1wb3J0IHt0b05hdGl2ZVBhdGhTZXB9IGZyb20gJy4uL2hlbHBlcnMnO1xuaW1wb3J0IHtFbmRwb2ludFByb3BUeXBlfSBmcm9tICcuLi9wcm9wLXR5cGVzJztcbmltcG9ydCB7ZmlsdGVyIGFzIGZpbHRlckRpZmZ9IGZyb20gJy4uL21vZGVscy9wYXRjaC9maWx0ZXInO1xuaW1wb3J0IHtidWlsZE11bHRpRmlsZVBhdGNofSBmcm9tICcuLi9tb2RlbHMvcGF0Y2gnO1xuXG5leHBvcnQgZGVmYXVsdCBjbGFzcyBQdWxsUmVxdWVzdFBhdGNoQ29udGFpbmVyIGV4dGVuZHMgUmVhY3QuQ29tcG9uZW50IHtcbiAgc3RhdGljIHByb3BUeXBlcyA9IHtcbiAgICAvLyBQdWxsIHJlcXVlc3QgcHJvcGVydGllc1xuICAgIG93bmVyOiBQcm9wVHlwZXMuc3RyaW5nLmlzUmVxdWlyZWQsXG4gICAgcmVwbzogUHJvcFR5cGVzLnN0cmluZy5pc1JlcXVpcmVkLFxuICAgIG51bWJlcjogUHJvcFR5cGVzLm51bWJlci5pc1JlcXVpcmVkLFxuXG4gICAgLy8gQ29ubmVjdGlvbiBwcm9wZXJ0aWVzXG4gICAgZW5kcG9pbnQ6IEVuZHBvaW50UHJvcFR5cGUuaXNSZXF1aXJlZCxcbiAgICB0b2tlbjogUHJvcFR5cGVzLnN0cmluZy5pc1JlcXVpcmVkLFxuXG4gICAgLy8gRmV0Y2hpbmcgYW5kIHBhcnNpbmdcbiAgICByZWZldGNoOiBQcm9wVHlwZXMuYm9vbCxcbiAgICBsYXJnZURpZmZUaHJlc2hvbGQ6IFByb3BUeXBlcy5udW1iZXIsXG5cbiAgICAvLyBSZW5kZXIgcHJvcC4gQ2FsbGVkIHdpdGggKGVycm9yIG9yIG51bGwsIG11bHRpRmlsZVBhdGNoIG9yIG51bGwpXG4gICAgY2hpbGRyZW46IFByb3BUeXBlcy5mdW5jLmlzUmVxdWlyZWQsXG4gIH1cblxuICBzdGF0ZSA9IHtcbiAgICBtdWx0aUZpbGVQYXRjaDogbnVsbCxcbiAgICBlcnJvcjogbnVsbCxcbiAgICBsYXN0OiB7dXJsOiBudWxsLCBwYXRjaDogbnVsbCwgZXRhZzogbnVsbH0sXG4gIH1cblxuICBjb21wb25lbnREaWRNb3VudCgpIHtcbiAgICB0aGlzLm1vdW50ZWQgPSB0cnVlO1xuICAgIHRoaXMuZmV0Y2hEaWZmKHRoaXMuc3RhdGUubGFzdCk7XG4gIH1cblxuICBjb21wb25lbnREaWRVcGRhdGUocHJldlByb3BzKSB7XG4gICAgY29uc3QgZXhwbGljaXRSZWZldGNoID0gdGhpcy5wcm9wcy5yZWZldGNoICYmICFwcmV2UHJvcHMucmVmZXRjaDtcbiAgICBjb25zdCByZXF1ZXN0ZWRVUkxDaGFuZ2UgPSB0aGlzLnN0YXRlLmxhc3QudXJsICE9PSB0aGlzLmdldERpZmZVUkwoKTtcblxuICAgIGlmIChleHBsaWNpdFJlZmV0Y2ggfHwgcmVxdWVzdGVkVVJMQ2hhbmdlKSB7XG4gICAgICBjb25zdCB7bGFzdH0gPSB0aGlzLnN0YXRlO1xuICAgICAgdGhpcy5zZXRTdGF0ZSh7XG4gICAgICAgIG11bHRpRmlsZVBhdGNoOiBudWxsLFxuICAgICAgICBlcnJvcjogbnVsbCxcbiAgICAgICAgbGFzdDoge3VybDogdGhpcy5nZXREaWZmVVJMKCksIHBhdGNoOiBudWxsLCBldGFnOiBudWxsfSxcbiAgICAgIH0pO1xuICAgICAgdGhpcy5mZXRjaERpZmYobGFzdCk7XG4gICAgfVxuICB9XG5cbiAgY29tcG9uZW50V2lsbFVubW91bnQoKSB7XG4gICAgdGhpcy5tb3VudGVkID0gZmFsc2U7XG4gIH1cblxuICByZW5kZXIoKSB7XG4gICAgcmV0dXJuIHRoaXMucHJvcHMuY2hpbGRyZW4odGhpcy5zdGF0ZS5lcnJvciwgdGhpcy5zdGF0ZS5tdWx0aUZpbGVQYXRjaCk7XG4gIH1cblxuICAvLyBHZW5lcmF0ZSBhIHYzIEdpdEh1YiBBUEkgUkVTVCBVUkwgZm9yIHRoZSBwdWxsIHJlcXVlc3QgcmVzb3VyY2UuXG4gIC8vIEV4YW1wbGU6IGh0dHBzOi8vYXBpLmdpdGh1Yi5jb20vcmVwb3MvYXRvbS9naXRodWIvcHVsbHMvMTgyOVxuICBnZXREaWZmVVJMKCkge1xuICAgIHJldHVybiB0aGlzLnByb3BzLmVuZHBvaW50LmdldFJlc3RVUkkoJ3JlcG9zJywgdGhpcy5wcm9wcy5vd25lciwgdGhpcy5wcm9wcy5yZXBvLCAncHVsbHMnLCB0aGlzLnByb3BzLm51bWJlcik7XG4gIH1cblxuICBidWlsZFBhdGNoKHJhd0RpZmYpIHtcbiAgICBjb25zdCB7ZmlsdGVyZWQsIHJlbW92ZWR9ID0gZmlsdGVyRGlmZihyYXdEaWZmKTtcbiAgICBjb25zdCBkaWZmcyA9IHBhcnNlRGlmZihmaWx0ZXJlZCkubWFwKGRpZmYgPT4ge1xuICAgIC8vIGRpZmYgY29taW5nIGZyb20gQVBJIHdpbGwgaGF2ZSB0aGUgZGVmYXVsIGdpdCBkaWZmIHByZWZpeGVzIGEvIGFuZCBiLyBhbmQgdXNlICpuaXgtc3R5bGUgLyBwYXRoIHNlcGFyYXRvcnMuXG4gICAgLy8gZS5nLiBhL2Rpci9maWxlMS5qcyBhbmQgYi9kaXIvZmlsZTIuanNcbiAgICAvLyBzZWUgaHR0cHM6Ly9naXQtc2NtLmNvbS9kb2NzL2dpdC1kaWZmI19nZW5lcmF0aW5nX3BhdGNoZXNfd2l0aF9wXG4gICAgICByZXR1cm4ge1xuICAgICAgICAuLi5kaWZmLFxuICAgICAgICBuZXdQYXRoOiBkaWZmLm5ld1BhdGggPyB0b05hdGl2ZVBhdGhTZXAoZGlmZi5uZXdQYXRoLnJlcGxhY2UoL15bYXxiXVxcLy8sICcnKSkgOiBkaWZmLm5ld1BhdGgsXG4gICAgICAgIG9sZFBhdGg6IGRpZmYub2xkUGF0aCA/IHRvTmF0aXZlUGF0aFNlcChkaWZmLm9sZFBhdGgucmVwbGFjZSgvXlthfGJdXFwvLywgJycpKSA6IGRpZmYub2xkUGF0aCxcbiAgICAgIH07XG4gICAgfSk7XG4gICAgY29uc3Qgb3B0aW9ucyA9IHtcbiAgICAgIHByZXNlcnZlT3JpZ2luYWw6IHRydWUsXG4gICAgICByZW1vdmVkLFxuICAgIH07XG4gICAgaWYgKHRoaXMucHJvcHMubGFyZ2VEaWZmVGhyZXNob2xkKSB7XG4gICAgICBvcHRpb25zLmxhcmdlRGlmZlRocmVzaG9sZCA9IHRoaXMucHJvcHMubGFyZ2VEaWZmVGhyZXNob2xkO1xuICAgIH1cbiAgICBjb25zdCBtZnAgPSBidWlsZE11bHRpRmlsZVBhdGNoKGRpZmZzLCBvcHRpb25zKTtcbiAgICByZXR1cm4gbWZwO1xuICB9XG5cbiAgYXN5bmMgZmV0Y2hEaWZmKGxhc3QpIHtcbiAgICBjb25zdCB1cmwgPSB0aGlzLmdldERpZmZVUkwoKTtcbiAgICBsZXQgcmVzcG9uc2U7XG5cbiAgICB0cnkge1xuICAgICAgY29uc3QgaGVhZGVycyA9IHtcbiAgICAgICAgQWNjZXB0OiAnYXBwbGljYXRpb24vdm5kLmdpdGh1Yi52My5kaWZmJyxcbiAgICAgICAgQXV0aG9yaXphdGlvbjogYGJlYXJlciAke3RoaXMucHJvcHMudG9rZW59YCxcbiAgICAgIH07XG5cbiAgICAgIGlmICh1cmwgPT09IGxhc3QudXJsICYmIGxhc3QuZXRhZyAhPT0gbnVsbCkge1xuICAgICAgICBoZWFkZXJzWydJZi1Ob25lLU1hdGNoJ10gPSBsYXN0LmV0YWc7XG4gICAgICB9XG5cbiAgICAgIHJlc3BvbnNlID0gYXdhaXQgZmV0Y2godXJsLCB7aGVhZGVyc30pO1xuICAgIH0gY2F0Y2ggKGVycikge1xuICAgICAgcmV0dXJuIHRoaXMucmVwb3J0RGlmZkVycm9yKGBOZXR3b3JrIGVycm9yIGVuY291bnRlcmVkIGZldGNoaW5nIHRoZSBwYXRjaDogJHtlcnIubWVzc2FnZX0uYCwgZXJyKTtcbiAgICB9XG5cbiAgICBpZiAocmVzcG9uc2Uuc3RhdHVzID09PSAzMDQpIHtcbiAgICAgIC8vIE5vdCBtb2RpZmllZC5cbiAgICAgIGlmICghdGhpcy5tb3VudGVkKSB7XG4gICAgICAgIHJldHVybiBudWxsO1xuICAgICAgfVxuXG4gICAgICByZXR1cm4gbmV3IFByb21pc2UocmVzb2x2ZSA9PiB0aGlzLnNldFN0YXRlKHtcbiAgICAgICAgbXVsdGlGaWxlUGF0Y2g6IGxhc3QucGF0Y2gsXG4gICAgICAgIGVycm9yOiBudWxsLFxuICAgICAgICBsYXN0LFxuICAgICAgfSkpO1xuICAgIH1cblxuICAgIGlmICghcmVzcG9uc2Uub2spIHtcbiAgICAgIHJldHVybiB0aGlzLnJlcG9ydERpZmZFcnJvcihgVW5hYmxlIHRvIGZldGNoIHRoZSBkaWZmIGZvciB0aGlzIHB1bGwgcmVxdWVzdDogJHtyZXNwb25zZS5zdGF0dXNUZXh0fS5gKTtcbiAgICB9XG5cbiAgICB0cnkge1xuICAgICAgY29uc3QgZXRhZyA9IHJlc3BvbnNlLmhlYWRlcnMuZ2V0KCdFVGFnJyk7XG4gICAgICBjb25zdCByYXdEaWZmID0gYXdhaXQgcmVzcG9uc2UudGV4dCgpO1xuICAgICAgaWYgKCF0aGlzLm1vdW50ZWQpIHtcbiAgICAgICAgcmV0dXJuIG51bGw7XG4gICAgICB9XG5cbiAgICAgIGNvbnN0IG11bHRpRmlsZVBhdGNoID0gdGhpcy5idWlsZFBhdGNoKHJhd0RpZmYpO1xuICAgICAgcmV0dXJuIG5ldyBQcm9taXNlKHJlc29sdmUgPT4gdGhpcy5zZXRTdGF0ZSh7XG4gICAgICAgIG11bHRpRmlsZVBhdGNoLFxuICAgICAgICBlcnJvcjogbnVsbCxcbiAgICAgICAgbGFzdDoge3VybCwgcGF0Y2g6IG11bHRpRmlsZVBhdGNoLCBldGFnfSxcbiAgICAgIH0sIHJlc29sdmUpKTtcbiAgICB9IGNhdGNoIChlcnIpIHtcbiAgICAgIHJldHVybiB0aGlzLnJlcG9ydERpZmZFcnJvcignVW5hYmxlIHRvIHBhcnNlIHRoZSBkaWZmIGZvciB0aGlzIHB1bGwgcmVxdWVzdC4nLCBlcnIpO1xuICAgIH1cbiAgfVxuXG4gIHJlcG9ydERpZmZFcnJvcihtZXNzYWdlLCBlcnJvcikge1xuICAgIGlmICghdGhpcy5tb3VudGVkKSB7XG4gICAgICByZXR1cm4gbnVsbDtcbiAgICB9XG5cbiAgICByZXR1cm4gbmV3IFByb21pc2UocmVzb2x2ZSA9PiB7XG4gICAgICBpZiAoZXJyb3IpIHtcbiAgICAgICAgLy8gZXNsaW50LWRpc2FibGUtbmV4dC1saW5lIG5vLWNvbnNvbGVcbiAgICAgICAgY29uc29sZS5lcnJvcihlcnJvcik7XG4gICAgICB9XG5cbiAgICAgIGlmICghdGhpcy5tb3VudGVkKSB7XG4gICAgICAgIHJlc29sdmUoKTtcbiAgICAgICAgcmV0dXJuO1xuICAgICAgfVxuXG4gICAgICB0aGlzLnNldFN0YXRlKHtlcnJvcjogbWVz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