"use strict";

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.expectRelayQuery = expectRelayQuery;
exports.clearRelayExpectations = clearRelayExpectations;
exports.default = void 0;
var _util = _interopRequireDefault(require("util"));
var _relayRuntime = require("relay-runtime");
var _moment = _interopRequireDefault(require("moment"));
function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }
const LODASH_ISEQUAL = 'lodash.isequal';
let isEqual = null;
const relayEnvironmentPerURL = new Map();
const tokenPerURL = new Map();
const fetchPerURL = new Map();
const responsesByQuery = new Map();
function logRatelimitApi(headers) {
  const remaining = headers.get('x-ratelimit-remaining');
  const total = headers.get('x-ratelimit-limit');
  const resets = headers.get('x-ratelimit-reset');
  const resetsIn = _moment.default.unix(parseInt(resets, 10)).from();

  // eslint-disable-next-line no-console
  console.debug(`GitHub API Rate Limiting Info: ${remaining}/${total} requests left â€” resets ${resetsIn}`);
}
function expectRelayQuery(operationPattern, response) {
  let resolve, reject;
  const handler = typeof response === 'function' ? response : () => ({
    data: response
  });
  const promise = new Promise((resolve0, reject0) => {
    resolve = resolve0;
    reject = reject0;
  });
  const existing = responsesByQuery.get(operationPattern.name) || [];
  existing.push({
    promise,
    handler,
    variables: operationPattern.variables || {},
    trace: operationPattern.trace
  });
  responsesByQuery.set(operationPattern.name, existing);
  const disable = () => responsesByQuery.delete(operationPattern.name);
  return {
    promise,
    resolve,
    reject,
    disable
  };
}
function clearRelayExpectations() {
  responsesByQuery.clear();
  relayEnvironmentPerURL.clear();
  tokenPerURL.clear();
  fetchPerURL.clear();
  responsesByQuery.clear();
}
function createFetchQuery(url) {
  if (atom.inSpecMode()) {
    return function specFetchQuery(operation, variables, _cacheConfig, _uploadables) {
      const expectations = responsesByQuery.get(operation.name) || [];
      const match = expectations.find(expectation => {
        if (isEqual === null) {
          // Lazily require lodash.isequal so we can keep it as a dev dependency.
          // Require indirectly to trick electron-link into not following this.
          isEqual = require(LODASH_ISEQUAL);
        }
        return isEqual(expectation.variables, variables);
      });
      if (!match) {
        // eslint-disable-next-line no-console
        console.log(`GraphQL query ${operation.name} was:\n  ${operation.text.replace(/\n/g, '\n  ')}\n` + _util.default.inspect(variables));
        const e = new Error(`Unexpected GraphQL query: ${operation.name}`);
        e.rawStack = e.stack;
        throw e;
      }
      const responsePromise = match.promise.then(() => {
        return match.handler(operation);
      });
      if (match.trace) {
        // eslint-disable-next-line no-console
        console.log(`[Relay] query "${operation.name}":\n${operation.text}`);
        responsePromise.then(result => {
          // eslint-disable-next-line no-console
          console.log(`[Relay] response "${operation.name}":`, result);
        }, err => {
          // eslint-disable-next-line no-console
          console.error(`[Relay] error "${operation.name}":\n${err.stack || err}`);
          throw err;
        });
      }
      return responsePromise;
    };
  }
  return async function fetchQuery(operation, variables, _cacheConfig, _uploadables) {
    const currentToken = tokenPerURL.get(url);
    let response;
    try {
      response = await fetch(url, {
        method: 'POST',
        headers: {
          'content-type': 'application/json',
          'Authorization': `bearer ${currentToken}`,
          'Accept': 'application/vnd.github.antiope-preview+json'
        },
        body: JSON.stringify({
          query: operation.text,
          variables
        })
      });
    } catch (e) {
      // A network error was encountered. Mark it so that QueryErrorView and ErrorView can distinguish these, because
      // the errors from "fetch" are TypeErrors without much information.
      e.network = true;
      e.rawStack = e.stack;
      throw e;
    }
    try {
      atom && atom.inDevMode() && logRatelimitApi(response.headers);
    } catch (_e) {/* do nothing */}
    if (response.status !== 200) {
      const e = new Error(`GraphQL API endpoint at ${url} returned ${response.status}`);
      e.response = response;
      e.responseText = await response.text();
      e.rawStack = e.stack;
      throw e;
    }
    const payload = await response.json();
    if (payload && payload.errors && payload.errors.length > 0) {
      const e = new Error(`GraphQL API endpoint at ${url} returned an error for query ${operation.name}.`);
      e.response = response;
      e.errors = payload.errors;
      e.rawStack = e.stack;
      throw e;
    }
    return payload;
  };
}
class RelayNetworkLayerManager {
  static getEnvironmentForHost(endpoint, token) {
    const url = endpoint.getGraphQLRoot();
    let {
      environment,
      network
    } = relayEnvironmentPerURL.get(url) || {};
    tokenPerURL.set(url, token);
    if (!environment) {
      if (!token) {
        throw new Error(`You must authenticate to ${endpoint.getHost()} first.`);
      }
      const source = new _relayRuntime.RecordSource();
      const store = new _relayRuntime.Store(source);
      network = _relayRuntime.Network.create(this.getFetchQuery(endpoint, token));
      environment = new _relayRuntime.Environment({
        network,
        store
      });
      relayEnvironmentPerURL.set(url, {
        environment,
        network
      });
    }
    return environment;
  }
  static getFetchQuery(endpoint, token) {
    const url = endpoint.getGraphQLRoot();
    tokenPerURL.set(url, token);
    let fetch = fetchPerURL.get(url);
    if (!fetch) {
      fetch = createFetchQuery(url);
      fetchPerURL.set(fetch);
    }
    return fetch;
  }
}
exports.default = RelayNetworkLayerManager;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJuYW1lcyI6WyJMT0RBU0hfSVNFUVVBTCIsImlzRXF1YWwiLCJyZWxheUVudmlyb25tZW50UGVyVVJMIiwiTWFwIiwidG9rZW5QZXJVUkwiLCJmZXRjaFBlclVSTCIsInJlc3BvbnNlc0J5UXVlcnkiLCJsb2dSYXRlbGltaXRBcGkiLCJoZWFkZXJzIiwicmVtYWluaW5nIiwiZ2V0IiwidG90YWwiLCJyZXNldHMiLCJyZXNldHNJbiIsIm1vbWVudCIsInVuaXgiLCJwYXJzZUludCIsImZyb20iLCJjb25zb2xlIiwiZGVidWciLCJleHBlY3RSZWxheVF1ZXJ5Iiwib3BlcmF0aW9uUGF0dGVybiIsInJlc3BvbnNlIiwicmVzb2x2ZSIsInJlamVjdCIsImhhbmRsZXIiLCJkYXRhIiwicHJvbWlzZSIsIlByb21pc2UiLCJyZXNvbHZlMCIsInJlamVjdDAiLCJleGlzdGluZyIsIm5hbWUiLCJwdXNoIiwidmFyaWFibGVzIiwidHJhY2UiLCJzZXQiLCJkaXNhYmxlIiwiZGVsZXRlIiwiY2xlYXJSZWxheUV4cGVjdGF0aW9ucyIsImNsZWFyIiwiY3JlYXRlRmV0Y2hRdWVyeSIsInVybCIsImF0b20iLCJpblNwZWNNb2RlIiwic3BlY0ZldGNoUXVlcnkiLCJvcGVyYXRpb24iLCJfY2FjaGVDb25maWciLCJfdXBsb2FkYWJsZXMiLCJleHBlY3RhdGlvbnMiLCJtYXRjaCIsImZpbmQiLCJleHBlY3RhdGlvbiIsInJlcXVpcmUiLCJsb2ciLCJ0ZXh0IiwicmVwbGFjZSIsInV0aWwiLCJpbnNwZWN0IiwiZSIsIkVycm9yIiwicmF3U3RhY2siLCJzdGFjayIsInJlc3BvbnNlUHJvbWlzZSIsInRoZW4iLCJyZXN1bHQiLCJlcnIiLCJlcnJvciIsImZldGNoUXVlcnkiLCJjdXJyZW50VG9rZW4iLCJmZXRjaCIsIm1ldGhvZCIsImJvZHkiLCJKU09OIiwic3RyaW5naWZ5IiwicXVlcnkiLCJuZXR3b3JrIiwiaW5EZXZNb2RlIiwiX2UiLCJzdGF0dXMiLCJyZXNwb25zZVRleHQiLCJwYXlsb2FkIiwianNvbiIsImVycm9ycyIsImxlbmd0aCIsIlJlbGF5TmV0d29ya0xheWVyTWFuYWdlciIsImdldEVudmlyb25tZW50Rm9ySG9zdCIsImVuZHBvaW50IiwidG9rZW4iLCJnZXRHcmFwaFFMUm9vdCIsImVudmlyb25tZW50IiwiZ2V0SG9zdCIsInNvdXJjZSIsIlJlY29yZFNvdXJjZSIsInN0b3JlIiwiU3RvcmUiLCJOZXR3b3JrIiwiY3JlYXRlIiwiZ2V0RmV0Y2hRdWVyeSIsIkVudmlyb25tZW50Il0sInNvdXJjZXMiOlsicmVsYXktbmV0d29yay1sYXllci1tYW5hZ2VyLmpzIl0sInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB1dGlsIGZyb20gJ3V0aWwnO1xuaW1wb3J0IHtFbnZpcm9ubWVudCwgTmV0d29yaywgUmVjb3JkU291cmNlLCBTdG9yZX0gZnJvbSAncmVsYXktcnVudGltZSc7XG5pbXBvcnQgbW9tZW50IGZyb20gJ21vbWVudCc7XG5cbmNvbnN0IExPREFTSF9JU0VRVUFMID0gJ2xvZGFzaC5pc2VxdWFsJztcbmxldCBpc0VxdWFsID0gbnVsbDtcblxuY29uc3QgcmVsYXlFbnZpcm9ubWVudFBlclVSTCA9IG5ldyBNYXAoKTtcbmNvbnN0IHRva2VuUGVyVVJMID0gbmV3IE1hcCgpO1xuY29uc3QgZmV0Y2hQZXJVUkwgPSBuZXcgTWFwKCk7XG5cbmNvbnN0IHJlc3BvbnNlc0J5UXVlcnkgPSBuZXcgTWFwKCk7XG5cbmZ1bmN0aW9uIGxvZ1JhdGVsaW1pdEFwaShoZWFkZXJzKSB7XG4gIGNvbnN0IHJlbWFpbmluZyA9IGhlYWRlcnMuZ2V0KCd4LXJhdGVsaW1pdC1yZW1haW5pbmcnKTtcbiAgY29uc3QgdG90YWwgPSBoZWFkZXJzLmdldCgneC1yYXRlbGltaXQtbGltaXQnKTtcbiAgY29uc3QgcmVzZXRzID0gaGVhZGVycy5nZXQoJ3gtcmF0ZWxpbWl0LXJlc2V0Jyk7XG4gIGNvbnN0IHJlc2V0c0luID0gbW9tZW50LnVuaXgocGFyc2VJbnQocmVzZXRzLCAxMCkpLmZyb20oKTtcblxuICAvLyBlc2xpbnQtZGlzYWJsZS1uZXh0LWxpbmUgbm8tY29uc29sZVxuICBjb25zb2xlLmRlYnVnKGBHaXRIdWIgQVBJIFJhdGUgTGltaXRpbmcgSW5mbzogJHtyZW1haW5pbmd9LyR7dG90YWx9IHJlcXVlc3RzIGxlZnQg4oCUIHJlc2V0cyAke3Jlc2V0c0lufWApO1xufVxuXG5leHBvcnQgZnVuY3Rpb24gZXhwZWN0UmVsYXlRdWVyeShvcGVyYXRpb25QYXR0ZXJuLCByZXNwb25zZSkge1xuICBsZXQgcmVzb2x2ZSwgcmVqZWN0O1xuICBjb25zdCBoYW5kbGVyID0gdHlwZW9mIHJlc3BvbnNlID09PSAnZnVuY3Rpb24nID8gcmVzcG9uc2UgOiAoKSA9PiAoe2RhdGE6IHJlc3BvbnNlfSk7XG5cbiAgY29uc3QgcHJvbWlzZSA9IG5ldyBQcm9taXNlKChyZXNvbHZlMCwgcmVqZWN0MCkgPT4ge1xuICAgIHJlc29sdmUgPSByZXNvbHZlMDtcbiAgICByZWplY3QgPSByZWplY3QwO1xuICB9KTtcblxuICBjb25zdCBleGlzdGluZyA9IHJlc3BvbnNlc0J5UXVlcnkuZ2V0KG9wZXJhdGlvblBhdHRlcm4ubmFtZSkgfHwgW107XG4gIGV4aXN0aW5nLnB1c2goe1xuICAgIHByb21pc2UsXG4gICAgaGFuZGxlcixcbiAgICB2YXJpYWJsZXM6IG9wZXJhdGlvblBhdHRlcm4udmFyaWFibGVzIHx8IHt9LFxuICAgIHRyYWNlOiBvcGVyYXRpb25QYXR0ZXJuLnRyYWNlLFxuICB9KTtcbiAgcmVzcG9uc2VzQnlRdWVyeS5zZXQob3BlcmF0aW9uUGF0dGVybi5uYW1lLCBleGlzdGluZyk7XG5cbiAgY29uc3QgZGlzYWJsZSA9ICgpID0+IHJlc3BvbnNlc0J5UXVlcnkuZGVsZXRlKG9wZXJhdGlvblBhdHRlcm4ubmFtZSk7XG5cbiAgcmV0dXJuIHtwcm9taXNlLCByZXNvbHZlLCByZWplY3QsIGRpc2FibGV9O1xufVxuXG5leHBvcnQgZnVuY3Rpb24gY2xlYXJSZWxheUV4cGVjdGF0aW9ucygpIHtcbiAgcmVzcG9uc2VzQnlRdWVyeS5jbGVhcigpO1xuICByZWxheUVudmlyb25tZW50UGVyVVJMLmNsZWFyKCk7XG4gIHRva2VuUGVyVVJMLmNsZWFyKCk7XG4gIGZldGNoUGVyVVJMLmNsZWFyKCk7XG4gIHJlc3BvbnNlc0J5UXVlcnkuY2xlYXIoKTtcbn1cblxuZnVuY3Rpb24gY3JlYXRlRmV0Y2hRdWVyeSh1cmwpIHtcbiAgaWYgKGF0b20uaW5TcGVjTW9kZSgpKSB7XG4gICAgcmV0dXJuIGZ1bmN0aW9uIHNwZWNGZXRjaFF1ZXJ5KG9wZXJhdGlvbiwgdmFyaWFibGVzLCBfY2FjaGVDb25maWcsIF91cGxvYWRhYmxlcykge1xuICAgICAgY29uc3QgZXhwZWN0YXRpb25zID0gcmVzcG9uc2VzQnlRdWVyeS5nZXQob3BlcmF0aW9uLm5hbWUpIHx8IFtdO1xuICAgICAgY29uc3QgbWF0Y2ggPSBleHBlY3RhdGlvbnMuZmluZChleHBlY3RhdGlvbiA9PiB7XG4gICAgICAgIGlmIChpc0VxdWFsID09PSBudWxsKSB7XG4gICAgICAgICAgLy8gTGF6aWx5IHJlcXVpcmUgbG9kYXNoLmlzZXF1YWwgc28gd2UgY2FuIGtlZXAgaXQgYXMgYSBkZXYgZGVwZW5kZW5jeS5cbiAgICAgICAgICAvLyBSZXF1aXJlIGluZGlyZWN0bHkgdG8gdHJpY2sgZWxlY3Ryb24tbGluayBpbnRvIG5vdCBmb2xsb3dpbmcgdGhpcy5cbiAgICAgICAgICBpc0VxdWFsID0gcmVxdWlyZShMT0RBU0hfSVNFUVVBTCk7XG4gICAgICAgIH1cblxuICAgICAgICByZXR1cm4gaXNFcXVhbChleHBlY3RhdGlvbi52YXJpYWJsZXMsIHZhcmlhYmxlcyk7XG4gICAgICB9KTtcblxuICAgICAgaWYgKCFtYXRjaCkge1xuICAgICAgICAvLyBlc2xpbnQtZGlzYWJsZS1uZXh0LWxpbmUgbm8tY29uc29sZVxuICAgICAgICBjb25zb2xlLmxvZyhcbiAgICAgICAgICBgR3JhcGhRTCBxdWVyeSAke29wZXJhdGlvbi5uYW1lfSB3YXM6XFxuICAke29wZXJhdGlvbi50ZXh0LnJlcGxhY2UoL1xcbi9nLCAnXFxuICAnKX1cXG5gICtcbiAgICAgICAgICB1dGlsLmluc3BlY3QodmFyaWFibGVzKSxcbiAgICAgICAgKTtcblxuICAgICAgICBjb25zdCBlID0gbmV3IEVycm9yKGBVbmV4cGVjdGVkIEdyYXBoUUwgcXVlcnk6ICR7b3BlcmF0aW9uLm5hbWV9YCk7XG4gICAgICAgIGUucmF3U3RhY2sgPSBlLnN0YWNrO1xuICAgICAgICB0aHJvdyBlO1xuICAgICAgfVxuXG4gICAgICBjb25zdCByZXNwb25zZVByb21pc2UgPSBtYXRjaC5wcm9taXNlLnRoZW4oKCkgPT4ge1xuICAgICAgICByZXR1cm4gbWF0Y2guaGFuZGxlcihvcGVyYXRpb24pO1xuICAgICAgfSk7XG5cbiAgICAgIGlmIChtYXRjaC50cmFjZSkge1xuICAgICAgICAvLyBlc2xpbnQtZGlzYWJsZS1uZXh0LWxpbmUgbm8tY29uc29sZVxuICAgICAgICBjb25zb2xlLmxvZyhgW1JlbGF5XSBxdWVyeSBcIiR7b3BlcmF0aW9uLm5hbWV9XCI6XFxuJHtvcGVyYXRpb24udGV4dH1gKTtcbiAgICAgICAgcmVzcG9uc2VQcm9taXNlLnRoZW4ocmVzdWx0ID0+IHtcbiAgICAgICAgICAvLyBlc2xpbnQtZGlzYWJsZS1uZXh0LWxpbmUgbm8tY29uc29sZVxuICAgICAgICAgIGNvbnNvbGUubG9nKGBbUmVsYXldIHJlc3BvbnNlIFwiJHtvcGVyYXRpb24ubmFtZX1cIjpgLCByZXN1bHQpO1xuICAgICAgICB9LCBlcnIgPT4ge1xuICAgICAgICAgIC8vIGVzbGludC1kaXNhYmxlLW5leHQtbGluZSBuby1jb25zb2xlXG4gICAgICAgICAgY29uc29sZS5lcnJvcihgW1JlbGF5XSBlcnJvciBcIiR7b3BlcmF0aW9uLm5hbWV9XCI6XFxuJHtlcnIuc3RhY2sgfHwgZXJyfWApO1xuICAgICAgICAgIHRocm93IGVycjtcbiAgICAgICAgfSk7XG4gICAgICB9XG5cbiAgICAgIHJldHVybiByZXNwb25zZVByb21pc2U7XG4gICAgfTtcbiAgfVxuXG4gIHJldHVybiBhc3luYyBmdW5jdGlvbiBmZXRjaFF1ZXJ5KG9wZXJhdGlvbiwgdmFyaWFibGVzLCBfY2FjaGVDb25maWcsIF91cGxvYWRhYmxlcykge1xuICAgIGNvbnN0IGN1cnJlbnRUb2tlbiA9IHRva2VuUGVyVVJMLmdldCh1cmwpO1xuXG4gICAgbGV0IHJlc3BvbnNlO1xuICAgIHRyeSB7XG4gICAgICByZXNwb25zZSA9IGF3YWl0IGZldGNoKHVybCwge1xuICAgICAgICBtZXRob2Q6ICdQT1NUJyxcbiAgICAgICAgaGVhZGVyczoge1xuICAgICAgICAgICdjb250ZW50LXR5cGUnOiAnYXBwbGljYXRpb24vanNvbicsXG4gICAgICAgICAgJ0F1dGhvcml6YXRpb24nOiBgYmVhcmVyICR7Y3VycmVudFRva2VufWAsXG4gICAgICAgICAgJ0FjY2VwdCc6ICdhcHBsaWNhdGlvbi92bmQuZ2l0aHViLmFudGlvcGUtcHJldmlldytqc29uJyxcbiAgICAgICAgfSxcbiAgICAgICAgYm9keTogSlNPTi5zdHJpbmdpZnkoe1xuICAgICAgICAgIHF1ZXJ5OiBvcGVyYXRpb24udGV4dCxcbiAgICAgICAgICB2YXJpYWJsZXMsXG4gICAgICAgIH0pLFxuICAgICAgfSk7XG4gICAgfSBjYXRjaCAoZSkge1xuICAgICAgLy8gQSBuZXR3b3JrIGVycm9yIHdhcyBlbmNvdW50ZXJlZC4gTWFyayBpdCBzbyB0aGF0IFF1ZXJ5RXJyb3JWaWV3IGFuZCBFcnJvclZpZXcgY2FuIGRpc3Rpbmd1aXNoIHRoZXNlLCBiZWNhdXNlXG4gICAgICAvLyB0aGUgZXJyb3JzIGZyb20gXCJmZXRjaFwiIGFyZSBUeXBlRXJyb3JzIHdpdGhvdXQgbXVjaCBpbmZvcm1hdGlvbi5cbiAgICAgIGUubmV0d29yayA9IHRydWU7XG4gICAgICBlLnJhd1N0YWNrID0gZS5zdGFjaztcbiAgICAgIHRocm93IGU7XG4gICAgfVxuXG4gICAgdHJ5IHtcbiAgICAgIGF0b20gJiYgYXRvbS5pbkRldk1vZGUoKSAmJiBsb2dSYXRlbGltaXRBcGkocmVzcG9uc2UuaGVhZGVycyk7XG4gICAgfSBjYXRjaCAoX2UpIHsgLyogZG8gbm90aGluZyAqLyB9XG5cbiAgICBpZiAocmVzcG9uc2Uuc3RhdHVzICE9PSAyMDApIHtcbiAgICAgIGNvbnN0IGUgPSBuZXcgRXJyb3IoYEdyYXBoUUwgQVBJIGVuZHBvaW50IGF0ICR7dXJsfSByZXR1cm5lZCAke3Jlc3BvbnNlLnN0YXR1c31gKTtcbiAgICAgIGUucmVzcG9uc2UgPSByZXNwb25zZTtcbiAgICAgIGUucmVzcG9uc2VUZXh0ID0gYXdhaXQgcmVzcG9uc2UudGV4dCgpO1xuICAgICAgZS5yYXdTdGFjayA9IGUuc3RhY2s7XG4gICAgICB0aHJvdyBlO1xuICAgIH1cblxuICAgIGNvbnN0IHBheWxvYWQgPSBhd2FpdCByZXNwb25zZS5qc29uKCk7XG5cbiAgICBpZiAocGF5bG9hZCAmJiBwYXlsb2FkLmVycm9ycyAmJiBwYXlsb2FkLmVycm9ycy5sZW5ndGggPiAwKSB7XG4gICAgICBjb25zdCBlID0gbmV3IEVycm9yKGBHcmFwaFFMIEFQSSBlbmRwb2ludCBhdCAke3VybH0gcmV0dXJuZWQgYW4gZXJyb3IgZm9yIHF1ZXJ5ICR7b3BlcmF0aW9uLm5hbWV9LmApO1xuICAgICAgZS5yZXNwb25zZSA9IHJlc3BvbnNlO1xuICAgICAgZS5lcnJvcnMgPSBwYXlsb2FkLmVycm9ycztcbiAgICAgIGUucmF3U3RhY2sgPSBlLnN0YWNrO1xuICAgICAgdGhyb3cgZTtcbiAgICB9XG5cbiAgICByZXR1cm4gcGF5bG9hZDtcbiAgfTtcbn1cblxuZXhwb3J0IGRlZmF1bHQgY2xhc3MgUmVsYXlOZXR3b3JrTGF5ZXJNYW5hZ2VyIHtcbiAgc3RhdGljIGdldEVudmlyb25tZW50Rm9ySG9zdChlbmRwb2ludCwgdG9rZW4pIHtcbiAgICBjb25zdCB1cmwgPSBlbmRwb2ludC5nZXRHcmFwaFFMUm9vdCgpO1xuICAgIGxldCB7ZW52aXJvbm1lbnQsIG5ldHdvcmt9ID0gcmVsYXlFbnZpcm9ubWVudFBlclVSTC5nZXQodXJsKSB8fCB7fTtcbiAgICB0b2tlblBlclVSTC5zZXQodXJsLCB0b2tlbik7XG4gICAgaWYgKCFlbnZpcm9ubWVudCkge1xuICAgICAgaWYgKCF0b2tlbikge1xuICAgICAgICB0aHJvdyBuZXcgRXJyb3IoYFlvdSBtdXN0IGF1dGhlbnRpY2F0ZSB0byAke2VuZHBvaW50LmdldEhvc3QoKX0gZmlyc3QuYCk7XG4gICAgICB9XG5cbiAgICAgIGNvbnN0IHNvdXJjZSA9IG5ldyBSZWNvcmRTb3VyY2UoKTtcbiAgICAgIGNvbnN0IHN0b3JlID0gbmV3IFN0b3JlKHNvdXJjZSk7XG4gICAgICBuZXR3b3JrID0gTmV0d29yay5jcmVhdGUodGhpcy5nZXRGZXRjaFF1ZXJ5KGVuZHBvaW50LCB0b2tlbikpO1xuICAgICAgZW52aXJvbm1lbnQgPSBuZXcgRW52aXJvbm1lbnQoe25ldHdvcmssIHN0b3JlfSk7XG5cbiAgICAgIHJlbGF5RW52aXJvbm1lbnRQZXJVUkwuc2V0KHVybCwge2Vudmlyb25tZW50LCBuZXR3b3JrfSk7XG4gICAgfVxuICAgIHJldHVybiBlbnZpcm9ubWVudDtcbiAgfVxuXG4gIHN0YXRpYyBnZXRGZXRjaFF1ZXJ5KGVuZHBvaW50LCB0b2tlbikge1xuICAgIGNvbnN0IHVybCA9IGVuZHBvaW50LmdldEdyYXBoUUxSb290KCk7XG4gICAgdG9rZW5QZXJVUkwuc2V0KHVybCwgdG9rZW4pO1xuICAgIGxldCBmZXRjaCA9IGZldGNoUGVyVVJMLmdldCh1cmwpO1xuICAgIGlmICghZmV0Y2gpIHtcbiAgICAgIGZldGNoID0gY3JlYXRlRmV0Y2hRdWVyeSh1cmwpO1xuICAgICAgZmV0Y2hQZXJVUkwuc2V0KGZldGNoKTtcbiAgICB9XG4gICAgcmV0dXJuIGZldGNoO1xuICB9XG59XG4iXSwibWFwcGluZ3MiOiI7Ozs7Ozs7O0FBQUE7QUFDQTtBQUNBO0FBQTRCO0FBRTVCLE1BQU1BLGNBQWMsR0FBRyxnQkFBZ0I7QUFDdkMsSUFBSUMsT0FBTyxHQUFHLElBQUk7QUFFbEIsTUFBTUMsc0JBQXNCLEdBQUcsSUFBSUMsR0FBRyxFQUFFO0FBQ3hDLE1BQU1DLFdBQVcsR0FBRyxJQUFJRCxHQUFHLEVBQUU7QUFDN0IsTUFBTUUsV0FBVyxHQUFHLElBQUlGLEdBQUcsRUFBRTtBQUU3QixNQUFNRyxnQkFBZ0IsR0FBRyxJQUFJSCxHQUFHLEVBQUU7QUFFbEMsU0FBU0ksZUFBZSxDQUFDQyxPQUFPLEVBQUU7RUFDaEMsTUFBTUMsU0FBUyxHQUFHRCxPQUFPLENBQUNFLEdBQUcsQ0FBQyx1QkFBdUIsQ0FBQztFQUN0RCxNQUFNQyxLQUFLLEdBQUdILE9BQU8sQ0FBQ0UsR0FBRyxDQUFDLG1CQUFtQixDQUFDO0VBQzlDLE1BQU1FLE1BQU0sR0FBR0osT0FBTyxDQUFDRSxHQUFHLENBQUMsbUJBQW1CLENBQUM7RUFDL0MsTUFBTUcsUUFBUSxHQUFHQyxlQUFNLENBQUNDLElBQUksQ0FBQ0MsUUFBUSxDQUFDSixNQUFNLEVBQUUsRUFBRSxDQUFDLENBQUMsQ0FBQ0ssSUFBSSxFQUFFOztFQUV6RDtFQUNBQyxPQUFPLENBQUNDLEtBQUssQ0FBRSxrQ0FBaUNWLFNBQVUsSUFBR0UsS0FBTSwyQkFBMEJFLFFBQVMsRUFBQyxDQUFDO0FBQzFHO0FBRU8sU0FBU08sZ0JBQWdCLENBQUNDLGdCQUFnQixFQUFFQyxRQUFRLEVBQUU7RUFDM0QsSUFBSUMsT0FBTyxFQUFFQyxNQUFNO0VBQ25CLE1BQU1DLE9BQU8sR0FBRyxPQUFPSCxRQUFRLEtBQUssVUFBVSxHQUFHQSxRQUFRLEdBQUcsT0FBTztJQUFDSSxJQUFJLEVBQUVKO0VBQVEsQ0FBQyxDQUFDO0VBRXBGLE1BQU1LLE9BQU8sR0FBRyxJQUFJQyxPQUFPLENBQUMsQ0FBQ0MsUUFBUSxFQUFFQyxPQUFPLEtBQUs7SUFDakRQLE9BQU8sR0FBR00sUUFBUTtJQUNsQkwsTUFBTSxHQUFHTSxPQUFPO0VBQ2xCLENBQUMsQ0FBQztFQUVGLE1BQU1DLFFBQVEsR0FBR3pCLGdCQUFnQixDQUFDSSxHQUFHLENBQUNXLGdCQUFnQixDQUFDVyxJQUFJLENBQUMsSUFBSSxFQUFFO0VBQ2xFRCxRQUFRLENBQUNFLElBQUksQ0FBQztJQUNaTixPQUFPO0lBQ1BGLE9BQU87SUFDUFMsU0FBUyxFQUFFYixnQkFBZ0IsQ0FBQ2EsU0FBUyxJQUFJLENBQUMsQ0FBQztJQUMzQ0MsS0FBSyxFQUFFZCxnQkFBZ0IsQ0FBQ2M7RUFDMUIsQ0FBQyxDQUFDO0VBQ0Y3QixnQkFBZ0IsQ0FBQzhCLEdBQUcsQ0FBQ2YsZ0JBQWdCLENBQUNXLElBQUksRUFBRUQsUUFBUSxDQUFDO0VBRXJELE1BQU1NLE9BQU8sR0FBRyxNQUFNL0IsZ0JBQWdCLENBQUNnQyxNQUFNLENBQUNqQixnQkFBZ0IsQ0FBQ1csSUFBSSxDQUFDO0VBRXBFLE9BQU87SUFBQ0wsT0FBTztJQUFFSixPQUFPO0lBQUVDLE1BQU07SUFBRWE7RUFBTyxDQUFDO0FBQzVDO0FBRU8sU0FBU0Usc0JBQXNCLEdBQUc7RUFDdkNqQyxnQkFBZ0IsQ0FBQ2tDLEtBQUssRUFBRTtFQUN4QnRDLHNCQUFzQixDQUFDc0MsS0FBSyxFQUFFO0VBQzlCcEMsV0FBVyxDQUFDb0MsS0FBSyxFQUFFO0VBQ25CbkMsV0FBVyxDQUFDbUMsS0FBSyxFQUFFO0VBQ25CbEMsZ0JBQWdCLENBQUNrQyxLQUFLLEVBQUU7QUFDMUI7QUFFQSxTQUFTQyxnQkFBZ0IsQ0FBQ0MsR0FBRyxFQUFFO0VBQzdCLElBQUlDLElBQUksQ0FBQ0MsVUFBVSxFQUFFLEVBQUU7SUFDckIsT0FBTyxTQUFTQyxjQUFjLENBQUNDLFNBQVMsRUFBRVosU0FBUyxFQUFFYSxZQUFZLEVBQUVDLFlBQVksRUFBRTtNQUMvRSxNQUFNQyxZQUFZLEdBQUczQyxnQkFBZ0IsQ0FBQ0ksR0FBRyxDQUFDb0MsU0FBUyxDQUFDZCxJQUFJLENBQUMsSUFBSSxFQUFFO01BQy9ELE1BQU1rQixLQUFLLEdBQUdELFlBQVksQ0FBQ0UsSUFBSSxDQUFDQyxXQUFXLElBQUk7UUFDN0MsSUFBSW5ELE9BQU8sS0FBSyxJQUFJLEVBQUU7VUFDcEI7VUFDQTtVQUNBQSxPQUFPLEdBQUdvRCxPQUFPLENBQUNyRCxjQUFjLENBQUM7UUFDbkM7UUFFQSxPQUFPQyxPQUFPLENBQUNtRCxXQUFXLENBQUNsQixTQUFTLEVBQUVBLFNBQVMsQ0FBQztNQUNsRCxDQUFDLENBQUM7TUFFRixJQUFJLENBQUNnQixLQUFLLEVBQUU7UUFDVjtRQUNBaEMsT0FBTyxDQUFDb0MsR0FBRyxDQUNSLGlCQUFnQlIsU0FBUyxDQUFDZCxJQUFLLFlBQVdjLFNBQVMsQ0FBQ1MsSUFBSSxDQUFDQyxPQUFPLENBQUMsS0FBSyxFQUFFLE1BQU0sQ0FBRSxJQUFHLEdBQ3BGQyxhQUFJLENBQUNDLE9BQU8sQ0FBQ3hCLFNBQVMsQ0FBQyxDQUN4QjtRQUVELE1BQU15QixDQUFDLEdBQUcsSUFBSUMsS0FBSyxDQUFFLDZCQUE0QmQsU0FBUyxDQUFDZCxJQUFLLEVBQUMsQ0FBQztRQUNsRTJCLENBQUMsQ0FBQ0UsUUFBUSxHQUFHRixDQUFDLENBQUNHLEtBQUs7UUFDcEIsTUFBTUgsQ0FBQztNQUNUO01BRUEsTUFBTUksZUFBZSxHQUFHYixLQUFLLENBQUN2QixPQUFPLENBQUNxQyxJQUFJLENBQUMsTUFBTTtRQUMvQyxPQUFPZCxLQUFLLENBQUN6QixPQUFPLENBQUNxQixTQUFTLENBQUM7TUFDakMsQ0FBQyxDQUFDO01BRUYsSUFBSUksS0FBSyxDQUFDZixLQUFLLEVBQUU7UUFDZjtRQUNBakIsT0FBTyxDQUFDb0MsR0FBRyxDQUFFLGtCQUFpQlIsU0FBUyxDQUFDZCxJQUFLLE9BQU1jLFNBQVMsQ0FBQ1MsSUFBSyxFQUFDLENBQUM7UUFDcEVRLGVBQWUsQ0FBQ0MsSUFBSSxDQUFDQyxNQUFNLElBQUk7VUFDN0I7VUFDQS9DLE9BQU8sQ0FBQ29DLEdBQUcsQ0FBRSxxQkFBb0JSLFNBQVMsQ0FBQ2QsSUFBSyxJQUFHLEVBQUVpQyxNQUFNLENBQUM7UUFDOUQsQ0FBQyxFQUFFQyxHQUFHLElBQUk7VUFDUjtVQUNBaEQsT0FBTyxDQUFDaUQsS0FBSyxDQUFFLGtCQUFpQnJCLFNBQVMsQ0FBQ2QsSUFBSyxPQUFNa0MsR0FBRyxDQUFDSixLQUFLLElBQUlJLEdBQUksRUFBQyxDQUFDO1VBQ3hFLE1BQU1BLEdBQUc7UUFDWCxDQUFDLENBQUM7TUFDSjtNQUVBLE9BQU9ILGVBQWU7SUFDeEIsQ0FBQztFQUNIO0VBRUEsT0FBTyxlQUFlSyxVQUFVLENBQUN0QixTQUFTLEVBQUVaLFNBQVMsRUFBRWEsWUFBWSxFQUFFQyxZQUFZLEVBQUU7SUFDakYsTUFBTXFCLFlBQVksR0FBR2pFLFdBQVcsQ0FBQ00sR0FBRyxDQUFDZ0MsR0FBRyxDQUFDO0lBRXpDLElBQUlwQixRQUFRO0lBQ1osSUFBSTtNQUNGQSxRQUFRLEdBQUcsTUFBTWdELEtBQUssQ0FBQzVCLEdBQUcsRUFBRTtRQUMxQjZCLE1BQU0sRUFBRSxNQUFNO1FBQ2QvRCxPQUFPLEVBQUU7VUFDUCxjQUFjLEVBQUUsa0JBQWtCO1VBQ2xDLGVBQWUsRUFBRyxVQUFTNkQsWUFBYSxFQUFDO1VBQ3pDLFFBQVEsRUFBRTtRQUNaLENBQUM7UUFDREcsSUFBSSxFQUFFQyxJQUFJLENBQUNDLFNBQVMsQ0FBQztVQUNuQkMsS0FBSyxFQUFFN0IsU0FBUyxDQUFDUyxJQUFJO1VBQ3JCckI7UUFDRixDQUFDO01BQ0gsQ0FBQyxDQUFDO0lBQ0osQ0FBQyxDQUFDLE9BQU95QixDQUFDLEVBQUU7TUFDVjtNQUNBO01BQ0FBLENBQUMsQ0FBQ2lCLE9BQU8sR0FBRyxJQUFJO01BQ2hCakIsQ0FBQyxDQUFDRSxRQUFRLEdBQUdGLENBQUMsQ0FBQ0csS0FBSztNQUNwQixNQUFNSCxDQUFDO0lBQ1Q7SUFFQSxJQUFJO01BQ0ZoQixJQUFJLElBQUlBLElBQUksQ0FBQ2tDLFNBQVMsRUFBRSxJQUFJdEUsZUFBZSxDQUFDZSxRQUFRLENBQUNkLE9BQU8sQ0FBQztJQUMvRCxDQUFDLENBQUMsT0FBT3NFLEVBQUUsRUFBRSxDQUFFO0lBRWYsSUFBSXhELFFBQVEsQ0FBQ3lELE1BQU0sS0FBSyxHQUFHLEVBQUU7TUFDM0IsTUFBTXBCLENBQUMsR0FBRyxJQUFJQyxLQUFLLENBQUUsMkJBQTBCbEIsR0FBSSxhQUFZcEIsUUFBUSxDQUFDeUQsTUFBTyxFQUFDLENBQUM7TUFDakZwQixDQUFDLENBQUNyQyxRQUFRLEdBQUdBLFFBQVE7TUFDckJxQyxDQUFDLENBQUNxQixZQUFZLEdBQUcsTUFBTTFELFFBQVEsQ0FBQ2lDLElBQUksRUFBRTtNQUN0Q0ksQ0FBQyxDQUFDRSxRQUFRLEdBQUdGLENBQUMsQ0FBQ0csS0FBSztNQUNwQixNQUFNSCxDQUFDO0lBQ1Q7SUFFQSxNQUFNc0IsT0FBTyxHQUFHLE1BQU0zRCxRQUFRLENBQUM0RCxJQUFJLEVBQUU7SUFFckMsSUFBSUQsT0FBTyxJQUFJQSxPQUFPLENBQUNFLE1BQU0sSUFBSUYsT0FBTyxDQUFDRSxNQUFNLENBQUNDLE1BQU0sR0FBRyxDQUFDLEVBQUU7TUFDMUQsTUFBTXpCLENBQUMsR0FBRyxJQUFJQyxLQUFLLENBQUUsMkJBQTBCbEIsR0FBSSxnQ0FBK0JJLFNBQVMsQ0FBQ2QsSUFBSyxHQUFFLENBQUM7TUFDcEcyQixDQUFDLENBQUNyQyxRQUFRLEdBQUdBLFFBQVE7TUFDckJxQyxDQUFDLENBQUN3QixNQUFNLEdBQUdGLE9BQU8sQ0FBQ0UsTUFBTTtNQUN6QnhCLENBQUMsQ0FBQ0UsUUFBUSxHQUFHRixDQUFDLENBQUNHLEtBQUs7TUFDcEIsTUFBTUgsQ0FBQztJQUNUO0lBRUEsT0FBT3NCLE9BQU87RUFDaEIsQ0FBQztBQUNIO0FBRWUsTUFBTUksd0JBQXdCLENBQUM7RUFDNUMsT0FBT0MscUJBQXFCLENBQUNDLFFBQVEsRUFBRUMsS0FBSyxFQUFFO0lBQzVDLE1BQU05QyxHQUFHLEdBQUc2QyxRQUFRLENBQUNFLGNBQWMsRUFBRTtJQUNyQyxJQUFJO01BQUNDLFdBQVc7TUFBRWQ7SUFBTyxDQUFDLEdBQUcxRSxzQkFBc0IsQ0FBQ1EsR0FBRyxDQUFDZ0MsR0FBRyxDQUFDLElBQUksQ0FBQyxDQUFDO0lBQ2xFdEMsV0FBVyxDQUFDZ0MsR0FBRyxDQUFDTSxHQUFHLEVBQUU4QyxLQUFLLENBQUM7SUFDM0IsSUFBSSxDQUFDRSxXQUFXLEVBQUU7TUFDaEIsSUFBSSxDQUFDRixLQUFLLEVBQUU7UUFDVixNQUFNLElBQUk1QixLQUFLLENBQUUsNEJBQTJCMkIsUUFBUSxDQUFDSSxPQUFPLEVBQUcsU0FBUSxDQUFDO01BQzFFO01BRUEsTUFBTUMsTUFBTSxHQUFHLElBQUlDLDBCQUFZLEVBQUU7TUFDakMsTUFBTUMsS0FBSyxHQUFHLElBQUlDLG1CQUFLLENBQUNILE1BQU0sQ0FBQztNQUMvQmhCLE9BQU8sR0FBR29CLHFCQUFPLENBQUNDLE1BQU0sQ0FBQyxJQUFJLENBQUNDLGFBQWEsQ0FBQ1gsUUFBUSxFQUFFQyxLQUFLLENBQUMsQ0FBQztNQUM3REUsV0FBVyxHQUFHLElBQUlTLHlCQUFXLENBQUM7UUFBQ3ZCLE9BQU87UUFBRWtCO01BQUssQ0FBQyxDQUFDO01BRS9DNUYsc0JBQXNCLENBQUNrQyxHQUFHLENBQUNNLEdBQUcsRUFBRTtRQUFDZ0QsV0FBVztRQUFFZDtNQUFPLENBQUMsQ0FBQztJQUN6RDtJQUNBLE9BQU9jLFdBQVc7RUFDcEI7RUFFQSxPQUFPUSxhQUFhLENBQUNYLFFBQVEsRUFBRUMsS0FBSyxFQUFFO0lBQ3BDLE1BQU05QyxHQUFHLEdBQUc2QyxRQUFRLENBQUNFLGNBQWMsRUFBRTtJQUNyQ3JGLFdBQVcsQ0FBQ2dDLEdBQUcsQ0FBQ00sR0FBRyxFQUFFOEMsS0FBSyxDQUFDO0lBQzNCLElBQUlsQixLQUFLLEdBQUdqRSxXQUFXLENBQUNLLEdBQUcsQ0FBQ2dDLEdBQUcsQ0FBQztJQUNoQyxJQUFJLENBQUM0QixLQUFLLEVBQUU7TUFDVkEsS0FBSyxHQUFHN0IsZ0JBQWdCLENBQUNDLEdBQUcsQ0FBQztNQUM3QnJDLFdBQVcsQ0FBQytCLEdBQUcsQ0FBQ2tDLEtBQUssQ0FBQztJQUN4QjtJQUNBLE9BQU9BLEtBQUs7RUFDZDtBQUNGO0FBQUMifQ==