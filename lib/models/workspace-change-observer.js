"use strict";

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.default = exports.FOCUS = void 0;
var _path = _interopRequireDefault(require("path"));
var _eventKit = require("event-kit");
var _atom = require("atom");
var _eventLogger = _interopRequireDefault(require("./event-logger"));
var _helpers = require("../helpers");
function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }
const FOCUS = Symbol('focus');
exports.FOCUS = FOCUS;
class WorkspaceChangeObserver {
  constructor(window, workspace, repository) {
    (0, _helpers.autobind)(this, 'observeTextEditor');
    this.window = window;
    this.repository = repository;
    this.workspace = workspace;
    this.observedBuffers = new WeakSet();
    this.emitter = new _eventKit.Emitter();
    this.disposables = new _eventKit.CompositeDisposable();
    this.logger = new _eventLogger.default('workspace watcher');
    this.started = false;
  }
  async start() {
    const focusHandler = event => {
      if (this.repository) {
        this.logger.showFocusEvent();
        this.didChange([{
          special: FOCUS
        }]);
      }
    };
    this.window.addEventListener('focus', focusHandler);
    this.disposables.add(this.workspace.observeTextEditors(this.observeTextEditor), new _eventKit.Disposable(() => this.window.removeEventListener('focus', focusHandler)));
    await this.watchActiveRepositoryGitDirectory();
    this.started = true;
    return this;
  }
  async destroy() {
    this.started = false;
    this.observedBuffers = new WeakSet();
    this.emitter.dispose();
    this.disposables.dispose();
    await this.stopCurrentFileWatcher();
  }
  isStarted() {
    return this.started;
  }
  didChange(payload) {
    this.emitter.emit('did-change', payload);
  }
  didChangeWorkdirOrHead() {
    this.emitter.emit('did-change-workdir-or-head');
  }
  onDidChange(callback) {
    return this.emitter.on('did-change', callback);
  }
  onDidChangeWorkdirOrHead(callback) {
    return this.emitter.on('did-change-workdir-or-head', callback);
  }
  getRepository() {
    return this.repository;
  }
  async watchActiveRepositoryGitDirectory() {
    const repository = this.getRepository();
    const gitDirectoryPath = repository.getGitDirectoryPath();
    const basenamesOfInterest = ['config', 'index', 'HEAD', 'MERGE_HEAD'];
    const workdirOrHeadBasenames = ['config', 'index'];
    const eventPaths = event => {
      const ps = [event.path];
      if (event.oldPath) {
        ps.push(event.oldPath);
      }
      return ps;
    };
    const acceptEvent = event => {
      return eventPaths(event).some(eventPath => {
        return basenamesOfInterest.includes(_path.default.basename(eventPath)) || _path.default.dirname(eventPath).includes(_path.default.join('.git', 'refs'));
      });
    };
    const isWorkdirOrHeadEvent = event => {
      return eventPaths(event).some(eventPath => workdirOrHeadBasenames.includes(_path.default.basename(eventPath)));
    };
    this.currentFileWatcher = await (0, _atom.watchPath)(gitDirectoryPath, {}, events => {
      const filteredEvents = events.filter(acceptEvent);
      if (filteredEvents.length) {
        this.logger.showEvents(filteredEvents);
        this.didChange(filteredEvents);
        if (filteredEvents.some(isWorkdirOrHeadEvent)) {
          this.logger.showWorkdirOrHeadEvents();
          this.didChangeWorkdirOrHead();
        }
      }
    });
    this.currentFileWatcher.onDidError(error => {
      const workingDirectory = repository.getWorkingDirectoryPath();
      // eslint-disable-next-line no-console
      console.warn(`Error in WorkspaceChangeObserver in ${workingDirectory}:`, error);
      this.stopCurrentFileWatcher();
    });
    this.logger.showStarted(gitDirectoryPath, 'workspace emulated');
  }
  stopCurrentFileWatcher() {
    if (this.currentFileWatcher) {
      this.currentFileWatcher.dispose();
      this.currentFileWatcher = null;
      this.logger.showStopped();
    }
    return Promise.resolve();
  }
  activeRepositoryContainsPath(filePath) {
    const repository = this.getRepository();
    if (filePath && repository) {
      return filePath.indexOf(repository.getWorkingDirectoryPath()) !== -1;
    } else {
      return false;
    }
  }
  observeTextEditor(editor) {
    const buffer = editor.getBuffer();
    if (!this.observedBuffers.has(buffer)) {
      let lastPath = buffer.getPath();
      const didChange = () => {
        const currentPath = buffer.getPath();
        const events = currentPath === lastPath ? [{
          action: 'modified',
          path: currentPath
        }] : [{
          action: 'renamed',
          path: currentPath,
          oldPath: lastPath
        }];
        lastPath = currentPath;
        this.logger.showEvents(events);
        this.didChange(events);
      };
      this.observedBuffers.add(buffer);
      const disposables = new _eventKit.CompositeDisposable(buffer.onDidSave(() => {
        if (this.activeRepositoryContainsPath(buffer.getPath())) {
          didChange();
        }
      }), buffer.onDidReload(() => {
        if (this.activeRepositoryContainsPath(buffer.getPath())) {
          didChange();
        }
      }), buffer.onDidDestroy(() => {
        if (this.activeRepositoryContainsPath(buffer.getPath())) {
          didChange();
        }
        disposables.dispose();
      }));
      this.disposables.add(disposables);
    }
  }
}
exports.default = WorkspaceChangeObserver;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJuYW1lcyI6WyJGT0NVUyIsIlN5bWJvbCIsIldvcmtzcGFjZUNoYW5nZU9ic2VydmVyIiwiY29uc3RydWN0b3IiLCJ3aW5kb3ciLCJ3b3Jrc3BhY2UiLCJyZXBvc2l0b3J5IiwiYXV0b2JpbmQiLCJvYnNlcnZlZEJ1ZmZlcnMiLCJXZWFrU2V0IiwiZW1pdHRlciIsIkVtaXR0ZXIiLCJkaXNwb3NhYmxlcyIsIkNvbXBvc2l0ZURpc3Bvc2FibGUiLCJsb2dnZXIiLCJFdmVudExvZ2dlciIsInN0YXJ0ZWQiLCJzdGFydCIsImZvY3VzSGFuZGxlciIsImV2ZW50Iiwic2hvd0ZvY3VzRXZlbnQiLCJkaWRDaGFuZ2UiLCJzcGVjaWFsIiwiYWRkRXZlbnRMaXN0ZW5lciIsImFkZCIsIm9ic2VydmVUZXh0RWRpdG9ycyIsIm9ic2VydmVUZXh0RWRpdG9yIiwiRGlzcG9zYWJsZSIsInJlbW92ZUV2ZW50TGlzdGVuZXIiLCJ3YXRjaEFjdGl2ZVJlcG9zaXRvcnlHaXREaXJlY3RvcnkiLCJkZXN0cm95IiwiZGlzcG9zZSIsInN0b3BDdXJyZW50RmlsZVdhdGNoZXIiLCJpc1N0YXJ0ZWQiLCJwYXlsb2FkIiwiZW1pdCIsImRpZENoYW5nZVdvcmtkaXJPckhlYWQiLCJvbkRpZENoYW5nZSIsImNhbGxiYWNrIiwib24iLCJvbkRpZENoYW5nZVdvcmtkaXJPckhlYWQiLCJnZXRSZXBvc2l0b3J5IiwiZ2l0RGlyZWN0b3J5UGF0aCIsImdldEdpdERpcmVjdG9yeVBhdGgiLCJiYXNlbmFtZXNPZkludGVyZXN0Iiwid29ya2Rpck9ySGVhZEJhc2VuYW1lcyIsImV2ZW50UGF0aHMiLCJwcyIsInBhdGgiLCJvbGRQYXRoIiwicHVzaCIsImFjY2VwdEV2ZW50Iiwic29tZSIsImV2ZW50UGF0aCIsImluY2x1ZGVzIiwiYmFzZW5hbWUiLCJkaXJuYW1lIiwiam9pbiIsImlzV29ya2Rpck9ySGVhZEV2ZW50IiwiY3VycmVudEZpbGVXYXRjaGVyIiwid2F0Y2hQYXRoIiwiZXZlbnRzIiwiZmlsdGVyZWRFdmVudHMiLCJmaWx0ZXIiLCJsZW5ndGgiLCJzaG93RXZlbnRzIiwic2hvd1dvcmtkaXJPckhlYWRFdmVudHMiLCJvbkRpZEVycm9yIiwiZXJyb3IiLCJ3b3JraW5nRGlyZWN0b3J5IiwiZ2V0V29ya2luZ0RpcmVjdG9yeVBhdGgiLCJjb25zb2xlIiwid2FybiIsInNob3dTdGFydGVkIiwic2hvd1N0b3BwZWQiLCJQcm9taXNlIiwicmVzb2x2ZSIsImFjdGl2ZVJlcG9zaXRvcnlDb250YWluc1BhdGgiLCJmaWxlUGF0aCIsImluZGV4T2YiLCJlZGl0b3IiLCJidWZmZXIiLCJnZXRCdWZmZXIiLCJoYXMiLCJsYXN0UGF0aCIsImdldFBhdGgiLCJjdXJyZW50UGF0aCIsImFjdGlvbiIsIm9uRGlkU2F2ZSIsIm9uRGlkUmVsb2FkIiwib25EaWREZXN0cm95Il0sInNvdXJjZXMiOlsid29ya3NwYWNlLWNoYW5nZS1vYnNlcnZlci5qcyJdLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgcGF0aCBmcm9tICdwYXRoJztcbmltcG9ydCB7Q29tcG9zaXRlRGlzcG9zYWJsZSwgRGlzcG9zYWJsZSwgRW1pdHRlcn0gZnJvbSAnZXZlbnQta2l0JztcbmltcG9ydCB7d2F0Y2hQYXRofSBmcm9tICdhdG9tJztcblxuaW1wb3J0IEV2ZW50TG9nZ2VyIGZyb20gJy4vZXZlbnQtbG9nZ2VyJztcbmltcG9ydCB7YXV0b2JpbmR9IGZyb20gJy4uL2hlbHBlcnMnO1xuXG5leHBvcnQgY29uc3QgRk9DVVMgPSBTeW1ib2woJ2ZvY3VzJyk7XG5cbmV4cG9ydCBkZWZhdWx0IGNsYXNzIFdvcmtzcGFjZUNoYW5nZU9ic2VydmVyIHtcbiAgY29uc3RydWN0b3Iod2luZG93LCB3b3Jrc3BhY2UsIHJlcG9zaXRvcnkpIHtcbiAgICBhdXRvYmluZCh0aGlzLCAnb2JzZXJ2ZVRleHRFZGl0b3InKTtcblxuICAgIHRoaXMud2luZG93ID0gd2luZG93O1xuICAgIHRoaXMucmVwb3NpdG9yeSA9IHJlcG9zaXRvcnk7XG4gICAgdGhpcy53b3Jrc3BhY2UgPSB3b3Jrc3BhY2U7XG4gICAgdGhpcy5vYnNlcnZlZEJ1ZmZlcnMgPSBuZXcgV2Vha1NldCgpO1xuICAgIHRoaXMuZW1pdHRlciA9IG5ldyBFbWl0dGVyKCk7XG4gICAgdGhpcy5kaXNwb3NhYmxlcyA9IG5ldyBDb21wb3NpdGVEaXNwb3NhYmxlKCk7XG4gICAgdGhpcy5sb2dnZXIgPSBuZXcgRXZlbnRMb2dnZXIoJ3dvcmtzcGFjZSB3YXRjaGVyJyk7XG4gICAgdGhpcy5zdGFydGVkID0gZmFsc2U7XG4gIH1cblxuICBhc3luYyBzdGFydCgpIHtcbiAgICBjb25zdCBmb2N1c0hhbmRsZXIgPSBldmVudCA9PiB7XG4gICAgICBpZiAodGhpcy5yZXBvc2l0b3J5KSB7XG4gICAgICAgIHRoaXMubG9nZ2VyLnNob3dGb2N1c0V2ZW50KCk7XG4gICAgICAgIHRoaXMuZGlkQ2hhbmdlKFt7c3BlY2lhbDogRk9DVVN9XSk7XG4gICAgICB9XG4gICAgfTtcbiAgICB0aGlzLndpbmRvdy5hZGRFdmVudExpc3RlbmVyKCdmb2N1cycsIGZvY3VzSGFuZGxlcik7XG4gICAgdGhpcy5kaXNwb3NhYmxlcy5hZGQoXG4gICAgICB0aGlzLndvcmtzcGFjZS5vYnNlcnZlVGV4dEVkaXRvcnModGhpcy5vYnNlcnZlVGV4dEVkaXRvciksXG4gICAgICBuZXcgRGlzcG9zYWJsZSgoKSA9PiB0aGlzLndpbmRvdy5yZW1vdmVFdmVudExpc3RlbmVyKCdmb2N1cycsIGZvY3VzSGFuZGxlcikpLFxuICAgICk7XG4gICAgYXdhaXQgdGhpcy53YXRjaEFjdGl2ZVJlcG9zaXRvcnlHaXREaXJlY3RvcnkoKTtcbiAgICB0aGlzLnN0YXJ0ZWQgPSB0cnVlO1xuICAgIHJldHVybiB0aGlzO1xuICB9XG5cbiAgYXN5bmMgZGVzdHJveSgpIHtcbiAgICB0aGlzLnN0YXJ0ZWQgPSBmYWxzZTtcbiAgICB0aGlzLm9ic2VydmVkQnVmZmVycyA9IG5ldyBXZWFrU2V0KCk7XG4gICAgdGhpcy5lbWl0dGVyLmRpc3Bvc2UoKTtcbiAgICB0aGlzLmRpc3Bvc2FibGVzLmRpc3Bvc2UoKTtcbiAgICBhd2FpdCB0aGlzLnN0b3BDdXJyZW50RmlsZVdhdGNoZXIoKTtcbiAgfVxuXG4gIGlzU3RhcnRlZCgpIHtcbiAgICByZXR1cm4gdGhpcy5zdGFydGVkO1xuICB9XG5cbiAgZGlkQ2hhbmdlKHBheWxvYWQpIHtcbiAgICB0aGlzLmVtaXR0ZXIuZW1pdCgnZGlkLWNoYW5nZScsIHBheWxvYWQpO1xuICB9XG5cbiAgZGlkQ2hhbmdlV29ya2Rpck9ySGVhZCgpIHtcbiAgICB0aGlzLmVtaXR0ZXIuZW1pdCgnZGlkLWNoYW5nZS13b3JrZGlyLW9yLWhlYWQnKTtcbiAgfVxuXG4gIG9uRGlkQ2hhbmdlKGNhbGxiYWNrKSB7XG4gICAgcmV0dXJuIHRoaXMuZW1pdHRlci5vbignZGlkLWNoYW5nZScsIGNhbGxiYWNrKTtcbiAgfVxuXG4gIG9uRGlkQ2hhbmdlV29ya2Rpck9ySGVhZChjYWxsYmFjaykge1xuICAgIHJldHVybiB0aGlzLmVtaXR0ZXIub24oJ2RpZC1jaGFuZ2Utd29ya2Rpci1vci1oZWFkJywgY2FsbGJhY2spO1xuICB9XG5cbiAgZ2V0UmVwb3NpdG9yeSgpIHtcbiAgICByZXR1cm4gdGhpcy5yZXBvc2l0b3J5O1xuICB9XG5cbiAgYXN5bmMgd2F0Y2hBY3RpdmVSZXBvc2l0b3J5R2l0RGlyZWN0b3J5KCkge1xuICAgIGNvbnN0IHJlcG9zaXRvcnkgPSB0aGlzLmdldFJlcG9zaXRvcnkoKTtcbiAgICBjb25zdCBnaXREaXJlY3RvcnlQYXRoID0gcmVwb3NpdG9yeS5nZXRHaXREaXJlY3RvcnlQYXRoKCk7XG5cbiAgICBjb25zdCBiYXNlbmFtZXNPZkludGVyZXN0ID0gWydjb25maWcnLCAnaW5kZXgnLCAnSEVBRCcsICdNRVJHRV9IRUFEJ107XG4gICAgY29uc3Qgd29ya2Rpck9ySGVhZEJhc2VuYW1lcyA9IFsnY29uZmlnJywgJ2luZGV4J107XG5cbiAgICBjb25zdCBldmVudFBhdGhzID0gZXZlbnQgPT4ge1xuICAgICAgY29uc3QgcHMgPSBbZXZlbnQucGF0aF07XG4gICAgICBpZiAoZXZlbnQub2xkUGF0aCkgeyBwcy5wdXNoKGV2ZW50Lm9sZFBhdGgpOyB9XG4gICAgICByZXR1cm4gcHM7XG4gICAgfTtcblxuICAgIGNvbnN0IGFjY2VwdEV2ZW50ID0gZXZlbnQgPT4ge1xuICAgICAgcmV0dXJuIGV2ZW50UGF0aHMoZXZlbnQpLnNvbWUoZXZlbnRQYXRoID0+IHtcbiAgICAgICAgcmV0dXJuIGJhc2VuYW1lc09mSW50ZXJlc3QuaW5jbHVkZXMocGF0aC5iYXNlbmFtZShldmVudFBhdGgpKSB8fFxuICAgICAgICAgIHBhdGguZGlybmFtZShldmVudFBhdGgpLmluY2x1ZGVzKHBhdGguam9pbignLmdpdCcsICdyZWZzJykpO1xuICAgICAgfSk7XG4gICAgfTtcblxuICAgIGNvbnN0IGlzV29ya2Rpck9ySGVhZEV2ZW50ID0gZXZlbnQgPT4ge1xuICAgICAgcmV0dXJuIGV2ZW50UGF0aHMoZXZlbnQpLnNvbWUoZXZlbnRQYXRoID0+IHdvcmtkaXJPckhlYWRCYXNlbmFtZXMuaW5jbHVkZXMocGF0aC5iYXNlbmFtZShldmVudFBhdGgpKSk7XG4gICAgfTtcblxuICAgIHRoaXMuY3VycmVudEZpbGVXYXRjaGVyID0gYXdhaXQgd2F0Y2hQYXRoKGdpdERpcmVjdG9yeVBhdGgsIHt9LCBldmVudHMgPT4ge1xuICAgICAgY29uc3QgZmlsdGVyZWRFdmVudHMgPSBldmVudHMuZmlsdGVyKGFjY2VwdEV2ZW50KTtcblxuICAgICAgaWYgKGZpbHRlcmVkRXZlbnRzLmxlbmd0aCkge1xuICAgICAgICB0aGlzLmxvZ2dlci5zaG93RXZlbnRzKGZpbHRlcmVkRXZlbnRzKTtcbiAgICAgICAgdGhpcy5kaWRDaGFuZ2UoZmlsdGVyZWRFdmVudHMpO1xuICAgICAgICBpZiAoZmlsdGVyZWRFdmVudHMuc29tZShpc1dvcmtkaXJPckhlYWRFdmVudCkpIHtcbiAgICAgICAgICB0aGlzLmxvZ2dlci5zaG93V29ya2Rpck9ySGVhZEV2ZW50cygpO1xuICAgICAgICAgIHRoaXMuZGlkQ2hhbmdlV29ya2Rpck9ySGVhZCgpO1xuICAgICAgICB9XG4gICAgICB9XG4gICAgfSk7XG5cbiAgICB0aGlzLmN1cnJlbnRGaWxlV2F0Y2hlci5vbkRpZEVycm9yKGVycm9yID0+IHtcbiAgICAgIGNvbnN0IHdvcmtpbmdEaXJlY3RvcnkgPSByZXBvc2l0b3J5LmdldFdvcmtpbmdEaXJlY3RvcnlQYXRoKCk7XG4gICAgICAvLyBlc2xpbnQtZGlzYWJsZS1uZXh0LWxpbmUgbm8tY29uc29sZVxuICAgICAgY29uc29sZS53YXJuKGBFcnJvciBpbiBXb3Jrc3BhY2VDaGFuZ2VPYnNlcnZlciBpbiAke3dvcmtpbmdEaXJlY3Rvcnl9OmAsIGVycm9yKTtcbiAgICAgIHRoaXMuc3RvcEN1cnJlbnRGaWxlV2F0Y2hlcigpO1xuICAgIH0pO1xuXG4gICAgdGhpcy5sb2dnZXIuc2hvd1N0YXJ0ZWQoZ2l0RGlyZWN0b3J5UGF0aCwgJ3dvcmtzcGFjZSBlbXVsYXRlZCcpO1xuICB9XG5cbiAgc3RvcEN1cnJlbnRGaWxlV2F0Y2hlcigpIHtcbiAgICBpZiAodGhpcy5jdXJyZW50RmlsZVdhdGNoZXIpIHtcbiAgICAgIHRoaXMuY3VycmVudEZpbGVXYXRjaGVyLmRpc3Bvc2UoKTtcbiAgICAgIHRoaXMuY3VycmVudEZpbGVXYXRjaGVyID0gbnVsbDtcbiAgICAgIHRoaXMubG9nZ2VyLnNob3dTdG9wcGVkKCk7XG4gICAgfVxuICAgIHJldHVybiBQcm9taXNlLnJlc29sdmUoKTtcbiAgfVxuXG4gIGFjdGl2ZVJlcG9zaXRvcnlDb250YWluc1BhdGgoZmlsZVBhdGgpIHtcbiAgICBjb25zdCByZXBvc2l0b3J5ID0gdGhpcy5nZXRSZXBvc2l0b3J5KCk7XG4gICAgaWYgKGZpbGVQYXRoICYmIHJlcG9zaXRvcnkpIHtcbiAgICAgIHJldHVybiBmaWxlUGF0aC5pbmRleE9mKHJlcG9zaXRvcnkuZ2V0V29ya2luZ0RpcmVjdG9yeVBhdGgoKSkgIT09IC0xO1xuICAgIH0gZWxzZSB7XG4gICAgICByZXR1cm4gZmFsc2U7XG4gICAgfVxuICB9XG5cbiAgb2JzZXJ2ZVRleHRFZGl0b3IoZWRpdG9yKSB7XG4gICAgY29uc3QgYnVmZmVyID0gZWRpdG9yLmdldEJ1ZmZlcigpO1xuICAgIGlmICghdGhpcy5vYnNlcnZlZEJ1ZmZlcnMuaGFzKGJ1ZmZlcikpIHtcbiAgICAgIGxldCBsYXN0UGF0aCA9IGJ1ZmZlci5nZXRQYXRoKCk7XG4gICAgICBjb25zdCBkaWRDaGFuZ2UgPSAoKSA9PiB7XG4gICAgICAgIGNvbnN0IGN1cnJlbnRQYXRoID0gYnVmZmVyLmdldFBhdGgoKTtcbiAgICAgICAgY29uc3QgZXZlbnRzID0gY3VycmVudFBhdGggPT09IGxhc3RQYXRoID9cbiAgICAgICAgICBbe2FjdGlvbjogJ21vZGlmaWVkJywgcGF0aDogY3VycmVudFBhdGh9XSA6XG4gICAgICAgICAgW3thY3Rpb246ICdyZW5hbWVkJywgcGF0aDogY3VycmVudFBhdGgsIG9sZFBhdGg6IGxhc3RQYXRofV07XG4gICAgICAgIGxhc3RQYXRoID0gY3VycmVudFBhdGg7XG4gICAgICAgIHRoaXMubG9nZ2VyLnNob3dFdmVudHMoZXZlbnRzKTtcbiAgICAgICAgdGhpcy5kaWRDaGFuZ2UoZXZlbnRzKTtcbiAgICAgIH07XG5cbiAgICAgIHRoaXMub2JzZXJ2ZWRCdWZmZXJzLmFkZChidWZmZXIpO1xuICAgICAgY29uc3QgZGlzcG9zYWJsZXMgPSBuZXcgQ29tcG9zaXRlRGlzcG9zYWJsZShcbiAgICAgICAgYnVmZmVyLm9uRGlkU2F2ZSgoKSA9PiB7XG4gICAgICAgICAgaWYgKHRoaXMuYWN0aXZlUmVwb3NpdG9yeUNvbnRhaW5zUGF0aChidWZmZXIuZ2V0UGF0aCgpKSkge1xuICAgICAgICAgICAgZGlkQ2hhbmdlKCk7XG4gICAgICAgICAgfVxuICAgICAgICB9KSxcbiAgICAgICAgYnVmZmVyLm9uRGlkUmVsb2FkKCgpID0+IHtcbiAgICAgICAgICBpZiAodGhpcy5hY3RpdmVSZXBvc2l0b3J5Q29udGFpbnNQYXRoKGJ1ZmZlci5nZXRQYXRoKCkpKSB7XG4gICAgICAgICAgICBkaWRDaGFuZ2UoKTtcbiAgICAgICAgICB9XG4gICAgICAgIH0pLFxuICAgICAgICBidWZmZXIub25EaWREZXN0cm95KCgpID0+IHtcbiAgICAgICAgICBpZiAodGhpcy5hY3RpdmVSZXBvc2l0b3J5Q29udGFpbnNQYXRoKGJ1ZmZlci5nZXRQYXRoKCkpKSB7XG4gICAgICAgICAgICBkaWRDaGFuZ2UoKTtcbiAgICAgICAgICB9XG4gICAgICAgICAgZGlzcG9zYWJsZXMuZGlzcG9zZSgpO1xuICAgICAgICB9KSxcbiAgICAgICk7XG4gICAgICB0aGlzLmRpc3Bvc2FibGVzLmFkZChkaXNwb3NhYmxlcyk7XG4gICAgfVxuICB9XG59XG4iXSwibWFwcGluZ3MiOiI7Ozs7OztBQUFBO0FBQ0E7QUFDQTtBQUVBO0FBQ0E7QUFBb0M7QUFFN0IsTUFBTUEsS0FBSyxHQUFHQyxNQUFNLENBQUMsT0FBTyxDQUFDO0FBQUM7QUFFdEIsTUFBTUMsdUJBQXVCLENBQUM7RUFDM0NDLFdBQVcsQ0FBQ0MsTUFBTSxFQUFFQyxTQUFTLEVBQUVDLFVBQVUsRUFBRTtJQUN6QyxJQUFBQyxpQkFBUSxFQUFDLElBQUksRUFBRSxtQkFBbUIsQ0FBQztJQUVuQyxJQUFJLENBQUNILE1BQU0sR0FBR0EsTUFBTTtJQUNwQixJQUFJLENBQUNFLFVBQVUsR0FBR0EsVUFBVTtJQUM1QixJQUFJLENBQUNELFNBQVMsR0FBR0EsU0FBUztJQUMxQixJQUFJLENBQUNHLGVBQWUsR0FBRyxJQUFJQyxPQUFPLEVBQUU7SUFDcEMsSUFBSSxDQUFDQyxPQUFPLEdBQUcsSUFBSUMsaUJBQU8sRUFBRTtJQUM1QixJQUFJLENBQUNDLFdBQVcsR0FBRyxJQUFJQyw2QkFBbUIsRUFBRTtJQUM1QyxJQUFJLENBQUNDLE1BQU0sR0FBRyxJQUFJQyxvQkFBVyxDQUFDLG1CQUFtQixDQUFDO0lBQ2xELElBQUksQ0FBQ0MsT0FBTyxHQUFHLEtBQUs7RUFDdEI7RUFFQSxNQUFNQyxLQUFLLEdBQUc7SUFDWixNQUFNQyxZ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