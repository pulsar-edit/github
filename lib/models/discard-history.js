"use strict";

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.default = void 0;
var _path = _interopRequireDefault(require("path"));
var _os = _interopRequireDefault(require("os"));
var _fsExtra = _interopRequireDefault(require("fs-extra"));
var _mkdirp = _interopRequireDefault(require("mkdirp"));
var _discardHistoryStores = require("./discard-history-stores");
var _helpers = require("../helpers");
function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }
function ownKeys(object, enumerableOnly) { var keys = Object.keys(object); if (Object.getOwnPropertySymbols) { var symbols = Object.getOwnPropertySymbols(object); enumerableOnly && (symbols = symbols.filter(function (sym) { return Object.getOwnPropertyDescriptor(object, sym).enumerable; })), keys.push.apply(keys, symbols); } return keys; }
function _objectSpread(target) { for (var i = 1; i < arguments.length; i++) { var source = null != arguments[i] ? arguments[i] : {}; i % 2 ? ownKeys(Object(source), !0).forEach(function (key) { _defineProperty(target, key, source[key]); }) : Object.getOwnPropertyDescriptors ? Object.defineProperties(target, Object.getOwnPropertyDescriptors(source)) : ownKeys(Object(source)).forEach(function (key) { Object.defineProperty(target, key, Object.getOwnPropertyDescriptor(source, key)); }); } return target; }
function _defineProperty(obj, key, value) { key = _toPropertyKey(key); if (key in obj) { Object.defineProperty(obj, key, { value: value, enumerable: true, configurable: true, writable: true }); } else { obj[key] = value; } return obj; }
function _toPropertyKey(arg) { var key = _toPrimitive(arg, "string"); return typeof key === "symbol" ? key : String(key); }
function _toPrimitive(input, hint) { if (typeof input !== "object" || input === null) return input; var prim = input[Symbol.toPrimitive]; if (prim !== undefined) { var res = prim.call(input, hint || "default"); if (typeof res !== "object") return res; throw new TypeError("@@toPrimitive must return a primitive value."); } return (hint === "string" ? String : Number)(input); }
const emptyFilePath = _path.default.join(_os.default.tmpdir(), 'empty-file.txt');
const emptyFilePromise = _fsExtra.default.writeFile(emptyFilePath, '');
class DiscardHistory {
  constructor(createBlob, expandBlobToFile, mergeFile, workdirPath, {
    maxHistoryLength
  } = {}) {
    this.createBlob = createBlob;
    this.expandBlobToFile = expandBlobToFile;
    this.mergeFile = mergeFile;
    this.workdirPath = workdirPath;
    this.partialFileHistory = new _discardHistoryStores.PartialFileDiscardHistory(maxHistoryLength);
    this.wholeFileHistory = new _discardHistoryStores.WholeFileDiscardHistory(maxHistoryLength);
  }
  getLastSnapshots(partialDiscardFilePath = null) {
    if (partialDiscardFilePath) {
      return this.partialFileHistory.getLastSnapshotsForPath(partialDiscardFilePath);
    } else {
      return this.wholeFileHistory.getLastSnapshots();
    }
  }
  getHistory(partialDiscardFilePath = null) {
    if (partialDiscardFilePath) {
      return this.partialFileHistory.getHistoryForPath(partialDiscardFilePath);
    } else {
      return this.wholeFileHistory.getHistory();
    }
  }
  hasHistory(partialDiscardFilePath = null) {
    const history = this.getHistory(partialDiscardFilePath);
    return history.length > 0;
  }
  popHistory(partialDiscardFilePath = null) {
    if (partialDiscardFilePath) {
      return this.partialFileHistory.popHistoryForPath(partialDiscardFilePath);
    } else {
      return this.wholeFileHistory.popHistory();
    }
  }
  clearHistory(partialDiscardFilePath = null) {
    if (partialDiscardFilePath) {
      this.partialFileHistory.clearHistoryForPath(partialDiscardFilePath);
    } else {
      this.wholeFileHistory.clearHistory();
    }
  }
  updateHistory(history) {
    this.partialFileHistory.setHistory(history.partialFileHistory || {});
    this.wholeFileHistory.setHistory(history.wholeFileHistory || []);
  }
  async createHistoryBlob() {
    const histories = {
      wholeFileHistory: this.wholeFileHistory.getHistory(),
      partialFileHistory: this.partialFileHistory.getHistory()
    };
    const historySha = await this.createBlob({
      stdin: JSON.stringify(histories)
    });
    return historySha;
  }
  async storeBeforeAndAfterBlobs(filePaths, isSafe, destructiveAction, partialDiscardFilePath = null) {
    if (partialDiscardFilePath) {
      return await this.storeBlobsForPartialFileHistory(partialDiscardFilePath, isSafe, destructiveAction);
    } else {
      return await this.storeBlobsForWholeFileHistory(filePaths, isSafe, destructiveAction);
    }
  }
  async storeBlobsForPartialFileHistory(filePath, isSafe, destructiveAction) {
    const beforeSha = await this.createBlob({
      filePath
    });
    const isNotSafe = !(await isSafe());
    if (isNotSafe) {
      return null;
    }
    await destructiveAction();
    const afterSha = await this.createBlob({
      filePath
    });
    const snapshots = {
      beforeSha,
      afterSha
    };
    this.partialFileHistory.addHistory(filePath, snapshots);
    return snapshots;
  }
  async storeBlobsForWholeFileHistory(filePaths, isSafe, destructiveAction) {
    const snapshotsByPath = {};
    const beforePromises = filePaths.map(async filePath => {
      snapshotsByPath[filePath] = {
        beforeSha: await this.createBlob({
          filePath
        })
      };
    });
    await Promise.all(beforePromises);
    const isNotSafe = !(await isSafe());
    if (isNotSafe) {
      return null;
    }
    await destructiveAction();
    const afterPromises = filePaths.map(async filePath => {
      snapshotsByPath[filePath].afterSha = await this.createBlob({
        filePath
      });
    });
    await Promise.all(afterPromises);
    this.wholeFileHistory.addHistory(snapshotsByPath);
    return snapshotsByPath;
  }
  async restoreLastDiscardInTempFiles(isSafe, partialDiscardFilePath = null) {
    let lastDiscardSnapshots = this.getLastSnapshots(partialDiscardFilePath);
    if (partialDiscardFilePath) {
      lastDiscardSnapshots = lastDiscardSnapshots ? [lastDiscardSnapshots] : [];
    }
    const tempFolderPaths = await this.expandBlobsToFilesInTempFolder(lastDiscardSnapshots);
    if (!isSafe()) {
      return [];
    }
    return await this.mergeFiles(tempFolderPaths);
  }
  async expandBlobsToFilesInTempFolder(snapshots) {
    const tempFolderPath = await (0, _helpers.getTempDir)({
      prefix: 'github-discard-history-'
    });
    const pathPromises = snapshots.map(async ({
      filePath,
      beforeSha,
      afterSha
    }) => {
      const dir = _path.default.dirname(_path.default.join(tempFolderPath, filePath));
      await (0, _mkdirp.default)(dir);
      const theirsPath = !beforeSha ? null : await this.expandBlobToFile(_path.default.join(tempFolderPath, `${filePath}-before-discard`), beforeSha);
      const commonBasePath = !afterSha ? null : await this.expandBlobToFile(_path.default.join(tempFolderPath, `${filePath}-after-discard`), afterSha);
      const resultPath = _path.default.join(dir, `~${_path.default.basename(filePath)}-merge-result`);
      return {
        filePath,
        commonBasePath,
        theirsPath,
        resultPath,
        theirsSha: beforeSha,
        commonBaseSha: afterSha
      };
    });
    return await Promise.all(pathPromises);
  }
  async mergeFiles(filePaths) {
    const mergeFilePromises = filePaths.map(async (filePathInfo, i) => {
      const {
        filePath,
        commonBasePath,
        theirsPath,
        resultPath,
        theirsSha,
        commonBaseSha
      } = filePathInfo;
      const currentSha = await this.createBlob({
        filePath
      });
      let mergeResult;
      if (theirsPath && commonBasePath) {
        mergeResult = await this.mergeFile(filePath, commonBasePath, theirsPath, resultPath);
      } else if (!theirsPath && commonBasePath) {
        // deleted file
        const oursSha = await this.createBlob({
          filePath
        });
        if (oursSha === commonBaseSha) {
          // no changes since discard, mark file to be deleted
          mergeResult = {
            filePath,
            resultPath: null,
            deleted: true,
            conflict: false
          };
        } else {
          // changes since discard result in conflict
          await _fsExtra.default.copy(_path.default.join(this.workdirPath, filePath), resultPath);
          mergeResult = {
            filePath,
            resultPath,
            conflict: true
          };
        }
      } else if (theirsPath && !commonBasePath) {
        // added file
        const fileDoesExist = await (0, _helpers.fileExists)(_path.default.join(this.workdirPath, filePath));
        if (!fileDoesExist) {
          await _fsExtra.default.copy(theirsPath, resultPath);
          mergeResult = {
            filePath,
            resultPath,
            conflict: false
          };
        } else {
          await emptyFilePromise;
          mergeResult = await this.mergeFile(filePath, emptyFilePath, theirsPath, resultPath);
        }
      } else {
        throw new Error('One of the following must be defined - theirsPath:' + `${theirsPath} or commonBasePath: ${commonBasePath}`);
      }
      return _objectSpread({}, mergeResult, {
        theirsSha,
        commonBaseSha,
        currentSha
      });
    });
    return await Promise.all(mergeFilePromises);
  }
}
exports.default = DiscardHistory;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJuYW1lcyI6WyJfcGF0aCIsIl9pbnRlcm9wUmVxdWlyZURlZmF1bHQiLCJyZXF1aXJlIiwiX29zIiwiX2ZzRXh0cmEiLCJfbWtkaXJwIiwiX2Rpc2NhcmRIaXN0b3J5U3RvcmVzIiwiX2hlbHBlcnMiLCJvYmoiLCJfX2VzTW9kdWxlIiwiZGVmYXVsdCIsIm93bktleXMiLCJvYmplY3QiLCJlbnVtZXJhYmxlT25seSIsImtleXMiLCJPYmplY3QiLCJnZXRPd25Qcm9wZXJ0eVN5bWJvbHMiLCJzeW1ib2xzIiwiZmlsdGVyIiwic3ltIiwiZ2V0T3duUHJvcGVydHlEZXNjcmlwdG9yIiwiZW51bWVyYWJsZSIsInB1c2giLCJhcHBseSIsIl9vYmplY3RTcHJlYWQiLCJ0YXJnZXQiLCJpIiwiYXJndW1lbnRzIiwibGVuZ3RoIiwic291cmNlIiwiZm9yRWFjaCIsImtleSIsIl9kZWZpbmVQcm9wZXJ0eSIsImdldE93blByb3BlcnR5RGVzY3JpcHRvcnMiLCJkZWZpbmVQcm9wZXJ0aWVzIiwiZGVmaW5lUHJvcGVydHkiLCJ2YWx1ZSIsIl90b1Byb3BlcnR5S2V5IiwiY29uZmlndXJhYmxlIiwid3JpdGFibGUiLCJhcmciLCJfdG9QcmltaXRpdmUiLCJTdHJpbmciLCJpbnB1dCIsImhpbnQiLCJwcmltIiwiU3ltYm9sIiwidG9QcmltaXRpdmUiLCJ1bmRlZmluZWQiLCJyZXMiLCJjYWxsIiwiVHlwZUVycm9yIiwiTnVtYmVyIiwiZW1wdHlGaWxlUGF0aCIsInBhdGgiLCJqb2luIiwib3MiLCJ0bXBkaXIiLCJlbXB0eUZpbGVQcm9taXNlIiwiZnMiLCJ3cml0ZUZpbGUiLCJEaXNjYXJkSGlzdG9yeSIsImNvbnN0cnVjdG9yIiwiY3JlYXRlQmxvYiIsImV4cGFuZEJsb2JUb0ZpbGUiLCJtZXJnZUZpbGUiLCJ3b3JrZGlyUGF0aCIsIm1heEhpc3RvcnlMZW5ndGgiLCJwYXJ0aWFsRmlsZUhpc3RvcnkiLCJQYXJ0aWFsRmlsZURpc2NhcmRIaXN0b3J5Iiwid2hvbGVGaWxlSGlzdG9yeSIsIldob2xlRmlsZURpc2NhcmRIaXN0b3J5IiwiZ2V0TGFzdFNuYXBzaG90cyIsInBhcnRpYWxEaXNjYXJkRmlsZVBhdGgiLCJnZXRMYXN0U25hcHNob3RzRm9yUGF0aCIsImdldEhpc3RvcnkiLCJnZXRIaXN0b3J5Rm9yUGF0aCIsImhhc0hpc3RvcnkiLCJoaXN0b3J5IiwicG9wSGlzdG9yeSIsInBvcEhpc3RvcnlGb3JQYXRoIiwiY2xlYXJIaXN0b3J5IiwiY2xlYXJIaXN0b3J5Rm9yUGF0aCIsInVwZGF0ZUhpc3RvcnkiLCJzZXRIaXN0b3J5IiwiY3JlYXRlSGlzdG9yeUJsb2IiLCJoaXN0b3JpZXMiLCJoaXN0b3J5U2hhIiwic3RkaW4iLCJKU09OIiwic3RyaW5naWZ5Iiwic3RvcmVCZWZvcmVBbmRBZnRlckJsb2JzIiwiZmlsZVBhdGhzIiwiaXNTYWZlIiwiZGVzdHJ1Y3RpdmVBY3Rpb24iLCJzdG9yZUJsb2JzRm9yUGFydGlhbEZpbGVIaXN0b3J5Iiwic3RvcmVCbG9ic0Zvcldob2xlRmlsZUhpc3RvcnkiLCJmaWxlUGF0aCIsImJlZm9yZVNoYSIsImlzTm90U2FmZSIsImFmdGVyU2hhIiwic25hcHNob3RzIiwiYWRkSGlzdG9yeSIsInNuYXBzaG90c0J5UGF0aCIsImJlZm9yZVByb21pc2VzIiwibWFwIiwiUHJvbWlzZSIsImFsbCIsImFmdGVyUHJvbWlzZXMiLCJyZXN0b3JlTGFzdERpc2NhcmRJblRlbXBGaWxlcyIsImxhc3REaXNjYXJkU25hcHNob3RzIiwidGVtcEZvbGRlclBhdGhzIiwiZXhwYW5kQmxvYnNUb0ZpbGVzSW5UZW1wRm9sZGVyIiwibWVyZ2VGaWxlcyIsInRlbXBGb2xkZXJQYXRoIiwiZ2V0VGVtcERpciIsInByZWZpeCIsInBhdGhQcm9taXNlcyIsImRpciIsImRpcm5hbWUiLCJta2RpcnAiLCJ0aGVpcnNQYXRoIiwiY29tbW9uQmFzZVBhdGgiLCJyZXN1bHRQYXRoIiwiYmFzZW5hbWUiLCJ0aGVpcnNTaGEiLCJjb21tb25CYXNlU2hhIiwibWVyZ2VGaWxlUHJvbWlzZXMiLCJmaWxlUGF0aEluZm8iLCJjdXJyZW50U2hhIiwibWVyZ2VSZXN1bHQiLCJvdXJzU2hhIiwiZGVsZXRlZCIsImNvbmZsaWN0IiwiY29weSIsImZpbGVEb2VzRXhpc3QiLCJmaWxlRXhpc3RzIiwiRXJyb3IiLCJleHBvcnRzIl0sInNvdXJjZXMiOlsiZGlzY2FyZC1oaXN0b3J5LmpzIl0sInNvdXJjZXNDb250ZW50IjpbImltcG9ydCBwYXRoIGZyb20gJ3BhdGgnO1xuaW1wb3J0IG9zIGZyb20gJ29zJztcbmltcG9ydCBmcyBmcm9tICdmcy1leHRyYSc7XG5cbmltcG9ydCBta2RpcnAgZnJvbSAnbWtkaXJwJztcblxuaW1wb3J0IHtQYXJ0aWFsRmlsZURpc2NhcmRIaXN0b3J5LCBXaG9sZUZpbGVEaXNjYXJkSGlzdG9yeX0gZnJvbSAnLi9kaXNjYXJkLWhpc3Rvcnktc3RvcmVzJztcblxuaW1wb3J0IHtnZXRUZW1wRGlyLCBmaWxlRXhpc3RzfSBmcm9tICcuLi9oZWxwZXJzJztcblxuY29uc3QgZW1wdHlGaWxlUGF0aCA9IHBhdGguam9pbihvcy50bXBkaXIoKSwgJ2VtcHR5LWZpbGUudHh0Jyk7XG5jb25zdCBlbXB0eUZpbGVQcm9taXNlID0gZnMud3JpdGVGaWxlKGVtcHR5RmlsZVBhdGgsICcnKTtcblxuZXhwb3J0IGRlZmF1bHQgY2xhc3MgRGlzY2FyZEhpc3Rvcnkge1xuICBjb25zdHJ1Y3RvcihjcmVhdGVCbG9iLCBleHBhbmRCbG9iVG9GaWxlLCBtZXJnZUZpbGUsIHdvcmtkaXJQYXRoLCB7bWF4SGlzdG9yeUxlbmd0aH0gPSB7fSkge1xuICAgIHRoaXMuY3JlYXRlQmxvYiA9IGNyZWF0ZUJsb2I7XG4gICAgdGhpcy5leHBhbmRCbG9iVG9GaWxlID0gZXhwYW5kQmxvYlRvRmlsZTtcbiAgICB0aGlzLm1lcmdlRmlsZSA9IG1lcmdlRmlsZTtcbiAgICB0aGlzLndvcmtkaXJQYXRoID0gd29ya2RpclBhdGg7XG4gICAgdGhpcy5wYXJ0aWFsRmlsZUhpc3RvcnkgPSBuZXcgUGFydGlhbEZpbGVEaXNjYXJkSGlzdG9yeShtYXhIaXN0b3J5TGVuZ3RoKTtcbiAgICB0aGlzLndob2xlRmlsZUhpc3RvcnkgPSBuZXcgV2hvbGVGaWxlRGlzY2FyZEhpc3RvcnkobWF4SGlzdG9yeUxlbmd0aCk7XG4gIH1cblxuICBnZXRMYXN0U25hcHNob3RzKHBhcnRpYWxEaXNjYXJkRmlsZVBhdGggPSBudWxsKSB7XG4gICAgaWYgKHBhcnRpYWxEaXNjYXJkRmlsZVBhdGgpIHtcbiAgICAgIHJldHVybiB0aGlzLnBhcnRpYWxGaWxlSGlzdG9yeS5nZXRMYXN0U25hcHNob3RzRm9yUGF0aChwYXJ0aWFsRGlzY2FyZEZpbGVQYXRoKTtcbiAgICB9IGVsc2Uge1xuICAgICAgcmV0dXJuIHRoaXMud2hvbGVGaWxlSGlzdG9yeS5nZXRMYXN0U25hcHNob3RzKCk7XG4gICAgfVxuICB9XG5cbiAgZ2V0SGlzdG9yeShwYXJ0aWFsRGlzY2FyZEZpbGVQYXRoID0gbnVsbCkge1xuICAgIGlmIChwYXJ0aWFsRGlzY2FyZEZpbGVQYXRoKSB7XG4gICAgICByZXR1cm4gdGhpcy5wYXJ0aWFsRmlsZUhpc3RvcnkuZ2V0SGlzdG9yeUZvclBhdGgocGFydGlhbERpc2NhcmRGaWxlUGF0aCk7XG4gICAgfSBlbHNlIHtcbiAgICAgIHJldHVybiB0aGlzLndob2xlRmlsZUhpc3RvcnkuZ2V0SGlzdG9yeSgpO1xuICAgIH1cbiAgfVxuXG4gIGhhc0hpc3RvcnkocGFydGlhbERpc2NhcmRGaWxlUGF0aCA9IG51bGwpIHtcbiAgICBjb25zdCBoaXN0b3J5ID0gdGhpcy5nZXRIaXN0b3J5KHBhcnRpYWxEaXNjYXJkRmlsZVBhdGgpO1xuICAgIHJldHVybiBoaXN0b3J5Lmxlbmd0aCA+IDA7XG4gIH1cblxuICBwb3BIaXN0b3J5KHBhcnRpYWxEaXNjYXJkRmlsZVBhdGggPSBudWxsKSB7XG4gICAgaWYgKHBhcnRpYWxEaXNjYXJkRmlsZVBhdGgpIHtcbiAgICAgIHJldHVybiB0aGlzLnBhcnRpYWxGaWxlSGlzdG9yeS5wb3BIaXN0b3J5Rm9yUGF0aChwYXJ0aWFsRGlzY2FyZEZpbGVQYXRoKTtcbiAgICB9IGVsc2Uge1xuICAgICAgcmV0dXJuIHRoaXMud2hvbGVGaWxlSGlzdG9yeS5wb3BIaXN0b3J5KCk7XG4gICAgfVxuICB9XG5cbiAgY2xlYXJIaXN0b3J5KHBhcnRpYWxEaXNjYXJkRmlsZVBhdGggPSBudWxsKSB7XG4gICAgaWYgKHBhcnRpYWxEaXNjYXJkRmlsZVBhdGgpIHtcbiAgICAgIHRoaXMucGFydGlhbEZpbGVIaXN0b3J5LmNsZWFySGlzdG9yeUZvclBhdGgocGFydGlhbERpc2NhcmRGaWxlUGF0aCk7XG4gICAgfSBlbHNlIHtcbiAgICAgIHRoaXMud2hvbGVGaWxlSGlzdG9yeS5jbGVhckhpc3RvcnkoKTtcbiAgICB9XG4gIH1cblxuICB1cGRhdGVIaXN0b3J5KGhpc3RvcnkpIHtcbiAgICB0aGlzLnBhcnRpYWxGaWxlSGlzdG9yeS5zZXRIaXN0b3J5KGhpc3RvcnkucGFydGlhbEZpbGVIaXN0b3J5IHx8IHt9KTtcbiAgICB0aGlzLndob2xlRmlsZUhpc3Rvcnkuc2V0SGlzdG9yeShoaXN0b3J5Lndob2xlRmlsZUhpc3RvcnkgfHwgW10pO1xuICB9XG5cbiAgYXN5bmMgY3JlYXRlSGlzdG9yeUJsb2IoKSB7XG4gICAgY29uc3QgaGlzdG9yaWVzID0ge1xuICAgICAgd2hvbGVGaWxlSGlzdG9yeTogdGhpcy53aG9sZUZpbGVIaXN0b3J5LmdldEhpc3RvcnkoKSxcbiAgICAgIHBhcnRpYWxGaWxlSGlzdG9yeTogdGhpcy5wYXJ0aWFsRmlsZUhpc3RvcnkuZ2V0SGlzdG9yeSgpLFxuICAgIH07XG4gICAgY29uc3QgaGlzdG9yeVNoYSA9IGF3YWl0IHRoaXMuY3JlYXRlQmxvYih7c3RkaW46IEpTT04uc3RyaW5naWZ5KGhpc3Rvcmllcyl9KTtcbiAgICByZXR1cm4gaGlzdG9yeVNoYTtcbiAgfVxuXG4gIGFzeW5jIHN0b3JlQmVmb3JlQW5kQWZ0ZXJCbG9icyhmaWxlUGF0aHMsIGlzU2FmZSwgZGVzdHJ1Y3RpdmVBY3Rpb24sIHBhcnRpYWxEaXNjYXJkRmlsZVBhdGggPSBudWxsKSB7XG4gICAgaWYgKHBhcnRpYWxEaXNjYXJkRmlsZVBhdGgpIHtcbiAgICAgIHJldHVybiBhd2FpdCB0aGlzLnN0b3JlQmxvYnNGb3JQYXJ0aWFsRmlsZUhpc3RvcnkocGFydGlhbERpc2NhcmRGaWxlUGF0aCwgaXNTYWZlLCBkZXN0cnVjdGl2ZUFjdGlvbik7XG4gICAgfSBlbHNlIHtcbiAgICAgIHJldHVybiBhd2FpdCB0aGlzLnN0b3JlQmxvYnNGb3JXaG9sZUZpbGVIaXN0b3J5KGZpbGVQYXRocywgaXNTYWZlLCBkZXN0cnVjdGl2ZUFjdGlvbik7XG4gICAgfVxuICB9XG5cbiAgYXN5bmMgc3RvcmVCbG9ic0ZvclBhcnRpYWxGaWxlSGlzdG9yeShmaWxlUGF0aCwgaXNTYWZlLCBkZXN0cnVjdGl2ZUFjdGlvbikge1xuICAgIGNvbnN0IGJlZm9yZVNoYSA9IGF3YWl0IHRoaXMuY3JlYXRlQmxvYih7ZmlsZVBhdGh9KTtcbiAgICBjb25zdCBpc05vdFNhZmUgPSAhKGF3YWl0IGlzU2FmZSgpKTtcbiAgICBpZiAoaXNOb3RTYWZlKSB7IHJldHVybiBudWxsOyB9XG4gICAgYXdhaXQgZGVzdHJ1Y3RpdmVBY3Rpb24oKTtcbiAgICBjb25zdCBhZnRlclNoYSA9IGF3YWl0IHRoaXMuY3JlYXRlQmxvYih7ZmlsZVBhdGh9KTtcbiAgICBjb25zdCBzbmFwc2hvdHMgPSB7YmVmb3JlU2hhLCBhZnRlclNoYX07XG4gICAgdGhpcy5wYXJ0aWFsRmlsZUhpc3RvcnkuYWRkSGlzdG9yeShmaWxlUGF0aCwgc25hcHNob3RzKTtcbiAgICByZXR1cm4gc25hcHNob3RzO1xuICB9XG5cbiAgYXN5bmMgc3RvcmVCbG9ic0Zvcldob2xlRmlsZUhpc3RvcnkoZmlsZVBhdGhzLCBpc1NhZmUsIGRlc3RydWN0aXZlQWN0aW9uKSB7XG4gICAgY29uc3Qgc25hcHNob3RzQnlQYXRoID0ge307XG4gICAgY29uc3QgYmVmb3JlUHJvbWlzZXMgPSBmaWxlUGF0aHMubWFwKGFzeW5jIGZpbGVQYXRoID0+IHtcbiAgICAgIHNuYXBzaG90c0J5UGF0aFtmaWxlUGF0aF0gPSB7YmVmb3JlU2hhOiBhd2FpdCB0aGlzLmNyZWF0ZUJsb2Ioe2ZpbGVQYXRofSl9O1xuICAgIH0pO1xuICAgIGF3YWl0IFByb21pc2UuYWxsKGJlZm9yZVByb21pc2VzKTtcbiAgICBjb25zdCBpc05vdFNhZmUgPSAhKGF3YWl0IGlzU2FmZSgpKTtcbiAgICBpZiAoaXNOb3RTYWZlKSB7IHJldHVybiBudWxsOyB9XG4gICAgYXdhaXQgZGVzdHJ1Y3RpdmVBY3Rpb24oKTtcbiAgICBjb25zdCBhZnRlclByb21pc2VzID0gZmlsZVBhdGhzLm1hcChhc3luYyBmaWxlUGF0aCA9PiB7XG4gICAgICBzbmFwc2hvdHNCeVBhdGhbZmlsZVBhdGhdLmFmdGVyU2hhID0gYXdhaXQgdGhpcy5jcmVhdGVCbG9iKHtmaWxlUGF0aH0pO1xuICAgIH0pO1xuICAgIGF3YWl0IFByb21pc2UuYWxsKGFmdGVyUHJvbWlzZXMpO1xuICAgIHRoaXMud2hvbGVGaWxlSGlzdG9yeS5hZGRIaXN0b3J5KHNuYXBzaG90c0J5UGF0aCk7XG4gICAgcmV0dXJuIHNuYXBzaG90c0J5UGF0aDtcbiAgfVxuXG4gIGFzeW5jIHJlc3RvcmVMYXN0RGlzY2FyZEluVGVtcEZpbGVzKGlzU2FmZSwgcGFydGlhbERpc2NhcmRGaWxlUGF0aCA9IG51bGwpIHtcbiAgICBsZXQgbGFzdERpc2NhcmRTbmFwc2hvdHMgPSB0aGlzLmdldExhc3RTbmFwc2hvdHMocGFydGlhbERpc2NhcmRGaWxlUGF0aCk7XG4gICAgaWYgKHBhcnRpYWxEaXNjYXJkRmlsZVBhdGgpIHtcbiAgICAgIGxhc3REaXNjYXJkU25hcHNob3RzID0gbGFzdERpc2NhcmRTbmFwc2hvdHMgPyBbbGFzdERpc2NhcmRTbmFwc2hvdHNdIDogW107XG4gICAgfVxuICAgIGNvbnN0IHRlbXBGb2xkZXJQYXRocyA9IGF3YWl0IHRoaXMuZXhwYW5kQmxvYnNUb0ZpbGVzSW5UZW1wRm9sZGVyKGxhc3REaXNjYXJkU25hcHNob3RzKTtcbiAgICBpZiAoIWlzU2FmZSgpKSB7IHJldHVybiBbXTsgfVxuICAgIHJldHVybiBhd2FpdCB0aGlzLm1lcmdlRmlsZXModGVtcEZvbGRlclBhdGhzKTtcbiAgfVxuXG4gIGFzeW5jIGV4cGFuZEJsb2JzVG9GaWxlc0luVGVtcEZvbGRlcihzbmFwc2hvdHMpIHtcbiAgICBjb25zdCB0ZW1wRm9sZGVyUGF0aCA9IGF3YWl0IGdldFRlbXBEaXIoe3ByZWZpeDogJ2dpdGh1Yi1kaXNjYXJkLWhpc3RvcnktJ30pO1xuICAgIGNvbnN0IHBhdGhQcm9taXNlcyA9IHNuYXBzaG90cy5tYXAoYXN5bmMgKHtmaWxlUGF0aCwgYmVmb3JlU2hhLCBhZnRlclNoYX0pID0+IHtcbiAgICAgIGNvbnN0IGRpciA9IHBhdGguZGlybmFtZShwYXRoLmpvaW4odGVtcEZvbGRlclBhdGgsIGZpbGVQYXRoKSk7XG4gICAgICBhd2FpdCBta2RpcnAoZGlyKTtcbiAgICAgIGNvbnN0IHRoZWlyc1BhdGggPSAhYmVmb3JlU2hhID8gbnVsbCA6XG4gICAgICAgIGF3YWl0IHRoaXMuZXhwYW5kQmxvYlRvRmlsZShwYXRoLmpvaW4odGVtcEZvbGRlclBhdGgsIGAke2ZpbGVQYXRofS1iZWZvcmUtZGlzY2FyZGApLCBiZWZvcmVTaGEpO1xuICAgICAgY29uc3QgY29tbW9uQmFzZVBhdGggPSAhYWZ0ZXJTaGEgPyBudWxsIDpcbiAgICAgICAgYXdhaXQgdGhpcy5leHBhbmRCbG9iVG9GaWxlKHBhdGguam9pbih0ZW1wRm9sZGVyUGF0aCwgYCR7ZmlsZVBhdGh9LWFmdGVyLWRpc2NhcmRgKSwgYWZ0ZXJTaGEpO1xuICAgICAgY29uc3QgcmVzdWx0UGF0aCA9IHBhdGguam9pbihkaXIsIGB+JHtwYXRoLmJhc2VuYW1lKGZpbGVQYXRoKX0tbWVyZ2UtcmVzdWx0YCk7XG4gICAgICByZXR1cm4ge2ZpbGVQYXRoLCBjb21tb25CYXNlUGF0aCwgdGhlaXJzUGF0aCwgcmVzdWx0UGF0aCwgdGhlaXJzU2hhOiBiZWZvcmVTaGEsIGNvbW1vbkJhc2VTaGE6IGFmdGVyU2hhfTtcbiAgICB9KTtcbiAgICByZXR1cm4gYXdhaXQgUHJvbWlzZS5hbGwocGF0aFByb21pc2VzKTtcbiAgfVxuXG4gIGFzeW5jIG1lcmdlRmlsZXMoZmlsZVBhdGhzKSB7XG4gICAgY29uc3QgbWVyZ2VGaWxlUHJvbWlzZXMgPSBmaWxlUGF0aHMubWFwKGFzeW5jIChmaWxlUGF0aEluZm8sIGkpID0+IHtcbiAgICAgIGNvbnN0IHtmaWxlUGF0aCwgY29tbW9uQmFzZVBhdGgsIHRoZWlyc1BhdGgsIHJlc3VsdFBhdGgsIHRoZWlyc1NoYSwgY29tbW9uQmFzZVNoYX0gPSBmaWxlUGF0aEluZm87XG4gICAgICBjb25zdCBjdXJyZW50U2hhID0gYXdhaXQgdGhpcy5jcmVhdGVCbG9iKHtmaWxlUGF0aH0pO1xuICAgICAgbGV0IG1lcmdlUmVzdWx0O1xuICAgICAgaWYgKHRoZWlyc1BhdGggJiYgY29tbW9uQmFzZVBhdGgpIHtcbiAgICAgICAgbWVyZ2VSZXN1bHQgPSBhd2FpdCB0aGlzLm1lcmdlRmlsZShmaWxlUGF0aCwgY29tbW9uQmFzZVBhdGgsIHRoZWlyc1BhdGgsIHJlc3VsdFBhdGgpO1xuICAgICAgfSBlbHNlIGlmICghdGhlaXJzUGF0aCAmJiBjb21tb25CYXNlUGF0aCkgeyAvLyBkZWxldGVkIGZpbGVcbiAgICAgICAgY29uc3Qgb3Vyc1NoYSA9IGF3YWl0IHRoaXMuY3JlYXRlQmxvYih7ZmlsZVBhdGh9KTtcbiAgICAgICAgaWYgKG91cnNTaGEgPT09IGNvbW1vbkJhc2VTaGEpIHsgLy8gbm8gY2hhbmdlcyBzaW5jZSBkaXNjYXJkLCBtYXJrIGZpbGUgdG8gYmUgZGVsZXRlZFxuICAgICAgICAgIG1lcmdlUmVzdWx0ID0ge2ZpbGVQYXRoLCByZXN1bHRQYXRoOiBudWxsLCBkZWxldGVkOiB0cnVlLCBjb25mbGljdDogZmFsc2V9O1xuICAgICAgICB9IGVsc2UgeyAvLyBjaGFuZ2VzIHNpbmNlIGRpc2NhcmQgcmVzdWx0IGluIGNvbmZsaWN0XG4gICAgICAgICAgYXdhaXQgZnMuY29weShwYXRoLmpvaW4odGhpcy53b3JrZGlyUGF0aCwgZmlsZVBhdGgpLCByZXN1bHRQYXRoKTtcbiAgICAgICAgICBtZXJnZVJlc3VsdCA9IHtmaWxlUGF0aCwgcmVzdWx0UGF0aCwgY29uZmxpY3Q6IHRydWV9O1xuICAgICAgICB9XG4gICAgICB9IGVsc2UgaWYgKHRoZWlyc1BhdGggJiYgIWNvbW1vbkJhc2VQYXRoKSB7IC8vIGFkZGVkIGZpbGVcbiAgICAgICAgY29uc3QgZmlsZURvZXNFeGlzdCA9IGF3YWl0IGZpbGVFeGlzdHMocGF0aC5qb2luKHRoaXMud29ya2RpclBhdGgsIGZpbGVQYXRoKSk7XG4gICAgICAgIGlmICghZmlsZURvZXNFeGlzdCkge1xuICAgICAgICAgIGF3YWl0IGZzLmNvcHkodGhlaXJzUGF0aCwgcmVzdWx0UGF0aCk7XG4gICAgICAgICAgbWVyZ2VSZXN1bHQgPSB7ZmlsZVBhdGgsIHJlc3VsdFBhdGgsIGNvbmZsaWN0OiBmYWxzZX07XG4gICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgYXdhaXQgZW1wdHlGaWxlUHJvbWlzZTtcbiAgICAgICAgICBtZXJnZVJlc3VsdCA9IGF3YWl0IHRoaXMubWVyZ2VGaWxlKGZpbGVQYXRoLCBlbXB0eUZpbGVQYXRoLCB0aGVpcnNQYXRoLCByZXN1bHRQYXRoKTtcbiAgICAgICAgfVxuICAgICAgfSBlbHNlIHtcbiAgICAgICAgdGhyb3cgbmV3IEVycm9yKCdPbmUgb2YgdGhlIGZvbGxvd2luZyBtdXN0IGJlIGRlZmluZWQgLSB0aGVpcnNQYXRoOicgK1xuICAgICAgICAgIGAke3RoZWlyc1BhdGh9IG9yIGNvbW1vbkJhc2VQYXRoOiAke2NvbW1vbkJhc2VQYXRofWApO1xuICAgICAgfVxuICAgICAgcmV0dXJuIHsuLi5tZXJnZVJlc3VsdCwgdGhlaXJzU2hhLCBjb21tb25CYXNlU2hhLCBjdXJyZW50U2hhfTtcbiAgICB9KTtcbiAgICByZXR1cm4gYXdhaXQgUHJvbWlzZS5hbGwobWVyZ2VGaWxlUHJvbWlz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