"use strict";

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.default = void 0;
var _path = _interopRequireDefault(require("path"));
var _os = _interopRequireDefault(require("os"));
var _fsExtra = _interopRequireDefault(require("fs-extra"));
var _mkdirp = _interopRequireDefault(require("mkdirp"));
var _discardHistoryStores = require("./discard-history-stores");
var _helpers = require("../helpers");
function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }
function ownKeys(e, r) { var t = Object.keys(e); if (Object.getOwnPropertySymbols) { var o = Object.getOwnPropertySymbols(e); r && (o = o.filter(function (r) { return Object.getOwnPropertyDescriptor(e, r).enumerable; })), t.push.apply(t, o); } return t; }
function _objectSpread(e) { for (var r = 1; r < arguments.length; r++) { var t = null != arguments[r] ? arguments[r] : {}; r % 2 ? ownKeys(Object(t), !0).forEach(function (r) { _defineProperty(e, r, t[r]); }) : Object.getOwnPropertyDescriptors ? Object.defineProperties(e, Object.getOwnPropertyDescriptors(t)) : ownKeys(Object(t)).forEach(function (r) { Object.defineProperty(e, r, Object.getOwnPropertyDescriptor(t, r)); }); } return e; }
function _defineProperty(obj, key, value) { key = _toPropertyKey(key); if (key in obj) { Object.defineProperty(obj, key, { value: value, enumerable: true, configurable: true, writable: true }); } else { obj[key] = value; } return obj; }
function _toPropertyKey(arg) { var key = _toPrimitive(arg, "string"); return typeof key === "symbol" ? key : String(key); }
function _toPrimitive(input, hint) { if (typeof input !== "object" || input === null) return input; var prim = input[Symbol.toPrimitive]; if (prim !== undefined) { var res = prim.call(input, hint || "default"); if (typeof res !== "object") return res; throw new TypeError("@@toPrimitive must return a primitive value."); } return (hint === "string" ? String : Number)(input); }
const emptyFilePath = _path.default.join(_os.default.tmpdir(), 'empty-file.txt');
const emptyFilePromise = _fsExtra.default.writeFile(emptyFilePath, '');
class DiscardHistory {
  constructor(createBlob, expandBlobToFile, mergeFile, workdirPath, {
    maxHistoryLength
  } = {}) {
    this.createBlob = createBlob;
    this.expandBlobToFile = expandBlobToFile;
    this.mergeFile = mergeFile;
    this.workdirPath = workdirPath;
    this.partialFileHistory = new _discardHistoryStores.PartialFileDiscardHistory(maxHistoryLength);
    this.wholeFileHistory = new _discardHistoryStores.WholeFileDiscardHistory(maxHistoryLength);
  }
  getLastSnapshots(partialDiscardFilePath = null) {
    if (partialDiscardFilePath) {
      return this.partialFileHistory.getLastSnapshotsForPath(partialDiscardFilePath);
    } else {
      return this.wholeFileHistory.getLastSnapshots();
    }
  }
  getHistory(partialDiscardFilePath = null) {
    if (partialDiscardFilePath) {
      return this.partialFileHistory.getHistoryForPath(partialDiscardFilePath);
    } else {
      return this.wholeFileHistory.getHistory();
    }
  }
  hasHistory(partialDiscardFilePath = null) {
    const history = this.getHistory(partialDiscardFilePath);
    return history.length > 0;
  }
  popHistory(partialDiscardFilePath = null) {
    if (partialDiscardFilePath) {
      return this.partialFileHistory.popHistoryForPath(partialDiscardFilePath);
    } else {
      return this.wholeFileHistory.popHistory();
    }
  }
  clearHistory(partialDiscardFilePath = null) {
    if (partialDiscardFilePath) {
      this.partialFileHistory.clearHistoryForPath(partialDiscardFilePath);
    } else {
      this.wholeFileHistory.clearHistory();
    }
  }
  updateHistory(history) {
    this.partialFileHistory.setHistory(history.partialFileHistory || {});
    this.wholeFileHistory.setHistory(history.wholeFileHistory || []);
  }
  async createHistoryBlob() {
    const histories = {
      wholeFileHistory: this.wholeFileHistory.getHistory(),
      partialFileHistory: this.partialFileHistory.getHistory()
    };
    const historySha = await this.createBlob({
      stdin: JSON.stringify(histories)
    });
    return historySha;
  }
  async storeBeforeAndAfterBlobs(filePaths, isSafe, destructiveAction, partialDiscardFilePath = null) {
    if (partialDiscardFilePath) {
      return await this.storeBlobsForPartialFileHistory(partialDiscardFilePath, isSafe, destructiveAction);
    } else {
      return await this.storeBlobsForWholeFileHistory(filePaths, isSafe, destructiveAction);
    }
  }
  async storeBlobsForPartialFileHistory(filePath, isSafe, destructiveAction) {
    const beforeSha = await this.createBlob({
      filePath
    });
    const isNotSafe = !(await isSafe());
    if (isNotSafe) {
      return null;
    }
    await destructiveAction();
    const afterSha = await this.createBlob({
      filePath
    });
    const snapshots = {
      beforeSha,
      afterSha
    };
    this.partialFileHistory.addHistory(filePath, snapshots);
    return snapshots;
  }
  async storeBlobsForWholeFileHistory(filePaths, isSafe, destructiveAction) {
    const snapshotsByPath = {};
    const beforePromises = filePaths.map(async filePath => {
      snapshotsByPath[filePath] = {
        beforeSha: await this.createBlob({
          filePath
        })
      };
    });
    await Promise.all(beforePromises);
    const isNotSafe = !(await isSafe());
    if (isNotSafe) {
      return null;
    }
    await destructiveAction();
    const afterPromises = filePaths.map(async filePath => {
      snapshotsByPath[filePath].afterSha = await this.createBlob({
        filePath
      });
    });
    await Promise.all(afterPromises);
    this.wholeFileHistory.addHistory(snapshotsByPath);
    return snapshotsByPath;
  }
  async restoreLastDiscardInTempFiles(isSafe, partialDiscardFilePath = null) {
    let lastDiscardSnapshots = this.getLastSnapshots(partialDiscardFilePath);
    if (partialDiscardFilePath) {
      lastDiscardSnapshots = lastDiscardSnapshots ? [lastDiscardSnapshots] : [];
    }
    const tempFolderPaths = await this.expandBlobsToFilesInTempFolder(lastDiscardSnapshots);
    if (!isSafe()) {
      return [];
    }
    return await this.mergeFiles(tempFolderPaths);
  }
  async expandBlobsToFilesInTempFolder(snapshots) {
    const tempFolderPath = await (0, _helpers.getTempDir)({
      prefix: 'github-discard-history-'
    });
    const pathPromises = snapshots.map(async ({
      filePath,
      beforeSha,
      afterSha
    }) => {
      const dir = _path.default.dirname(_path.default.join(tempFolderPath, filePath));
      await (0, _mkdirp.default)(dir);
      const theirsPath = !beforeSha ? null : await this.expandBlobToFile(_path.default.join(tempFolderPath, `${filePath}-before-discard`), beforeSha);
      const commonBasePath = !afterSha ? null : await this.expandBlobToFile(_path.default.join(tempFolderPath, `${filePath}-after-discard`), afterSha);
      const resultPath = _path.default.join(dir, `~${_path.default.basename(filePath)}-merge-result`);
      return {
        filePath,
        commonBasePath,
        theirsPath,
        resultPath,
        theirsSha: beforeSha,
        commonBaseSha: afterSha
      };
    });
    return await Promise.all(pathPromises);
  }
  async mergeFiles(filePaths) {
    const mergeFilePromises = filePaths.map(async (filePathInfo, i) => {
      const {
        filePath,
        commonBasePath,
        theirsPath,
        resultPath,
        theirsSha,
        commonBaseSha
      } = filePathInfo;
      const currentSha = await this.createBlob({
        filePath
      });
      let mergeResult;
      if (theirsPath && commonBasePath) {
        mergeResult = await this.mergeFile(filePath, commonBasePath, theirsPath, resultPath);
      } else if (!theirsPath && commonBasePath) {
        // deleted file
        const oursSha = await this.createBlob({
          filePath
        });
        if (oursSha === commonBaseSha) {
          // no changes since discard, mark file to be deleted
          mergeResult = {
            filePath,
            resultPath: null,
            deleted: true,
            conflict: false
          };
        } else {
          // changes since discard result in conflict
          await _fsExtra.default.copy(_path.default.join(this.workdirPath, filePath), resultPath);
          mergeResult = {
            filePath,
            resultPath,
            conflict: true
          };
        }
      } else if (theirsPath && !commonBasePath) {
        // added file
        const fileDoesExist = await (0, _helpers.fileExists)(_path.default.join(this.workdirPath, filePath));
        if (!fileDoesExist) {
          await _fsExtra.default.copy(theirsPath, resultPath);
          mergeResult = {
            filePath,
            resultPath,
            conflict: false
          };
        } else {
          await emptyFilePromise;
          mergeResult = await this.mergeFile(filePath, emptyFilePath, theirsPath, resultPath);
        }
      } else {
        throw new Error('One of the following must be defined - theirsPath:' + `${theirsPath} or commonBasePath: ${commonBasePath}`);
      }
      return _objectSpread({}, mergeResult, {
        theirsSha,
        commonBaseSha,
        currentSha
      });
    });
    return await Promise.all(mergeFilePromises);
  }
}
exports.default = DiscardHistory;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJuYW1lcyI6WyJfcGF0aCIsIl9pbnRlcm9wUmVxdWlyZURlZmF1bHQiLCJyZXF1aXJlIiwiX29zIiwiX2ZzRXh0cmEiLCJfbWtkaXJwIiwiX2Rpc2NhcmRIaXN0b3J5U3RvcmVzIiwiX2hlbHBlcnMiLCJvYmoiLCJfX2VzTW9kdWxlIiwiZGVmYXVsdCIsIm93bktleXMiLCJlIiwiciIsInQiLCJPYmplY3QiLCJrZXlzIiwiZ2V0T3duUHJvcGVydHlTeW1ib2xzIiwibyIsImZpbHRlciIsImdldE93blByb3BlcnR5RGVzY3JpcHRvciIsImVudW1lcmFibGUiLCJwdXNoIiwiYXBwbHkiLCJfb2JqZWN0U3ByZWFkIiwiYXJndW1lbnRzIiwibGVuZ3RoIiwiZm9yRWFjaCIsIl9kZWZpbmVQcm9wZXJ0eSIsImdldE93blByb3BlcnR5RGVzY3JpcHRvcnMiLCJkZWZpbmVQcm9wZXJ0aWVzIiwiZGVmaW5lUHJvcGVydHkiLCJrZXkiLCJ2YWx1ZSIsIl90b1Byb3BlcnR5S2V5IiwiY29uZmlndXJhYmxlIiwid3JpdGFibGUiLCJhcmciLCJfdG9QcmltaXRpdmUiLCJTdHJpbmciLCJpbnB1dCIsImhpbnQiLCJwcmltIiwiU3ltYm9sIiwidG9QcmltaXRpdmUiLCJ1bmRlZmluZWQiLCJyZXMiLCJjYWxsIiwiVHlwZUVycm9yIiwiTnVtYmVyIiwiZW1wdHlGaWxlUGF0aCIsInBhdGgiLCJqb2luIiwib3MiLCJ0bXBkaXIiLCJlbXB0eUZpbGVQcm9taXNlIiwiZnMiLCJ3cml0ZUZpbGUiLCJEaXNjYXJkSGlzdG9yeSIsImNvbnN0cnVjdG9yIiwiY3JlYXRlQmxvYiIsImV4cGFuZEJsb2JUb0ZpbGUiLCJtZXJnZUZpbGUiLCJ3b3JrZGlyUGF0aCIsIm1heEhpc3RvcnlMZW5ndGgiLCJwYXJ0aWFsRmlsZUhpc3RvcnkiLCJQYXJ0aWFsRmlsZURpc2NhcmRIaXN0b3J5Iiwid2hvbGVGaWxlSGlzdG9yeSIsIldob2xlRmlsZURpc2NhcmRIaXN0b3J5IiwiZ2V0TGFzdFNuYXBzaG90cyIsInBhcnRpYWxEaXNjYXJkRmlsZVBhdGgiLCJnZXRMYXN0U25hcHNob3RzRm9yUGF0aCIsImdldEhpc3RvcnkiLCJnZXRIaXN0b3J5Rm9yUGF0aCIsImhhc0hpc3RvcnkiLCJoaXN0b3J5IiwicG9wSGlzdG9yeSIsInBvcEhpc3RvcnlGb3JQYXRoIiwiY2xlYXJIaXN0b3J5IiwiY2xlYXJIaXN0b3J5Rm9yUGF0aCIsInVwZGF0ZUhpc3RvcnkiLCJzZXRIaXN0b3J5IiwiY3JlYXRlSGlzdG9yeUJsb2IiLCJoaXN0b3JpZXMiLCJoaXN0b3J5U2hhIiwic3RkaW4iLCJKU09OIiwic3RyaW5naWZ5Iiwic3RvcmVCZWZvcmVBbmRBZnRlckJsb2JzIiwiZmlsZVBhdGhzIiwiaXNTYWZlIiwiZGVzdHJ1Y3RpdmVBY3Rpb24iLCJzdG9yZUJsb2JzRm9yUGFydGlhbEZpbGVIaXN0b3J5Iiwic3RvcmVCbG9ic0Zvcldob2xlRmlsZUhpc3RvcnkiLCJmaWxlUGF0aCIsImJlZm9yZVNoYSIsImlzTm90U2FmZSIsImFmdGVyU2hhIiwic25hcHNob3RzIiwiYWRkSGlzdG9yeSIsInNuYXBzaG90c0J5UGF0aCIsImJlZm9yZVByb21pc2VzIiwibWFwIiwiUHJvbWlzZSIsImFsbCIsImFmdGVyUHJvbWlzZXMiLCJyZXN0b3JlTGFzdERpc2NhcmRJblRlbXBGaWxlcyIsImxhc3REaXNjYXJkU25hcHNob3RzIiwidGVtcEZvbGRlclBhdGhzIiwiZXhwYW5kQmxvYnNUb0ZpbGVzSW5UZW1wRm9sZGVyIiwibWVyZ2VGaWxlcyIsInRlbXBGb2xkZXJQYXRoIiwiZ2V0VGVtcERpciIsInByZWZpeCIsInBhdGhQcm9taXNlcyIsImRpciIsImRpcm5hbWUiLCJta2RpcnAiLCJ0aGVpcnNQYXRoIiwiY29tbW9uQmFzZVBhdGgiLCJyZXN1bHRQYXRoIiwiYmFzZW5hbWUiLCJ0aGVpcnNTaGEiLCJjb21tb25CYXNlU2hhIiwibWVyZ2VGaWxlUHJvbWlzZXMiLCJmaWxlUGF0aEluZm8iLCJpIiwiY3VycmVudFNoYSIsIm1lcmdlUmVzdWx0Iiwib3Vyc1NoYSIsImRlbGV0ZWQiLCJjb25mbGljdCIsImNvcHkiLCJmaWxlRG9lc0V4aXN0IiwiZmlsZUV4aXN0cyIsIkVycm9yIiwiZXhwb3J0cyJdLCJzb3VyY2VzIjpbImRpc2NhcmQtaGlzdG9yeS5qcyJdLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgcGF0aCBmcm9tICdwYXRoJztcbmltcG9ydCBvcyBmcm9tICdvcyc7XG5pbXBvcnQgZnMgZnJvbSAnZnMtZXh0cmEnO1xuXG5pbXBvcnQgbWtkaXJwIGZyb20gJ21rZGlycCc7XG5cbmltcG9ydCB7UGFydGlhbEZpbGVEaXNjYXJkSGlzdG9yeSwgV2hvbGVGaWxlRGlzY2FyZEhpc3Rvcnl9IGZyb20gJy4vZGlzY2FyZC1oaXN0b3J5LXN0b3Jlcyc7XG5cbmltcG9ydCB7Z2V0VGVtcERpciwgZmlsZUV4aXN0c30gZnJvbSAnLi4vaGVscGVycyc7XG5cbmNvbnN0IGVtcHR5RmlsZVBhdGggPSBwYXRoLmpvaW4ob3MudG1wZGlyKCksICdlbXB0eS1maWxlLnR4dCcpO1xuY29uc3QgZW1wdHlGaWxlUHJvbWlzZSA9IGZzLndyaXRlRmlsZShlbXB0eUZpbGVQYXRoLCAnJyk7XG5cbmV4cG9ydCBkZWZhdWx0IGNsYXNzIERpc2NhcmRIaXN0b3J5IHtcbiAgY29uc3RydWN0b3IoY3JlYXRlQmxvYiwgZXhwYW5kQmxvYlRvRmlsZSwgbWVyZ2VGaWxlLCB3b3JrZGlyUGF0aCwge21heEhpc3RvcnlMZW5ndGh9ID0ge30pIHtcbiAgICB0aGlzLmNyZWF0ZUJsb2IgPSBjcmVhdGVCbG9iO1xuICAgIHRoaXMuZXhwYW5kQmxvYlRvRmlsZSA9IGV4cGFuZEJsb2JUb0ZpbGU7XG4gICAgdGhpcy5tZXJnZUZpbGUgPSBtZXJnZUZpbGU7XG4gICAgdGhpcy53b3JrZGlyUGF0aCA9IHdvcmtkaXJQYXRoO1xuICAgIHRoaXMucGFydGlhbEZpbGVIaXN0b3J5ID0gbmV3IFBhcnRpYWxGaWxlRGlzY2FyZEhpc3RvcnkobWF4SGlzdG9yeUxlbmd0aCk7XG4gICAgdGhpcy53aG9sZUZpbGVIaXN0b3J5ID0gbmV3IFdob2xlRmlsZURpc2NhcmRIaXN0b3J5KG1heEhpc3RvcnlMZW5ndGgpO1xuICB9XG5cbiAgZ2V0TGFzdFNuYXBzaG90cyhwYXJ0aWFsRGlzY2FyZEZpbGVQYXRoID0gbnVsbCkge1xuICAgIGlmIChwYXJ0aWFsRGlzY2FyZEZpbGVQYXRoKSB7XG4gICAgICByZXR1cm4gdGhpcy5wYXJ0aWFsRmlsZUhpc3RvcnkuZ2V0TGFzdFNuYXBzaG90c0ZvclBhdGgocGFydGlhbERpc2NhcmRGaWxlUGF0aCk7XG4gICAgfSBlbHNlIHtcbiAgICAgIHJldHVybiB0aGlzLndob2xlRmlsZUhpc3RvcnkuZ2V0TGFzdFNuYXBzaG90cygpO1xuICAgIH1cbiAgfVxuXG4gIGdldEhpc3RvcnkocGFydGlhbERpc2NhcmRGaWxlUGF0aCA9IG51bGwpIHtcbiAgICBpZiAocGFydGlhbERpc2NhcmRGaWxlUGF0aCkge1xuICAgICAgcmV0dXJuIHRoaXMucGFydGlhbEZpbGVIaXN0b3J5LmdldEhpc3RvcnlGb3JQYXRoKHBhcnRpYWxEaXNjYXJkRmlsZVBhdGgpO1xuICAgIH0gZWxzZSB7XG4gICAgICByZXR1cm4gdGhpcy53aG9sZUZpbGVIaXN0b3J5LmdldEhpc3RvcnkoKTtcbiAgICB9XG4gIH1cblxuICBoYXNIaXN0b3J5KHBhcnRpYWxEaXNjYXJkRmlsZVBhdGggPSBudWxsKSB7XG4gICAgY29uc3QgaGlzdG9yeSA9IHRoaXMuZ2V0SGlzdG9yeShwYXJ0aWFsRGlzY2FyZEZpbGVQYXRoKTtcbiAgICByZXR1cm4gaGlzdG9yeS5sZW5ndGggPiAwO1xuICB9XG5cbiAgcG9wSGlzdG9yeShwYXJ0aWFsRGlzY2FyZEZpbGVQYXRoID0gbnVsbCkge1xuICAgIGlmIChwYXJ0aWFsRGlzY2FyZEZpbGVQYXRoKSB7XG4gICAgICByZXR1cm4gdGhpcy5wYXJ0aWFsRmlsZUhpc3RvcnkucG9wSGlzdG9yeUZvclBhdGgocGFydGlhbERpc2NhcmRGaWxlUGF0aCk7XG4gICAgfSBlbHNlIHtcbiAgICAgIHJldHVybiB0aGlzLndob2xlRmlsZUhpc3RvcnkucG9wSGlzdG9yeSgpO1xuICAgIH1cbiAgfVxuXG4gIGNsZWFySGlzdG9yeShwYXJ0aWFsRGlzY2FyZEZpbGVQYXRoID0gbnVsbCkge1xuICAgIGlmIChwYXJ0aWFsRGlzY2FyZEZpbGVQYXRoKSB7XG4gICAgICB0aGlzLnBhcnRpYWxGaWxlSGlzdG9yeS5jbGVhckhpc3RvcnlGb3JQYXRoKHBhcnRpYWxEaXNjYXJkRmlsZVBhdGgpO1xuICAgIH0gZWxzZSB7XG4gICAgICB0aGlzLndob2xlRmlsZUhpc3RvcnkuY2xlYXJIaXN0b3J5KCk7XG4gICAgfVxuICB9XG5cbiAgdXBkYXRlSGlzdG9yeShoaXN0b3J5KSB7XG4gICAgdGhpcy5wYXJ0aWFsRmlsZUhpc3Rvcnkuc2V0SGlzdG9yeShoaXN0b3J5LnBhcnRpYWxGaWxlSGlzdG9yeSB8fCB7fSk7XG4gICAgdGhpcy53aG9sZUZpbGVIaXN0b3J5LnNldEhpc3RvcnkoaGlzdG9yeS53aG9sZUZpbGVIaXN0b3J5IHx8IFtdKTtcbiAgfVxuXG4gIGFzeW5jIGNyZWF0ZUhpc3RvcnlCbG9iKCkge1xuICAgIGNvbnN0IGhpc3RvcmllcyA9IHtcbiAgICAgIHdob2xlRmlsZUhpc3Rvcnk6IHRoaXMud2hvbGVGaWxlSGlzdG9yeS5nZXRIaXN0b3J5KCksXG4gICAgICBwYXJ0aWFsRmlsZUhpc3Rvcnk6IHRoaXMucGFydGlhbEZpbGVIaXN0b3J5LmdldEhpc3RvcnkoKSxcbiAgICB9O1xuICAgIGNvbnN0IGhpc3RvcnlTaGEgPSBhd2FpdCB0aGlzLmNyZWF0ZUJsb2Ioe3N0ZGluOiBKU09OLnN0cmluZ2lmeShoaXN0b3JpZXMpfSk7XG4gICAgcmV0dXJuIGhpc3RvcnlTaGE7XG4gIH1cblxuICBhc3luYyBzdG9yZUJlZm9yZUFuZEFmdGVyQmxvYnMoZmlsZVBhdGhzLCBpc1NhZmUsIGRlc3RydWN0aXZlQWN0aW9uLCBwYXJ0aWFsRGlzY2FyZEZpbGVQYXRoID0gbnVsbCkge1xuICAgIGlmIChwYXJ0aWFsRGlzY2FyZEZpbGVQYXRoKSB7XG4gICAgICByZXR1cm4gYXdhaXQgdGhpcy5zdG9yZUJsb2JzRm9yUGFydGlhbEZpbGVIaXN0b3J5KHBhcnRpYWxEaXNjYXJkRmlsZVBhdGgsIGlzU2FmZSwgZGVzdHJ1Y3RpdmVBY3Rpb24pO1xuICAgIH0gZWxzZSB7XG4gICAgICByZXR1cm4gYXdhaXQgdGhpcy5zdG9yZUJsb2JzRm9yV2hvbGVGaWxlSGlzdG9yeShmaWxlUGF0aHMsIGlzU2FmZSwgZGVzdHJ1Y3RpdmVBY3Rpb24pO1xuICAgIH1cbiAgfVxuXG4gIGFzeW5jIHN0b3JlQmxvYnNGb3JQYXJ0aWFsRmlsZUhpc3RvcnkoZmlsZVBhdGgsIGlzU2FmZSwgZGVzdHJ1Y3RpdmVBY3Rpb24pIHtcbiAgICBjb25zdCBiZWZvcmVTaGEgPSBhd2FpdCB0aGlzLmNyZWF0ZUJsb2Ioe2ZpbGVQYXRofSk7XG4gICAgY29uc3QgaXNOb3RTYWZlID0gIShhd2FpdCBpc1NhZmUoKSk7XG4gICAgaWYgKGlzTm90U2FmZSkgeyByZXR1cm4gbnVsbDsgfVxuICAgIGF3YWl0IGRlc3RydWN0aXZlQWN0aW9uKCk7XG4gICAgY29uc3QgYWZ0ZXJTaGEgPSBhd2FpdCB0aGlzLmNyZWF0ZUJsb2Ioe2ZpbGVQYXRofSk7XG4gICAgY29uc3Qgc25hcHNob3RzID0ge2JlZm9yZVNoYSwgYWZ0ZXJTaGF9O1xuICAgIHRoaXMucGFydGlhbEZpbGVIaXN0b3J5LmFkZEhpc3RvcnkoZmlsZVBhdGgsIHNuYXBzaG90cyk7XG4gICAgcmV0dXJuIHNuYXBzaG90cztcbiAgfVxuXG4gIGFzeW5jIHN0b3JlQmxvYnNGb3JXaG9sZUZpbGVIaXN0b3J5KGZpbGVQYXRocywgaXNTYWZlLCBkZXN0cnVjdGl2ZUFjdGlvbikge1xuICAgIGNvbnN0IHNuYXBzaG90c0J5UGF0aCA9IHt9O1xuICAgIGNvbnN0IGJlZm9yZVByb21pc2VzID0gZmlsZVBhdGhzLm1hcChhc3luYyBmaWxlUGF0aCA9PiB7XG4gICAgICBzbmFwc2hvdHNCeVBhdGhbZmlsZVBhdGhdID0ge2JlZm9yZVNoYTogYXdhaXQgdGhpcy5jcmVhdGVCbG9iKHtmaWxlUGF0aH0pfTtcbiAgICB9KTtcbiAgICBhd2FpdCBQcm9taXNlLmFsbChiZWZvcmVQcm9taXNlcyk7XG4gICAgY29uc3QgaXNOb3RTYWZlID0gIShhd2FpdCBpc1NhZmUoKSk7XG4gICAgaWYgKGlzTm90U2FmZSkgeyByZXR1cm4gbnVsbDsgfVxuICAgIGF3YWl0IGRlc3RydWN0aXZlQWN0aW9uKCk7XG4gICAgY29uc3QgYWZ0ZXJQcm9taXNlcyA9IGZpbGVQYXRocy5tYXAoYXN5bmMgZmlsZVBhdGggPT4ge1xuICAgICAgc25hcHNob3RzQnlQYXRoW2ZpbGVQYXRoXS5hZnRlclNoYSA9IGF3YWl0IHRoaXMuY3JlYXRlQmxvYih7ZmlsZVBhdGh9KTtcbiAgICB9KTtcbiAgICBhd2FpdCBQcm9taXNlLmFsbChhZnRlclByb21pc2VzKTtcbiAgICB0aGlzLndob2xlRmlsZUhpc3RvcnkuYWRkSGlzdG9yeShzbmFwc2hvdHNCeVBhdGgpO1xuICAgIHJldHVybiBzbmFwc2hvdHNCeVBhdGg7XG4gIH1cblxuICBhc3luYyByZXN0b3JlTGFzdERpc2NhcmRJblRlbXBGaWxlcyhpc1NhZmUsIHBhcnRpYWxEaXNjYXJkRmlsZVBhdGggPSBudWxsKSB7XG4gICAgbGV0IGxhc3REaXNjYXJkU25hcHNob3RzID0gdGhpcy5nZXRMYXN0U25hcHNob3RzKHBhcnRpYWxEaXNjYXJkRmlsZVBhdGgpO1xuICAgIGlmIChwYXJ0aWFsRGlzY2FyZEZpbGVQYXRoKSB7XG4gICAgICBsYXN0RGlzY2FyZFNuYXBzaG90cyA9IGxhc3REaXNjYXJkU25hcHNob3RzID8gW2xhc3REaXNjYXJkU25hcHNob3RzXSA6IFtdO1xuICAgIH1cbiAgICBjb25zdCB0ZW1wRm9sZGVyUGF0aHMgPSBhd2FpdCB0aGlzLmV4cGFuZEJsb2JzVG9GaWxlc0luVGVtcEZvbGRlcihsYXN0RGlzY2FyZFNuYXBzaG90cyk7XG4gICAgaWYgKCFpc1NhZmUoKSkgeyByZXR1cm4gW107IH1cbiAgICByZXR1cm4gYXdhaXQgdGhpcy5tZXJnZUZpbGVzKHRlbXBGb2xkZXJQYXRocyk7XG4gIH1cblxuICBhc3luYyBleHBhbmRCbG9ic1RvRmlsZXNJblRlbXBGb2xkZXIoc25hcHNob3RzKSB7XG4gICAgY29uc3QgdGVtcEZvbGRlclBhdGggPSBhd2FpdCBnZXRUZW1wRGlyKHtwcmVmaXg6ICdnaXRodWItZGlzY2FyZC1oaXN0b3J5LSd9KTtcbiAgICBjb25zdCBwYXRoUHJvbWlzZXMgPSBzbmFwc2hvdHMubWFwKGFzeW5jICh7ZmlsZVBhdGgsIGJlZm9yZVNoYSwgYWZ0ZXJTaGF9KSA9PiB7XG4gICAgICBjb25zdCBkaXIgPSBwYXRoLmRpcm5hbWUocGF0aC5qb2luKHRlbXBGb2xkZXJQYXRoLCBmaWxlUGF0aCkpO1xuICAgICAgYXdhaXQgbWtkaXJwKGRpcik7XG4gICAgICBjb25zdCB0aGVpcnNQYXRoID0gIWJlZm9yZVNoYSA/IG51bGwgOlxuICAgICAgICBhd2FpdCB0aGlzLmV4cGFuZEJsb2JUb0ZpbGUocGF0aC5qb2luKHRlbXBGb2xkZXJQYXRoLCBgJHtmaWxlUGF0aH0tYmVmb3JlLWRpc2NhcmRgKSwgYmVmb3JlU2hhKTtcbiAgICAgIGNvbnN0IGNvbW1vbkJhc2VQYXRoID0gIWFmdGVyU2hhID8gbnVsbCA6XG4gICAgICAgIGF3YWl0IHRoaXMuZXhwYW5kQmxvYlRvRmlsZShwYXRoLmpvaW4odGVtcEZvbGRlclBhdGgsIGAke2ZpbGVQYXRofS1hZnRlci1kaXNjYXJkYCksIGFmdGVyU2hhKTtcbiAgICAgIGNvbnN0IHJlc3VsdFBhdGggPSBwYXRoLmpvaW4oZGlyLCBgfiR7cGF0aC5iYXNlbmFtZShmaWxlUGF0aCl9LW1lcmdlLXJlc3VsdGApO1xuICAgICAgcmV0dXJuIHtmaWxlUGF0aCwgY29tbW9uQmFzZVBhdGgsIHRoZWlyc1BhdGgsIHJlc3VsdFBhdGgsIHRoZWlyc1NoYTogYmVmb3JlU2hhLCBjb21tb25CYXNlU2hhOiBhZnRlclNoYX07XG4gICAgfSk7XG4gICAgcmV0dXJuIGF3YWl0IFByb21pc2UuYWxsKHBhdGhQcm9taXNlcyk7XG4gIH1cblxuICBhc3luYyBtZXJnZUZpbGVzKGZpbGVQYXRocykge1xuICAgIGNvbnN0IG1lcmdlRmlsZVByb21pc2VzID0gZmlsZVBhdGhzLm1hcChhc3luYyAoZmlsZVBhdGhJbmZvLCBpKSA9PiB7XG4gICAgICBjb25zdCB7ZmlsZVBhdGgsIGNvbW1vbkJhc2VQYXRoLCB0aGVpcnNQYXRoLCByZXN1bHRQYXRoLCB0aGVpcnNTaGEsIGNvbW1vbkJhc2VTaGF9ID0gZmlsZVBhdGhJbmZvO1xuICAgICAgY29uc3QgY3VycmVudFNoYSA9IGF3YWl0IHRoaXMuY3JlYXRlQmxvYih7ZmlsZVBhdGh9KTtcbiAgICAgIGxldCBtZXJnZVJlc3VsdDtcbiAgICAgIGlmICh0aGVpcnNQYXRoICYmIGNvbW1vbkJhc2VQYXRoKSB7XG4gICAgICAgIG1lcmdlUmVzdWx0ID0gYXdhaXQgdGhpcy5tZXJnZUZpbGUoZmlsZVBhdGgsIGNvbW1vbkJhc2VQYXRoLCB0aGVpcnNQYXRoLCByZXN1bHRQYXRoKTtcbiAgICAgIH0gZWxzZSBpZiAoIXRoZWlyc1BhdGggJiYgY29tbW9uQmFzZVBhdGgpIHsgLy8gZGVsZXRlZCBmaWxlXG4gICAgICAgIGNvbnN0IG91cnNTaGEgPSBhd2FpdCB0aGlzLmNyZWF0ZUJsb2Ioe2ZpbGVQYXRofSk7XG4gICAgICAgIGlmIChvdXJzU2hhID09PSBjb21tb25CYXNlU2hhKSB7IC8vIG5vIGNoYW5nZXMgc2luY2UgZGlzY2FyZCwgbWFyayBmaWxlIHRvIGJlIGRlbGV0ZWRcbiAgICAgICAgICBtZXJnZVJlc3VsdCA9IHtmaWxlUGF0aCwgcmVzdWx0UGF0aDogbnVsbCwgZGVsZXRlZDogdHJ1ZSwgY29uZmxpY3Q6IGZhbHNlfTtcbiAgICAgICAgfSBlbHNlIHsgLy8gY2hhbmdlcyBzaW5jZSBkaXNjYXJkIHJlc3VsdCBpbiBjb25mbGljdFxuICAgICAgICAgIGF3YWl0IGZzLmNvcHkocGF0aC5qb2luKHRoaXMud29ya2RpclBhdGgsIGZpbGVQYXRoKSwgcmVzdWx0UGF0aCk7XG4gICAgICAgICAgbWVyZ2VSZXN1bHQgPSB7ZmlsZVBhdGgsIHJlc3VsdFBhdGgsIGNvbmZsaWN0OiB0cnVlfTtcbiAgICAgICAgfVxuICAgICAgfSBlbHNlIGlmICh0aGVpcnNQYXRoICYmICFjb21tb25CYXNlUGF0aCkgeyAvLyBhZGRlZCBmaWxlXG4gICAgICAgIGNvbnN0IGZpbGVEb2VzRXhpc3QgPSBhd2FpdCBmaWxlRXhpc3RzKHBhdGguam9pbih0aGlzLndvcmtkaXJQYXRoLCBmaWxlUGF0aCkpO1xuICAgICAgICBpZiAoIWZpbGVEb2VzRXhpc3QpIHtcbiAgICAgICAgICBhd2FpdCBmcy5jb3B5KHRoZWlyc1BhdGgsIHJlc3VsdFBhdGgpO1xuICAgICAgICAgIG1lcmdlUmVzdWx0ID0ge2ZpbGVQYXRoLCByZXN1bHRQYXRoLCBjb25mbGljdDogZmFsc2V9O1xuICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgIGF3YWl0IGVtcHR5RmlsZVByb21pc2U7XG4gICAgICAgICAgbWVyZ2VSZXN1bHQgPSBhd2FpdCB0aGlzLm1lcmdlRmlsZShmaWxlUGF0aCwgZW1wdHlGaWxlUGF0aCwgdGhlaXJzUGF0aCwgcmVzdWx0UGF0aCk7XG4gICAgICAgIH1cbiAgICAgIH0gZWxzZSB7XG4gICAgICAgIHRocm93IG5ldyBFcnJvcignT25lIG9mIHRoZSBmb2xsb3dpbmcgbXVzdCBiZSBkZWZpbmVkIC0gdGhlaXJzUGF0aDonICtcbiAgICAgICAgICBgJHt0aGVpcnNQYXRofSBvciBjb21tb25CYXNlUGF0aDogJHtjb21tb25CYXNlUGF0aH1gKTtcbiAgICAgIH1cbiAgICAgIHJldHVybiB7Li4ubWVyZ2VSZXN1bHQsIHRoZWlyc1NoYSwgY29tbW9uQmFzZVNoYSwgY3VycmVudFNoYX07XG4gICAgfSk7XG4gICAgcmV0dXJuIGF3YWl0IFByb21pc2UuYWxsKG1lcmdlRmlsZVByb21pc2VzKTtcbiAgfVxufVxuIl0sIm1hcHBpbmdzIjoiOzs7Ozs7QUFBQSxJQUFB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