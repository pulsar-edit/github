"use strict";

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.default = exports.source = void 0;
var _yubikiri = _interopRequireDefault(require("yubikiri"));
var _eventKit = require("event-kit");
var _relayNetworkLayerManager = _interopRequireDefault(require("../relay-network-layer-manager"));
var _author = _interopRequireWildcard(require("./author"));
var _keytarStrategy = require("../shared/keytar-strategy");
var _modelObserver = _interopRequireDefault(require("./model-observer"));
function _getRequireWildcardCache(e) { if ("function" != typeof WeakMap) return null; var r = new WeakMap(), t = new WeakMap(); return (_getRequireWildcardCache = function (e) { return e ? t : r; })(e); }
function _interopRequireWildcard(e, r) { if (!r && e && e.__esModule) return e; if (null === e || "object" != typeof e && "function" != typeof e) return { default: e }; var t = _getRequireWildcardCache(r); if (t && t.has(e)) return t.get(e); var n = { __proto__: null }, a = Object.defineProperty && Object.getOwnPropertyDescriptor; for (var u in e) if ("default" !== u && Object.prototype.hasOwnProperty.call(e, u)) { var i = a ? Object.getOwnPropertyDescriptor(e, u) : null; i && (i.get || i.set) ? Object.defineProperty(n, u, i) : n[u] = e[u]; } return n.default = e, t && t.set(e, n), n; }
function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }
function _defineProperty(obj, key, value) { key = _toPropertyKey(key); if (key in obj) { Object.defineProperty(obj, key, { value: value, enumerable: true, configurable: true, writable: true }); } else { obj[key] = value; } return obj; }
function _toPropertyKey(arg) { var key = _toPrimitive(arg, "string"); return typeof key === "symbol" ? key : String(key); }
function _toPrimitive(input, hint) { if (typeof input !== "object" || input === null) return input; var prim = input[Symbol.toPrimitive]; if (prim !== undefined) { var res = prim.call(input, hint || "default"); if (typeof res !== "object") return res; throw new TypeError("@@toPrimitive must return a primitive value."); } return (hint === "string" ? String : Number)(input); }
// This is a guess about what a reasonable value is. Can adjust if performance is poor.
const MAX_COMMITS = 5000;
const source = {
  PENDING: Symbol('pending'),
  GITLOG: Symbol('git log'),
  GITHUBAPI: Symbol('github API')
};
exports.source = source;
class GraphQLCache {
  // One hour

  constructor() {
    this.bySlug = new Map();
  }
  get(remote) {
    const slug = remote.getSlug();
    const {
      ts,
      data
    } = this.bySlug.get(slug) || {
      ts: -Infinity,
      data: {}
    };
    if (Date.now() - ts > this.constructor.MAX_AGE_MS) {
      this.bySlug.delete(slug);
      return null;
    }
    return data;
  }
  set(remote, data) {
    this.bySlug.set(remote.getSlug(), {
      ts: Date.now(),
      data
    });
  }
}
_defineProperty(GraphQLCache, "MAX_AGE_MS", 3.6e6);
class UserStore {
  constructor({
    repository,
    login,
    config
  }) {
    this.emitter = new _eventKit.Emitter();
    this.subs = new _eventKit.CompositeDisposable();

    // TODO: [ku 3/2018] Consider using Dexie (indexDB wrapper) like Desktop and persist users across sessions
    this.allUsers = new Map();
    this.excludedUsers = new Set();
    this.users = [];
    this.committer = _author.nullAuthor;
    this.last = {
      source: source.PENDING,
      repository: null,
      excludedUsers: this.excludedUsers
    };
    this.cache = new GraphQLCache();
    this.repositoryObserver = new _modelObserver.default({
      fetchData: r => (0, _yubikiri.default)({
        committer: r.getCommitter(),
        authors: r.getAuthors({
          max: MAX_COMMITS
        }),
        remotes: r.getRemotes()
      }),
      didUpdate: () => this.loadUsers()
    });
    this.repositoryObserver.setActiveModel(repository);
    this.loginObserver = new _modelObserver.default({
      didUpdate: () => this.loadUsers()
    });
    this.loginObserver.setActiveModel(login);
    this.subs.add(config.observe('github.excludedUsers', value => {
      this.excludedUsers = new Set((value || '').split(/\s*,\s*/).filter(each => each.length > 0));
      return this.loadUsers();
    }));
  }
  dispose() {
    this.subs.dispose();
    this.emitter.dispose();
  }
  async loadUsers() {
    const data = this.repositoryObserver.getActiveModelData();
    if (!data) {
      return;
    }
    this.setCommitter(data.committer);
    const githubRemotes = Array.from(data.remotes).filter(remote => remote.isGithubRepo());
    if (githubRemotes.length > 0) {
      await this.loadUsersFromGraphQL(githubRemotes);
    } else {
      this.addUsers(data.authors, source.GITLOG);
    }

    // if for whatever reason, no committers can be added, fall back to
    // using git log committers as the last resort
    if (this.allUsers.size === 0) {
      this.addUsers(data.authors, source.GITLOG);
    }
  }
  loadUsersFromGraphQL(remotes) {
    return Promise.all(Array.from(remotes, remote => this.loadMentionableUsers(remote)));
  }
  async getToken(loginModel, loginAccount) {
    if (!loginModel) {
      return null;
    }
    const token = await loginModel.getToken(loginAccount);
    if (token === _keytarStrategy.UNAUTHENTICATED || token === _keytarStrategy.INSUFFICIENT || token instanceof Error) {
      return null;
    }
    return token;
  }
  async loadMentionableUsers(remote) {
    const cached = this.cache.get(remote);
    if (cached !== null) {
      this.addUsers(cached, source.GITHUBAPI);
      return;
    }
    const endpoint = remote.getEndpoint();
    const token = await this.getToken(this.loginObserver.getActiveModel(), endpoint.getLoginAccount());
    if (!token) {
      return;
    }
    const fetchQuery = _relayNetworkLayerManager.default.getFetchQuery(endpoint, token);
    let hasMore = true;
    let cursor = null;
    const remoteUsers = [];
    while (hasMore) {
      const response = await fetchQuery({
        name: 'GetMentionableUsers',
        text: `
          query GetMentionableUsers($owner: String!, $name: String!, $first: Int!, $after: String) {
            repository(owner: $owner, name: $name) {
              mentionableUsers(first: $first, after: $after) {
                nodes {
                  login
                  email
                  name
                }
                pageInfo {
                  hasNextPage
                  endCursor
                }
              }
            }
          }
        `
      }, {
        owner: remote.getOwner(),
        name: remote.getRepo(),
        first: 100,
        after: cursor
      });

      /* istanbul ignore if */
      if (response.errors && response.errors.length > 1) {
        // eslint-disable-next-line no-console
        console.error(`Error fetching mentionable users:\n${response.errors.map(e => e.message).join('\n')}`);
      }
      if (!response.data || !response.data.repository) {
        break;
      }
      const connection = response.data.repository.mentionableUsers;
      const authors = connection.nodes.map(node => {
        if (node.email === '') {
          node.email = `${node.login}@users.noreply.github.com`;
        }
        return new _author.default(node.email, node.name, node.login);
      });
      this.addUsers(authors, source.GITHUBAPI);
      remoteUsers.push(...authors);
      cursor = connection.pageInfo.endCursor;
      hasMore = connection.pageInfo.hasNextPage;
    }
    this.cache.set(remote, remoteUsers);
  }
  addUsers(users, nextSource) {
    let changed = false;
    if (nextSource !== this.last.source || this.repositoryObserver.getActiveModel() !== this.last.repository || this.excludedUsers !== this.last.excludedUsers) {
      changed = true;
      this.allUsers.clear();
    }
    for (const author of users) {
      if (!this.allUsers.has(author.getEmail())) {
        changed = true;
      }
      this.allUsers.set(author.getEmail(), author);
    }
    if (changed) {
      this.finalize();
    }
    this.last.source = nextSource;
    this.last.repository = this.repositoryObserver.getActiveModel();
    this.last.excludedUsers = this.excludedUsers;
  }
  finalize() {
    // TODO: [ku 3/2018] consider sorting based on most recent authors or commit frequency
    const users = [];
    for (const author of this.allUsers.values()) {
      if (author.matches(this.committer)) {
        continue;
      }
      if (author.isNoReply()) {
        continue;
      }
      if (this.excludedUsers.has(author.getEmail())) {
        continue;
      }
      users.push(author);
    }
    users.sort(_author.default.compare);
    this.users = users;
    this.didUpdate();
  }
  setRepository(repository) {
    this.repositoryObserver.setActiveModel(repository);
  }
  setLoginModel(login) {
    this.loginObserver.setActiveModel(login);
  }
  setCommitter(committer) {
    const changed = !this.committer.matches(committer);
    this.committer = committer;
    if (changed) {
      this.finalize();
    }
  }
  didUpdate() {
    this.emitter.emit('did-update', this.getUsers());
  }
  onDidUpdate(callback) {
    return this.emitter.on('did-update', callback);
  }
  getUsers() {
    return this.users;
  }
}
exports.default = UserStore;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJuYW1lcyI6WyJfeXViaWtpcmkiLCJfaW50ZXJvcFJlcXVpcmVEZWZhdWx0IiwicmVxdWlyZSIsIl9ldmVudEtpdCIsIl9yZWxheU5ldHdvcmtMYXllck1hbmFnZXIiLCJfYXV0aG9yIiwiX2ludGVyb3BSZXF1aXJlV2lsZGNhcmQiLCJfa2V5dGFyU3RyYXRlZ3kiLCJfbW9kZWxPYnNlcnZlciIsIl9nZXRSZXF1aXJlV2lsZGNhcmRDYWNoZSIsImUiLCJXZWFrTWFwIiwiciIsInQiLCJfX2VzTW9kdWxlIiwiZGVmYXVsdCIsImhhcyIsImdldCIsIm4iLCJfX3Byb3RvX18iLCJhIiwiT2JqZWN0IiwiZGVmaW5lUHJvcGVydHkiLCJnZXRPd25Qcm9wZXJ0eURlc2NyaXB0b3IiLCJ1IiwicHJvdG90eXBlIiwiaGFzT3duUHJvcGVydHkiLCJjYWxsIiwiaSIsInNldCIsIm9iaiIsIl9kZWZpbmVQcm9wZXJ0eSIsImtleSIsInZhbHVlIiwiX3RvUHJvcGVydHlLZXkiLCJlbnVtZXJhYmxlIiwiY29uZmlndXJhYmxlIiwid3JpdGFibGUiLCJhcmciLCJfdG9QcmltaXRpdmUiLCJTdHJpbmciLCJpbnB1dCIsImhpbnQiLCJwcmltIiwiU3ltYm9sIiwidG9QcmltaXRpdmUiLCJ1bmRlZmluZWQiLCJyZXMiLCJUeXBlRXJyb3IiLCJOdW1iZXIiLCJNQVhfQ09NTUlUUyIsInNvdXJjZSIsIlBFTkRJTkciLCJHSVRMT0ciLCJHSVRIVUJBUEkiLCJleHBvcnRzIiwiR3JhcGhRTENhY2hlIiwiY29uc3RydWN0b3IiLCJieVNsdWciLCJNYXAiLCJyZW1vdGUiLCJzbHVnIiwiZ2V0U2x1ZyIsInRzIiwiZGF0YSIsIkluZmluaXR5IiwiRGF0ZSIsIm5vdyIsIk1BWF9BR0VfTVMiLCJkZWxldGUiLCJVc2VyU3RvcmUiLCJyZXBvc2l0b3J5IiwibG9naW4iLCJjb25maWciLCJlbWl0dGVyIiwiRW1pdHRlciIsInN1YnMiLCJDb21wb3NpdGVEaXNwb3NhYmxlIiwiYWxsVXNlcnMiLCJleGNsdWRlZFVzZXJzIiwiU2V0IiwidXNlcnMiLCJjb21taXR0ZXIiLCJudWxsQXV0aG9yIiwibGFzdCIsImNhY2hlIiwicmVwb3NpdG9yeU9ic2VydmVyIiwiTW9kZWxPYnNlcnZlciIsImZldGNoRGF0YSIsInl1YmlraXJpIiwiZ2V0Q29tbWl0dGVyIiwiYXV0aG9ycyIsImdldEF1dGhvcnMiLCJtYXgiLCJyZW1vdGVzIiwiZ2V0UmVtb3RlcyIsImRpZFVwZGF0ZSIsImxvYWRVc2VycyIsInNldEFjdGl2ZU1vZGVsIiwibG9naW5PYnNlcnZlciIsImFkZCIsIm9ic2VydmUiLCJzcGxpdCIsImZpbHRlciIsImVhY2giLCJsZW5ndGgiLCJkaXNwb3NlIiwiZ2V0QWN0aXZlTW9kZWxEYXRhIiwic2V0Q29tbWl0dGVyIiwiZ2l0aHViUmVtb3RlcyIsIkFycmF5IiwiZnJvbSIsImlzR2l0aHViUmVwbyIsImxvYWRVc2Vyc0Zyb21HcmFwaFFMIiwiYWRkVXNlcnMiLCJzaXplIiwiUHJvbWlzZSIsImFsbCIsImxvYWRNZW50aW9uYWJsZVVzZXJzIiwiZ2V0VG9rZW4iLCJsb2dpbk1vZGVsIiwibG9naW5BY2NvdW50IiwidG9rZW4iLCJVTkFVVEhFTlRJQ0FURUQiLCJJTlNVRkZJQ0lFTlQiLCJFcnJvciIsImNhY2hlZCIsImVuZHBvaW50IiwiZ2V0RW5kcG9pbnQiLCJnZXRBY3RpdmVNb2RlbCIsImdldExvZ2luQWNjb3VudCIsImZldGNoUXVlcnkiLCJSZWxheU5ldHdvcmtMYXllck1hbmFnZXIiLCJnZXRGZXRjaFF1ZXJ5IiwiaGFzTW9yZSIsImN1cnNvciIsInJlbW90ZVVzZXJzIiwicmVzcG9uc2UiLCJuYW1lIiwidGV4dCIsIm93bmVyIiwiZ2V0T3duZXIiLCJnZXRSZXBvIiwiZmlyc3QiLCJhZnRlciIsImVycm9ycyIsImNvbnNvbGUiLCJlcnJvciIsIm1hcCIsIm1lc3NhZ2UiLCJqb2luIiwiY29ubmVjdGlvbiIsIm1lbnRpb25hYmxlVXNlcnMiLCJub2RlcyIsIm5vZGUiLCJlbWFpbCIsIkF1dGhvciIsInB1c2giLCJwYWdlSW5mbyIsImVuZEN1cnNvciIsImhhc05leHRQYWdlIiwibmV4dFNvdXJjZSIsImNoYW5nZWQiLCJjbGVhciIsImF1dGhvciIsImdldEVtYWlsIiwiZmluYWxpemUiLCJ2YWx1ZXMiLCJtYXRjaGVzIiwiaXNOb1JlcGx5Iiwic29ydCIsImNvbXBhcmUiLCJzZXRSZXBvc2l0b3J5Iiwic2V0TG9naW5Nb2RlbCIsImVtaXQiLCJnZXRVc2VycyIsIm9uRGlkVXBkYXRlIiwiY2FsbGJhY2siLCJvbiJdLCJzb3VyY2VzIjpbInVzZXItc3RvcmUuanMiXSwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHl1YmlraXJpIGZyb20gJ3l1YmlraXJpJztcbmltcG9ydCB7RW1pdHRlciwgQ29tcG9zaXRlRGlzcG9zYWJsZX0gZnJvbSAnZXZlbnQta2l0JztcblxuaW1wb3J0IFJlbGF5TmV0d29ya0xheWVyTWFuYWdlciBmcm9tICcuLi9yZWxheS1uZXR3b3JrLWxheWVyLW1hbmFnZXInO1xuaW1wb3J0IEF1dGhvciwge251bGxBdXRob3J9IGZyb20gJy4vYXV0aG9yJztcbmltcG9ydCB7VU5BVVRIRU5USUNBVEVELCBJTlNVRkZJQ0lFTlR9IGZyb20gJy4uL3NoYXJlZC9rZXl0YXItc3RyYXRlZ3knO1xuaW1wb3J0IE1vZGVsT2JzZXJ2ZXIgZnJvbSAnLi9tb2RlbC1vYnNlcnZlcic7XG5cbi8vIFRoaXMgaXMgYSBndWVzcyBhYm91dCB3aGF0IGEgcmVhc29uYWJsZSB2YWx1ZSBpcy4gQ2FuIGFkanVzdCBpZiBwZXJmb3JtYW5jZSBpcyBwb29yLlxuY29uc3QgTUFYX0NPTU1JVFMgPSA1MDAwO1xuXG5leHBvcnQgY29uc3Qgc291cmNlID0ge1xuICBQRU5ESU5HOiBTeW1ib2woJ3BlbmRpbmcnKSxcbiAgR0lUTE9HOiBTeW1ib2woJ2dpdCBsb2cnKSxcbiAgR0lUSFVCQVBJOiBTeW1ib2woJ2dpdGh1YiBBUEknKSxcbn07XG5cbmNsYXNzIEdyYXBoUUxDYWNoZSB7XG4gIC8vIE9uZSBob3VyXG4gIHN0YXRpYyBNQVhfQUdFX01TID0gMy42ZTZcblxuICBjb25zdHJ1Y3RvcigpIHtcbiAgICB0aGlzLmJ5U2x1ZyA9IG5ldyBNYXAoKTtcbiAgfVxuXG4gIGdldChyZW1vdGUpIHtcbiAgICBjb25zdCBzbHVnID0gcmVtb3RlLmdldFNsdWcoKTtcbiAgICBjb25zdCB7dHMsIGRhdGF9ID0gdGhpcy5ieVNsdWcuZ2V0KHNsdWcpIHx8IHtcbiAgICAgIHRzOiAtSW5maW5pdHksXG4gICAgICBkYXRhOiB7fSxcbiAgICB9O1xuXG4gICAgaWYgKERhdGUubm93KCkgLSB0cyA+IHRoaXMuY29uc3RydWN0b3IuTUFYX0FHRV9NUykge1xuICAgICAgdGhpcy5ieVNsdWcuZGVsZXRlKHNsdWcpO1xuICAgICAgcmV0dXJuIG51bGw7XG4gICAgfVxuICAgIHJldHVybiBkYXRhO1xuICB9XG5cbiAgc2V0KHJlbW90ZSwgZGF0YSkge1xuICAgIHRoaXMuYnlTbHVnLnNldChyZW1vdGUuZ2V0U2x1ZygpLCB7dHM6IERhdGUubm93KCksIGRhdGF9KTtcbiAgfVxufVxuXG5leHBvcnQgZGVmYXVsdCBjbGFzcyBVc2VyU3RvcmUge1xuICBjb25zdHJ1Y3Rvcih7cmVwb3NpdG9yeSwgbG9naW4sIGNvbmZpZ30pIHtcbiAgICB0aGlzLmVtaXR0ZXIgPSBuZXcgRW1pdHRlcigpO1xuICAgIHRoaXMuc3VicyA9IG5ldyBDb21wb3NpdGVEaXNwb3NhYmxlKCk7XG5cbiAgICAvLyBUT0RPOiBba3UgMy8yMDE4XSBDb25zaWRlciB1c2luZyBEZXhpZSAoaW5kZXhEQiB3cmFwcGVyKSBsaWtlIERlc2t0b3AgYW5kIHBlcnNpc3QgdXNlcnMgYWNyb3NzIHNlc3Npb25zXG4gICAgdGhpcy5hbGxVc2VycyA9IG5ldyBNYXAoKTtcbiAgICB0aGlzLmV4Y2x1ZGVkVXNlcnMgPSBuZXcgU2V0KCk7XG4gICAgdGhpcy51c2VycyA9IFtdO1xuICAgIHRoaXMuY29tbWl0dGVyID0gbnVsbEF1dGhvcjtcblxuICAgIHRoaXMubGFzdCA9IHtcbiAgICAgIHNvdXJjZTogc291cmNlLlBFTkRJTkcsXG4gICAgICByZXBvc2l0b3J5OiBudWxsLFxuICAgICAgZXhjbHVkZWRVc2VyczogdGhpcy5leGNsdWRlZFVzZXJzLFxuICAgIH07XG4gICAgdGhpcy5jYWNoZSA9IG5ldyBHcmFwaFFMQ2FjaGUoKTtcblxuICAgIHRoaXMucmVwb3NpdG9yeU9ic2VydmVyID0gbmV3IE1vZGVsT2JzZXJ2ZXIoe1xuICAgICAgZmV0Y2hEYXRhOiByID0+IHl1YmlraXJpKHtcbiAgICAgICAgY29tbWl0dGVyOiByLmdldENvbW1pdHRlcigpLFxuICAgICAgICBhdXRob3JzOiByLmdldEF1dGhvcnMoe21heDogTUFYX0NPTU1JVFN9KSxcbiAgICAgICAgcmVtb3Rlczogci5nZXRSZW1vdGVzKCksXG4gICAgICB9KSxcbiAgICAgIGRpZFVwZGF0ZTogKCkgPT4gdGhpcy5sb2FkVXNlcnMoKSxcbiAgICB9KTtcbiAgICB0aGlzLnJlcG9zaXRvcnlPYnNlcnZlci5zZXRBY3RpdmVNb2RlbChyZXBvc2l0b3J5KTtcblxuICAgIHRoaXMubG9naW5PYnNlcnZlciA9IG5ldyBNb2RlbE9ic2VydmVyKHtcbiAgICAgIGRpZFVwZGF0ZTogKCkgPT4gdGhpcy5sb2FkVXNlcnMoKSxcbiAgICB9KTtcbiAgICB0aGlzLmxvZ2luT2JzZXJ2ZXIuc2V0QWN0aXZlTW9kZWwobG9naW4pO1xuXG4gICAgdGhpcy5zdWJzLmFkZChcbiAgICAgIGNvbmZpZy5vYnNlcnZlKCdnaXRodWIuZXhjbHVkZWRVc2VycycsIHZhbHVlID0+IHtcbiAgICAgICAgdGhpcy5leGNsdWRlZFVzZXJzID0gbmV3IFNldChcbiAgICAgICAgICAodmFsdWUgfHwgJycpLnNwbGl0KC9cXHMqLFxccyovKS5maWx0ZXIoZWFjaCA9PiBlYWNoLmxlbmd0aCA+IDApLFxuICAgICAgICApO1xuICAgICAgICByZXR1cm4gdGhpcy5sb2FkVXNlcnMoKTtcbiAgICAgIH0pLFxuICAgICk7XG4gIH1cblxuICBkaXNwb3NlKCkge1xuICAgIHRoaXMuc3Vicy5kaXNwb3NlKCk7XG4gICAgdGhpcy5lbWl0dGVyLmRpc3Bvc2UoKTtcbiAgfVxuXG4gIGFzeW5jIGxvYWRVc2VycygpIHtcbiAgICBjb25zdCBkYXRhID0gdGhpcy5yZXBvc2l0b3J5T2JzZXJ2ZXIuZ2V0QWN0aXZlTW9kZWxEYXRhKCk7XG5cbiAgICBpZiAoIWRhdGEpIHtcbiAgICAgIHJldHVybjtcbiAgICB9XG5cbiAgICB0aGlzLnNldENvbW1pdHRlcihkYXRhLmNvbW1pdHRlcik7XG4gICAgY29uc3QgZ2l0aHViUmVtb3RlcyA9IEFycmF5LmZyb20oZGF0YS5yZW1vdGVzKS5maWx0ZXIocmVtb3RlID0+IHJlbW90ZS5pc0dpdGh1YlJlcG8oKSk7XG5cbiAgICBpZiAoZ2l0aHViUmVtb3Rlcy5sZW5ndGggPiAwKSB7XG4gICAgICBhd2FpdCB0aGlzLmxvYWRVc2Vyc0Zyb21HcmFwaFFMKGdpdGh1YlJlbW90ZXMpO1xuICAgIH0gZWxzZSB7XG4gICAgICB0aGlzLmFkZFVzZXJzKGRhdGEuYXV0aG9ycywgc291cmNlLkdJVExPRyk7XG4gICAgfVxuXG4gICAgLy8gaWYgZm9yIHdoYXRldmVyIHJlYXNvbiwgbm8gY29tbWl0dGVycyBjYW4gYmUgYWRkZWQsIGZhbGwgYmFjayB0b1xuICAgIC8vIHVzaW5nIGdpdCBsb2cgY29tbWl0dGVycyBhcyB0aGUgbGFzdCByZXNvcnRcbiAgICBpZiAodGhpcy5hbGxVc2Vycy5zaXplID09PSAwKSB7XG4gICAgICB0aGlzLmFkZFVzZXJzKGRhdGEuYXV0aG9ycywgc291cmNlLkdJVExPRyk7XG4gICAgfVxuICB9XG5cbiAgbG9hZFVzZXJzRnJvbUdyYXBoUUwocmVtb3Rlcykge1xuICAgIHJldHVybiBQcm9taXNlLmFsbChcbiAgICAgIEFycmF5LmZyb20ocmVtb3RlcywgcmVtb3RlID0+IHRoaXMubG9hZE1lbnRpb25hYmxlVXNlcnMocmVtb3RlKSksXG4gICAgKTtcbiAgfVxuXG4gIGFzeW5jIGdldFRva2VuKGxvZ2luTW9kZWwsIGxvZ2luQWNjb3VudCkge1xuICAgIGlmICghbG9naW5Nb2RlbCkge1xuICAgICAgcmV0dXJuIG51bGw7XG4gICAgfVxuICAgIGNvbnN0IHRva2VuID0gYXdhaXQgbG9naW5Nb2RlbC5nZXRUb2tlbihsb2dpbkFjY291bnQpO1xuICAgIGlmICh0b2tlbiA9PT0gVU5BVVRIRU5USUNBVEVEIHx8IHRva2VuID09PSBJTlNVRkZJQ0lFTlQgfHwgdG9rZW4gaW5zdGFuY2VvZiBFcnJvcikge1xuICAgICAgcmV0dXJuIG51bGw7XG4gICAgfVxuICAgIHJldHVybiB0b2tlbjtcbiAgfVxuXG4gIGFzeW5jIGxvYWRNZW50aW9uYWJsZVVzZXJzKHJlbW90ZSkge1xuICAgIGNvbnN0IGNhY2hlZCA9IHRoaXMuY2FjaGUuZ2V0KHJlbW90ZSk7XG4gICAgaWYgKGNhY2hlZCAhPT0gbnVsbCkge1xuICAgICAgdGhpcy5hZGRVc2VycyhjYWNoZWQsIHNvdXJjZS5HSVRIVUJBUEkpO1xuICAgICAgcmV0dXJuO1xuICAgIH1cblxuICAgIGNvbnN0IGVuZHBvaW50ID0gcmVtb3RlLmdldEVuZHBvaW50KCk7XG4gICAgY29uc3QgdG9rZW4gPSBhd2FpdCB0aGlzLmdldFRva2VuKHRoaXMubG9naW5PYnNlcnZlci5nZXRBY3RpdmVNb2RlbCgpLCBlbmRwb2ludC5nZXRMb2dpbkFjY291bnQoKSk7XG4gICAgaWYgKCF0b2tlbikge1xuICAgICAgcmV0dXJuO1xuICAgIH1cblxuICAgIGNvbnN0IGZldGNoUXVlcnkgPSBSZWxheU5ldHdvcmtMYXllck1hbmFnZXIuZ2V0RmV0Y2hRdWVyeShlbmRwb2ludCwgdG9rZW4pO1xuXG4gICAgbGV0IGhhc01vcmUgPSB0cnVlO1xuICAgIGxldCBjdXJzb3IgPSBudWxsO1xuICAgIGNvbnN0IHJlbW90ZVVzZXJzID0gW107XG5cbiAgICB3aGlsZSAoaGFzTW9yZSkge1xuICAgICAgY29uc3QgcmVzcG9uc2UgPSBhd2FpdCBmZXRjaFF1ZXJ5KHtcbiAgICAgICAgbmFtZTogJ0dldE1lbnRpb25hYmxlVXNlcnMnLFxuICAgICAgICB0ZXh0OiBgXG4gICAgICAgICAgcXVlcnkgR2V0TWVudGlvbmFibGVVc2Vycygkb3duZXI6IFN0cmluZyEsICRuYW1lOiBTdHJpbmchLCAkZmlyc3Q6IEludCEsICRhZnRlcjogU3RyaW5nKSB7XG4gICAgICAgICAgICByZXBvc2l0b3J5KG93bmVyOiAkb3duZXIsIG5hbWU6ICRuYW1lKSB7XG4gICAgICAgICAgICAgIG1lbnRpb25hYmxlVXNlcnMoZmlyc3Q6ICRmaXJzdCwgYWZ0ZXI6ICRhZnRlcikge1xuICAgICAgICAgICAgICAgIG5vZGVzIHtcbiAgICAgICAgICAgICAgICAgIGxvZ2luXG4gICAgICAgICAgICAgICAgICBlbWFpbFxuICAgICAgICAgICAgICAgICAgbmFtZVxuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICBwYWdlSW5mbyB7XG4gICAgICAgICAgICAgICAgICBoYXNOZXh0UGFnZVxuICAgICAgICAgICAgICAgICAgZW5kQ3Vyc29yXG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9XG4gICAgICAgICAgfVxuICAgICAgICBgLFxuICAgICAgfSwge1xuICAgICAgICBvd25lcjogcmVtb3RlLmdldE93bmVyKCksXG4gICAgICAgIG5hbWU6IHJlbW90ZS5nZXRSZXBvKCksXG4gICAgICAgIGZpcnN0OiAxMDAsXG4gICAgICAgIGFmdGVyOiBjdXJzb3IsXG4gICAgICB9KTtcblxuICAgICAgLyogaXN0YW5idWwgaWdub3JlIGlmICovXG4gICAgICBpZiAocmVzcG9uc2UuZXJyb3JzICYmIHJlc3BvbnNlLmVycm9ycy5sZW5ndGggPiAxKSB7XG4gICAgICAgIC8vIGVzbGludC1kaXNhYmxlLW5leHQtbGluZSBuby1jb25zb2xlXG4gICAgICAgIGNvbnNvbGUuZXJyb3IoYEVycm9yIGZldGNoaW5nIG1lbnRpb25hYmxlIHVzZXJzOlxcbiR7cmVzcG9uc2UuZXJyb3JzLm1hcChlID0+IGUubWVzc2FnZSkuam9pbignXFxuJyl9YCk7XG4gICAgICB9XG5cbiAgICAgIGlmICghcmVzcG9uc2UuZGF0YSB8fCAhcmVzcG9uc2UuZGF0YS5yZXBvc2l0b3J5KSB7XG4gICAgICAgIGJyZWFrO1xuICAgICAgfVxuXG4gICAgICBjb25zdCBjb25uZWN0aW9uID0gcmVzcG9uc2UuZGF0YS5yZXBvc2l0b3J5Lm1lbnRpb25hYmxlVXNlcnM7XG4gICAgICBjb25zdCBhdXRob3JzID0gY29ubmVjdGlvbi5ub2Rlcy5tYXAobm9kZSA9PiB7XG4gICAgICAgIGlmIChub2RlLmVtYWlsID09PSAnJykge1xuICAgICAgICAgIG5vZGUuZW1haWwgPSBgJHtub2RlLmxvZ2lufUB1c2Vycy5ub3JlcGx5LmdpdGh1Yi5jb21gO1xuICAgICAgICB9XG5cbiAgICAgICAgcmV0dXJuIG5ldyBBdXRob3Iobm9kZS5lbWFpbCwgbm9kZS5uYW1lLCBub2RlLmxvZ2luKTtcbiAgICAgIH0pO1xuICAgICAgdGhpcy5hZGRVc2VycyhhdXRob3JzLCBzb3VyY2UuR0lUSFVCQVBJKTtcbiAgICAgIHJlbW90ZVVzZXJzLnB1c2goLi4uYXV0aG9ycyk7XG5cbiAgICAgIGN1cnNvciA9IGNvbm5lY3Rpb24ucGFnZUluZm8uZW5kQ3Vyc29yO1xuICAgICAgaGFzTW9yZSA9IGNvbm5lY3Rpb24ucGFnZUluZm8uaGFzTmV4dFBhZ2U7XG4gICAgfVxuXG4gICAgdGhpcy5jYWNoZS5zZXQocmVtb3RlLCByZW1vdGVVc2Vycyk7XG4gIH1cblxuICBhZGRVc2Vycyh1c2VycywgbmV4dFNvdXJjZSkge1xuICAgIGxldCBjaGFuZ2VkID0gZmFsc2U7XG5cbiAgICBpZiAoXG4gICAgICBuZXh0U291cmNlICE9PSB0aGlzLmxhc3Quc291cmNlIHx8XG4gICAgICB0aGlzLnJlcG9zaXRvcnlPYnNlcnZlci5nZXRBY3RpdmVNb2RlbCgpICE9PSB0aGlzLmxhc3QucmVwb3NpdG9yeSB8fFxuICAgICAgdGhpcy5leGNsdWRlZFVzZXJzICE9PSB0aGlzLmxhc3QuZXhjbHVkZWRVc2Vyc1xuICAgICkge1xuICAgICAgY2hhbmdlZCA9IHRydWU7XG4gICAgICB0aGlzLmFsbFVzZXJzLmNsZWFyKCk7XG4gICAgfVxuXG4gICAgZm9yIChjb25zdCBhdXRob3Igb2YgdXNlcnMpIHtcbiAgICAgIGlmICghdGhpcy5hbGxVc2Vycy5oYXMoYXV0aG9yLmdldEVtYWlsKCkpKSB7XG4gICAgICAgIGNoYW5nZWQgPSB0cnVlO1xuICAgICAgfVxuICAgICAgdGhpcy5hbGxVc2Vycy5zZXQoYXV0aG9yLmdldEVtYWlsKCksIGF1dGhvcik7XG4gICAgfVxuXG4gICAgaWYgKGNoYW5nZWQpIHtcbiAgICAgIHRoaXMuZmluYWxpemUoKTtcbiAgICB9XG4gICAgdGhpcy5sYXN0LnNvdXJjZSA9IG5leHRTb3VyY2U7XG4gICAgdGhpcy5sYXN0LnJlcG9zaXRvcnkgPSB0aGlzLnJlcG9zaXRvcnlPYnNlcnZlci5nZXRBY3RpdmVNb2RlbCgpO1xuICAgIHRoaXMubGFzdC5leGNsdWRlZFVzZXJzID0gdGhpcy5leGNsdWRlZFVzZXJzO1xuICB9XG5cbiAgZmluYWxpemUoKSB7XG4gICAgLy8gVE9ETzogW2t1IDMvMjAxOF0gY29uc2lkZXIgc29ydGluZyBiYXNlZCBvbiBtb3N0IHJlY2VudCBhdXRob3JzIG9yIGNvbW1pdCBmcmVxdWVuY3lcbiAgICBjb25zdCB1c2VycyA9IFtdO1xuICAgIGZvciAoY29uc3QgYXV0aG9yIG9mIHRoaXMuYWxsVXNlcnMudmFsdWVzKCkpIHtcbiAgICAgIGlmIChhdXRob3IubWF0Y2hlcyh0aGlzLmNvbW1pdHRlcikpIHsgY29udGludWU7IH1cbiAgICAgIGlmIChhdXRob3IuaXNOb1JlcGx5KCkpIHsgY29udGludWU7IH1cbiAgICAgIGlmICh0aGlzLmV4Y2x1ZGVkVXNlcnMuaGFzKGF1dGhvci5nZXRFbWFpbCgpKSkgeyBjb250aW51ZTsgfVxuXG4gICAgICB1c2Vycy5wdXNoKGF1dGhvcik7XG4gICAgfVxuICAgIHVzZXJzLnNvcnQoQXV0aG9yLmNvbXBhcmUpO1xuICAgIHRoaXMudXNlcnMgPSB1c2VycztcbiAgICB0aGlzLmRpZFVwZGF0ZSgpO1xuICB9XG5cbiAgc2V0UmVwb3NpdG9yeShyZXBvc2l0b3J5KSB7XG4gICAgdGhpcy5yZXBvc2l0b3J5T2JzZXJ2ZXIuc2V0QWN0aXZlTW9kZWwocmVwb3NpdG9yeSk7XG4gIH1cblxuICBzZXRMb2dpbk1vZGVsKGxvZ2luKSB7XG4gICAgdGhpcy5sb2dpbk9ic2VydmVyLnNldEFjdGl2ZU1vZGVsKGxvZ2luKTtcbiAgfVxuXG4gIHNldENvbW1pdHRlcihjb21taXR0ZXIpIHtcbiAgICBjb25zdCBjaGFuZ2VkID0gIXRoaXMuY29tbWl0dGVyLm1hdGNoZXMoY29tbWl0dGVyKTtcbiAgICB0aGlzLmNvbW1pdHRlciA9IGNvbW1pdHRlcjtcbiAgICBpZiAoY2hhbmdlZCkge1xuICAgICAgdGhpcy5maW5hbGl6ZSgpO1xuICAgIH1cbiAgfVxuXG4gIGRpZFVwZGF0ZSgpIHtcbiAgICB0aGlzLmVtaXR0ZXIuZW1pdCgnZGlkLXVwZGF0ZScsIHRoaXMuZ2V0VXNlcnMoKSk7XG4gIH1cblxuICBvbkRpZFVwZGF0ZShjYWxsYmFjaykge1xuICAgIHJldHVybiB0aGlzLmVtaXR0ZXIub24oJ2RpZC11cGRhdGUnLCBjYWxsYmFjayk7XG4gIH1cblxuICBnZXRVc2VycygpIHtcbiAgICByZXR1cm4gdGhpcy51c2VycztcbiAgfVxufVxuIl0sIm1hcHBpbmdzIjoiOzs7Ozs7QUFBQSxJQUFBQSxTQUFBLEdBQUFDLHNCQUFBLENBQUFDLE9BQUE7QUFDQSxJQUFBQyxTQUFBLEdBQUFELE9BQUE7QUFFQSxJQUFBRSx5QkFBQSxHQUFBSCxzQkFBQSxDQUFBQyxPQUFBO0FBQ0EsSUFBQUcsT0FBQSxHQUFBQyx1QkFBQSxDQUFBSixPQUFBO0FBQ0EsSUFBQUssZUFBQSxHQUFBTCxPQUFBO0FBQ0EsSUFBQU0sY0FBQSxHQUFBUCxzQkFBQSxDQUFBQyxPQUFBO0FBQTZDLFNBQUFPLHlCQUFBQyxDQUFBLDZCQUFBQyxPQUFBLG1CQUFBQyxDQUFB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