"use strict";

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.default = void 0;
var _compareSets = _interopRequireDefault(require("compare-sets"));
var _eventKit = require("event-kit");
var _workdirContext = _interopRequireDefault(require("./workdir-context"));
function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }
function ownKeys(e, r) { var t = Object.keys(e); if (Object.getOwnPropertySymbols) { var o = Object.getOwnPropertySymbols(e); r && (o = o.filter(function (r) { return Object.getOwnPropertyDescriptor(e, r).enumerable; })), t.push.apply(t, o); } return t; }
function _objectSpread(e) { for (var r = 1; r < arguments.length; r++) { var t = null != arguments[r] ? arguments[r] : {}; r % 2 ? ownKeys(Object(t), !0).forEach(function (r) { _defineProperty(e, r, t[r]); }) : Object.getOwnPropertyDescriptors ? Object.defineProperties(e, Object.getOwnPropertyDescriptors(t)) : ownKeys(Object(t)).forEach(function (r) { Object.defineProperty(e, r, Object.getOwnPropertyDescriptor(t, r)); }); } return e; }
function _defineProperty(obj, key, value) { key = _toPropertyKey(key); if (key in obj) { Object.defineProperty(obj, key, { value: value, enumerable: true, configurable: true, writable: true }); } else { obj[key] = value; } return obj; }
function _toPropertyKey(arg) { var key = _toPrimitive(arg, "string"); return typeof key === "symbol" ? key : String(key); }
function _toPrimitive(input, hint) { if (typeof input !== "object" || input === null) return input; var prim = input[Symbol.toPrimitive]; if (prim !== undefined) { var res = prim.call(input, hint || "default"); if (typeof res !== "object") return res; throw new TypeError("@@toPrimitive must return a primitive value."); } return (hint === "string" ? String : Number)(input); }
/**
 * Manage a WorkdirContext for each open directory.
 */
class WorkdirContextPool {
  /**
   * Options will be passed to each `WorkdirContext` as it is created.
   */
  constructor(options = {}) {
    this.options = options;
    this.contexts = new Map();
    this.emitter = new _eventKit.Emitter();
  }
  size() {
    return this.contexts.size;
  }

  /**
   * Access the context mapped to a known directory.
   */
  getContext(directory) {
    const {
      pipelineManager
    } = this.options;
    return this.contexts.get(directory) || _workdirContext.default.absent({
      pipelineManager
    });
  }

  /**
   * Return a WorkdirContext whose Repository has at least one remote configured to push to the named GitHub repository.
   * Returns a null context if zero or more than one contexts match.
   */
  async getMatchingContext(host, owner, repo) {
    const matches = await Promise.all(this.withResidentContexts(async (_workdir, context) => {
      const match = await context.getRepository().hasGitHubRemote(host, owner, repo);
      return match ? context : null;
    }));
    const filtered = matches.filter(Boolean);
    return filtered.length === 1 ? filtered[0] : _workdirContext.default.absent(_objectSpread({}, this.options));
  }
  add(directory, options = {}, silenceEmitter = false) {
    if (this.contexts.has(directory)) {
      return this.getContext(directory);
    }
    const context = new _workdirContext.default(directory, _objectSpread({}, this.options, {}, options));
    this.contexts.set(directory, context);
    const disposable = context.subs;
    const forwardEvent = (subMethod, emitEventName) => {
      const emit = () => this.emitter.emit(emitEventName, context);
      disposable.add(context[subMethod](emit));
    };
    forwardEvent('onDidStartObserver', 'did-start-observer');
    forwardEvent('onDidChangeWorkdirOrHead', 'did-change-workdir-or-head');
    forwardEvent('onDidChangeRepositoryState', 'did-change-repository-state');
    forwardEvent('onDidUpdateRepository', 'did-update-repository');
    forwardEvent('onDidDestroyRepository', 'did-destroy-repository');

    // Propagate global cache invalidations across all resident contexts
    disposable.add(context.getRepository().onDidGloballyInvalidate(spec => {
      this.withResidentContexts((_workdir, eachContext) => {
        if (eachContext !== context) {
          eachContext.getRepository().acceptInvalidation(spec);
        }
      });
    }));
    if (!silenceEmitter) {
      this.emitter.emit('did-change-contexts', {
        added: new Set([directory])
      });
    }
    return context;
  }
  replace(directory, options = {}, silenceEmitter = false) {
    this.remove(directory, true);
    this.add(directory, options, true);
    if (!silenceEmitter) {
      this.emitter.emit('did-change-contexts', {
        altered: new Set([directory])
      });
    }
  }
  remove(directory, silenceEmitter = false) {
    const existing = this.contexts.get(directory);
    this.contexts.delete(directory);
    if (existing) {
      existing.destroy();
      if (!silenceEmitter) {
        this.emitter.emit('did-change-contexts', {
          removed: new Set([directory])
        });
      }
    }
  }
  set(directories, options = {}) {
    const previous = new Set(this.contexts.keys());
    const {
      added,
      removed
    } = (0, _compareSets.default)(previous, directories);
    for (const directory of added) {
      this.add(directory, options, true);
    }
    for (const directory of removed) {
      this.remove(directory, true);
    }
    if (added.size !== 0 || removed.size !== 0) {
      this.emitter.emit('did-change-contexts', {
        added,
        removed
      });
    }
  }
  getCurrentWorkDirs() {
    return this.contexts.keys();
  }
  withResidentContexts(callback) {
    const results = [];
    for (const [workdir, context] of this.contexts) {
      results.push(callback(workdir, context));
    }
    return results;
  }
  onDidStartObserver(callback) {
    return this.emitter.on('did-start-observer', callback);
  }
  onDidChangePoolContexts(callback) {
    return this.emitter.on('did-change-contexts', callback);
  }
  onDidChangeWorkdirOrHead(callback) {
    return this.emitter.on('did-change-workdir-or-head', callback);
  }
  onDidChangeRepositoryState(callback) {
    return this.emitter.on('did-change-repository-state', callback);
  }
  onDidUpdateRepository(callback) {
    return this.emitter.on('did-update-repository', callback);
  }
  onDidDestroyRepository(callback) {
    return this.emitter.on('did-destroy-repository', callback);
  }
  clear() {
    const workdirs = new Set();
    this.withResidentContexts(workdir => {
      this.remove(workdir, true);
      workdirs.add(workdir);
    });
    _workdirContext.default.destroyAbsent();
    if (workdirs.size !== 0) {
      this.emitter.emit('did-change-contexts', {
        removed: workdirs
      });
    }
  }
}
exports.default = WorkdirContextPool;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJuYW1lcyI6WyJfY29tcGFyZVNldHMiLCJfaW50ZXJvcFJlcXVpcmVEZWZhdWx0IiwicmVxdWlyZSIsIl9ldmVudEtpdCIsIl93b3JrZGlyQ29udGV4dCIsIm9iaiIsIl9fZXNNb2R1bGUiLCJkZWZhdWx0Iiwib3duS2V5cyIsImUiLCJyIiwidCIsIk9iamVjdCIsImtleXMiLCJnZXRPd25Qcm9wZXJ0eVN5bWJvbHMiLCJvIiwiZmlsdGVyIiwiZ2V0T3duUHJvcGVydHlEZXNjcmlwdG9yIiwiZW51bWVyYWJsZSIsInB1c2giLCJhcHBseSIsIl9vYmplY3RTcHJlYWQiLCJhcmd1bWVudHMiLCJsZW5ndGgiLCJmb3JFYWNoIiwiX2RlZmluZVByb3BlcnR5IiwiZ2V0T3duUHJvcGVydHlEZXNjcmlwdG9ycyIsImRlZmluZVByb3BlcnRpZXMiLCJkZWZpbmVQcm9wZXJ0eSIsImtleSIsInZhbHVlIiwiX3RvUHJvcGVydHlLZXkiLCJjb25maWd1cmFibGUiLCJ3cml0YWJsZSIsImFyZyIsIl90b1ByaW1pdGl2ZSIsIlN0cmluZyIsImlucHV0IiwiaGludCIsInByaW0iLCJTeW1ib2wiLCJ0b1ByaW1pdGl2ZSIsInVuZGVmaW5lZCIsInJlcyIsImNhbGwiLCJUeXBlRXJyb3IiLCJOdW1iZXIiLCJXb3JrZGlyQ29udGV4dFBvb2wiLCJjb25zdHJ1Y3RvciIsIm9wdGlvbnMiLCJjb250ZXh0cyIsIk1hcCIsImVtaXR0ZXIiLCJFbWl0dGVyIiwic2l6ZSIsImdldENvbnRleHQiLCJkaXJlY3RvcnkiLCJwaXBlbGluZU1hbmFnZXIiLCJnZXQiLCJXb3JrZGlyQ29udGV4dCIsImFic2VudCIsImdldE1hdGNoaW5nQ29udGV4dCIsImhvc3QiLCJvd25lciIsInJlcG8iLCJtYXRjaGVzIiwiUHJvbWlzZSIsImFsbCIsIndpdGhSZXNpZGVudENvbnRleHRzIiwiX3dvcmtkaXIiLCJjb250ZXh0IiwibWF0Y2giLCJnZXRSZXBvc2l0b3J5IiwiaGFzR2l0SHViUmVtb3RlIiwiZmlsdGVyZWQiLCJCb29sZWFuIiwiYWRkIiwic2lsZW5jZUVtaXR0ZXIiLCJoYXMiLCJzZXQiLCJkaXNwb3NhYmxlIiwic3VicyIsImZvcndhcmRFdmVudCIsInN1Yk1ldGhvZCIsImVtaXRFdmVudE5hbWUiLCJlbWl0Iiwib25EaWRHbG9iYWxseUludmFsaWRhdGUiLCJzcGVjIiwiZWFjaENvbnRleHQiLCJhY2NlcHRJbnZhbGlkYXRpb24iLCJhZGRlZCIsIlNldCIsInJlcGxhY2UiLCJyZW1vdmUiLCJhbHRlcmVkIiwiZXhpc3RpbmciLCJkZWxldGUiLCJkZXN0cm95IiwicmVtb3ZlZCIsImRpcmVjdG9yaWVzIiwicHJldmlvdXMiLCJjb21wYXJlU2V0cyIsImdldEN1cnJlbnRXb3JrRGlycyIsImNhbGxiYWNrIiwicmVzdWx0cyIsIndvcmtkaXIiLCJvbkRpZFN0YXJ0T2JzZXJ2ZXIiLCJvbiIsIm9uRGlkQ2hhbmdlUG9vbENvbnRleHRzIiwib25EaWRDaGFuZ2VXb3JrZGlyT3JIZWFkIiwib25EaWRDaGFuZ2VSZXBvc2l0b3J5U3RhdGUiLCJvbkRpZFVwZGF0ZVJlcG9zaXRvcnkiLCJvbkRpZERlc3Ryb3lSZXBvc2l0b3J5IiwiY2xlYXIiLCJ3b3JrZGlycyIsImRlc3Ryb3lBYnNlbnQiLCJleHBvcnRzIl0sInNvdXJjZXMiOlsid29ya2Rpci1jb250ZXh0LXBvb2wuanMiXSwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IGNvbXBhcmVTZXRzIGZyb20gJ2NvbXBhcmUtc2V0cyc7XG5cbmltcG9ydCB7RW1pdHRlcn0gZnJvbSAnZXZlbnQta2l0JztcbmltcG9ydCBXb3JrZGlyQ29udGV4dCBmcm9tICcuL3dvcmtkaXItY29udGV4dCc7XG5cbi8qKlxuICogTWFuYWdlIGEgV29ya2RpckNvbnRleHQgZm9yIGVhY2ggb3BlbiBkaXJlY3RvcnkuXG4gKi9cbmV4cG9ydCBkZWZhdWx0IGNsYXNzIFdvcmtkaXJDb250ZXh0UG9vbCB7XG5cbiAgLyoqXG4gICAqIE9wdGlvbnMgd2lsbCBiZSBwYXNzZWQgdG8gZWFjaCBgV29ya2RpckNvbnRleHRgIGFzIGl0IGlzIGNyZWF0ZWQuXG4gICAqL1xuICBjb25zdHJ1Y3RvcihvcHRpb25zID0ge30pIHtcbiAgICB0aGlzLm9wdGlvbnMgPSBvcHRpb25zO1xuXG4gICAgdGhpcy5jb250ZXh0cyA9IG5ldyBNYXAoKTtcbiAgICB0aGlzLmVtaXR0ZXIgPSBuZXcgRW1pdHRlcigpO1xuICB9XG5cbiAgc2l6ZSgpIHtcbiAgICByZXR1cm4gdGhpcy5jb250ZXh0cy5zaXplO1xuICB9XG5cbiAgLyoqXG4gICAqIEFjY2VzcyB0aGUgY29udGV4dCBtYXBwZWQgdG8gYSBrbm93biBkaXJlY3RvcnkuXG4gICAqL1xuICBnZXRDb250ZXh0KGRpcmVjdG9yeSkge1xuICAgIGNvbnN0IHtwaXBlbGluZU1hbmFnZXJ9ID0gdGhpcy5vcHRpb25zO1xuICAgIHJldHVybiB0aGlzLmNvbnRleHRzLmdldChkaXJlY3RvcnkpIHx8IFdvcmtkaXJDb250ZXh0LmFic2VudCh7cGlwZWxpbmVNYW5hZ2VyfSk7XG4gIH1cblxuICAvKipcbiAgICogUmV0dXJuIGEgV29ya2RpckNvbnRleHQgd2hvc2UgUmVwb3NpdG9yeSBoYXMgYXQgbGVhc3Qgb25lIHJlbW90ZSBjb25maWd1cmVkIHRvIHB1c2ggdG8gdGhlIG5hbWVkIEdpdEh1YiByZXBvc2l0b3J5LlxuICAgKiBSZXR1cm5zIGEgbnVsbCBjb250ZXh0IGlmIHplcm8gb3IgbW9yZSB0aGFuIG9uZSBjb250ZXh0cyBtYXRjaC5cbiAgICovXG4gIGFzeW5jIGdldE1hdGNoaW5nQ29udGV4dChob3N0LCBvd25lciwgcmVwbykge1xuICAgIGNvbnN0IG1hdGNoZXMgPSBhd2FpdCBQcm9taXNlLmFsbChcbiAgICAgIHRoaXMud2l0aFJlc2lkZW50Q29udGV4dHMoYXN5bmMgKF93b3JrZGlyLCBjb250ZXh0KSA9PiB7XG4gICAgICAgIGNvbnN0IG1hdGNoID0gYXdhaXQgY29udGV4dC5nZXRSZXBvc2l0b3J5KCkuaGFzR2l0SHViUmVtb3RlKGhvc3QsIG93bmVyLCByZXBvKTtcbiAgICAgICAgcmV0dXJuIG1hdGNoID8gY29udGV4dCA6IG51bGw7XG4gICAgICB9KSxcbiAgICApO1xuICAgIGNvbnN0IGZpbHRlcmVkID0gbWF0Y2hlcy5maWx0ZXIoQm9vbGVhbik7XG5cbiAgICByZXR1cm4gZmlsdGVyZWQubGVuZ3RoID09PSAxID8gZmlsdGVyZWRbMF0gOiBXb3JrZGlyQ29udGV4dC5hYnNlbnQoey4uLnRoaXMub3B0aW9uc30pO1xuICB9XG5cbiAgYWRkKGRpcmVjdG9yeSwgb3B0aW9ucyA9IHt9LCBzaWxlbmNlRW1pdHRlciA9IGZhbHNlKSB7XG4gICAgaWYgKHRoaXMuY29udGV4dHMuaGFzKGRpcmVjdG9yeSkpIHtcbiAgICAgIHJldHVybiB0aGlzLmdldENvbnRleHQoZGlyZWN0b3J5KTtcbiAgICB9XG5cbiAgICBjb25zdCBjb250ZXh0ID0gbmV3IFdvcmtkaXJDb250ZXh0KGRpcmVjdG9yeSwgey4uLnRoaXMub3B0aW9ucywgLi4ub3B0aW9uc30pO1xuICAgIHRoaXMuY29udGV4dHMuc2V0KGRpcmVjdG9yeSwgY29udGV4dCk7XG5cbiAgICBjb25zdCBkaXNwb3NhYmxlID0gY29udGV4dC5zdWJzO1xuXG4gICAgY29uc3QgZm9yd2FyZEV2ZW50ID0gKHN1Yk1ldGhvZCwgZW1pdEV2ZW50TmFtZSkgPT4ge1xuICAgICAgY29uc3QgZW1pdCA9ICgpID0+IHRoaXMuZW1pdHRlci5lbWl0KGVtaXRFdmVudE5hbWUsIGNvbnRleHQpO1xuICAgICAgZGlzcG9zYWJsZS5hZGQoY29udGV4dFtzdWJNZXRob2RdKGVtaXQpKTtcbiAgICB9O1xuXG4gICAgZm9yd2FyZEV2ZW50KCdvbkRpZFN0YXJ0T2JzZXJ2ZXInLCAnZGlkLXN0YXJ0LW9ic2VydmVyJyk7XG4gICAgZm9yd2FyZEV2ZW50KCdvbkRpZENoYW5nZVdvcmtkaXJPckhlYWQnLCAnZGlkLWNoYW5nZS13b3JrZGlyLW9yLWhlYWQnKTtcbiAgICBmb3J3YXJkRXZlbnQoJ29uRGlkQ2hhbmdlUmVwb3NpdG9yeVN0YXRlJywgJ2RpZC1jaGFuZ2UtcmVwb3NpdG9yeS1zdGF0ZScpO1xuICAgIGZvcndhcmRFdmVudCgnb25EaWRVcGRhdGVSZXBvc2l0b3J5JywgJ2RpZC11cGRhdGUtcmVwb3NpdG9yeScpO1xuICAgIGZvcndhcmRFdmVudCgnb25EaWREZXN0cm95UmVwb3NpdG9yeScsICdkaWQtZGVzdHJveS1yZXBvc2l0b3J5Jyk7XG5cbiAgICAvLyBQcm9wYWdhdGUgZ2xvYmFsIGNhY2hlIGludmFsaWRhdGlvbnMgYWNyb3NzIGFsbCByZXNpZGVudCBjb250ZXh0c1xuICAgIGRpc3Bvc2FibGUuYWRkKGNvbnRleHQuZ2V0UmVwb3NpdG9yeSgpLm9uRGlkR2xvYmFsbHlJbnZhbGlkYXRlKHNwZWMgPT4ge1xuICAgICAgdGhpcy53aXRoUmVzaWRlbnRDb250ZXh0cygoX3dvcmtkaXIsIGVhY2hDb250ZXh0KSA9PiB7XG4gICAgICAgIGlmIChlYWNoQ29udGV4dCAhPT0gY29udGV4dCkge1xuICAgICAgICAgIGVhY2hDb250ZXh0LmdldFJlcG9zaXRvcnkoKS5hY2NlcHRJbnZhbGlkYXRpb24oc3BlYyk7XG4gICAgICAgIH1cbiAgICAgIH0pO1xuICAgIH0pKTtcblxuICAgIGlmICghc2lsZW5jZUVtaXR0ZXIpIHtcbiAgICAgIHRoaXMuZW1pdHRlci5lbWl0KCdkaWQtY2hhbmdlLWNvbnRleHRzJywge2FkZGVkOiBuZXcgU2V0KFtkaXJlY3RvcnldKX0pO1xuICAgIH1cblxuICAgIHJldHVybiBjb250ZXh0O1xuICB9XG5cbiAgcmVwbGFjZShkaXJlY3RvcnksIG9wdGlvbnMgPSB7fSwgc2lsZW5jZUVtaXR0ZXIgPSBmYWxzZSkge1xuICAgIHRoaXMucmVtb3ZlKGRpcmVjdG9yeSwgdHJ1ZSk7XG4gICAgdGhpcy5hZGQoZGlyZWN0b3J5LCBvcHRpb25zLCB0cnVlKTtcblxuICAgIGlmICghc2lsZW5jZUVtaXR0ZXIpIHtcbiAgICAgIHRoaXMuZW1pdHRlci5lbWl0KCdkaWQtY2hhbmdlLWNvbnRleHRzJywge2FsdGVyZWQ6IG5ldyBTZXQoW2RpcmVjdG9yeV0pfSk7XG4gICAgfVxuICB9XG5cbiAgcmVtb3ZlKGRpcmVjdG9yeSwgc2lsZW5jZUVtaXR0ZXIgPSBmYWxzZSkge1xuICAgIGNvbnN0IGV4aXN0aW5nID0gdGhpcy5jb250ZXh0cy5nZXQoZGlyZWN0b3J5KTtcbiAgICB0aGlzLmNvbnRleHRzLmRlbGV0ZShkaXJlY3RvcnkpO1xuXG4gICAgaWYgKGV4aXN0aW5nKSB7XG4gICAgICBleGlzdGluZy5kZXN0cm95KCk7XG5cbiAgICAgIGlmICghc2lsZW5jZUVtaXR0ZXIpIHtcbiAgICAgICAgdGhpcy5lbWl0dGVyLmVtaXQoJ2RpZC1jaGFuZ2UtY29udGV4dHMnLCB7cmVtb3ZlZDogbmV3IFNldChbZGlyZWN0b3J5XSl9KTtcbiAgICAgIH1cbiAgICB9XG4gIH1cblxuICBzZXQoZGlyZWN0b3JpZXMsIG9wdGlvbnMgPSB7fSkge1xuICAgIGNvbnN0IHByZXZpb3VzID0gbmV3IFNldCh0aGlzLmNvbnRleHRzLmtleXMoKSk7XG4gICAgY29uc3Qge2FkZGVkLCByZW1vdmVkfSA9IGNvbXBhcmVTZXRzKHByZXZpb3VzLCBkaXJlY3Rvcmllcyk7XG5cbiAgICBmb3IgKGNvbnN0IGRpcmVjdG9yeSBvZiBhZGRlZCkge1xuICAgICAgdGhpcy5hZGQoZGlyZWN0b3J5LCBvcHRpb25zLCB0cnVlKTtcbiAgICB9XG4gICAgZm9yIChjb25zdCBkaXJlY3Rvcnkgb2YgcmVtb3ZlZCkge1xuICAgICAgdGhpcy5yZW1vdmUoZGlyZWN0b3J5LCB0cnVlKTtcbiAgICB9XG5cbiAgICBpZiAoYWRkZWQuc2l6ZSAhPT0gMCB8fCByZW1vdmVkLnNpemUgIT09IDApIHtcbiAgICAgIHRoaXMuZW1pdHRlci5lbWl0KCdkaWQtY2hhbmdlLWNvbnRleHRzJywge2FkZGVkLCByZW1vdmVkfSk7XG4gICAgfVxuICB9XG5cbiAgZ2V0Q3VycmVudFdvcmtEaXJzKCkge1xuICAgIHJldHVybiB0aGlzLmNvbnRleHRzLmtleXMoKTtcbiAgfVxuXG4gIHdpdGhSZXNpZGVudENvbnRleHRzKGNhbGxiYWNrKSB7XG4gICAgY29uc3QgcmVzdWx0cyA9IFtdO1xuICAgIGZvciAoY29uc3QgW3dvcmtkaXIsIGNvbnRleHRdIG9mIHRoaXMuY29udGV4dHMpIHtcbiAgICAgIHJlc3VsdHMucHVzaChjYWxsYmFjayh3b3JrZGlyLCBjb250ZXh0KSk7XG4gICAgfVxuICAgIHJldHVybiByZXN1bHRzO1xuICB9XG5cbiAgb25EaWRTdGFydE9ic2VydmVyKGNhbGxiYWNrKSB7XG4gICAgcmV0dXJuIHRoaXMuZW1pdHRlci5vbignZGlkLXN0YXJ0LW9ic2VydmVyJywgY2FsbGJhY2spO1xuICB9XG5cbiAgb25EaWRDaGFuZ2VQb29sQ29udGV4dHMoY2FsbGJhY2spIHtcbiAgICByZXR1cm4gdGhpcy5lbWl0dGVyLm9uKCdkaWQtY2hhbmdlLWNvbnRleHRzJywgY2FsbGJhY2spO1xuICB9XG5cbiAgb25EaWRDaGFuZ2VXb3JrZGlyT3JIZWFkKGNhbGxiYWNrKSB7XG4gICAgcmV0dXJuIHRoaXMuZW1pdHRlci5vbignZGlkLWNoYW5nZS13b3JrZGlyLW9yLWhlYWQnLCBjYWxsYmFjayk7XG4gIH1cblxuICBvbkRpZENoYW5nZVJlcG9zaXRvcnlTdGF0ZShjYWxsYmFjaykge1xuICAgIHJldHVybiB0aGlzLmVtaXR0ZXIub24oJ2RpZC1jaGFuZ2UtcmVwb3NpdG9yeS1zdGF0ZScsIGNhbGxiYWNrKTtcbiAgfVxuXG4gIG9uRGlkVXBkYXRlUmVwb3NpdG9yeShjYWxsYmFjaykge1xuICAgIHJldHVybiB0aGlzLmVtaXR0ZXIub24oJ2RpZC11cGRhdGUtcmVwb3NpdG9yeScsIGNhbGxiYWNrKTtcbiAgfVxuXG4gIG9uRGlkRGVzdHJveVJlcG9zaXRvcnkoY2FsbGJhY2spIHtcbiAgICByZXR1cm4gdGhpcy5lbWl0dGVyLm9uKCdkaWQtZGVzdHJveS1yZXBvc2l0b3J5JywgY2FsbGJhY2spO1xuICB9XG5cbiAgY2xlYXIoKSB7XG4gICAgY29uc3Qgd29ya2RpcnMgPSBuZXcgU2V0KCk7XG5cbiAgICB0aGlzLndpdGhSZXNpZGVudENvbnRleHRzKHdvcmtkaXIgPT4ge1xuICAgICAgdGhpcy5yZW1vdmUod29ya2RpciwgdHJ1ZSk7XG4gICAgICB3b3JrZGlycy5hZGQod29ya2Rpcik7XG4gICAgfSk7XG5cbiAgICBXb3JrZGlyQ29udGV4dC5kZXN0cm95QWJzZW50KCk7XG5cbiAgICBpZiAod29ya2RpcnMuc2l6ZSAhPT0gMCkge1xuICAgICAgdGhpcy5lbWl0dGVyLmVtaXQoJ2RpZC1jaGFuZ2UtY29udGV4dHMnLCB7cmVtb3ZlZDogd29ya2RpcnN9KTtcbiAgICB9XG4gIH1cbn1cbiJdLCJtYXBwaW5ncyI6Ijs7Ozs7O0FBQUEsSUFBQUEsWUFBQSxHQUFBQyxzQkFBQSxDQUFBQyxPQUFBO0FBRUEsSUFBQUMsU0FBQSxHQUFBRCxPQUFBO0FBQ0EsSUFBQUUsZUFBQSxHQUFBSCxzQkFBQSxDQUFBQyxPQUFBO0FBQStDLFNBQUFELHVCQUFBSSxHQUFBLFdBQUFBLEdBQUEsSUFBQUEsR0FBQSxDQUFBQyxVQUFBLEdBQUFELEdBQUEsS0FBQUUsT0FBQSxFQUFBRixHQUFBO0FBQUEsU0FBQUcsUUFBQUMsQ0FBQSxFQUFBQyxDQUFBLFFBQUFDLENBQUEsR0FBQUMsTUFBQSxDQUFBQyxJQUFBLENBQUFKLENBQUEsT0FBQUcsTUFBQSxDQUFBRSxxQkFBQSxRQUFBQyxDQUFBLEdBQUFILE1BQUEsQ0FBQUUscUJBQUEsQ0FBQUwsQ0FBQSxHQUFBQyxDQUFBLEtBQUFLLENBQUEsR0FBQUEsQ0FBQSxDQUFBQyxNQUFBLFdBQUFOLENBQUEsV0FBQUUsTUFBQSxDQUFBSyx3QkFBQSxDQUFBUixDQUFBLEVBQUFDLENBQUEsRUFBQVEsVUFBQSxPQUFBUCxDQUFBLENBQUFRLElBQUEsQ0FBQUMsS0FBQSxDQUFBVCxDQUFBLEVBQUFJLENBQUEsWUFBQUosQ0FBQTtBQUFBLFNBQUFVLGNBQUFaLENBQUEsYUFBQUMsQ0FBQSxNQUFBQSxDQUFBLEdBQUFZLFNBQUEsQ0FBQUMsTUFBQSxFQUFBYixDQUFB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