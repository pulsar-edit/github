"use strict";

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.default = void 0;
var _compareSets = _interopRequireDefault(require("compare-sets"));
var _eventKit = require("event-kit");
var _workdirContext = _interopRequireDefault(require("./workdir-context"));
function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }
function ownKeys(object, enumerableOnly) { var keys = Object.keys(object); if (Object.getOwnPropertySymbols) { var symbols = Object.getOwnPropertySymbols(object); enumerableOnly && (symbols = symbols.filter(function (sym) { return Object.getOwnPropertyDescriptor(object, sym).enumerable; })), keys.push.apply(keys, symbols); } return keys; }
function _objectSpread(target) { for (var i = 1; i < arguments.length; i++) { var source = null != arguments[i] ? arguments[i] : {}; i % 2 ? ownKeys(Object(source), !0).forEach(function (key) { _defineProperty(target, key, source[key]); }) : Object.getOwnPropertyDescriptors ? Object.defineProperties(target, Object.getOwnPropertyDescriptors(source)) : ownKeys(Object(source)).forEach(function (key) { Object.defineProperty(target, key, Object.getOwnPropertyDescriptor(source, key)); }); } return target; }
function _defineProperty(obj, key, value) { key = _toPropertyKey(key); if (key in obj) { Object.defineProperty(obj, key, { value: value, enumerable: true, configurable: true, writable: true }); } else { obj[key] = value; } return obj; }
function _toPropertyKey(arg) { var key = _toPrimitive(arg, "string"); return typeof key === "symbol" ? key : String(key); }
function _toPrimitive(input, hint) { if (typeof input !== "object" || input === null) return input; var prim = input[Symbol.toPrimitive]; if (prim !== undefined) { var res = prim.call(input, hint || "default"); if (typeof res !== "object") return res; throw new TypeError("@@toPrimitive must return a primitive value."); } return (hint === "string" ? String : Number)(input); }
/**
 * Manage a WorkdirContext for each open directory.
 */
class WorkdirContextPool {
  /**
   * Options will be passed to each `WorkdirContext` as it is created.
   */
  constructor(options = {}) {
    this.options = options;
    this.contexts = new Map();
    this.emitter = new _eventKit.Emitter();
  }
  size() {
    return this.contexts.size;
  }

  /**
   * Access the context mapped to a known directory.
   */
  getContext(directory) {
    const {
      pipelineManager
    } = this.options;
    return this.contexts.get(directory) || _workdirContext.default.absent({
      pipelineManager
    });
  }

  /**
   * Return a WorkdirContext whose Repository has at least one remote configured to push to the named GitHub repository.
   * Returns a null context if zero or more than one contexts match.
   */
  async getMatchingContext(host, owner, repo) {
    const matches = await Promise.all(this.withResidentContexts(async (_workdir, context) => {
      const match = await context.getRepository().hasGitHubRemote(host, owner, repo);
      return match ? context : null;
    }));
    const filtered = matches.filter(Boolean);
    return filtered.length === 1 ? filtered[0] : _workdirContext.default.absent(_objectSpread({}, this.options));
  }
  add(directory, options = {}, silenceEmitter = false) {
    if (this.contexts.has(directory)) {
      return this.getContext(directory);
    }
    const context = new _workdirContext.default(directory, _objectSpread({}, this.options, {}, options));
    this.contexts.set(directory, context);
    const disposable = context.subs;
    const forwardEvent = (subMethod, emitEventName) => {
      const emit = () => this.emitter.emit(emitEventName, context);
      disposable.add(context[subMethod](emit));
    };
    forwardEvent('onDidStartObserver', 'did-start-observer');
    forwardEvent('onDidChangeWorkdirOrHead', 'did-change-workdir-or-head');
    forwardEvent('onDidChangeRepositoryState', 'did-change-repository-state');
    forwardEvent('onDidUpdateRepository', 'did-update-repository');
    forwardEvent('onDidDestroyRepository', 'did-destroy-repository');

    // Propagate global cache invalidations across all resident contexts
    disposable.add(context.getRepository().onDidGloballyInvalidate(spec => {
      this.withResidentContexts((_workdir, eachContext) => {
        if (eachContext !== context) {
          eachContext.getRepository().acceptInvalidation(spec);
        }
      });
    }));
    if (!silenceEmitter) {
      this.emitter.emit('did-change-contexts', {
        added: new Set([directory])
      });
    }
    return context;
  }
  replace(directory, options = {}, silenceEmitter = false) {
    this.remove(directory, true);
    this.add(directory, options, true);
    if (!silenceEmitter) {
      this.emitter.emit('did-change-contexts', {
        altered: new Set([directory])
      });
    }
  }
  remove(directory, silenceEmitter = false) {
    const existing = this.contexts.get(directory);
    this.contexts.delete(directory);
    if (existing) {
      existing.destroy();
      if (!silenceEmitter) {
        this.emitter.emit('did-change-contexts', {
          removed: new Set([directory])
        });
      }
    }
  }
  set(directories, options = {}) {
    const previous = new Set(this.contexts.keys());
    const {
      added,
      removed
    } = (0, _compareSets.default)(previous, directories);
    for (const directory of added) {
      this.add(directory, options, true);
    }
    for (const directory of removed) {
      this.remove(directory, true);
    }
    if (added.size !== 0 || removed.size !== 0) {
      this.emitter.emit('did-change-contexts', {
        added,
        removed
      });
    }
  }
  getCurrentWorkDirs() {
    return this.contexts.keys();
  }
  withResidentContexts(callback) {
    const results = [];
    for (const [workdir, context] of this.contexts) {
      results.push(callback(workdir, context));
    }
    return results;
  }
  onDidStartObserver(callback) {
    return this.emitter.on('did-start-observer', callback);
  }
  onDidChangePoolContexts(callback) {
    return this.emitter.on('did-change-contexts', callback);
  }
  onDidChangeWorkdirOrHead(callback) {
    return this.emitter.on('did-change-workdir-or-head', callback);
  }
  onDidChangeRepositoryState(callback) {
    return this.emitter.on('did-change-repository-state', callback);
  }
  onDidUpdateRepository(callback) {
    return this.emitter.on('did-update-repository', callback);
  }
  onDidDestroyRepository(callback) {
    return this.emitter.on('did-destroy-repository', callback);
  }
  clear() {
    const workdirs = new Set();
    this.withResidentContexts(workdir => {
      this.remove(workdir, true);
      workdirs.add(workdir);
    });
    _workdirContext.default.destroyAbsent();
    if (workdirs.size !== 0) {
      this.emitter.emit('did-change-contexts', {
        removed: workdirs
      });
    }
  }
}
exports.default = WorkdirContextPool;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJuYW1lcyI6WyJfY29tcGFyZVNldHMiLCJfaW50ZXJvcFJlcXVpcmVEZWZhdWx0IiwicmVxdWlyZSIsIl9ldmVudEtpdCIsIl93b3JrZGlyQ29udGV4dCIsIm9iaiIsIl9fZXNNb2R1bGUiLCJkZWZhdWx0Iiwib3duS2V5cyIsIm9iamVjdCIsImVudW1lcmFibGVPbmx5Iiwia2V5cyIsIk9iamVjdCIsImdldE93blByb3BlcnR5U3ltYm9scyIsInN5bWJvbHMiLCJmaWx0ZXIiLCJzeW0iLCJnZXRPd25Qcm9wZXJ0eURlc2NyaXB0b3IiLCJlbnVtZXJhYmxlIiwicHVzaCIsImFwcGx5IiwiX29iamVjdFNwcmVhZCIsInRhcmdldCIsImkiLCJhcmd1bWVudHMiLCJsZW5ndGgiLCJzb3VyY2UiLCJmb3JFYWNoIiwia2V5IiwiX2RlZmluZVByb3BlcnR5IiwiZ2V0T3duUHJvcGVydHlEZXNjcmlwdG9ycyIsImRlZmluZVByb3BlcnRpZXMiLCJkZWZpbmVQcm9wZXJ0eSIsInZhbHVlIiwiX3RvUHJvcGVydHlLZXkiLCJjb25maWd1cmFibGUiLCJ3cml0YWJsZSIsImFyZyIsIl90b1ByaW1pdGl2ZSIsIlN0cmluZyIsImlucHV0IiwiaGludCIsInByaW0iLCJTeW1ib2wiLCJ0b1ByaW1pdGl2ZSIsInVuZGVmaW5lZCIsInJlcyIsImNhbGwiLCJUeXBlRXJyb3IiLCJOdW1iZXIiLCJXb3JrZGlyQ29udGV4dFBvb2wiLCJjb25zdHJ1Y3RvciIsIm9wdGlvbnMiLCJjb250ZXh0cyIsIk1hcCIsImVtaXR0ZXIiLCJFbWl0dGVyIiwic2l6ZSIsImdldENvbnRleHQiLCJkaXJlY3RvcnkiLCJwaXBlbGluZU1hbmFnZXIiLCJnZXQiLCJXb3JrZGlyQ29udGV4dCIsImFic2VudCIsImdldE1hdGNoaW5nQ29udGV4dCIsImhvc3QiLCJvd25lciIsInJlcG8iLCJtYXRjaGVzIiwiUHJvbWlzZSIsImFsbCIsIndpdGhSZXNpZGVudENvbnRleHRzIiwiX3dvcmtkaXIiLCJjb250ZXh0IiwibWF0Y2giLCJnZXRSZXBvc2l0b3J5IiwiaGFzR2l0SHViUmVtb3RlIiwiZmlsdGVyZWQiLCJCb29sZWFuIiwiYWRkIiwic2lsZW5jZUVtaXR0ZXIiLCJoYXMiLCJzZXQiLCJkaXNwb3NhYmxlIiwic3VicyIsImZvcndhcmRFdmVudCIsInN1Yk1ldGhvZCIsImVtaXRFdmVudE5hbWUiLCJlbWl0Iiwib25EaWRHbG9iYWxseUludmFsaWRhdGUiLCJzcGVjIiwiZWFjaENvbnRleHQiLCJhY2NlcHRJbnZhbGlkYXRpb24iLCJhZGRlZCIsIlNldCIsInJlcGxhY2UiLCJyZW1vdmUiLCJhbHRlcmVkIiwiZXhpc3RpbmciLCJkZWxldGUiLCJkZXN0cm95IiwicmVtb3ZlZCIsImRpcmVjdG9yaWVzIiwicHJldmlvdXMiLCJjb21wYXJlU2V0cyIsImdldEN1cnJlbnRXb3JrRGlycyIsImNhbGxiYWNrIiwicmVzdWx0cyIsIndvcmtkaXIiLCJvbkRpZFN0YXJ0T2JzZXJ2ZXIiLCJvbiIsIm9uRGlkQ2hhbmdlUG9vbENvbnRleHRzIiwib25EaWRDaGFuZ2VXb3JrZGlyT3JIZWFkIiwib25EaWRDaGFuZ2VSZXBvc2l0b3J5U3RhdGUiLCJvbkRpZFVwZGF0ZVJlcG9zaXRvcnkiLCJvbkRpZERlc3Ryb3lSZXBvc2l0b3J5IiwiY2xlYXIiLCJ3b3JrZGlycyIsImRlc3Ryb3lBYnNlbnQiLCJleHBvcnRzIl0sInNvdXJjZXMiOlsid29ya2Rpci1jb250ZXh0LXBvb2wuanMiXSwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IGNvbXBhcmVTZXRzIGZyb20gJ2NvbXBhcmUtc2V0cyc7XG5cbmltcG9ydCB7RW1pdHRlcn0gZnJvbSAnZXZlbnQta2l0JztcbmltcG9ydCBXb3JrZGlyQ29udGV4dCBmcm9tICcuL3dvcmtkaXItY29udGV4dCc7XG5cbi8qKlxuICogTWFuYWdlIGEgV29ya2RpckNvbnRleHQgZm9yIGVhY2ggb3BlbiBkaXJlY3RvcnkuXG4gKi9cbmV4cG9ydCBkZWZhdWx0IGNsYXNzIFdvcmtkaXJDb250ZXh0UG9vbCB7XG5cbiAgLyoqXG4gICAqIE9wdGlvbnMgd2lsbCBiZSBwYXNzZWQgdG8gZWFjaCBgV29ya2RpckNvbnRleHRgIGFzIGl0IGlzIGNyZWF0ZWQuXG4gICAqL1xuICBjb25zdHJ1Y3RvcihvcHRpb25zID0ge30pIHtcbiAgICB0aGlzLm9wdGlvbnMgPSBvcHRpb25zO1xuXG4gICAgdGhpcy5jb250ZXh0cyA9IG5ldyBNYXAoKTtcbiAgICB0aGlzLmVtaXR0ZXIgPSBuZXcgRW1pdHRlcigpO1xuICB9XG5cbiAgc2l6ZSgpIHtcbiAgICByZXR1cm4gdGhpcy5jb250ZXh0cy5zaXplO1xuICB9XG5cbiAgLyoqXG4gICAqIEFjY2VzcyB0aGUgY29udGV4dCBtYXBwZWQgdG8gYSBrbm93biBkaXJlY3RvcnkuXG4gICAqL1xuICBnZXRDb250ZXh0KGRpcmVjdG9yeSkge1xuICAgIGNvbnN0IHtwaXBlbGluZU1hbmFnZXJ9ID0gdGhpcy5vcHRpb25zO1xuICAgIHJldHVybiB0aGlzLmNvbnRleHRzLmdldChkaXJlY3RvcnkpIHx8IFdvcmtkaXJDb250ZXh0LmFic2VudCh7cGlwZWxpbmVNYW5hZ2VyfSk7XG4gIH1cblxuICAvKipcbiAgICogUmV0dXJuIGEgV29ya2RpckNvbnRleHQgd2hvc2UgUmVwb3NpdG9yeSBoYXMgYXQgbGVhc3Qgb25lIHJlbW90ZSBjb25maWd1cmVkIHRvIHB1c2ggdG8gdGhlIG5hbWVkIEdpdEh1YiByZXBvc2l0b3J5LlxuICAgKiBSZXR1cm5zIGEgbnVsbCBjb250ZXh0IGlmIHplcm8gb3IgbW9yZSB0aGFuIG9uZSBjb250ZXh0cyBtYXRjaC5cbiAgICovXG4gIGFzeW5jIGdldE1hdGNoaW5nQ29udGV4dChob3N0LCBvd25lciwgcmVwbykge1xuICAgIGNvbnN0IG1hdGNoZXMgPSBhd2FpdCBQcm9taXNlLmFsbChcbiAgICAgIHRoaXMud2l0aFJlc2lkZW50Q29udGV4dHMoYXN5bmMgKF93b3JrZGlyLCBjb250ZXh0KSA9PiB7XG4gICAgICAgIGNvbnN0IG1hdGNoID0gYXdhaXQgY29udGV4dC5nZXRSZXBvc2l0b3J5KCkuaGFzR2l0SHViUmVtb3RlKGhvc3QsIG93bmVyLCByZXBvKTtcbiAgICAgICAgcmV0dXJuIG1hdGNoID8gY29udGV4dCA6IG51bGw7XG4gICAgICB9KSxcbiAgICApO1xuICAgIGNvbnN0IGZpbHRlcmVkID0gbWF0Y2hlcy5maWx0ZXIoQm9vbGVhbik7XG5cbiAgICByZXR1cm4gZmlsdGVyZWQubGVuZ3RoID09PSAxID8gZmlsdGVyZWRbMF0gOiBXb3JrZGlyQ29udGV4dC5hYnNlbnQoey4uLnRoaXMub3B0aW9uc30pO1xuICB9XG5cbiAgYWRkKGRpcmVjdG9yeSwgb3B0aW9ucyA9IHt9LCBzaWxlbmNlRW1pdHRlciA9IGZhbHNlKSB7XG4gICAgaWYgKHRoaXMuY29udGV4dHMuaGFzKGRpcmVjdG9yeSkpIHtcbiAgICAgIHJldHVybiB0aGlzLmdldENvbnRleHQoZGlyZWN0b3J5KTtcbiAgICB9XG5cbiAgICBjb25zdCBjb250ZXh0ID0gbmV3IFdvcmtkaXJDb250ZXh0KGRpcmVjdG9yeSwgey4uLnRoaXMub3B0aW9ucywgLi4ub3B0aW9uc30pO1xuICAgIHRoaXMuY29udGV4dHMuc2V0KGRpcmVjdG9yeSwgY29udGV4dCk7XG5cbiAgICBjb25zdCBkaXNwb3NhYmxlID0gY29udGV4dC5zdWJzO1xuXG4gICAgY29uc3QgZm9yd2FyZEV2ZW50ID0gKHN1Yk1ldGhvZCwgZW1pdEV2ZW50TmFtZSkgPT4ge1xuICAgICAgY29uc3QgZW1pdCA9ICgpID0+IHRoaXMuZW1pdHRlci5lbWl0KGVtaXRFdmVudE5hbWUsIGNvbnRleHQpO1xuICAgICAgZGlzcG9zYWJsZS5hZGQoY29udGV4dFtzdWJNZXRob2RdKGVtaXQpKTtcbiAgICB9O1xuXG4gICAgZm9yd2FyZEV2ZW50KCdvbkRpZFN0YXJ0T2JzZXJ2ZXInLCAnZGlkLXN0YXJ0LW9ic2VydmVyJyk7XG4gICAgZm9yd2FyZEV2ZW50KCdvbkRpZENoYW5nZVdvcmtkaXJPckhlYWQnLCAnZGlkLWNoYW5nZS13b3JrZGlyLW9yLWhlYWQnKTtcbiAgICBmb3J3YXJkRXZlbnQoJ29uRGlkQ2hhbmdlUmVwb3NpdG9yeVN0YXRlJywgJ2RpZC1jaGFuZ2UtcmVwb3NpdG9yeS1zdGF0ZScpO1xuICAgIGZvcndhcmRFdmVudCgnb25EaWRVcGRhdGVSZXBvc2l0b3J5JywgJ2RpZC11cGRhdGUtcmVwb3NpdG9yeScpO1xuICAgIGZvcndhcmRFdmVudCgnb25EaWREZXN0cm95UmVwb3NpdG9yeScsICdkaWQtZGVzdHJveS1yZXBvc2l0b3J5Jyk7XG5cbiAgICAvLyBQcm9wYWdhdGUgZ2xvYmFsIGNhY2hlIGludmFsaWRhdGlvbnMgYWNyb3NzIGFsbCByZXNpZGVudCBjb250ZXh0c1xuICAgIGRpc3Bvc2FibGUuYWRkKGNvbnRleHQuZ2V0UmVwb3NpdG9yeSgpLm9uRGlkR2xvYmFsbHlJbnZhbGlkYXRlKHNwZWMgPT4ge1xuICAgICAgdGhpcy53aXRoUmVzaWRlbnRDb250ZXh0cygoX3dvcmtkaXIsIGVhY2hDb250ZXh0KSA9PiB7XG4gICAgICAgIGlmIChlYWNoQ29udGV4dCAhPT0gY29udGV4dCkge1xuICAgICAgICAgIGVhY2hDb250ZXh0LmdldFJlcG9zaXRvcnkoKS5hY2NlcHRJbnZhbGlkYXRpb24oc3BlYyk7XG4gICAgICAgIH1cbiAgICAgIH0pO1xuICAgIH0pKTtcblxuICAgIGlmICghc2lsZW5jZUVtaXR0ZXIpIHtcbiAgICAgIHRoaXMuZW1pdHRlci5lbWl0KCdkaWQtY2hhbmdlLWNvbnRleHRzJywge2FkZGVkOiBuZXcgU2V0KFtkaXJlY3RvcnldKX0pO1xuICAgIH1cblxuICAgIHJldHVybiBjb250ZXh0O1xuICB9XG5cbiAgcmVwbGFjZShkaXJlY3RvcnksIG9wdGlvbnMgPSB7fSwgc2lsZW5jZUVtaXR0ZXIgPSBmYWxzZSkge1xuICAgIHRoaXMucmVtb3ZlKGRpcmVjdG9yeSwgdHJ1ZSk7XG4gICAgdGhpcy5hZGQoZGlyZWN0b3J5LCBvcHRpb25zLCB0cnVlKTtcblxuICAgIGlmICghc2lsZW5jZUVtaXR0ZXIpIHtcbiAgICAgIHRoaXMuZW1pdHRlci5lbWl0KCdkaWQtY2hhbmdlLWNvbnRleHRzJywge2FsdGVyZWQ6IG5ldyBTZXQoW2RpcmVjdG9yeV0pfSk7XG4gICAgfVxuICB9XG5cbiAgcmVtb3ZlKGRpcmVjdG9yeSwgc2lsZW5jZUVtaXR0ZXIgPSBmYWxzZSkge1xuICAgIGNvbnN0IGV4aXN0aW5nID0gdGhpcy5jb250ZXh0cy5nZXQoZGlyZWN0b3J5KTtcbiAgICB0aGlzLmNvbnRleHRzLmRlbGV0ZShkaXJlY3RvcnkpO1xuXG4gICAgaWYgKGV4aXN0aW5nKSB7XG4gICAgICBleGlzdGluZy5kZXN0cm95KCk7XG5cbiAgICAgIGlmICghc2lsZW5jZUVtaXR0ZXIpIHtcbiAgICAgICAgdGhpcy5lbWl0dGVyLmVtaXQoJ2RpZC1jaGFuZ2UtY29udGV4dHMnLCB7cmVtb3ZlZDogbmV3IFNldChbZGlyZWN0b3J5XSl9KTtcbiAgICAgIH1cbiAgICB9XG4gIH1cblxuICBzZXQoZGlyZWN0b3JpZXMsIG9wdGlvbnMgPSB7fSkge1xuICAgIGNvbnN0IHByZXZpb3VzID0gbmV3IFNldCh0aGlzLmNvbnRleHRzLmtleXMoKSk7XG4gICAgY29uc3Qge2FkZGVkLCByZW1vdmVkfSA9IGNvbXBhcmVTZXRzKHByZXZpb3VzLCBkaXJlY3Rvcmllcyk7XG5cbiAgICBmb3IgKGNvbnN0IGRpcmVjdG9yeSBvZiBhZGRlZCkge1xuICAgICAgdGhpcy5hZGQoZGlyZWN0b3J5LCBvcHRpb25zLCB0cnVlKTtcbiAgICB9XG4gICAgZm9yIChjb25zdCBkaXJlY3Rvcnkgb2YgcmVtb3ZlZCkge1xuICAgICAgdGhpcy5yZW1vdmUoZGlyZWN0b3J5LCB0cnVlKTtcbiAgICB9XG5cbiAgICBpZiAoYWRkZWQuc2l6ZSAhPT0gMCB8fCByZW1vdmVkLnNpemUgIT09IDApIHtcbiAgICAgIHRoaXMuZW1pdHRlci5lbWl0KCdkaWQtY2hhbmdlLWNvbnRleHRzJywge2FkZGVkLCByZW1vdmVkfSk7XG4gICAgfVxuICB9XG5cbiAgZ2V0Q3VycmVudFdvcmtEaXJzKCkge1xuICAgIHJldHVybiB0aGlzLmNvbnRleHRzLmtleXMoKTtcbiAgfVxuXG4gIHdpdGhSZXNpZGVudENvbnRleHRzKGNhbGxiYWNrKSB7XG4gICAgY29uc3QgcmVzdWx0cyA9IFtdO1xuICAgIGZvciAoY29uc3QgW3dvcmtkaXIsIGNvbnRleHRdIG9mIHRoaXMuY29udGV4dHMpIHtcbiAgICAgIHJlc3VsdHMucHVzaChjYWxsYmFjayh3b3JrZGlyLCBjb250ZXh0KSk7XG4gICAgfVxuICAgIHJldHVybiByZXN1bHRzO1xuICB9XG5cbiAgb25EaWRTdGFydE9ic2VydmVyKGNhbGxiYWNrKSB7XG4gICAgcmV0dXJuIHRoaXMuZW1pdHRlci5vbignZGlkLXN0YXJ0LW9ic2VydmVyJywgY2FsbGJhY2spO1xuICB9XG5cbiAgb25EaWRDaGFuZ2VQb29sQ29udGV4dHMoY2FsbGJhY2spIHtcbiAgICByZXR1cm4gdGhpcy5lbWl0dGVyLm9uKCdkaWQtY2hhbmdlLWNvbnRleHRzJywgY2FsbGJhY2spO1xuICB9XG5cbiAgb25EaWRDaGFuZ2VXb3JrZGlyT3JIZWFkKGNhbGxiYWNrKSB7XG4gICAgcmV0dXJuIHRoaXMuZW1pdHRlci5vbignZGlkLWNoYW5nZS13b3JrZGlyLW9yLWhlYWQnLCBjYWxsYmFjayk7XG4gIH1cblxuICBvbkRpZENoYW5nZVJlcG9zaXRvcnlTdGF0ZShjYWxsYmFjaykge1xuICAgIHJldHVybiB0aGlzLmVtaXR0ZXIub24oJ2RpZC1jaGFuZ2UtcmVwb3NpdG9yeS1zdGF0ZScsIGNhbGxiYWNrKTtcbiAgfVxuXG4gIG9uRGlkVXBkYXRlUmVwb3NpdG9yeShjYWxsYmFjaykge1xuICAgIHJldHVybiB0aGlzLmVtaXR0ZXIub24oJ2RpZC11cGRhdGUtcmVwb3NpdG9yeScsIGNhbGxiYWNrKTtcbiAgfVxuXG4gIG9uRGlkRGVzdHJveVJlcG9zaXRvcnkoY2FsbGJhY2spIHtcbiAgICByZXR1cm4gdGhpcy5lbWl0dGVyLm9uKCdkaWQtZGVzdHJveS1yZXBvc2l0b3J5JywgY2FsbGJhY2spO1xuICB9XG5cbiAgY2xlYXIoKSB7XG4gICAgY29uc3Qgd29ya2RpcnMgPSBuZXcgU2V0KCk7XG5cbiAgICB0aGlzLndpdGhSZXNpZGVudENvbnRleHRzKHdvcmtkaXIgPT4ge1xuICAgICAgdGhpcy5yZW1vdmUod29ya2RpciwgdHJ1ZSk7XG4gICAgICB3b3JrZGlycy5hZGQod29ya2Rpcik7XG4gICAgfSk7XG5cbiAgICBXb3JrZGlyQ29udGV4dC5kZXN0cm95QWJzZW50KCk7XG5cbiAgICBpZiAod29ya2RpcnMuc2l6ZSAhPT0gMCkge1xuICAgICAgdGhpcy5lbWl0dGVyLmVtaXQoJ2RpZC1jaGFuZ2UtY29udGV4dHMnLCB7cmVtb3ZlZDogd29ya2RpcnN9KTtcbiAgICB9XG4gIH1cbn1cbiJdLCJtYXBwaW5ncyI6Ijs7Ozs7O0FBQUEsSUFBQUEsWUFBQSxHQUFBQyxzQkFBQSxDQUFBQyxPQUFBO0FBRUEsSUFBQUMsU0FBQSxHQUFBRCxPQUFBO0FBQ0EsSUFBQUUsZUFBQSxHQUFBSCxzQkFBQSxDQUFBQyxPQUFBO0FBQStDLFNBQUFELHVCQUFBSSxHQUFBLFdBQUFBLEdBQUEsSUFBQUEsR0FBQSxDQUFBQyxVQUFBLEdBQUFELEdBQUEsS0FBQUUsT0FBQSxFQUFBRixHQUFBO0FBQUEsU0FBQUcsUUFBQUMsTUFBQSxFQUFBQyxjQUFBLFFBQUFDLElBQUEsR0FBQUMsTUFBQSxDQUFBRCxJQUFBLENBQUFGLE1BQUEsT0FBQUcsTUFBQSxDQUFBQyxxQkFBQSxRQUFBQyxPQUFBLEdBQUFGLE1BQUEsQ0FBQUMscUJBQUEsQ0FBQUosTUFBQSxHQUFBQyxjQUFBLEtBQUFJLE9BQUEsR0FBQUEsT0FBQSxDQUFBQyxNQUFBLFdBQUFDLEdBQUEsV0FBQUosTUFBQSxDQUFBSyx3QkFBQSxDQUFBUixNQUFBLEVBQUFPLEdBQUEsRUFBQUUsVUFBQSxPQUFBUCxJQUFBLENBQUFRLElBQUEsQ0FBQUMsS0FBQSxDQUFBVCxJQUFBLEVBQUFHLE9BQUEsWUFBQUgsSUFBQTtBQUFBLFNBQUFVLGNBQUFDLE1BQUEsYUFBQUMs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