"use strict";

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.default = void 0;
var _eventKit = require("event-kit");
var _atom = require("atom");
var _path = _interopRequireDefault(require("path"));
var _eventLogger = _interopRequireDefault(require("./event-logger"));
function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }
class FileSystemChangeObserver {
  constructor(repository) {
    this.emitter = new _eventKit.Emitter();
    this.repository = repository;
    this.logger = new _eventLogger.default('fs watcher');
    this.started = false;
  }
  async start() {
    await this.watchRepository();
    this.started = true;
    return this;
  }
  async destroy() {
    this.started = false;
    this.emitter.dispose();
    await this.stopCurrentFileWatcher();
  }
  isStarted() {
    return this.started;
  }
  didChange(payload) {
    this.emitter.emit('did-change', payload);
  }
  didChangeWorkdirOrHead() {
    this.emitter.emit('did-change-workdir-or-head');
  }
  onDidChange(callback) {
    return this.emitter.on('did-change', callback);
  }
  onDidChangeWorkdirOrHead(callback) {
    return this.emitter.on('did-change-workdir-or-head', callback);
  }
  getRepository() {
    return this.repository;
  }
  async watchRepository() {
    const allPaths = event => {
      const ps = [event.path];
      if (event.oldPath) {
        ps.push(event.oldPath);
      }
      return ps;
    };
    const isNonGitFile = event => allPaths(event).some(eventPath => !eventPath.split(_path.default.sep).includes('.git'));
    const isWatchedGitFile = event => allPaths(event).some(eventPath => {
      return ['config', 'index', 'HEAD', 'MERGE_HEAD'].includes(_path.default.basename(eventPath)) || _path.default.dirname(eventPath).includes(_path.default.join('.git', 'refs'));
    });
    const handleEvents = events => {
      const filteredEvents = events.filter(e => isNonGitFile(e) || isWatchedGitFile(e));
      if (filteredEvents.length) {
        this.logger.showEvents(filteredEvents);
        this.didChange(filteredEvents);
        const workdirOrHeadEvent = filteredEvents.find(event => {
          return allPaths(event).every(eventPath => !['config', 'index'].includes(_path.default.basename(eventPath)));
        });
        if (workdirOrHeadEvent) {
          this.logger.showWorkdirOrHeadEvents();
          this.didChangeWorkdirOrHead();
        }
      }
    };
    this.currentFileWatcher = await (0, _atom.watchPath)(this.repository.getWorkingDirectoryPath(), {}, handleEvents);
    this.logger.showStarted(this.repository.getWorkingDirectoryPath(), 'Atom watchPath');
  }
  stopCurrentFileWatcher() {
    if (this.currentFileWatcher) {
      this.currentFileWatcher.dispose();
      this.logger.showStopped();
    }
    return Promise.resolve();
  }
}
exports.default = FileSystemChangeObserver;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJuYW1lcyI6WyJGaWxlU3lzdGVtQ2hhbmdlT2JzZXJ2ZXIiLCJjb25zdHJ1Y3RvciIsInJlcG9zaXRvcnkiLCJlbWl0dGVyIiwiRW1pdHRlciIsImxvZ2dlciIsIkV2ZW50TG9nZ2VyIiwic3RhcnRlZCIsInN0YXJ0Iiwid2F0Y2hSZXBvc2l0b3J5IiwiZGVzdHJveSIsImRpc3Bvc2UiLCJzdG9wQ3VycmVudEZpbGVXYXRjaGVyIiwiaXNTdGFydGVkIiwiZGlkQ2hhbmdlIiwicGF5bG9hZCIsImVtaXQiLCJkaWRDaGFuZ2VXb3JrZGlyT3JIZWFkIiwib25EaWRDaGFuZ2UiLCJjYWxsYmFjayIsIm9uIiwib25EaWRDaGFuZ2VXb3JrZGlyT3JIZWFkIiwiZ2V0UmVwb3NpdG9yeSIsImFsbFBhdGhzIiwiZXZlbnQiLCJwcyIsInBhdGgiLCJvbGRQYXRoIiwicHVzaCIsImlzTm9uR2l0RmlsZSIsInNvbWUiLCJldmVudFBhdGgiLCJzcGxpdCIsInNlcCIsImluY2x1ZGVzIiwiaXNXYXRjaGVkR2l0RmlsZSIsImJhc2VuYW1lIiwiZGlybmFtZSIsImpvaW4iLCJoYW5kbGVFdmVudHMiLCJldmVudHMiLCJmaWx0ZXJlZEV2ZW50cyIsImZpbHRlciIsImUiLCJsZW5ndGgiLCJzaG93RXZlbnRzIiwid29ya2Rpck9ySGVhZEV2ZW50IiwiZmluZCIsImV2ZXJ5Iiwic2hvd1dvcmtkaXJPckhlYWRFdmVudHMiLCJjdXJyZW50RmlsZVdhdGNoZXIiLCJ3YXRjaFBhdGgiLCJnZXRXb3JraW5nRGlyZWN0b3J5UGF0aCIsInNob3dTdGFydGVkIiwic2hvd1N0b3BwZWQiLCJQcm9taXNlIiwicmVzb2x2ZSJdLCJzb3VyY2VzIjpbImZpbGUtc3lzdGVtLWNoYW5nZS1vYnNlcnZlci5qcyJdLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQge0VtaXR0ZXJ9IGZyb20gJ2V2ZW50LWtpdCc7XG5pbXBvcnQge3dhdGNoUGF0aH0gZnJvbSAnYXRvbSc7XG5cbmltcG9ydCBwYXRoIGZyb20gJ3BhdGgnO1xuXG5pbXBvcnQgRXZlbnRMb2dnZXIgZnJvbSAnLi9ldmVudC1sb2dnZXInO1xuXG5leHBvcnQgZGVmYXVsdCBjbGFzcyBGaWxlU3lzdGVtQ2hhbmdlT2JzZXJ2ZXIge1xuICBjb25zdHJ1Y3RvcihyZXBvc2l0b3J5KSB7XG4gICAgdGhpcy5lbWl0dGVyID0gbmV3IEVtaXR0ZXIoKTtcbiAgICB0aGlzLnJlcG9zaXRvcnkgPSByZXBvc2l0b3J5O1xuICAgIHRoaXMubG9nZ2VyID0gbmV3IEV2ZW50TG9nZ2VyKCdmcyB3YXRjaGVyJyk7XG5cbiAgICB0aGlzLnN0YXJ0ZWQgPSBmYWxzZTtcbiAgfVxuXG4gIGFzeW5jIHN0YXJ0KCkge1xuICAgIGF3YWl0IHRoaXMud2F0Y2hSZXBvc2l0b3J5KCk7XG4gICAgdGhpcy5zdGFydGVkID0gdHJ1ZTtcbiAgICByZXR1cm4gdGhpcztcbiAgfVxuXG4gIGFzeW5jIGRlc3Ryb3koKSB7XG4gICAgdGhpcy5zdGFydGVkID0gZmFsc2U7XG4gICAgdGhpcy5lbWl0dGVyLmRpc3Bvc2UoKTtcbiAgICBhd2FpdCB0aGlzLnN0b3BDdXJyZW50RmlsZVdhdGNoZXIoKTtcbiAgfVxuXG4gIGlzU3RhcnRlZCgpIHtcbiAgICByZXR1cm4gdGhpcy5zdGFydGVkO1xuICB9XG5cbiAgZGlkQ2hhbmdlKHBheWxvYWQpIHtcbiAgICB0aGlzLmVtaXR0ZXIuZW1pdCgnZGlkLWNoYW5nZScsIHBheWxvYWQpO1xuICB9XG5cbiAgZGlkQ2hhbmdlV29ya2Rpck9ySGVhZCgpIHtcbiAgICB0aGlzLmVtaXR0ZXIuZW1pdCgnZGlkLWNoYW5nZS13b3JrZGlyLW9yLWhlYWQnKTtcbiAgfVxuXG4gIG9uRGlkQ2hhbmdlKGNhbGxiYWNrKSB7XG4gICAgcmV0dXJuIHRoaXMuZW1pdHRlci5vbignZGlkLWNoYW5nZScsIGNhbGxiYWNrKTtcbiAgfVxuXG4gIG9uRGlkQ2hhbmdlV29ya2Rpck9ySGVhZChjYWxsYmFjaykge1xuICAgIHJldHVybiB0aGlzLmVtaXR0ZXIub24oJ2RpZC1jaGFuZ2Utd29ya2Rpci1vci1oZWFkJywgY2FsbGJhY2spO1xuICB9XG5cbiAgZ2V0UmVwb3NpdG9yeSgpIHtcbiAgICByZXR1cm4gdGhpcy5yZXBvc2l0b3J5O1xuICB9XG5cbiAgYXN5bmMgd2F0Y2hSZXBvc2l0b3J5KCkge1xuICAgIGNvbnN0IGFsbFBhdGhzID0gZXZlbnQgPT4ge1xuICAgICAgY29uc3QgcHMgPSBbZXZlbnQucGF0aF07XG4gICAgICBpZiAoZXZlbnQub2xkUGF0aCkgeyBwcy5wdXNoKGV2ZW50Lm9sZFBhdGgpOyB9XG4gICAgICByZXR1cm4gcHM7XG4gICAgfTtcblxuICAgIGNvbnN0IGlzTm9uR2l0RmlsZSA9IGV2ZW50ID0+IGFsbFBhdGhzKGV2ZW50KS5zb21lKGV2ZW50UGF0aCA9PiAhZXZlbnRQYXRoLnNwbGl0KHBhdGguc2VwKS5pbmNsdWRlcygnLmdpdCcpKTtcblxuICAgIGNvbnN0IGlzV2F0Y2hlZEdpdEZpbGUgPSBldmVudCA9PiBhbGxQYXRocyhldmVudCkuc29tZShldmVudFBhdGggPT4ge1xuICAgICAgcmV0dXJuIFsnY29uZmlnJywgJ2luZGV4JywgJ0hFQUQnLCAnTUVSR0VfSEVBRCddLmluY2x1ZGVzKHBhdGguYmFzZW5hbWUoZXZlbnRQYXRoKSkgfHxcbiAgICAgICAgcGF0aC5kaXJuYW1lKGV2ZW50UGF0aCkuaW5jbHVkZXMocGF0aC5qb2luKCcuZ2l0JywgJ3JlZnMnKSk7XG4gICAgfSk7XG5cbiAgICBjb25zdCBoYW5kbGVFdmVudHMgPSBldmVudHMgPT4ge1xuICAgICAgY29uc3QgZmlsdGVyZWRFdmVudHMgPSBldmVudHMuZmlsdGVyKGUgPT4gaXNOb25HaXRGaWxlKGUpIHx8IGlzV2F0Y2hlZEdpdEZpbGUoZSkpO1xuICAgICAgaWYgKGZpbHRlcmVkRXZlbnRzLmxlbmd0aCkge1xuICAgICAgICB0aGlzLmxvZ2dlci5zaG93RXZlbnRzKGZpbHRlcmVkRXZlbnRzKTtcbiAgICAgICAgdGhpcy5kaWRDaGFuZ2UoZmlsdGVyZWRFdmVudHMpO1xuICAgICAgICBjb25zdCB3b3JrZGlyT3JIZWFkRXZlbnQgPSBmaWx0ZXJlZEV2ZW50cy5maW5kKGV2ZW50ID0+IHtcbiAgICAgICAgICByZXR1cm4gYWxsUGF0aHMoZXZlbnQpLmV2ZXJ5KGV2ZW50UGF0aCA9PiAhWydjb25maWcnLCAnaW5kZXgnXS5pbmNsdWRlcyhwYXRoLmJhc2VuYW1lKGV2ZW50UGF0aCkpKTtcbiAgICAgICAgfSk7XG4gICAgICAgIGlmICh3b3JrZGlyT3JIZWFkRXZlbnQpIHtcbiAgICAgICAgICB0aGlzLmxvZ2dlci5zaG93V29ya2Rpck9ySGVhZEV2ZW50cygpO1xuICAgICAgICAgIHRoaXMuZGlkQ2hhbmdlV29ya2Rpck9ySGVhZCgpO1xuICAgICAgICB9XG4gICAgICB9XG4gICAgfTtcblxuICAgIHRoaXMuY3VycmVudEZpbGVXYXRjaGVyID0gYXdhaXQgd2F0Y2hQYXRoKHRoaXMucmVwb3NpdG9yeS5nZXRXb3JraW5nRGlyZWN0b3J5UGF0aCgpLCB7fSwgaGFuZGxlRXZlbnRzKTtcbiAgICB0aGlzLmxvZ2dlci5zaG93U3RhcnRlZCh0aGlzLnJlcG9zaXRvcnkuZ2V0V29ya2luZ0RpcmVjdG9yeVBhdGgoKSwgJ0F0b20gd2F0Y2hQYXRoJyk7XG4gIH1cblxuICBzdG9wQ3VycmVudEZpbGVXYXRjaGVyKCkge1xuICAgIGlmICh0aGlzLmN1cnJlbnRGaWxlV2F0Y2hlcikge1xuICAgICAgdGhpcy5jdXJyZW50RmlsZVdhdGNoZXIuZGlzcG9zZSgpO1xuICAgICAgdGhpcy5sb2dnZXIuc2hvd1N0b3BwZWQoKTtcbiAgICB9XG4gICAgcmV0dXJuIFByb21pc2UucmVzb2x2ZSgpO1xuICB9XG59XG4iXSwibWFwcGluZ3MiOiI7Ozs7OztBQUFBO0FBQ0E7QUFFQTtBQUVBO0FBQXlDO0FBRTFCLE1BQU1BLHdCQUF3QixDQUFDO0VBQzVDQyxXQUFXLENBQUNDLFVBQVUsRUFBRTtJQUN0QixJQUFJLENBQUNDLE9BQU8sR0FBRyxJQUFJQyxpQkFBTyxFQUFFO0lBQzVCLElBQUksQ0FBQ0YsVUFBVSxHQUFH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