"use strict";

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.default = void 0;
var _crypto = _interopRequireDefault(require("crypto"));
var _eventKit = require("event-kit");
var _keytarStrategy = require("../shared/keytar-strategy");
function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }
function _defineProperty(obj, key, value) { key = _toPropertyKey(key); if (key in obj) { Object.defineProperty(obj, key, { value: value, enumerable: true, configurable: true, writable: true }); } else { obj[key] = value; } return obj; }
function _toPropertyKey(t) { var i = _toPrimitive(t, "string"); return "symbol" == typeof i ? i : String(i); }
function _toPrimitive(t, r) { if ("object" != typeof t || !t) return t; var e = t[Symbol.toPrimitive]; if (void 0 !== e) { var i = e.call(t, r || "default"); if ("object" != typeof i) return i; throw new TypeError("@@toPrimitive must return a primitive value."); } return ("string" === r ? String : Number)(t); }
let instance = null;
class GithubLoginModel {
  // Be sure that we're requesting at least this many scopes on the token we grant through github.atom.io or we'll
  // give everyone a really frustrating experience ;-)

  static get() {
    if (!instance) {
      instance = new GithubLoginModel();
    }
    return instance;
  }
  constructor(Strategy) {
    this._Strategy = Strategy;
    this._strategy = null;
    this.emitter = new _eventKit.Emitter();
    this.checked = new Map();
  }
  async getStrategy() {
    if (this._strategy) {
      return this._strategy;
    }
    if (this._Strategy) {
      this._strategy = new this._Strategy();
      return this._strategy;
    }
    this._strategy = await (0, _keytarStrategy.createStrategy)();
    return this._strategy;
  }
  async getToken(account) {
    const strategy = await this.getStrategy();
    const password = await strategy.getPassword('atom-github', account);
    if (!password || password === _keytarStrategy.UNAUTHENTICATED) {
      // User is not logged in
      return _keytarStrategy.UNAUTHENTICATED;
    }
    if (/^https?:\/\//.test(account)) {
      // Avoid storing tokens in memory longer than necessary. Let's cache token scope checks by storing a set of
      // checksums instead.
      const hash = _crypto.default.createHash('md5');
      hash.update(password);
      const fingerprint = hash.digest('base64');
      const outcome = this.checked.get(fingerprint);
      if (outcome === _keytarStrategy.UNAUTHENTICATED || outcome === _keytarStrategy.INSUFFICIENT) {
        // Cached failure
        return outcome;
      } else if (!outcome) {
        // No cached outcome. Query for scopes.
        try {
          const scopes = await this.getScopes(account, password);
          if (scopes === _keytarStrategy.UNAUTHORIZED) {
            // Password is incorrect. Treat it as though you aren't authenticated at all.
            this.checked.set(fingerprint, _keytarStrategy.UNAUTHENTICATED);
            return _keytarStrategy.UNAUTHENTICATED;
          }
          const scopeSet = new Set(scopes);
          for (const scope of this.constructor.REQUIRED_SCOPES) {
            if (!scopeSet.has(scope)) {
              if (scope === 'public_repo' && scopeSet.has('repo')) {
                // 'repo' is a superset of, and implies, 'public_repo'.
                // Setting just 'public_repo' or full 'repo' both have legitimate use-cases. So we won't warn about it.
                continue;
              }
              if (scope === 'read:org' && scopeSet.has('admin:org')) {
                // 'admin:org' is a superset of, and implies, 'read:org'.
                console.warn('Excessive scopes detected on your github token. Please only set the actually needed scopes on your PAT.');
                console.warn('Excessive scope "admin:org" should be "read:org" instead.');
                continue;
              }
              if (scope === 'user:email' && scopeSet.has('user')) {
                // 'user' is a superset of, and implies, 'user:email'.
                console.warn('Excessive scopes detected on your github token. Please only set the actually needed scopes on your PAT.');
                console.warn('Excessive scope "user" should be "user:email" instead.');
                continue;
              }
              // Token doesn't have enough OAuth scopes, need to reauthenticate
              console.log("GitHub token doesn't have a required scope! Missing: " + scope);
              this.checked.set(fingerprint, _keytarStrategy.INSUFFICIENT);
              return _keytarStrategy.INSUFFICIENT;
            }
          }

          // Successfully authenticated and had all required scopes.
          this.checked.set(fingerprint, true);
        } catch (e) {
          // Most likely a network error. Do not cache the failure.
          return e;
        }
      }
    }
    return password;
  }
  async setToken(account, token) {
    const strategy = await this.getStrategy();
    await strategy.replacePassword('atom-github', account, token);
    this.didUpdate();
  }
  async removeToken(account) {
    const strategy = await this.getStrategy();
    await strategy.deletePassword('atom-github', account);
    this.didUpdate();
  }

  /* istanbul ignore next */
  async getScopes(host, token) {
    if (atom.inSpecMode()) {
      if (token === 'good-token') {
        return this.constructor.REQUIRED_SCOPES;
      }
      throw new Error('Attempt to check token scopes in specs');
    }
    let response;
    try {
      response = await fetch(host, {
        method: 'HEAD',
        headers: {
          Authorization: `bearer ${token}`
        }
      });
    } catch (e) {
      e.network = true;
      throw e;
    }
    if (response.status === 401) {
      return _keytarStrategy.UNAUTHORIZED;
    }
    if (response.status !== 200) {
      const e = new Error(`Unable to check token for OAuth scopes against ${host}`);
      e.response = response;
      e.responseText = await response.text();
      throw e;
    }
    return response.headers.get('X-OAuth-Scopes').split(/\s*,\s*/);
  }
  didUpdate() {
    this.emitter.emit('did-update');
  }
  onDidUpdate(cb) {
    return this.emitter.on('did-update', cb);
  }
  destroy() {
    this.emitter.dispose();
  }
}
exports.default = GithubLoginModel;
_defineProperty(GithubLoginModel, "REQUIRED_SCOPES", ['public_repo', 'read:org', 'user:email']);
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJuYW1lcyI6WyJfY3J5cHRvIiwiX2ludGVyb3BSZXF1aXJlRGVmYXVsdCIsInJlcXVpcmUiLCJfZXZlbnRLaXQiLCJfa2V5dGFyU3RyYXRlZ3kiLCJvYmoiLCJfX2VzTW9kdWxlIiwiZGVmYXVsdCIsIl9kZWZpbmVQcm9wZXJ0eSIsImtleSIsInZhbHVlIiwiX3RvUHJvcGVydHlLZXkiLCJPYmplY3QiLCJkZWZpbmVQcm9wZXJ0eSIsImVudW1lcmFibGUiLCJjb25maWd1cmFibGUiLCJ3cml0YWJsZSIsInQiLCJpIiwiX3RvUHJpbWl0aXZlIiwiU3RyaW5nIiwiciIsImUiLCJTeW1ib2wiLCJ0b1ByaW1pdGl2ZSIsImNhbGwiLCJUeXBlRXJyb3IiLCJOdW1iZXIiLCJpbnN0YW5jZSIsIkdpdGh1YkxvZ2luTW9kZWwiLCJnZXQiLCJjb25zdHJ1Y3RvciIsIlN0cmF0ZWd5IiwiX1N0cmF0ZWd5IiwiX3N0cmF0ZWd5IiwiZW1pdHRlciIsIkVtaXR0ZXIiLCJjaGVja2VkIiwiTWFwIiwiZ2V0U3RyYXRlZ3kiLCJjcmVhdGVTdHJhdGVneSIsImdldFRva2VuIiwiYWNjb3VudCIsInN0cmF0ZWd5IiwicGFzc3dvcmQiLCJnZXRQYXNzd29yZCIsIlVOQVVUSEVOVElDQVRFRCIsInRlc3QiLCJoYXNoIiwiY3J5cHRvIiwiY3JlYXRlSGFzaCIsInVwZGF0ZSIsImZpbmdlcnByaW50IiwiZGlnZXN0Iiwib3V0Y29tZSIsIklOU1VGRklDSUVOVCIsInNjb3BlcyIsImdldFNjb3BlcyIsIlVOQVVUSE9SSVpFRCIsInNldCIsInNjb3BlU2V0IiwiU2V0Iiwic2NvcGUiLCJSRVFVSVJFRF9TQ09QRVMiLCJoYXMiLCJjb25zb2xlIiwid2FybiIsImxvZyIsInNldFRva2VuIiwidG9rZW4iLCJyZXBsYWNlUGFzc3dvcmQiLCJkaWRVcGRhdGUiLCJyZW1vdmVUb2tlbiIsImRlbGV0ZVBhc3N3b3JkIiwiaG9zdCIsImF0b20iLCJpblNwZWNNb2RlIiwiRXJyb3IiLCJyZXNwb25zZSIsImZldGNoIiwibWV0aG9kIiwiaGVhZGVycyIsIkF1dGhvcml6YXRpb24iLCJuZXR3b3JrIiwic3RhdHVzIiwicmVzcG9uc2VUZXh0IiwidGV4dCIsInNwbGl0IiwiZW1pdCIsIm9uRGlkVXBkYXRlIiwiY2IiLCJvbiIsImRlc3Ryb3kiLCJkaXNwb3NlIiwiZXhwb3J0cyJdLCJzb3VyY2VzIjpbImdpdGh1Yi1sb2dpbi1tb2RlbC5qcyJdLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgY3J5cHRvIGZyb20gJ2NyeXB0byc7XG5pbXBvcnQge0VtaXR0ZXJ9IGZyb20gJ2V2ZW50LWtpdCc7XG5cbmltcG9ydCB7VU5BVVRIRU5USUNBVEVELCBJTlNVRkZJQ0lFTlQsIFVOQVVUSE9SSVpFRCwgY3JlYXRlU3RyYXRlZ3l9IGZyb20gJy4uL3NoYXJlZC9rZXl0YXItc3RyYXRlZ3knO1xuXG5sZXQgaW5zdGFuY2UgPSBudWxsO1xuXG5leHBvcnQgZGVmYXVsdCBjbGFzcyBHaXRodWJMb2dpbk1vZGVsIHtcbiAgLy8gQmUgc3VyZSB0aGF0IHdlJ3JlIHJlcXVlc3RpbmcgYXQgbGVhc3QgdGhpcyBtYW55IHNjb3BlcyBvbiB0aGUgdG9rZW4gd2UgZ3JhbnQgdGhyb3VnaCBnaXRodWIuYXRvbS5pbyBvciB3ZSdsbFxuICAvLyBnaXZlIGV2ZXJ5b25lIGEgcmVhbGx5IGZydXN0cmF0aW5nIGV4cGVyaWVuY2UgOy0pXG4gIHN0YXRpYyBSRVFVSVJFRF9TQ09QRVMgPSBbJ3B1YmxpY19yZXBvJywgJ3JlYWQ6b3JnJywgJ3VzZXI6ZW1haWwnXVxuXG4gIHN0YXRpYyBnZXQoKSB7XG4gICAgaWYgKCFpbnN0YW5jZSkge1xuICAgICAgaW5zdGFuY2UgPSBuZXcgR2l0aHViTG9naW5Nb2RlbCgpO1xuICAgIH1cbiAgICByZXR1cm4gaW5zdGFuY2U7XG4gIH1cblxuICBjb25zdHJ1Y3RvcihTdHJhdGVneSkge1xuICAgIHRoaXMuX1N0cmF0ZWd5ID0gU3RyYXRlZ3k7XG4gICAgdGhpcy5fc3RyYXRlZ3kgPSBudWxsO1xuICAgIHRoaXMuZW1pdHRlciA9IG5ldyBFbWl0dGVyKCk7XG4gICAgdGhpcy5jaGVja2VkID0gbmV3IE1hcCgpO1xuICB9XG5cbiAgYXN5bmMgZ2V0U3RyYXRlZ3koKSB7XG4gICAgaWYgKHRoaXMuX3N0cmF0ZWd5KSB7XG4gICAgICByZXR1cm4gdGhpcy5fc3RyYXRlZ3k7XG4gICAgfVxuXG4gICAgaWYgKHRoaXMuX1N0cmF0ZWd5KSB7XG4gICAgICB0aGlzLl9zdHJhdGVneSA9IG5ldyB0aGlzLl9TdHJhdGVneSgpO1xuICAgICAgcmV0dXJuIHRoaXMuX3N0cmF0ZWd5O1xuICAgIH1cblxuICAgIHRoaXMuX3N0cmF0ZWd5ID0gYXdhaXQgY3JlYXRlU3RyYXRlZ3koKTtcbiAgICByZXR1cm4gdGhpcy5fc3RyYXRlZ3k7XG4gIH1cblxuICBhc3luYyBnZXRUb2tlbihhY2NvdW50KSB7XG4gICAgY29uc3Qgc3RyYXRlZ3kgPSBhd2FpdCB0aGlzLmdldFN0cmF0ZWd5KCk7XG4gICAgY29uc3QgcGFzc3dvcmQgPSBhd2FpdCBzdHJhdGVneS5nZXRQYXNzd29yZCgnYXRvbS1naXRodWInLCBhY2NvdW50KTtcbiAgICBpZiAoIXBhc3N3b3JkIHx8IHBhc3N3b3JkID09PSBVTkFVVEhFTlRJQ0FURUQpIHtcbiAgICAgIC8vIFVzZXIgaXMgbm90IGxvZ2dlZCBpblxuICAgICAgcmV0dXJuIFVOQVVUSEVOVElDQVRFRDtcbiAgICB9XG5cbiAgICBpZiAoL15odHRwcz86XFwvXFwvLy50ZXN0KGFjY291bnQpKSB7XG4gICAgICAvLyBBdm9pZCBzdG9yaW5nIHRva2VucyBpbiBtZW1vcnkgbG9uZ2VyIHRoYW4gbmVjZXNzYXJ5LiBMZXQncyBjYWNoZSB0b2tlbiBzY29wZSBjaGVja3MgYnkgc3RvcmluZyBhIHNldCBvZlxuICAgICAgLy8gY2hlY2tzdW1zIGluc3RlYWQuXG4gICAgICBjb25zdCBoYXNoID0gY3J5cHRvLmNyZWF0ZUhhc2goJ21kNScpO1xuICAgICAgaGFzaC51cGRhdGUocGFzc3dvcmQpO1xuICAgICAgY29uc3QgZmluZ2VycHJpbnQgPSBoYXNoLmRpZ2VzdCgnYmFzZTY0Jyk7XG5cbiAgICAgIGNvbnN0IG91dGNvbWUgPSB0aGlzLmNoZWNrZWQuZ2V0KGZpbmdlcnByaW50KTtcbiAgICAgIGlmIChvdXRjb21lID09PSBVTkFVVEhFTlRJQ0FURUQgfHwgb3V0Y29tZSA9PT0gSU5TVUZGSUNJRU5UKSB7XG4gICAgICAgIC8vIENhY2hlZCBmYWlsdXJlXG4gICAgICAgIHJldHVybiBvdXRjb21lO1xuICAgICAgfSBlbHNlIGlmICghb3V0Y29tZSkge1xuICAgICAgICAvLyBObyBjYWNoZWQgb3V0Y29tZS4gUXVlcnkgZm9yIHNjb3Blcy5cbiAgICAgICAgdHJ5IHtcbiAgICAgICAgICBjb25zdCBzY29wZXMgPSBhd2FpdCB0aGlzLmdldFNjb3BlcyhhY2NvdW50LCBwYXNzd29yZCk7XG4gICAgICAgICAgaWYgKHNjb3BlcyA9PT0gVU5BVVRIT1JJWkVEKSB7XG4gICAgICAgICAgICAvLyBQYXNzd29yZCBpcyBpbmNvcnJlY3QuIFRyZWF0IGl0IGFzIHRob3VnaCB5b3UgYXJlbid0IGF1dGhlbnRpY2F0ZWQgYXQgYWxsLlxuICAgICAgICAgICAgdGhpcy5jaGVja2VkLnNldChmaW5nZXJwcmludCwgVU5BVVRIRU5USUNBVEVEKTtcbiAgICAgICAgICAgIHJldHVybiBVTkFVVEhFTlRJQ0FURUQ7XG4gICAgICAgICAgfVxuICAgICAgICAgIGNvbnN0IHNjb3BlU2V0ID0gbmV3IFNldChzY29wZXMpO1xuXG4gICAgICAgICAgZm9yIChjb25zdCBzY29wZSBvZiB0aGlzLmNvbnN0cnVjdG9yLlJFUVVJUkVEX1NDT1BFUykge1xuICAgICAgICAgICAgaWYgKCFzY29wZVNldC5oYXMoc2NvcGUpKSB7XG4gICAgICAgICAgICAgIGlmIChzY29wZSA9PT0gJ3B1YmxpY19yZXBvJyAmJiBzY29wZVNldC5oYXMoJ3JlcG8nKSkge1xuICAgICAgICAgICAgICAgIC8vICdyZXBvJyBpcyBhIHN1cGVyc2V0IG9mLCBhbmQgaW1wbGllcywgJ3B1YmxpY19yZXBvJy5cbiAgICAgICAgICAgICAgICAvLyBTZXR0aW5nIGp1c3QgJ3B1YmxpY19yZXBvJyBvciBmdWxsICdyZXBvJyBib3RoIGhhdmUgbGVnaXRpbWF0ZSB1c2UtY2FzZXMuIFNvIHdlIHdvbid0IHdhcm4gYWJvdXQgaXQuXG4gICAgICAgICAgICAgICAgY29udGludWU7XG4gICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgaWYgKHNjb3BlID09PSAncmVhZDpvcmcnICYmIHNjb3BlU2V0LmhhcygnYWRtaW46b3JnJykpIHtcbiAgICAgICAgICAgICAgICAvLyAnYWRtaW46b3JnJyBpcyBhIHN1cGVyc2V0IG9mLCBhbmQgaW1wbGllcywgJ3JlYWQ6b3JnJy5cbiAgICAgICAgICAgICAgICBjb25zb2xlLndhcm4oJ0V4Y2Vzc2l2ZSBzY29wZXMgZGV0ZWN0ZWQgb24geW91ciBnaXRodWIgdG9rZW4uIFBsZWFzZSBvbmx5IHNldCB0aGUgYWN0dWFsbHkgbmVlZGVkIHNjb3BlcyBvbiB5b3VyIFBBVC4nKVxuICAgICAgICAgICAgICAgIGNvbnNvbGUud2FybignRXhjZXNzaXZlIHNjb3BlIFwiYWRtaW46b3JnXCIgc2hvdWxkIGJlIFwicmVhZDpvcmdcIiBpbnN0ZWFkLicpXG4gICAgICAgICAgICAgICAgY29udGludWU7XG4gICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgaWYgKHNjb3BlID09PSAndXNlcjplbWFpbCcgJiYgc2NvcGVTZXQuaGFzKCd1c2VyJykpIHtcbiAgICAgICAgICAgICAgICAvLyAndXNlcicgaXMgYSBzdXBlcnNldCBvZiwgYW5kIGltcGxpZXMsICd1c2VyOmVtYWlsJy5cbiAgICAgICAgICAgICAgICBjb25zb2xlLndhcm4oJ0V4Y2Vzc2l2ZSBzY29wZXMgZGV0ZWN0ZWQgb24geW91ciBnaXRodWIgdG9rZW4uIFBsZWFzZSBvbmx5IHNldCB0aGUgYWN0dWFsbHkgbmVlZGVkIHNjb3BlcyBvbiB5b3VyIFBBVC4nKVxuICAgICAgICAgICAgICAgIGNvbnNvbGUud2FybignRXhjZXNzaXZlIHNjb3BlIFwidXNlclwiIHNob3VsZCBiZSBcInVzZXI6ZW1haWxcIiBpbnN0ZWFkLicpXG4gICAgICAgICAgICAgICAgY29udGludWU7XG4gICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgLy8gVG9rZW4gZG9lc24ndCBoYXZlIGVub3VnaCBPQXV0aCBzY29wZXMsIG5lZWQgdG8gcmVhdXRoZW50aWNhdGVcbiAgICAgICAgICAgICAgY29uc29sZS5sb2coXCJHaXRIdWIgdG9rZW4gZG9lc24ndCBoYXZlIGEgcmVxdWlyZWQgc2NvcGUhIE1pc3Npbmc6IFwiICsgc2NvcGUpO1xuICAgICAgICAgICAgICB0aGlzLmNoZWNrZWQuc2V0KGZpbmdlcnByaW50LCBJTlNVRkZJQ0lFTlQpO1xuICAgICAgICAgICAgICByZXR1cm4gSU5TVUZGSUNJRU5UO1xuICAgICAgICAgICAgfVxuICAgICAgICAgIH1cblxuICAgICAgICAgIC8vIFN1Y2Nlc3NmdWxseSBhdXRoZW50aWNhdGVkIGFuZCBoYWQgYWxsIHJlcXVpcmVkIHNjb3Blcy5cbiAgICAgICAgICB0aGlzLmNoZWNrZWQuc2V0KGZpbmdlcnByaW50LCB0cnVlKTtcbiAgICAgICAgfSBjYXRjaCAoZSkge1xuICAgICAgICAgIC8vIE1vc3QgbGlrZWx5IGEgbmV0d29yayBlcnJvci4gRG8gbm90IGNhY2hlIHRoZSBmYWlsdXJlLlxuICAgICAgICAgIHJldHVybiBlO1xuICAgICAgICB9XG4gICAgICB9XG4gICAgfVxuXG4gICAgcmV0dXJuIHBhc3N3b3JkO1xuICB9XG5cbiAgYXN5bmMgc2V0VG9rZW4oYWNjb3VudCwgdG9rZW4pIHtcbiAgICBjb25zdCBzdHJhdGVneSA9IGF3YWl0IHRoaXMuZ2V0U3RyYXRlZ3koKTtcbiAgICBhd2FpdCBzdHJhdGVneS5yZXBsYWNlUGFzc3dvcmQoJ2F0b20tZ2l0aHViJywgYWNjb3VudCwgdG9rZW4pO1xuICAgIHRoaXMuZGlkVXBkYXRlKCk7XG4gIH1cblxuICBhc3luYyByZW1vdmVUb2tlbihhY2NvdW50KSB7XG4gICAgY29uc3Qgc3RyYXRlZ3kgPSBhd2FpdCB0aGlzLmdldFN0cmF0ZWd5KCk7XG4gICAgYXdhaXQgc3RyYXRlZ3kuZGVsZXRlUGFzc3dvcmQoJ2F0b20tZ2l0aHViJywgYWNjb3VudCk7XG4gICAgdGhpcy5kaWRVcGRhdGUoKTtcbiAgfVxuXG4gIC8qIGlzdGFuYnVsIGlnbm9yZSBuZXh0ICovXG4gIGFzeW5jIGdldFNjb3Blcyhob3N0LCB0b2tlbikge1xuICAgIGlmIChhdG9tLmluU3BlY01vZGUoKSkge1xuICAgICAgaWYgKHRva2VuID09PSAnZ29vZC10b2tlbicpIHtcbiAgICAgICAgcmV0dXJuIHRoaXMuY29uc3RydWN0b3IuUkVRVUlSRURfU0NPUEVTO1xuICAgICAgfVxuXG4gICAgICB0aHJvdyBuZXcgRXJyb3IoJ0F0dGVtcHQgdG8gY2hlY2sgdG9rZW4gc2NvcGVzIGluIHNwZWNzJyk7XG4gICAgfVxuXG4gICAgbGV0IHJlc3BvbnNlO1xuICAgIHRyeSB7XG4gICAgICByZXNwb25zZSA9IGF3YWl0IGZldGNoKGhvc3QsIHtcbiAgICAgICAgbWV0aG9kOiAnSEVBRCcsXG4gICAgICAgIGhlYWRlcnM6IHtBdXRob3JpemF0aW9uOiBgYmVhcmVyICR7dG9rZW59YH0sXG4gICAgICB9KTtcbiAgICB9IGNhdGNoIChlKSB7XG4gICAgICBlLm5ldHdvcmsgPSB0cnVlO1xuICAgICAgdGhyb3cgZTtcbiAgICB9XG5cbiAgICBpZiAocmVzcG9uc2Uuc3RhdHVzID09PSA0MDEpIHtcbiAgICAgIHJldHVybiBVTkFVVEhPUklaRUQ7XG4gICAgfVxuXG4gICAgaWYgKHJlc3BvbnNlLnN0YXR1cyAhPT0gMjAwKSB7XG4gICAgICBjb25zdCBlID0gbmV3IEVycm9yKGBVbmFibGUgdG8gY2hlY2sgdG9rZW4gZm9yIE9BdXRoIHNjb3BlcyBhZ2FpbnN0ICR7aG9zdH1gKTtcbiAgICAgIGUucmVzcG9uc2UgPSByZXNwb25zZTtcbiAgICAgIGUucmVzcG9uc2VUZXh0ID0gYXdhaXQgcmVzcG9uc2UudGV4dCgpO1xuICAgICAgdGhyb3cgZTtcbiAgICB9XG5cbiAgICByZXR1cm4gcmVzcG9uc2UuaGVhZGVycy5nZXQoJ1gtT0F1dGgtU2NvcGVzJykuc3BsaXQoL1xccyosXFxzKi8pO1xuICB9XG5cbiAgZGlkVXBkYXRlKCkge1xuICAgIHRoaXMuZW1pdHRlci5lbWl0KCdkaWQtdXBkYXRlJyk7XG4gIH1cblxuICBvbkRpZFVwZGF0ZShjYikge1xuICAgIHJldHVybiB0aGlzLmVtaXR0ZXIub24oJ2RpZC11cGRhdGUnLCBjYik7XG4gIH1cblxuICBkZXN0cm95KCkge1xuICAgIHRoaXMuZW1pdHRlci5kaXNwb3NlKCk7XG4gIH1cbn1cbiJdLCJtYXBwaW5ncyI6Ijs7Ozs7O0FBQUEsSUFBQUEsT0FBQSxHQUFBQyxzQkFBQSxDQUFBQyxPQUFBO0FBQ0EsSUFBQUMsU0FBQSxHQUFBRCxPQUFBO0FBRUEsSUFBQUUsZUFBQSxHQUFBRixPQUFBO0FBQXNHLFNBQUFELHVCQUFBSSxHQUFBLFdBQUFBLEdBQUEsSUFBQUEsR0FBQSxDQUFBQyxVQUFBLEdBQUFELEdBQUEsS0FBQUUsT0FBQSxFQUFBRixHQUFBO0FBQUEsU0FBQUcsZ0JBQUFILEdBQUEsRUFBQUksR0FBQSxFQUFBQyxLQUFBLElBQUFELEdBQUEsR0FBQUUsY0FBQSxDQUFBRixHQUFBLE9BQUFBLEdBQUEsSUFBQUosR0FBQSxJQUFBTyxNQUFBLENBQUFDLGNBQUEsQ0FBQVIsR0FBQSxFQUFBSSxHQUFBLElBQUFDLEtBQUEsRUFBQUEsS0FBQSxFQUFBSSxVQUFBLFFBQUFDLFlBQUEsUUFBQUMsUUFBQSxvQkFBQVgsR0FBQSxDQUFBSSxHQUFBLElBQUFDLEtBQUEsV0FBQUwsR0FBQTtBQUFBLFNBQUFNLGVBQUFNLENBQUEsUUFBQUMsQ0FBQSxHQUFBQyxZQUFBLENBQUFGLENBQUEsdUNBQUFDLENBQUEsR0FBQUEsQ0FBQSxHQUFBRSxNQUFBLENBQUFGLENBQUE7QUFBQSxTQUFBQyxhQUFBRixDQUFBLEVBQUFJLENBQUEs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